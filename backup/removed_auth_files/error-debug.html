<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>400ã‚¨ãƒ©ãƒ¼è©³ç´°èª¿æŸ» - RentPipe</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .section {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .btn {
            background: #4285f4;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        
        .btn-danger { background: #ea4335; }
        .btn-success { background: #34a853; }
        .btn-warning { background: #fbbc04; color: #333; }
        
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        
        .status-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .debug-output {
            max-height: 400px;
            overflow-y: auto;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            font-family: monospace;
            font-size: 11px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>ğŸ” 400ã‚¨ãƒ©ãƒ¼è©³ç´°èª¿æŸ»ãƒ„ãƒ¼ãƒ«</h1>
    
    <!-- ç¾åœ¨ã®çŠ¶æ³ç¢ºèª -->
    <div class="section">
        <h2>ğŸ“Š ç¾åœ¨ã®çŠ¶æ³ç¢ºèª</h2>
        <button onclick="checkCurrentStatus()" class="btn">ç¾åœ¨ã®çŠ¶æ³ã‚’ç¢ºèª</button>
        <div id="current-status" class="status status-info">
            ã€Œç¾åœ¨ã®çŠ¶æ³ã‚’ç¢ºèªã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„
        </div>
    </div>
    
    <!-- èª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆç¢ºèª -->
    <div class="section">
        <h2>ğŸ“œ èª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆç¢ºèª</h2>
        <button onclick="checkLoadedScripts()" class="btn">ã‚¹ã‚¯ãƒªãƒ—ãƒˆç¢ºèª</button>
        <div id="loaded-scripts" class="debug-output">
            ã‚¹ã‚¯ãƒªãƒ—ãƒˆä¸€è¦§ãŒè¡¨ç¤ºã•ã‚Œã¾ã™
        </div>
    </div>
    
    <!-- é–¢æ•°ã®å­˜åœ¨ç¢ºèª -->
    <div class="section">
        <h2>ğŸ”§ é–¢æ•°ã®å­˜åœ¨ç¢ºèª</h2>
        <button onclick="checkFunctions()" class="btn">é–¢æ•°ç¢ºèª</button>
        <div id="function-check" class="debug-output">
            é–¢æ•°ã®å­˜åœ¨çŠ¶æ³ãŒè¡¨ç¤ºã•ã‚Œã¾ã™
        </div>
    </div>
    
    <!-- ã‚¨ãƒ©ãƒ¼å†ç¾ãƒ†ã‚¹ãƒˆ -->
    <div class="section">
        <h2>ğŸ§ª ã‚¨ãƒ©ãƒ¼å†ç¾ãƒ†ã‚¹ãƒˆ</h2>
        <p>ãƒ†ã‚¹ãƒˆç”¨é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã§ã‚¨ãƒ©ãƒ¼ã‚’å†ç¾ã—ã¾ã™ï¼š</p>
        <button onclick="reproduceError()" class="btn btn-warning">ã‚¨ãƒ©ãƒ¼å†ç¾ãƒ†ã‚¹ãƒˆ</button>
        <div id="error-reproduction" class="debug-output">
            ã‚¨ãƒ©ãƒ¼å†ç¾çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™
        </div>
    </div>
    
    <!-- Google Apps Scriptå˜ä½“ãƒ†ã‚¹ãƒˆ -->
    <div class="section">
        <h2>âœ… Google Apps Scriptå˜ä½“ãƒ†ã‚¹ãƒˆ</h2>
        <p>Google Apps ScriptãŒæ­£ã—ãå‹•ä½œã™ã‚‹ã‹ãƒ†ã‚¹ãƒˆã—ã¾ã™ï¼š</p>
        <input type="text" id="gas-url-input" placeholder="Google Apps Scriptã®URL" style="width: 100%; padding: 8px; margin-bottom: 10px;">
        <div>
            <button onclick="testGASOnly()" class="btn btn-success">Apps Scriptå˜ä½“ãƒ†ã‚¹ãƒˆ</button>
        </div>
        <div id="gas-test-result" class="debug-output">
            Google Apps Scriptãƒ†ã‚¹ãƒˆçµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™
        </div>
    </div>
    
    <!-- ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é€šä¿¡ç¢ºèª -->
    <div class="section">
        <h2>ğŸŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é€šä¿¡ç¢ºèª</h2>
        <button onclick="checkNetworkRequests()" class="btn">é€šä¿¡ãƒ­ã‚°ç¢ºèª</button>
        <div id="network-logs" class="debug-output">
            F12 Network ã‚¿ãƒ–ã§é€šä¿¡ã‚’ç¢ºèªã—ã¦ãã ã•ã„
        </div>
    </div>

    <!-- ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ã«æœ€å°é™ï¼‰ -->
    <script src="js/create-test-customers.js"></script>
    <script src="js/google-apps-script-forms.js"></script>
    
    <script>
        let debugLogs = [];
        
        // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°é–¢æ•°
        function debugLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            debugLogs.push(logEntry);
            console.log(logEntry);
        }
        
        // ç¾åœ¨ã®çŠ¶æ³ç¢ºèª
        function checkCurrentStatus() {
            debugLog('ç¾åœ¨ã®çŠ¶æ³ç¢ºèªé–‹å§‹');
            
            const status = {
                url: window.location.href,
                userAgent: navigator.userAgent,
                timestamp: new Date().toISOString(),
                
                // JavaScript ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å­˜åœ¨ç¢ºèª
                googleIdentity: !!window.GoogleIdentity,
                integratedAuth: !!window.IntegratedAuthManagerV2,
                googleFormsAPI: !!window.GoogleFormsAPIv2,
                simpleGoogleForms: !!window.SimpleGoogleForms,
                minimalGoogleForms: !!window.MinimalGoogleForms,
                googleAppsScriptForms: !!window.GoogleAppsScriptForms,
                
                // ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®å­˜åœ¨ç¢ºèª
                gapi: !!window.gapi,
                google: !!window.google,
                
                // é–¢æ•°ã®å­˜åœ¨ç¢ºèª
                createGoogleForm: typeof window.createGoogleForm,
                createGoogleFormGAS: typeof window.createGoogleFormGAS,
                
                // LocalStorageã®å†…å®¹
                localStorage: {
                    customers: !!localStorage.getItem('customers'),
                    googleAuth: !!localStorage.getItem('google_auth_data'),
                    rentpipeAuth: !!localStorage.getItem('rentpipe_auth')
                }
            };
            
            document.getElementById('current-status').textContent = JSON.stringify(status, null, 2);
            debugLog('ç¾åœ¨ã®çŠ¶æ³ç¢ºèªå®Œäº†: ' + JSON.stringify(status, null, 2));
        }
        
        // èª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆç¢ºèª
        function checkLoadedScripts() {
            debugLog('èª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆç¢ºèªé–‹å§‹');
            
            const scripts = Array.from(document.querySelectorAll('script')).map(script => ({
                src: script.src,
                inline: !script.src ? script.textContent.substring(0, 100) + '...' : null,
                async: script.async,
                defer: script.defer
            }));
            
            document.getElementById('loaded-scripts').textContent = JSON.stringify(scripts, null, 2);
            debugLog('ã‚¹ã‚¯ãƒªãƒ—ãƒˆç¢ºèªå®Œäº†: ' + scripts.length + 'å€‹ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆ');
        }
        
        // é–¢æ•°ã®å­˜åœ¨ç¢ºèª
        function checkFunctions() {
            debugLog('é–¢æ•°ã®å­˜åœ¨ç¢ºèªé–‹å§‹');
            
            const functions = {
                // å¤ã„Google Forms APIé–¢é€£
                'window.GoogleIdentity': typeof window.GoogleIdentity,
                'window.IntegratedAuthManagerV2': typeof window.IntegratedAuthManagerV2,
                'window.GoogleFormsAPIv2': typeof window.GoogleFormsAPIv2,
                'window.SimpleGoogleForms': typeof window.SimpleGoogleForms,
                'window.MinimalGoogleForms': typeof window.MinimalGoogleForms,
                
                // Google Apps Scripté–¢é€£
                'window.GoogleAppsScriptForms': typeof window.GoogleAppsScriptForms,
                
                // é–¢æ•°
                'window.createGoogleForm': typeof window.createGoogleForm,
                'window.createGoogleFormGAS': typeof window.createGoogleFormGAS,
                
                // ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
                'window.gapi': typeof window.gapi,
                'window.google': typeof window.google
            };
            
            // Google Apps Script Forms ã®è©³ç´°æƒ…å ±
            if (window.GoogleAppsScriptForms) {
                functions['GoogleAppsScriptForms.scriptUrl'] = window.GoogleAppsScriptForms.scriptUrl;
                functions['GoogleAppsScriptForms.isInitialized'] = window.GoogleAppsScriptForms.isInitialized;
                
                if (window.GoogleAppsScriptForms.getDebugInfo) {
                    functions['GoogleAppsScriptForms.debugInfo'] = window.GoogleAppsScriptForms.getDebugInfo();
                }
            }
            
            document.getElementById('function-check').textContent = JSON.stringify(functions, null, 2);
            debugLog('é–¢æ•°ç¢ºèªå®Œäº†');
        }
        
        // ã‚¨ãƒ©ãƒ¼å†ç¾ãƒ†ã‚¹ãƒˆ
        async function reproduceError() {
            debugLog('ã‚¨ãƒ©ãƒ¼å†ç¾ãƒ†ã‚¹ãƒˆé–‹å§‹');
            
            try {
                const testCustomer = {
                    id: 'debug-test-customer',
                    name: 'ãƒ‡ãƒãƒƒã‚°ãƒ†ã‚¹ãƒˆå¤ªéƒ',
                    email: 'debug@example.com',
                    phone: '03-0000-0000'
                };
                
                debugLog('ãƒ†ã‚¹ãƒˆé¡§å®¢ãƒ‡ãƒ¼ã‚¿: ' + JSON.stringify(testCustomer));
                
                // ã©ã®é–¢æ•°ãŒå‘¼ã³å‡ºã•ã‚Œã‚‹ã‹ç¢ºèª
                if (window.createGoogleForm) {
                    debugLog('createGoogleForm é–¢æ•°ãŒå­˜åœ¨ã—ã¾ã™');
                    debugLog('createGoogleForm ã®å®šç¾©: ' + window.createGoogleForm.toString().substring(0, 200));
                }
                
                if (window.createGoogleFormGAS) {
                    debugLog('createGoogleFormGAS é–¢æ•°ãŒå­˜åœ¨ã—ã¾ã™');
                }
                
                // å®Ÿéš›ã«ã‚¨ãƒ©ãƒ¼ã‚’å†ç¾
                document.getElementById('error-reproduction').textContent = 'ğŸ”„ ã‚¨ãƒ©ãƒ¼å†ç¾ä¸­...';
                
                if (window.createGoogleForm) {
                    debugLog('createGoogleForm ã‚’å‘¼ã³å‡ºã—ã¾ã™');
                    const result = await window.createGoogleForm(testCustomer.id);
                    debugLog('çµæœ: ' + JSON.stringify(result));
                }
                
            } catch (error) {
                debugLog('âŒ ã‚¨ãƒ©ãƒ¼å†ç¾æˆåŠŸï¼ˆã“ã‚ŒãŒåŸå› ã§ã™ï¼‰: ' + error.message);
                document.getElementById('error-reproduction').textContent = 
                    'âŒ ã‚¨ãƒ©ãƒ¼å†ç¾æˆåŠŸ:\n' + 
                    'ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ' + error.message + '\n' +
                    'ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹:\n' + error.stack;
            }
        }
        
        // Google Apps Scriptå˜ä½“ãƒ†ã‚¹ãƒˆ
        async function testGASOnly() {
            debugLog('Google Apps Scriptå˜ä½“ãƒ†ã‚¹ãƒˆé–‹å§‹');
            
            const gasUrl = document.getElementById('gas-url-input').value;
            
            if (!gasUrl) {
                document.getElementById('gas-test-result').textContent = 'âŒ Google Apps Scriptã®URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
                return;
            }
            
            try {
                const testData = {
                    customerData: {
                        id: 'gas-only-test',
                        name: 'GASå˜ä½“ãƒ†ã‚¹ãƒˆå¤ªéƒ',
                        email: 'gastest@example.com',
                        phone: '03-0000-0000'
                    }
                };
                
                debugLog('Google Apps Scriptã«ç›´æ¥ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡: ' + gasUrl);
                document.getElementById('gas-test-result').textContent = 'ğŸ”„ Google Apps Scriptãƒ†ã‚¹ãƒˆä¸­...';
                
                const response = await fetch(gasUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(testData),
                    mode: 'cors'
                });
                
                debugLog('ãƒ¬ã‚¹ãƒãƒ³ã‚¹çŠ¶æ…‹: ' + response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                debugLog('æˆåŠŸ: ' + JSON.stringify(result));
                
                document.getElementById('gas-test-result').textContent = 
                    'âœ… Google Apps Scriptå˜ä½“ãƒ†ã‚¹ãƒˆæˆåŠŸ!\n' +
                    JSON.stringify(result, null, 2);
                
            } catch (error) {
                debugLog('âŒ Google Apps Scriptå˜ä½“ãƒ†ã‚¹ãƒˆå¤±æ•—: ' + error.message);
                document.getElementById('gas-test-result').textContent = 
                    'âŒ Google Apps Scriptå˜ä½“ãƒ†ã‚¹ãƒˆå¤±æ•—:\n' +
                    'ã‚¨ãƒ©ãƒ¼: ' + error.message;
            }
        }
        
        // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é€šä¿¡ç¢ºèª
        function checkNetworkRequests() {
            const networkInfo = `
ğŸŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é€šä¿¡ç¢ºèªæ–¹æ³•:

1. F12 ã‚’æŠ¼ã—ã¦ãƒ‡ãƒ™ãƒ­ãƒƒãƒ‘ãƒ¼ãƒ„ãƒ¼ãƒ«ã‚’é–‹ã
2. Network ã‚¿ãƒ–ã‚’ã‚¯ãƒªãƒƒã‚¯
3. ã€ŒPreserve logã€ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã‚‹
4. ã€ŒClearã€ãƒœã‚¿ãƒ³ã§ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢
5. ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
6. é€ä¿¡ã•ã‚Œã‚‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ç¢ºèª

ç¢ºèªé …ç›®:
- ã©ã®URLã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒé€ä¿¡ã•ã‚Œã¦ã„ã‚‹ã‹
- ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å†…å®¹ï¼ˆ400ã‚¨ãƒ©ãƒ¼ã®è©³ç´°ï¼‰
- ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ã¨ãƒœãƒ‡ã‚£ã®å†…å®¹

ç‰¹ã«é‡è¦:
- forms.googleapis.com ã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒé€ä¿¡ã•ã‚Œã¦ã„ã‚‹å ´åˆ
  â†’ å¤ã„Google Forms APIãŒå‘¼ã³å‡ºã•ã‚Œã¦ã„ã¾ã™
- script.google.com ã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒé€ä¿¡ã•ã‚Œã¦ã„ã‚‹å ´åˆ  
  â†’ Google Apps ScriptãŒæ­£ã—ãå‘¼ã³å‡ºã•ã‚Œã¦ã„ã¾ã™
            `;
            
            document.getElementById('network-logs').textContent = networkInfo;
            debugLog('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç¢ºèªæ–¹æ³•ã‚’è¡¨ç¤º');
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®è‡ªå‹•ãƒã‚§ãƒƒã‚¯
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('ã‚¨ãƒ©ãƒ¼ãƒ‡ãƒãƒƒã‚°ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†');
            setTimeout(checkCurrentStatus, 1000);
        });
    </script>
</body>
</html>
