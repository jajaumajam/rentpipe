<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èªè¨¼çŠ¶æ…‹è¨ºæ–­ - RentPipe</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 2rem; line-height: 1.6; }
        .section { margin: 1rem 0; padding: 1rem; border: 1px solid #ddd; border-radius: 8px; }
        .success { background: #d1fae5; border-color: #059669; }
        .error { background: #fee2e2; border-color: #dc2626; }
        .warning { background: #fef3c7; border-color: #f59e0b; }
        .info { background: #dbeafe; border-color: #3b82f6; }
        .neutral { background: #f3f4f6; border-color: #9ca3af; }
        pre { background: #f3f4f6; padding: 1rem; overflow-x: auto; font-size: 12px; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; border: none; border-radius: 4px; }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-success { background: #059669; color: white; }
        .btn-danger { background: #dc2626; color: white; }
    </style>
</head>
<body>
    <h1>ğŸ” èªè¨¼çŠ¶æ…‹è¨ºæ–­</h1>
    
    <div class="section info">
        <h3>ğŸ“‹ è¨ºæ–­ç›®çš„</h3>
        <p>Googleèªè¨¼ã¨customer-minimal.htmlã®èªè¨¼çŠ¶æ…‹çµ±åˆã‚’è¨ºæ–­ã—ã¾ã™ã€‚</p>
    </div>
    
    <div class="section">
        <h3>ğŸ”§ è¨ºæ–­å®Ÿè¡Œ</h3>
        <button onclick="runFullDiagnosis()" class="btn-primary">å®Œå…¨è¨ºæ–­å®Ÿè¡Œ</button>
        <button onclick="fixAuthIssues()" class="btn-success">èªè¨¼å•é¡Œã‚’è‡ªå‹•ä¿®æ­£</button>
        <button onclick="clearAllAuth()" class="btn-danger">å…¨èªè¨¼ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢</button>
    </div>
    
    <div class="section">
        <h3>ğŸ“Š è¨ºæ–­çµæœ</h3>
        <div id="diagnosticResults">è¨ºæ–­ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„</div>
    </div>
    
    <div class="section">
        <h3>ğŸ”— ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸</h3>
        <p>
            <a href="login-google-simple.html" target="_blank">Googleãƒ­ã‚°ã‚¤ãƒ³</a> |
            <a href="customer-minimal.html" target="_blank">é¡§å®¢ç®¡ç†ï¼ˆç°¡æ˜“ç‰ˆï¼‰</a> |
            <a href="customer.html" target="_blank">é¡§å®¢ç®¡ç†</a> |
            <a href="index.html" target="_blank">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a>
        </p>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="js/simple-reliable-auth.js"></script>
    
    <script>
        // Firebaseè¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyBvJGdan0lvVSkaAbbSXQkoh6YyPoGyTgM",
            authDomain: "rentpipe-ab04e.firebaseapp.com",
            projectId: "rentpipe-ab04e",
            storageBucket: "rentpipe-ab04e.firebasestorage.app",
            messagingSenderId: "586040985916",
            appId: "1:586040985916:web:3cdb5db072f1a6569fb639"
        };
        firebase.initializeApp(firebaseConfig);
        
        function log(message, type = 'info') {
            const resultDiv = document.getElementById('diagnosticResults');
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : type === 'neutral' ? 'neutral' : 'info';
            const icon = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : type === 'warning' ? 'âš ï¸' : type === 'neutral' ? 'â„¹ï¸' : 'â„¹ï¸';
            
            resultDiv.innerHTML += `<div class="section ${className}">${icon} ${message}</div>`;
            console.log(message);
        }
        
        function runFullDiagnosis() {
            document.getElementById('diagnosticResults').innerHTML = '';
            log('ğŸ” èªè¨¼çŠ¶æ…‹ã®å®Œå…¨è¨ºæ–­ã‚’é–‹å§‹ã—ã¾ã™...', 'info');
            
            // 1. ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®èªè¨¼ãƒ‡ãƒ¼ã‚¿ç¢ºèªï¼ˆæ”¹å–„ç‰ˆï¼‰
            const authKeys = [
                { key: 'rentpipe_auth_simple', name: 'Simpleèªè¨¼ãƒ•ãƒ©ã‚°', required: true },
                { key: 'rentpipe_user_simple', name: 'Simpleèªè¨¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿', required: true },
                { key: 'rentpipe_temp_auth', name: 'Googleèªè¨¼ãƒ•ãƒ©ã‚°', required: true },
                { key: 'rentpipe_user_info', name: 'Googleèªè¨¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿', required: true },
                { key: 'rentpipe_auth', name: 'è¿½åŠ èªè¨¼æƒ…å ±', required: false },
                { key: 'rentpipe_demo_auth', name: 'ãƒ‡ãƒ¢èªè¨¼ï¼ˆGoogleèªè¨¼æ™‚ã¯ä¸è¦ï¼‰', required: false }
            ];
            
            log('ğŸ“Š ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®èªè¨¼ãƒ‡ãƒ¼ã‚¿ç¢ºèª:', 'info');
            
            let coreAuthCount = 0;
            let totalRequiredCount = 0;
            
            authKeys.forEach(({ key, name, required }) => {
                const data = localStorage.getItem(key);
                totalRequiredCount += required ? 1 : 0;
                
                if (data) {
                    try {
                        const parsed = JSON.parse(data);
                        log(`âœ… ${name}: ãƒ‡ãƒ¼ã‚¿ã‚ã‚Š`, 'success');
                        if (required) coreAuthCount++;
                        
                        // è©³ç´°æƒ…å ±ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®å ´åˆï¼‰
                        if (key.includes('user') && parsed.email) {
                            log(`   â”” ãƒ¦ãƒ¼ã‚¶ãƒ¼: ${parsed.email}${parsed.displayName ? ` (${parsed.displayName})` : ''}`, 'info');
                            if (parsed.photoURL) {
                                log(`   â”” å†™çœŸURL: ã‚ã‚Š (${parsed.photoURL.substring(0, 50)}...)`, 'info');
                            }
                        }
                        
                    } catch (e) {
                        log(`âœ… ${name}: ${data}`, 'success');
                        if (required) coreAuthCount++;
                    }
                } else {
                    if (required) {
                        log(`âŒ ${name}: ãƒ‡ãƒ¼ã‚¿ãªã—`, 'error');
                    } else {
                        log(`â„¹ï¸ ${name}: ãƒ‡ãƒ¼ã‚¿ãªã—ï¼ˆæ­£å¸¸ï¼‰`, 'neutral');
                    }
                }
            });
            
            // 2. èªè¨¼çŠ¶æ…‹ã‚µãƒãƒªãƒ¼
            log('ğŸ“Š èªè¨¼çŠ¶æ…‹ã‚µãƒãƒªãƒ¼:', 'info');
            
            if (coreAuthCount === totalRequiredCount) {
                log(`âœ… ã‚³ã‚¢èªè¨¼ãƒ‡ãƒ¼ã‚¿: ${coreAuthCount}/${totalRequiredCount}ä»¶ - å®Œå…¨`, 'success');
            } else {
                log(`âš ï¸ ã‚³ã‚¢èªè¨¼ãƒ‡ãƒ¼ã‚¿: ${coreAuthCount}/${totalRequiredCount}ä»¶ - ä¸å®Œå…¨`, 'warning');
            }
            
            // 3. simple-reliable-auth.js ã®é–¢æ•°ãƒ†ã‚¹ãƒˆ
            log('ğŸ”§ simple-reliable-auth.js é–¢æ•°ãƒ†ã‚¹ãƒˆ:', 'info');
            
            if (typeof isLoggedIn === 'function') {
                const loginStatus = isLoggedIn();
                log(`isLoggedIn(): ${loginStatus}`, loginStatus ? 'success' : 'error');
            } else {
                log('isLoggedIn() é–¢æ•°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
            }
            
            if (typeof getUser === 'function') {
                const user = getUser();
                if (user) {
                    log(`getUser(): ${user.email} (${user.displayName || 'åå‰ãªã—'})`, 'success');
                } else {
                    log('getUser(): null', 'error');
                }
            } else {
                log('getUser() é–¢æ•°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
            }
            
            // 4. Firebaseèªè¨¼çŠ¶æ…‹ç¢ºèª
            log('ğŸ”¥ Firebaseèªè¨¼çŠ¶æ…‹ç¢ºèª:', 'info');
            firebase.auth().onAuthStateChanged((user) => {
                if (user) {
                    log(`Firebaseèªè¨¼æ¸ˆã¿: ${user.email}`, 'success');
                    log(`Firebase UID: ${user.uid}`, 'success');
                    log(`Firebase å†™çœŸURL: ${user.photoURL ? 'ã‚ã‚Š' : 'ãªã—'}`, user.photoURL ? 'success' : 'neutral');
                } else {
                    log('Firebaseæœªèªè¨¼', 'error');
                }
            });
            
            // 5. customer-minimal.html ã®èªè¨¼ãƒã‚§ãƒƒã‚¯æ–¹å¼ã‚’è¨ºæ–­
            log('ğŸ“± customer-minimal.html èªè¨¼ãƒã‚§ãƒƒã‚¯è¨ºæ–­:', 'info');
            
            // customer-minimal.htmlã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ã‚’ãƒ†ã‚¹ãƒˆ
            const authMethods = [
                {
                    name: 'simple-reliable-authæ–¹å¼',
                    check: () => localStorage.getItem('rentpipe_auth_simple') === 'logged_in'
                },
                {
                    name: 'Googleèªè¨¼ãƒ•ãƒ©ã‚°æ–¹å¼',
                    check: () => localStorage.getItem('rentpipe_temp_auth') === 'google_authenticated'
                },
                {
                    name: 'çµ±åˆèªè¨¼æ–¹å¼',
                    check: () => {
                        const authSimple = localStorage.getItem('rentpipe_auth_simple') === 'logged_in';
                        const googleAuth = localStorage.getItem('rentpipe_temp_auth') === 'google_authenticated';
                        return authSimple || googleAuth;
                    }
                }
            ];
            
            authMethods.forEach(method => {
                const result = method.check();
                log(`${method.name}: ${result}`, result ? 'success' : 'error');
            });
            
            // 6. æ¨å¥¨è§£æ±ºç­–ï¼ˆæ”¹å–„ç‰ˆï¼‰
            setTimeout(() => {
                log('ğŸ’¡ è¨ºæ–­çµæœã«åŸºã¥ãæ¨å¥¨è§£æ±ºç­–:', 'warning');
                
                const hasSimpleAuth = localStorage.getItem('rentpipe_auth_simple') === 'logged_in';
                const hasGoogleAuth = localStorage.getItem('rentpipe_temp_auth') === 'google_authenticated';
                const hasUserData = localStorage.getItem('rentpipe_user_simple') && localStorage.getItem('rentpipe_user_info');
                
                if (hasSimpleAuth && hasGoogleAuth && hasUserData) {
                    log('ğŸ‰ å…¨èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™ï¼', 'success');
                    log('customer-minimal.htmlã§èªè¨¼çŠ¶æ…‹ãŒæ­£ã—ãè¡¨ç¤ºã•ã‚Œã‚‹ã¯ãšã§ã™', 'success');
                } else if (!hasSimpleAuth && hasGoogleAuth && hasUserData) {
                    log('ğŸ”§ ã€Œèªè¨¼å•é¡Œã‚’è‡ªå‹•ä¿®æ­£ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦èªè¨¼ãƒ‡ãƒ¼ã‚¿ã‚’çµ±ä¸€ã—ã¦ãã ã•ã„', 'warning');
                } else if (!hasUserData) {
                    log('ğŸ”§ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚å†åº¦Googleãƒ­ã‚°ã‚¤ãƒ³ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„', 'warning');
                } else if (!hasGoogleAuth) {
                    log('ğŸ”§ Googleèªè¨¼ãƒ•ãƒ©ã‚°ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚å†åº¦Googleãƒ­ã‚°ã‚¤ãƒ³ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„', 'warning');
                }
            }, 1000);
        }
        
        function fixAuthIssues() {
            log('ğŸ”§ èªè¨¼å•é¡Œã®è‡ªå‹•ä¿®æ­£ã‚’é–‹å§‹...', 'info');
            
            // æœ€ã‚‚å®Œå…¨ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            let userData = null;
            
            // æ–¹æ³•1: simple-reliable-auth ã‹ã‚‰å–å¾—
            const userSimple = localStorage.getItem('rentpipe_user_simple');
            if (userSimple) {
                try {
                    userData = JSON.parse(userSimple);
                    log('ğŸ“Š simple-reliable-auth ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿å–å¾—', 'info');
                } catch (e) {}
            }
            
            // æ–¹æ³•2: Googleèªè¨¼ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å–å¾—
            if (!userData) {
                const userInfo = localStorage.getItem('rentpipe_user_info');
                if (userInfo) {
                    try {
                        userData = JSON.parse(userInfo);
                        log('ğŸ“Š Googleèªè¨¼ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿å–å¾—', 'info');
                    } catch (e) {}
                }
            }
            
            if (userData && userData.email) {
                // å…¨å½¢å¼ã§ä¿å­˜
                localStorage.setItem('rentpipe_auth_simple', 'logged_in');
                localStorage.setItem('rentpipe_user_simple', JSON.stringify(userData));
                localStorage.setItem('rentpipe_temp_auth', 'google_authenticated');
                localStorage.setItem('rentpipe_user_info', JSON.stringify(userData));
                
                log('âœ… èªè¨¼ãƒ‡ãƒ¼ã‚¿ã‚’å…¨å½¢å¼ã§çµ±ä¸€ã—ã¾ã—ãŸ', 'success');
                log(`çµ±ä¸€ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼: ${userData.email}`, 'success');
                
                // ä¿®æ­£å¾Œã®ç¢ºèª
                setTimeout(() => {
                    log('ğŸ” ä¿®æ­£å¾Œã®ç¢ºèª:', 'info');
                    runFullDiagnosis();
                }, 500);
                
            } else {
                log('âŒ ä¿®æ­£å¯èƒ½ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚å…ˆã«Googleãƒ­ã‚°ã‚¤ãƒ³ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„', 'error');
            }
        }
        
        function clearAllAuth() {
            if (confirm('å…¨ã¦ã®èªè¨¼ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ\n\nå†åº¦ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚')) {
                const authKeys = [
                    'rentpipe_auth_simple',
                    'rentpipe_user_simple', 
                    'rentpipe_temp_auth',
                    'rentpipe_user_info',
                    'rentpipe_auth',
                    'rentpipe_demo_auth'
                ];
                
                authKeys.forEach(key => {
                    localStorage.removeItem(key);
                });
                
                // Firebaseèªè¨¼ã‚‚ã‚µã‚¤ãƒ³ã‚¢ã‚¦ãƒˆ
                firebase.auth().signOut();
                
                log('âœ… å…¨ã¦ã®èªè¨¼ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'success');
                log('ğŸ”„ ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦å†åº¦Googleãƒ­ã‚°ã‚¤ãƒ³ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„', 'info');
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            log('ğŸš€ èªè¨¼çŠ¶æ…‹è¨ºæ–­ãƒšãƒ¼ã‚¸åˆæœŸåŒ–å®Œäº†', 'info');
            log('ã€Œå®Œå…¨è¨ºæ–­å®Ÿè¡Œã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦è¨ºæ–­ã‚’é–‹å§‹ã—ã¦ãã ã•ã„', 'info');
        });
    </script>
</body>
</html>
