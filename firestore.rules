rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // システムコレクション（管理者のみ）
    match /system/{document} {
      allow read, write: if true; // Phase2開発中は一時的に許可
    }
    
    // テスト用コレクション（開発中のみ）
    match /test/{document} {
      allow read, write: if true;
    }
    
    // マルチテナント対応：テナント別データ分離
    match /tenants/{tenantId} {
      // テナント基本情報（認証ユーザーが自分のテナントのみアクセス可能）
      allow read, write: if request.auth != null 
        && request.auth.uid == tenantId;
      
      // テナント内の顧客データ
      match /customers/{customerId} {
        allow read, write: if request.auth != null 
          && request.auth.uid == tenantId;
        allow create: if request.auth != null 
          && request.auth.uid == tenantId
          && request.resource.data.tenantId == tenantId;
      }
      
      // テナント内の設定データ
      match /settings/{settingId} {
        allow read, write: if request.auth != null 
          && request.auth.uid == tenantId;
      }
      
      // テナント内の履歴データ
      match /history/{historyId} {
        allow read, write: if request.auth != null 
          && request.auth.uid == tenantId
          && request.resource.data.tenantId == tenantId;
      }
    }
    
    // ユーザー基本情報（自分の情報のみアクセス可能）
    match /users/{userId} {
      allow read, write: if request.auth != null 
        && request.auth.uid == userId;
    }
    
    // デフォルト：すべて拒否（セキュリティ重視）
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
