<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ­ã‚°ã‚¤ãƒ³ - RentPipe</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 2rem;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .status-message {
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 6px;
            text-align: center;
        }
        .status-loading { background: #dbeafe; border: 1px solid #3b82f6; color: #1e40af; }
        .status-success { background: #d1fae5; border: 1px solid #10b981; color: #065f46; }
        .status-error { background: #fee2e2; border: 1px solid #f87171; color: #991b1b; }
        .debug-info {
            margin-top: 1rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 6px;
            font-size: 14px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="login-container">
        <div style="text-align: center; margin-bottom: 2rem;">
            <h1>ğŸ  RentPipe</h1>
            <p>ä¸å‹•ç”£ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå‘ã‘é¡§å®¢ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </p>
        </div>

        <div id="statusMessage" class="status-message" style="display: none;"></div>

        <div style="text-align: center;">
            <button id="googleLoginBtn" onclick="handleGoogleLogin()" class="btn btn-primary" style="width: 100%; padding: 15px; font-size: 16px;">
                ğŸ” Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³
            </button>
        </div>

        <div id="debugInfo" class="debug-info"></div>
        
        <div style="margin-top: 2rem; text-align: center; font-size: 14px; color: #6b7280;">
            <p>
                <a href="customer-no-auth.html">èªè¨¼ãªã—ç‰ˆã§ãƒ†ã‚¹ãƒˆ</a> |
                <a href="google-drive-integration-test.html">çµ±åˆãƒ†ã‚¹ãƒˆ</a>
            </p>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <script>
        // Firebaseè¨­å®šï¼ˆæœ€æ–°ç‰ˆï¼‰
        const firebaseConfig = {
            apiKey: "AIzaSyBvJGdan0lvVSkaAbbSXQkoh6YyPoGyTgM",
            authDomain: "rentpipe-ab04e.firebaseapp.com",
            projectId: "rentpipe-ab04e",
            storageBucket: "rentpipe-ab04e.firebasestorage.app",
            messagingSenderId: "586040985916",
            appId: "1:586040985916:web:3cdb5db072f1a6569fb639"
        };

        console.log('ğŸ”¥ Firebaseè¨­å®šç¢ºèª:', {
            projectId: firebaseConfig.projectId,
            authDomain: firebaseConfig.authDomain,
            apiKeyPrefix: firebaseConfig.apiKey.substring(0, 20) + '...'
        });

        // FirebaseåˆæœŸåŒ–
        firebase.initializeApp(firebaseConfig);

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
        function showStatus(message, type = 'loading') {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = \`status-message status-\${type}\`;
            statusDiv.style.display = 'block';
        }

        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±è¡¨ç¤º
        function showDebugInfo(info) {
            const debugDiv = document.getElementById('debugInfo');
            debugDiv.innerHTML = \`<strong>ğŸ” ãƒ‡ãƒãƒƒã‚°æƒ…å ±:</strong><br>\${info}\`;
            debugDiv.style.display = 'block';
        }

        // èªè¨¼ãƒ‡ãƒ¼ã‚¿ä¿å­˜
        function saveAuthData(userData) {
            console.log('ğŸ’¾ èªè¨¼ãƒ‡ãƒ¼ã‚¿ä¿å­˜é–‹å§‹:', userData.email);
            
            try {
                // çµ±ä¸€å½¢å¼ã§ä¿å­˜
                localStorage.setItem('rentpipe_auth_simple', 'logged_in');
                localStorage.setItem('rentpipe_user_simple', JSON.stringify(userData));
                
                // äº’æ›æ€§ã®ãŸã‚ã®è¿½åŠ ä¿å­˜
                localStorage.setItem('rentpipe_temp_auth', 'google_authenticated');
                localStorage.setItem('rentpipe_user_info', JSON.stringify(userData));
                
                console.log('âœ… èªè¨¼ãƒ‡ãƒ¼ã‚¿ä¿å­˜å®Œäº†');
                return true;
                
            } catch (error) {
                console.error('âŒ èªè¨¼ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                return false;
            }
        }

        // Googleãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
        async function handleGoogleLogin() {
            console.log('ğŸ” Googleãƒ­ã‚°ã‚¤ãƒ³é–‹å§‹');
            
            const btn = document.getElementById('googleLoginBtn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = 'ãƒ­ã‚°ã‚¤ãƒ³ä¸­...';
            
            showStatus('Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ä¸­...', 'loading');
            
            try {
                // Googleèªè¨¼ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®è¨­å®š
                const provider = new firebase.auth.GoogleAuthProvider();
                
                // æ–°ã—ã„ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDã«å¯¾å¿œã™ã‚‹ã‚¹ã‚³ãƒ¼ãƒ—è¨­å®š
                provider.addScope('https://www.googleapis.com/auth/drive.file');
                provider.addScope('email');
                provider.addScope('profile');
                
                // å¼·åˆ¶çš„ã«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆé¸æŠç”»é¢ã‚’è¡¨ç¤º
                provider.setCustomParameters({
                    prompt: 'select_account'
                });
                
                console.log('ğŸ”‘ ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—èªè¨¼ã‚’é–‹å§‹...');
                const result = await firebase.auth().signInWithPopup(provider);
                
                const user = result.user;
                const credential = firebase.auth.GoogleAuthProvider.credentialFromResult(result);
                
                console.log('âœ… Firebaseèªè¨¼æˆåŠŸ:', user.email);
                
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿æº–å‚™
                const userData = {
                    uid: user.uid,
                    email: user.email,
                    name: user.displayName,
                    picture: user.photoURL,
                    accessToken: credential ? credential.accessToken : null
                };
                
                // èªè¨¼ãƒ‡ãƒ¼ã‚¿ä¿å­˜
                const saved = saveAuthData(userData);
                
                if (saved) {
                    showStatus(\`ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ: \${user.email}\`, 'success');
                    showDebugInfo(\`
                        ãƒ¦ãƒ¼ã‚¶ãƒ¼: \${userData.email}<br>
                        èªè¨¼çŠ¶æ…‹: ä¿å­˜å®Œäº†<br>
                        ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³: \${credential ? 'å–å¾—æ¸ˆã¿' : 'æœªå–å¾—'}
                    \`);
                    
                    // 3ç§’å¾Œã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
                    setTimeout(() => {
                        window.location.href = 'customer-no-auth.html';
                    }, 3000);
                    
                } else {
                    throw new Error('èªè¨¼ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
                
            } catch (error) {
                console.error('âŒ ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼:', error);
                
                let errorMessage = 'ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ';
                
                if (error.code === 'auth/popup-blocked') {
                    errorMessage = 'ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                } else if (error.code === 'auth/cancelled-popup-request') {
                    errorMessage = 'ãƒ­ã‚°ã‚¤ãƒ³ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸã€‚';
                } else if (error.code === 'auth/popup-closed-by-user') {
                    errorMessage = 'ãƒ­ã‚°ã‚¤ãƒ³ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒé–‰ã˜ã‚‰ã‚Œã¾ã—ãŸã€‚';
                } else if (error.message.includes('invalid')) {
                    errorMessage = 'OAuthè¨­å®šã«å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚';
                }
                
                showStatus(errorMessage, 'error');
                showDebugInfo(\`
                    ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰: \${error.code || 'unknown'}<br>
                    ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: \${error.message}
                \`);
                
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†æ™‚
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ“„ ä¿®æ­£ç‰ˆãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†');
            
            // æ—¢ã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            const authStatus = localStorage.getItem('rentpipe_auth_simple');
            if (authStatus === 'logged_in') {
                showStatus('æ—¢ã«ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã§ã™', 'success');
                setTimeout(() => {
                    window.location.href = 'customer-no-auth.html';
                }, 2000);
            }
        });
    </script>
</body>
</html>
