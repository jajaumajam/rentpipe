<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ログイン - RentPipe</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 2rem;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .status-message {
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 6px;
            text-align: center;
        }
        .status-loading { background: #dbeafe; border: 1px solid #3b82f6; color: #1e40af; }
        .status-success { background: #d1fae5; border: 1px solid #10b981; color: #065f46; }
        .status-error { background: #fee2e2; border: 1px solid #f87171; color: #991b1b; }
        .debug-info {
            margin-top: 1rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 6px;
            font-size: 14px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="login-container">
        <div style="text-align: center; margin-bottom: 2rem;">
            <h1>🏠 RentPipe</h1>
            <p>不動産エージェント向け顧客管理システム</p>
        </div>

        <div id="statusMessage" class="status-message" style="display: none;"></div>

        <div style="text-align: center;">
            <button id="googleLoginBtn" onclick="handleGoogleLogin()" class="btn btn-primary" style="width: 100%; padding: 15px; font-size: 16px;">
                🔐 Googleアカウントでログイン
            </button>
        </div>

        <div id="debugInfo" class="debug-info"></div>
        
        <div style="margin-top: 2rem; text-align: center; font-size: 14px; color: #6b7280;">
            <p>
                <a href="customer-no-auth.html">認証なし版でテスト</a> |
                <a href="google-drive-integration-test.html">統合テスト</a>
            </p>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <script>
        // Firebase設定（最新版）
        const firebaseConfig = {
            apiKey: "AIzaSyBvJGdan0lvVSkaAbbSXQkoh6YyPoGyTgM",
            authDomain: "rentpipe-ab04e.firebaseapp.com",
            projectId: "rentpipe-ab04e",
            storageBucket: "rentpipe-ab04e.firebasestorage.app",
            messagingSenderId: "586040985916",
            appId: "1:586040985916:web:3cdb5db072f1a6569fb639"
        };

        console.log('🔥 Firebase設定確認:', {
            projectId: firebaseConfig.projectId,
            authDomain: firebaseConfig.authDomain,
            apiKeyPrefix: firebaseConfig.apiKey.substring(0, 20) + '...'
        });

        // Firebase初期化
        firebase.initializeApp(firebaseConfig);

        // ステータス表示
        function showStatus(message, type = 'loading') {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = \`status-message status-\${type}\`;
            statusDiv.style.display = 'block';
        }

        // デバッグ情報表示
        function showDebugInfo(info) {
            const debugDiv = document.getElementById('debugInfo');
            debugDiv.innerHTML = \`<strong>🔍 デバッグ情報:</strong><br>\${info}\`;
            debugDiv.style.display = 'block';
        }

        // 認証データ保存
        function saveAuthData(userData) {
            console.log('💾 認証データ保存開始:', userData.email);
            
            try {
                // 統一形式で保存
                localStorage.setItem('rentpipe_auth_simple', 'logged_in');
                localStorage.setItem('rentpipe_user_simple', JSON.stringify(userData));
                
                // 互換性のための追加保存
                localStorage.setItem('rentpipe_temp_auth', 'google_authenticated');
                localStorage.setItem('rentpipe_user_info', JSON.stringify(userData));
                
                console.log('✅ 認証データ保存完了');
                return true;
                
            } catch (error) {
                console.error('❌ 認証データ保存エラー:', error);
                return false;
            }
        }

        // Googleログイン処理
        async function handleGoogleLogin() {
            console.log('🔐 Googleログイン開始');
            
            const btn = document.getElementById('googleLoginBtn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = 'ログイン中...';
            
            showStatus('Googleアカウントでログイン中...', 'loading');
            
            try {
                // Google認証プロバイダーの設定
                const provider = new firebase.auth.GoogleAuthProvider();
                
                // 新しいクライアントIDに対応するスコープ設定
                provider.addScope('https://www.googleapis.com/auth/drive.file');
                provider.addScope('email');
                provider.addScope('profile');
                
                // 強制的にアカウント選択画面を表示
                provider.setCustomParameters({
                    prompt: 'select_account'
                });
                
                console.log('🔑 ポップアップ認証を開始...');
                const result = await firebase.auth().signInWithPopup(provider);
                
                const user = result.user;
                const credential = firebase.auth.GoogleAuthProvider.credentialFromResult(result);
                
                console.log('✅ Firebase認証成功:', user.email);
                
                // ユーザーデータ準備
                const userData = {
                    uid: user.uid,
                    email: user.email,
                    name: user.displayName,
                    picture: user.photoURL,
                    accessToken: credential ? credential.accessToken : null
                };
                
                // 認証データ保存
                const saved = saveAuthData(userData);
                
                if (saved) {
                    showStatus(\`ログイン成功: \${user.email}\`, 'success');
                    showDebugInfo(\`
                        ユーザー: \${userData.email}<br>
                        認証状態: 保存完了<br>
                        アクセストークン: \${credential ? '取得済み' : '未取得'}
                    \`);
                    
                    // 3秒後にリダイレクト
                    setTimeout(() => {
                        window.location.href = 'customer-no-auth.html';
                    }, 3000);
                    
                } else {
                    throw new Error('認証データの保存に失敗しました');
                }
                
            } catch (error) {
                console.error('❌ ログインエラー:', error);
                
                let errorMessage = 'ログインに失敗しました';
                
                if (error.code === 'auth/popup-blocked') {
                    errorMessage = 'ポップアップがブロックされました。ブラウザの設定を確認してください。';
                } else if (error.code === 'auth/cancelled-popup-request') {
                    errorMessage = 'ログインがキャンセルされました。';
                } else if (error.code === 'auth/popup-closed-by-user') {
                    errorMessage = 'ログインウィンドウが閉じられました。';
                } else if (error.message.includes('invalid')) {
                    errorMessage = 'OAuth設定に問題があります。管理者にお問い合わせください。';
                }
                
                showStatus(errorMessage, 'error');
                showDebugInfo(\`
                    エラーコード: \${error.code || 'unknown'}<br>
                    エラーメッセージ: \${error.message}
                \`);
                
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // ページ読み込み完了時
        document.addEventListener('DOMContentLoaded', function() {
            console.log('📄 修正版ログインページ読み込み完了');
            
            // 既にログインしているかチェック
            const authStatus = localStorage.getItem('rentpipe_auth_simple');
            if (authStatus === 'logged_in') {
                showStatus('既にログイン済みです', 'success');
                setTimeout(() => {
                    window.location.href = 'customer-no-auth.html';
                }, 2000);
            }
        });
    </script>
</body>
</html>
