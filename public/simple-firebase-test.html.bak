<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Firebase Test</title>
    <style>
        body { 
            font-family: 'Noto Sans JP', sans-serif; 
            padding: 20px; 
            max-width: 600px; 
            margin: 0 auto; 
            line-height: 1.6;
        }
        .status { 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 8px; 
            border: 1px solid #ddd;
        }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .info { background: #d1ecf1; border-color: #b8daff; }
        button {
            background: #1e3a8a; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 6px; 
            margin: 5px; 
            cursor: pointer;
        }
        pre { 
            background: #f5f5f5; 
            padding: 10px; 
            border-radius: 4px; 
            font-size: 12px; 
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>ğŸ”¥ Firebase Phase2 - ã‚·ãƒ³ãƒ—ãƒ«ãƒ†ã‚¹ãƒˆ</h1>
    
    <div id="firebase-status" class="status info">
        <strong>ğŸ”§ FirebaseåˆæœŸåŒ–ä¸­...</strong>
    </div>
    
    <div>
        <button onclick="testStep1()">Step 1: åŸºæœ¬æ¥ç¶š</button>
        <button onclick="testStep2()">Step 2: èªè¨¼</button>
        <button onclick="testStep3()">Step 3: ãƒ‡ãƒ¼ã‚¿æ“ä½œ</button>
    </div>
    
    <div id="results"></div>
    
    <pre id="logs"></pre>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <script>
        // ãƒ­ã‚°è¡¨ç¤º
        function log(message, isError = false) {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('logs');
            const logEntry = `[${timestamp}] ${isError ? 'ERROR' : 'INFO'}: ${message}\n`;
            logElement.textContent += logEntry;
            logElement.scrollTop = logElement.scrollHeight;
            
            if (isError) {
                console.error(message);
            } else {
                console.log(message);
            }
        }
        
        // çµæœè¡¨ç¤º
        function showResult(title, success, message) {
            const resultsDiv = document.getElementById('results');
            const resultClass = success ? 'success' : 'error';
            const icon = success ? 'âœ…' : 'âŒ';
            
            resultsDiv.innerHTML += `
                <div class="status ${resultClass}">
                    <strong>${icon} ${title}</strong><br>
                    ${message}
                </div>
            `;
        }
        
        // Firebaseæ‰‹å‹•åˆæœŸåŒ–ï¼ˆã‚¨ãƒ©ãƒ¼åˆ¶å¾¡ï¼‰
        let app, db, auth;
        
        function initializeFirebase() {
            try {
                log('FirebaseåˆæœŸåŒ–é–‹å§‹...');
                
                const firebaseConfig = {
                    apiKey: "AIzaSyDGlTRxHU8BLjJeOL5p-VhIeHCKPGZFQE4",
                    authDomain: "rentpipe-ab04e.firebaseapp.com",
                    projectId: "rentpipe-ab04e",
                    storageBucket: "rentpipe-ab04e.firebasestorage.app",
                    messagingSenderId: "586040985916",
                    appId: "1:586040985916:web:3cdb5db072f1a6569fb639"
                };
                
                app = firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                auth = firebase.auth();
                
                window.db = db;
                window.auth = auth;
                
                log('âœ… FirebaseåˆæœŸåŒ–æˆåŠŸ');
                document.getElementById('firebase-status').innerHTML = '<strong>âœ… Firebaseæº–å‚™å®Œäº†</strong>';
                document.getElementById('firebase-status').className = 'status success';
                
                return true;
                
            } catch (error) {
                log(`âŒ FirebaseåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`, true);
                document.getElementById('firebase-status').innerHTML = `<strong>âŒ FirebaseåˆæœŸåŒ–å¤±æ•—</strong><br>${error.message}`;
                document.getElementById('firebase-status').className = 'status error';
                return false;
            }
        }
        
        // Step 1: åŸºæœ¬æ¥ç¶šãƒ†ã‚¹ãƒˆ
        async function testStep1() {
            log('ğŸ”Œ Step 1: åŸºæœ¬æ¥ç¶šãƒ†ã‚¹ãƒˆé–‹å§‹');
            
            try {
                if (!db) {
                    throw new Error('FirestoreãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                }
                
                // ç°¡å˜ãªèª­ã¿å–ã‚Šãƒ†ã‚¹ãƒˆ
                const testDoc = await db.collection('system').doc('test').get();
                log('åŸºæœ¬æ¥ç¶šãƒ†ã‚¹ãƒˆæˆåŠŸ');
                
                showResult('Step 1: åŸºæœ¬æ¥ç¶š', true, 'Firestoreã¸ã®æ¥ç¶šãŒæ­£å¸¸ã§ã™');
                
            } catch (error) {
                log(`åŸºæœ¬æ¥ç¶šãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, true);
                showResult('Step 1: åŸºæœ¬æ¥ç¶š', false, `æ¥ç¶šã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }
        
        // Step 2: èªè¨¼ãƒ†ã‚¹ãƒˆ
        async function testStep2() {
            log('ğŸ” Step 2: èªè¨¼ãƒ†ã‚¹ãƒˆé–‹å§‹');
            
            try {
                if (!auth) {
                    throw new Error('Firebase AuthãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                }
                
                const result = await auth.signInAnonymously();
                log(`èªè¨¼æˆåŠŸ: ${result.user.uid}`);
                
                showResult('Step 2: èªè¨¼', true, `åŒ¿åèªè¨¼æˆåŠŸï¼ˆUID: ${result.user.uid}ï¼‰`);
                
            } catch (error) {
                log(`èªè¨¼ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, true);
                showResult('Step 2: èªè¨¼', false, `èªè¨¼ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }
        
        // Step 3: ãƒ‡ãƒ¼ã‚¿æ“ä½œãƒ†ã‚¹ãƒˆ
        async function testStep3() {
            log('ğŸ“Š Step 3: ãƒ‡ãƒ¼ã‚¿æ“ä½œãƒ†ã‚¹ãƒˆé–‹å§‹');
            
            try {
                const currentUser = auth.currentUser;
                if (!currentUser) {
                    throw new Error('å…ˆã«èªè¨¼ã‚’å®Œäº†ã—ã¦ãã ã•ã„');
                }
                
                const testData = {
                    message: 'Phase2ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿',
                    tenantId: currentUser.uid,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                // ãƒ‡ãƒ¼ã‚¿æ›¸ãè¾¼ã¿
                const docRef = await db.collection(`tenants/${currentUser.uid}/test`).add(testData);
                log(`ãƒ‡ãƒ¼ã‚¿æ›¸ãè¾¼ã¿æˆåŠŸ: ${docRef.id}`);
                
                // ãƒ‡ãƒ¼ã‚¿èª­ã¿å–ã‚Š
                const doc = await docRef.get();
                if (doc.exists) {
                    log('ãƒ‡ãƒ¼ã‚¿èª­ã¿å–ã‚ŠæˆåŠŸ');
                    showResult('Step 3: ãƒ‡ãƒ¼ã‚¿æ“ä½œ', true, `ãƒ‡ãƒ¼ã‚¿æ“ä½œæˆåŠŸï¼ˆDoc ID: ${docRef.id}ï¼‰`);
                } else {
                    throw new Error('æ›¸ãè¾¼ã‚“ã ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
                
            } catch (error) {
                log(`ãƒ‡ãƒ¼ã‚¿æ“ä½œãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, true);
                showResult('Step 3: ãƒ‡ãƒ¼ã‚¿æ“ä½œ', false, `ãƒ‡ãƒ¼ã‚¿æ“ä½œã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆæœŸåŒ–
        window.addEventListener('load', function() {
            log('ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†');
            initializeFirebase();
        });
        
        // ã‚¨ãƒ©ãƒ¼ã‚­ãƒ£ãƒƒãƒ
        window.addEventListener('error', function(event) {
            log(`JavaScript Error: ${event.error.message}`, true);
        });
        
    </script>
</body>
</html>
