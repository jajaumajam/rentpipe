<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Firebase Test</title>
    <style>
        body { 
            font-family: 'Noto Sans JP', sans-serif; 
            padding: 20px; 
            max-width: 600px; 
            margin: 0 auto; 
            line-height: 1.6;
        }
        .status { 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 8px; 
            border: 1px solid #ddd;
        }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .info { background: #d1ecf1; border-color: #b8daff; }
        button {
            background: #1e3a8a; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 6px; 
            margin: 5px; 
            cursor: pointer;
        }
        pre { 
            background: #f5f5f5; 
            padding: 10px; 
            border-radius: 4px; 
            font-size: 12px; 
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>🔥 Firebase Phase2 - シンプルテスト</h1>
    
    <div id="firebase-status" class="status info">
        <strong>🔧 Firebase初期化中...</strong>
    </div>
    
    <div>
        <button onclick="testStep1()">Step 1: 基本接続</button>
        <button onclick="testStep2()">Step 2: 認証</button>
        <button onclick="testStep3()">Step 3: データ操作</button>
    </div>
    
    <div id="results"></div>
    
    <pre id="logs"></pre>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <script>
        // ログ表示
        function log(message, isError = false) {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('logs');
            const logEntry = `[${timestamp}] ${isError ? 'ERROR' : 'INFO'}: ${message}\n`;
            logElement.textContent += logEntry;
            logElement.scrollTop = logElement.scrollHeight;
            
            if (isError) {
                console.error(message);
            } else {
                console.log(message);
            }
        }
        
        // 結果表示
        function showResult(title, success, message) {
            const resultsDiv = document.getElementById('results');
            const resultClass = success ? 'success' : 'error';
            const icon = success ? '✅' : '❌';
            
            resultsDiv.innerHTML += `
                <div class="status ${resultClass}">
                    <strong>${icon} ${title}</strong><br>
                    ${message}
                </div>
            `;
        }
        
        // Firebase手動初期化（エラー制御）
        let app, db, auth;
        
        function initializeFirebase() {
            try {
                log('Firebase初期化開始...');
                
                const firebaseConfig = {
                    apiKey: "AIzaSyDGlTRxHU8BLjJeOL5p-VhIeHCKPGZFQE4",
                    authDomain: "rentpipe-ab04e.firebaseapp.com",
                    projectId: "rentpipe-ab04e",
                    storageBucket: "rentpipe-ab04e.firebasestorage.app",
                    messagingSenderId: "586040985916",
                    appId: "1:586040985916:web:3cdb5db072f1a6569fb639"
                };
                
                app = firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                auth = firebase.auth();
                
                window.db = db;
                window.auth = auth;
                
                log('✅ Firebase初期化成功');
                document.getElementById('firebase-status').innerHTML = '<strong>✅ Firebase準備完了</strong>';
                document.getElementById('firebase-status').className = 'status success';
                
                return true;
                
            } catch (error) {
                log(`❌ Firebase初期化エラー: ${error.message}`, true);
                document.getElementById('firebase-status').innerHTML = `<strong>❌ Firebase初期化失敗</strong><br>${error.message}`;
                document.getElementById('firebase-status').className = 'status error';
                return false;
            }
        }
        
        // Step 1: 基本接続テスト
        async function testStep1() {
            log('🔌 Step 1: 基本接続テスト開始');
            
            try {
                if (!db) {
                    throw new Error('Firestoreが初期化されていません');
                }
                
                // 簡単な読み取りテスト
                const testDoc = await db.collection('system').doc('test').get();
                log('基本接続テスト成功');
                
                showResult('Step 1: 基本接続', true, 'Firestoreへの接続が正常です');
                
            } catch (error) {
                log(`基本接続テストエラー: ${error.message}`, true);
                showResult('Step 1: 基本接続', false, `接続エラー: ${error.message}`);
            }
        }
        
        // Step 2: 認証テスト
        async function testStep2() {
            log('🔐 Step 2: 認証テスト開始');
            
            try {
                if (!auth) {
                    throw new Error('Firebase Authが初期化されていません');
                }
                
                const result = await auth.signInAnonymously();
                log(`認証成功: ${result.user.uid}`);
                
                showResult('Step 2: 認証', true, `匿名認証成功（UID: ${result.user.uid}）`);
                
            } catch (error) {
                log(`認証テストエラー: ${error.message}`, true);
                showResult('Step 2: 認証', false, `認証エラー: ${error.message}`);
            }
        }
        
        // Step 3: データ操作テスト
        async function testStep3() {
            log('📊 Step 3: データ操作テスト開始');
            
            try {
                const currentUser = auth.currentUser;
                if (!currentUser) {
                    throw new Error('先に認証を完了してください');
                }
                
                const testData = {
                    message: 'Phase2テストデータ',
                    tenantId: currentUser.uid,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                // データ書き込み
                const docRef = await db.collection(`tenants/${currentUser.uid}/test`).add(testData);
                log(`データ書き込み成功: ${docRef.id}`);
                
                // データ読み取り
                const doc = await docRef.get();
                if (doc.exists) {
                    log('データ読み取り成功');
                    showResult('Step 3: データ操作', true, `データ操作成功（Doc ID: ${docRef.id}）`);
                } else {
                    throw new Error('書き込んだデータが見つかりません');
                }
                
            } catch (error) {
                log(`データ操作テストエラー: ${error.message}`, true);
                showResult('Step 3: データ操作', false, `データ操作エラー: ${error.message}`);
            }
        }
        
        // ページ読み込み時に初期化
        window.addEventListener('load', function() {
            log('ページ読み込み完了');
            initializeFirebase();
        });
        
        // エラーキャッチ
        window.addEventListener('error', function(event) {
            log(`JavaScript Error: ${event.error.message}`, true);
        });
        
    </script>
</body>
</html>
