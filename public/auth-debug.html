<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èªè¨¼ãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ« - RentPipe</title>
    <link href="css/main.css" rel="stylesheet">
</head>

<body>
    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="nav-brand">ğŸ  RentPipe</a>
        </div>
    </nav>

    <main class="container">
        <div style="max-width: 800px; margin: 20px auto;">
            <h1>ğŸ”§ èªè¨¼ãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ«</h1>
            
            <!-- ç¾åœ¨ã®èªè¨¼çŠ¶æ…‹ -->
            <div style="background: white; padding: 20px; margin: 20px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                <h2>ğŸ” ç¾åœ¨ã®èªè¨¼çŠ¶æ…‹</h2>
                <div id="current-auth-status">èª­ã¿è¾¼ã¿ä¸­...</div>
                <button onclick="refreshAuthStatus()" style="margin-top: 10px; padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    ğŸ”„ èªè¨¼çŠ¶æ…‹ã‚’æ›´æ–°
                </button>
            </div>
            
            <!-- Googleèªè¨¼ãƒ‡ãƒ¼ã‚¿ã®æ‰‹å‹•ä¿å­˜ -->
            <div style="background: white; padding: 20px; margin: 20px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                <h2>ğŸ’¾ Googleèªè¨¼ãƒ‡ãƒ¼ã‚¿ã®æ‰‹å‹•å¤‰æ›</h2>
                <p>Googleèªè¨¼ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã™ã‚‹å ´åˆã€ä»–ã®å½¢å¼ã«æ‰‹å‹•ã§å¤‰æ›ã—ã¾ã™ã€‚</p>
                <button onclick="convertGoogleAuthData()" style="padding: 10px 20px; background: #16a34a; color: white; border: none; border-radius: 6px; cursor: pointer; margin-right: 10px;">
                    ğŸ”„ Googleèªè¨¼ãƒ‡ãƒ¼ã‚¿ã‚’å¤‰æ›
                </button>
                <button onclick="createDemoData()" style="padding: 10px 20px; background: #f59e0b; color: white; border: none; border-radius: 6px; cursor: pointer;">
                    ğŸ“Š ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
                </button>
                <div id="conversion-status" style="margin-top: 15px;"></div>
            </div>
            
            <!-- èªè¨¼ãƒ‡ãƒ¼ã‚¿è©³ç´°è¡¨ç¤º -->
            <div style="background: white; padding: 20px; margin: 20px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                <h2>ğŸ“‹ èªè¨¼ãƒ‡ãƒ¼ã‚¿è©³ç´°</h2>
                <button onclick="showDetailedAuthData()" style="padding: 8px 16px; background: #6366f1; color: white; border: none; border-radius: 4px; cursor: pointer; margin-bottom: 15px;">
                    ğŸ“Š è©³ç´°ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º
                </button>
                <div id="detailed-auth-data" style="font-family: monospace; font-size: 12px; white-space: pre-wrap; background: #f8f9fa; padding: 15px; border-radius: 6px; max-height: 400px; overflow-y: auto;"></div>
            </div>
            
            <!-- ãƒ†ã‚¹ãƒˆæ©Ÿèƒ½ -->
            <div style="background: white; padding: 20px; margin: 20px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                <h2>ğŸ§ª ãƒ†ã‚¹ãƒˆæ©Ÿèƒ½</h2>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button onclick="testCustomerPageAccess()" style="padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        ğŸ“„ customer.html ã‚¢ã‚¯ã‚»ã‚¹ãƒ†ã‚¹ãƒˆ
                    </button>
                    <button onclick="clearAllAuthData()" style="padding: 8px 16px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        ğŸ—‘ï¸ å…¨èªè¨¼ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢
                    </button>
                    <button onclick="exportAuthData()" style="padding: 8px 16px; background: #8b5cf6; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        ğŸ“¤ èªè¨¼ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                    </button>
                </div>
                <div id="test-results" style="margin-top: 15px;"></div>
            </div>
        </div>
    </main>

    <script>
        // èªè¨¼çŠ¶æ…‹ã‚’ç¢ºèª
        function refreshAuthStatus() {
            const statusDiv = document.getElementById('current-auth-status');
            const authKeys = [
                'google_auth_simple',
                'rentpipe_authenticated',
                'rentpipe_user',
                'rentpipe_auth_simple',
                'rentpipe_user_simple',
                'rentpipe_unified_auth',
                'rentpipe_demo_customers'
            ];
            
            let html = '<div style="font-family: monospace; line-height: 1.6;">';
            let hasValidAuth = false;
            let googleAuthData = null;
            
            authKeys.forEach(key => {
                const data = localStorage.getItem(key);
                if (data) {
                    html += `<div style="color: #059669;">âœ… ${key}: å­˜åœ¨</div>`;
                    
                    if (key === 'google_auth_simple') {
                        try {
                            googleAuthData = JSON.parse(data);
                            html += `<div style="margin-left: 20px; color: #6b7280;">ãƒ¦ãƒ¼ã‚¶ãƒ¼: ${googleAuthData.email}</div>`;
                            html += `<div style="margin-left: 20px; color: #6b7280;">æœ‰åŠ¹æœŸé™: ${new Date(googleAuthData.expires).toLocaleString()}</div>`;
                            hasValidAuth = true;
                        } catch (e) {
                            html += `<div style="margin-left: 20px; color: #ef4444;">è§£æã‚¨ãƒ©ãƒ¼</div>`;
                        }
                    } else if (key === 'rentpipe_demo_customers') {
                        try {
                            const customers = JSON.parse(data);
                            html += `<div style="margin-left: 20px; color: #6b7280;">é¡§å®¢æ•°: ${customers.length}ä»¶</div>`;
                        } catch (e) {
                            html += `<div style="margin-left: 20px; color: #ef4444;">è§£æã‚¨ãƒ©ãƒ¼</div>`;
                        }
                    } else {
                        try {
                            const parsed = JSON.parse(data);
                            if (parsed.email || parsed.displayName || parsed.name) {
                                html += `<div style="margin-left: 20px; color: #6b7280;">ãƒ¦ãƒ¼ã‚¶ãƒ¼: ${parsed.email || parsed.displayName || parsed.name}</div>`;
                            }
                        } catch (e) {
                            if (key === 'rentpipe_authenticated' && data === 'true') {
                                hasValidAuth = true;
                                html += `<div style="margin-left: 20px; color: #6b7280;">å€¤: ${data}</div>`;
                            } else if (key === 'rentpipe_auth_simple' && data === 'logged_in') {
                                hasValidAuth = true;
                                html += `<div style="margin-left: 20px; color: #6b7280;">å€¤: ${data}</div>`;
                            }
                        }
                    }
                } else {
                    html += `<div style="color: #ef4444;">âŒ ${key}: æœªè¨­å®š</div>`;
                }
            });
            
            html += '</div>';
            html += `<div style="margin-top: 15px; padding: 10px; border-radius: 6px; font-weight: bold; ${hasValidAuth ? 'background: #dcfce7; color: #166534;' : 'background: #fee2e2; color: #991b1b;'}">`;
            html += hasValidAuth ? 'âœ… æœ‰åŠ¹ãªèªè¨¼ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ' : 'âŒ æœ‰åŠ¹ãªèªè¨¼ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“';
            html += '</div>';
            
            statusDiv.innerHTML = html;
            
            return { hasValidAuth, googleAuthData };
        }

        // Googleèªè¨¼ãƒ‡ãƒ¼ã‚¿ã‚’ä»–ã®å½¢å¼ã«å¤‰æ›
        function convertGoogleAuthData() {
            const statusDiv = document.getElementById('conversion-status');
            statusDiv.innerHTML = '<div style="color: #3b82f6;">ğŸ”„ å¤‰æ›å‡¦ç†ä¸­...</div>';
            
            try {
                const googleAuthRaw = localStorage.getItem('google_auth_simple');
                if (!googleAuthRaw) {
                    statusDiv.innerHTML = '<div style="color: #ef4444;">âŒ Googleèªè¨¼ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>';
                    return;
                }
                
                const googleAuth = JSON.parse(googleAuthRaw);
                const now = Date.now();
                
                if (googleAuth.expires && now > googleAuth.expires) {
                    statusDiv.innerHTML = '<div style="color: #f59e0b;">âš ï¸ Googleèªè¨¼ãƒ‡ãƒ¼ã‚¿ãŒæœŸé™åˆ‡ã‚Œã§ã™</div>';
                    return;
                }
                
                const userData = {
                    id: googleAuth.id,
                    email: googleAuth.email,
                    name: googleAuth.name,
                    picture: googleAuth.picture
                };
                
                const sessionId = 'session-' + now + '-' + Math.random().toString(36).substr(2, 9);
                
                // 1. rentpipe_authenticated + rentpipe_user
                localStorage.setItem('rentpipe_authenticated', 'true');
                localStorage.setItem('rentpipe_user', JSON.stringify({
                    uid: userData.id,
                    email: userData.email,
                    displayName: userData.name,
                    photoURL: userData.picture
                }));
                
                // 2. rentpipe_auth_simple + rentpipe_user_simple  
                localStorage.setItem('rentpipe_auth_simple', 'logged_in');
                localStorage.setItem('rentpipe_user_simple', JSON.stringify({
                    id: userData.id,
                    email: userData.email,
                    name: userData.name,
                    picture: userData.picture
                }));
                
                // 3. rentpipe_unified_auth
                localStorage.setItem('rentpipe_unified_auth', JSON.stringify({
                    isAuthenticated: true,
                    user: {
                        id: userData.id,
                        email: userData.email,
                        displayName: userData.name,
                        photoURL: userData.picture
                    },
                    sessionId: sessionId,
                    loginTime: now,
                    authMethod: 'google'
                }));
                localStorage.setItem('rentpipe_session', sessionId);
                
                // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ã‚‚ä¿å­˜
                sessionStorage.setItem('rentpipe_authenticated', 'true');
                sessionStorage.setItem('rentpipe_user', JSON.stringify({
                    uid: userData.id,
                    email: userData.email,
                    displayName: userData.name,
                    photoURL: userData.picture
                }));
                
                statusDiv.innerHTML = '<div style="color: #059669;">âœ… èªè¨¼ãƒ‡ãƒ¼ã‚¿å¤‰æ›å®Œäº†ï¼</div>';
                
                // èªè¨¼çŠ¶æ…‹ã‚’æ›´æ–°
                setTimeout(refreshAuthStatus, 500);
                
            } catch (error) {
                statusDiv.innerHTML = `<div style="color: #ef4444;">âŒ å¤‰æ›ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
            }
        }

        // ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ä½œæˆ
        function createDemoData() {
            const demoCustomers = [
                {
                    id: 'cust_demo_1_' + Date.now(),
                    name: 'ç”°ä¸­å¤ªéƒ',
                    email: 'tanaka@example.com',
                    phone: '090-1234-5678',
                    age: 28,
                    occupation: 'ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢',
                    annualIncome: 5000000,
                    pipelineStatus: 'åˆå›ç›¸è«‡',
                    preferences: {
                        budgetMin: 8,
                        budgetMax: 12,
                        areas: ['æ¸‹è°·åŒº', 'æ–°å®¿åŒº'],
                        roomType: '1K',
                        requirements: ['é§…å¾’æ­©10åˆ†ä»¥å†…', 'ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆå®Œå‚™']
                    },
                    notes: 'å¹³æ—¥å¤œã®é€£çµ¡å¸Œæœ›',
                    urgency: 'æ™®é€š',
                    contactTime: 'å¹³æ—¥19:00-21:00',
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    source: 'ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆ'
                },
                {
                    id: 'cust_demo_2_' + Date.now(),
                    name: 'ä½è—¤èŠ±å­',
                    email: 'sato@example.com',
                    phone: '090-8765-4321',
                    age: 25,
                    occupation: 'ä¼šç¤¾å“¡',
                    annualIncome: 4000000,
                    pipelineStatus: 'ç‰©ä»¶ç´¹ä»‹',
                    preferences: {
                        budgetMin: 6,
                        budgetMax: 9,
                        areas: ['ä¸–ç”°è°·åŒº'],
                        roomType: '1DK',
                        requirements: ['ãƒšãƒƒãƒˆå¯', 'å—å‘ã']
                    },
                    notes: 'çŒ«ã‚’é£¼ã£ã¦ã„ã¾ã™',
                    urgency: 'æ€¥ã',
                    contactTime: 'å¹³æ—¥12:00-13:00',
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    source: 'ç´¹ä»‹'
                },
                {
                    id: 'cust_demo_3_' + Date.now(),
                    name: 'é«˜æ©‹ä¸€éƒ',
                    email: 'takahashi@example.com',
                    phone: '090-1111-2222',
                    age: 32,
                    occupation: 'ãƒ‡ã‚¶ã‚¤ãƒŠãƒ¼',
                    annualIncome: 4500000,
                    pipelineStatus: 'å†…è¦‹',
                    preferences: {
                        budgetMin: 10,
                        budgetMax: 15,
                        areas: ['æ¸¯åŒº', 'å“å·åŒº'],
                        roomType: '1LDK',
                        requirements: ['ãƒ‡ã‚¶ã‚¤ãƒŠãƒ¼ã‚º', 'ç¯‰æµ…']
                    },
                    notes: 'ã‚¯ãƒªã‚¨ã‚¤ãƒ†ã‚£ãƒ–ãªç©ºé–“å¸Œæœ›',
                    urgency: 'æ™®é€š',
                    contactTime: 'ã„ã¤ã§ã‚‚',
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    source: 'Instagram'
                }
            ];
            
            localStorage.setItem('rentpipe_demo_customers', JSON.stringify(demoCustomers));
            
            const statusDiv = document.getElementById('conversion-status');
            statusDiv.innerHTML = '<div style="color: #059669;">âœ… ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ä½œæˆå®Œäº†ï¼ï¼ˆ3ä»¶ï¼‰</div>';
            
            setTimeout(refreshAuthStatus, 500);
        }

        // è©³ç´°ãªèªè¨¼ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º
        function showDetailedAuthData() {
            const detailDiv = document.getElementById('detailed-auth-data');
            const authKeys = ['google_auth_simple', 'rentpipe_authenticated', 'rentpipe_user', 'rentpipe_auth_simple', 'rentpipe_user_simple', 'rentpipe_unified_auth', 'rentpipe_session', 'rentpipe_demo_customers'];
            
            let output = '=== èªè¨¼ãƒ‡ãƒ¼ã‚¿è©³ç´° ===\n\n';
            
            authKeys.forEach(key => {
                const data = localStorage.getItem(key);
                const sessionData = sessionStorage.getItem(key);
                
                output += `â—† ${key}\n`;
                output += `  LocalStorage: ${data ? (data.length > 100 ? data.substring(0, 100) + '...' : data) : 'æœªè¨­å®š'}\n`;
                output += `  SessionStorage: ${sessionData ? (sessionData.length > 100 ? sessionData.substring(0, 100) + '...' : sessionData) : 'æœªè¨­å®š'}\n`;
                
                if (data && key !== 'rentpipe_authenticated' && key !== 'rentpipe_auth_simple') {
                    try {
                        const parsed = JSON.parse(data);
                        output += `  è§£æçµæœ: ${JSON.stringify(parsed, null, 2)}\n`;
                    } catch (e) {
                        output += `  è§£æã‚¨ãƒ©ãƒ¼: ${e.message}\n`;
                    }
                }
                output += '\n';
            });
            
            detailDiv.textContent = output;
        }

        // customer.htmlã‚¢ã‚¯ã‚»ã‚¹ãƒ†ã‚¹ãƒˆ
        function testCustomerPageAccess() {
            const testDiv = document.getElementById('test-results');
            testDiv.innerHTML = '<div style="color: #3b82f6;">ğŸ”„ customer.htmlã‚¢ã‚¯ã‚»ã‚¹ãƒ†ã‚¹ãƒˆä¸­...</div>';
            
            setTimeout(() => {
                window.open('customer.html', '_blank');
                testDiv.innerHTML = '<div style="color: #059669;">âœ… customer.htmlã‚’æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ãã¾ã—ãŸã€‚æ­£å¸¸ã«è¡¨ç¤ºã•ã‚Œã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚</div>';
            }, 500);
        }

        // å…¨èªè¨¼ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢
        function clearAllAuthData() {
            if (confirm('å…¨ã¦ã®èªè¨¼ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) {
                const keys = ['google_auth_simple', 'rentpipe_authenticated', 'rentpipe_user', 'rentpipe_auth_simple', 'rentpipe_user_simple', 'rentpipe_unified_auth', 'rentpipe_session', 'rentpipe_demo_customers'];
                
                keys.forEach(key => {
                    localStorage.removeItem(key);
                    sessionStorage.removeItem(key);
                });
                
                const testDiv = document.getElementById('test-results');
                testDiv.innerHTML = '<div style="color: #059669;">âœ… å…¨èªè¨¼ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚</div>';
                
                setTimeout(() => {
                    refreshAuthStatus();
                    location.reload();
                }, 1000);
            }
        }

        // èªè¨¼ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        function exportAuthData() {
            const authKeys = ['google_auth_simple', 'rentpipe_authenticated', 'rentpipe_user', 'rentpipe_auth_simple', 'rentpipe_user_simple', 'rentpipe_unified_auth', 'rentpipe_session', 'rentpipe_demo_customers'];
            const authData = {};
            
            authKeys.forEach(key => {
                const localStorage_data = localStorage.getItem(key);
                const sessionStorage_data = sessionStorage.getItem(key);
                authData[key] = {
                    localStorage: localStorage_data,
                    sessionStorage: sessionStorage_data
                };
            });
            
            const dataStr = JSON.stringify(authData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = 'auth-data-export.json';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            const testDiv = document.getElementById('test-results');
            testDiv.innerHTML = '<div style="color: #059669;">âœ… èªè¨¼ãƒ‡ãƒ¼ã‚¿ã‚’exportã—ã¾ã—ãŸã€‚</div>';
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«èªè¨¼çŠ¶æ…‹ã‚’è¡¨ç¤º
        document.addEventListener('DOMContentLoaded', function() {
            refreshAuthStatus();
        });
    </script>
</body>
</html>
