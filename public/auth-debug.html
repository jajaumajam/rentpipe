<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>認証状態診断 - RentPipe</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 2rem; line-height: 1.6; }
        .section { margin: 1rem 0; padding: 1rem; border: 1px solid #ddd; border-radius: 8px; }
        .success { background: #d1fae5; border-color: #059669; }
        .error { background: #fee2e2; border-color: #dc2626; }
        .warning { background: #fef3c7; border-color: #f59e0b; }
        .info { background: #dbeafe; border-color: #3b82f6; }
        pre { background: #f3f4f6; padding: 1rem; overflow-x: auto; font-size: 12px; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; border: none; border-radius: 4px; }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-success { background: #059669; color: white; }
        .btn-danger { background: #dc2626; color: white; }
    </style>
</head>
<body>
    <h1>🔍 認証状態診断</h1>
    
    <div class="section info">
        <h3>📋 診断目的</h3>
        <p>Google認証は成功するが、customer-minimal.htmlで「未ログイン」と表示される問題を診断します。</p>
    </div>
    
    <div class="section">
        <h3>🔧 診断実行</h3>
        <button onclick="runFullDiagnosis()" class="btn-primary">完全診断実行</button>
        <button onclick="fixAuthIssues()" class="btn-success">認証問題を自動修正</button>
        <button onclick="clearAllAuth()" class="btn-danger">全認証データクリア</button>
    </div>
    
    <div class="section">
        <h3>📊 診断結果</h3>
        <div id="diagnosticResults">診断を実行してください</div>
    </div>
    
    <div class="section">
        <h3>🔗 テストページ</h3>
        <p>
            <a href="login-google-simple.html" target="_blank">Googleログイン</a> |
            <a href="customer-minimal.html" target="_blank">顧客管理（簡易版）</a> |
            <a href="customer.html" target="_blank">顧客管理</a> |
            <a href="index.html" target="_blank">ダッシュボード</a>
        </p>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="js/simple-reliable-auth.js"></script>
    
    <script>
        // Firebase設定
        const firebaseConfig = {
            apiKey: "AIzaSyBvJGdan0lvVSkaAbbSXQkoh6YyPoGyTgM",
            authDomain: "rentpipe-ab04e.firebaseapp.com",
            projectId: "rentpipe-ab04e",
            storageBucket: "rentpipe-ab04e.firebasestorage.app",
            messagingSenderId: "586040985916",
            appId: "1:586040985916:web:3cdb5db072f1a6569fb639"
        };
        firebase.initializeApp(firebaseConfig);
        
        function log(message, type = 'info') {
            const resultDiv = document.getElementById('diagnosticResults');
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info';
            const icon = type === 'error' ? '❌' : type === 'success' ? '✅' : type === 'warning' ? '⚠️' : 'ℹ️';
            
            resultDiv.innerHTML += `<div class="section ${className}">${icon} ${message}</div>`;
            console.log(message);
        }
        
        function runFullDiagnosis() {
            document.getElementById('diagnosticResults').innerHTML = '';
            log('🔍 認証状態の完全診断を開始します...', 'info');
            
            // 1. ローカルストレージの認証データ確認
            const authKeys = [
                'rentpipe_auth_simple',
                'rentpipe_user_simple', 
                'rentpipe_temp_auth',
                'rentpipe_user_info',
                'rentpipe_auth',
                'rentpipe_demo_auth'
            ];
            
            log('📊 ローカルストレージの認証データ:', 'info');
            authKeys.forEach(key => {
                const data = localStorage.getItem(key);
                if (data) {
                    try {
                        const parsed = JSON.parse(data);
                        log(`✅ ${key}: ${JSON.stringify(parsed, null, 2)}`, 'success');
                    } catch (e) {
                        log(`✅ ${key}: ${data}`, 'success');
                    }
                } else {
                    log(`❌ ${key}: データなし`, 'error');
                }
            });
            
            // 2. simple-reliable-auth.js の関数テスト
            log('🔧 simple-reliable-auth.js 関数テスト:', 'info');
            
            if (typeof isLoggedIn === 'function') {
                const loginStatus = isLoggedIn();
                log(`isLoggedIn(): ${loginStatus}`, loginStatus ? 'success' : 'error');
            } else {
                log('isLoggedIn() 関数が見つかりません', 'error');
            }
            
            if (typeof getUser === 'function') {
                const user = getUser();
                if (user) {
                    log(`getUser(): ${JSON.stringify(user, null, 2)}`, 'success');
                } else {
                    log('getUser(): null', 'error');
                }
            } else {
                log('getUser() 関数が見つかりません', 'error');
            }
            
            // 3. Firebase認証状態確認
            log('🔥 Firebase認証状態確認:', 'info');
            firebase.auth().onAuthStateChanged((user) => {
                if (user) {
                    log(`Firebase認証済み: ${user.email}`, 'success');
                    log(`Firebase UID: ${user.uid}`, 'success');
                } else {
                    log('Firebase未認証', 'error');
                }
            });
            
            // 4. customer-minimal.html の認証チェック方式を診断
            log('📱 customer-minimal.html 認証チェック診断:', 'info');
            
            // customer-minimal.htmlと同じロジックをテスト
            const possibleAuthMethods = [
                {
                    name: 'simple-reliable-auth方式',
                    check: () => localStorage.getItem('rentpipe_auth_simple') === 'logged_in'
                },
                {
                    name: 'Google認証フラグ方式',
                    check: () => localStorage.getItem('rentpipe_temp_auth') === 'google_authenticated'
                },
                {
                    name: '統合認証方式',
                    check: () => {
                        const authSimple = localStorage.getItem('rentpipe_auth_simple') === 'logged_in';
                        const googleAuth = localStorage.getItem('rentpipe_temp_auth') === 'google_authenticated';
                        return authSimple || googleAuth;
                    }
                }
            ];
            
            possibleAuthMethods.forEach(method => {
                const result = method.check();
                log(`${method.name}: ${result}`, result ? 'success' : 'error');
            });
            
            // 5. 推奨解決策
            setTimeout(() => {
                log('💡 診断結果に基づく推奨解決策:', 'warning');
                
                const hasSimpleAuth = localStorage.getItem('rentpipe_auth_simple') === 'logged_in';
                const hasGoogleAuth = localStorage.getItem('rentpipe_temp_auth') === 'google_authenticated';
                const hasUserData = localStorage.getItem('rentpipe_user_simple') || localStorage.getItem('rentpipe_user_info');
                
                if (!hasSimpleAuth && hasGoogleAuth && hasUserData) {
                    log('🔧 「認証問題を自動修正」ボタンをクリックして認証データを統一してください', 'warning');
                } else if (!hasUserData) {
                    log('🔧 ユーザーデータが不足しています。再度Googleログインを実行してください', 'warning');
                } else if (hasSimpleAuth) {
                    log('✅ 認証データは正常です。customer-minimal.htmlの問題の可能性があります', 'success');
                }
            }, 1000);
        }
        
        function fixAuthIssues() {
            log('🔧 認証問題の自動修正を開始...', 'info');
            
            // Google認証データから simple-reliable-auth データを生成
            const tempAuth = localStorage.getItem('rentpipe_temp_auth');
            const userInfo = localStorage.getItem('rentpipe_user_info');
            
            if (tempAuth === 'google_authenticated' && userInfo) {
                try {
                    const user = JSON.parse(userInfo);
                    
                    // simple-reliable-auth 形式で保存
                    localStorage.setItem('rentpipe_auth_simple', 'logged_in');
                    localStorage.setItem('rentpipe_user_simple', JSON.stringify(user));
                    
                    log('✅ Google認証データを simple-reliable-auth 形式に統一しました', 'success');
                    log(`統一されたユーザー: ${user.email}`, 'success');
                    
                    // 修正後の確認
                    setTimeout(() => {
                        log('🔍 修正後の確認:', 'info');
                        runFullDiagnosis();
                    }, 500);
                    
                } catch (error) {
                    log(`❌ 認証データの修正に失敗: ${error.message}`, 'error');
                }
            } else {
                log('❌ Google認証データが見つかりません。先にGoogleログインを実行してください', 'error');
            }
        }
        
        function clearAllAuth() {
            if (confirm('全ての認証データをクリアしますか？\n\n再度ログインが必要になります。')) {
                const authKeys = [
                    'rentpipe_auth_simple',
                    'rentpipe_user_simple', 
                    'rentpipe_temp_auth',
                    'rentpipe_user_info',
                    'rentpipe_auth',
                    'rentpipe_demo_auth'
                ];
                
                authKeys.forEach(key => {
                    localStorage.removeItem(key);
                });
                
                // Firebase認証もサインアウト
                firebase.auth().signOut();
                
                log('✅ 全ての認証データをクリアしました', 'success');
                log('🔄 ページを再読み込みして再度Googleログインを実行してください', 'info');
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            log('🚀 認証状態診断ページ初期化完了', 'info');
            log('「完全診断実行」ボタンをクリックして診断を開始してください', 'info');
        });
    </script>
</body>
</html>
