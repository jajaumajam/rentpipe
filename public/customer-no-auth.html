<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¡§å®¢ç®¡ç†ï¼ˆèªè¨¼ãªã—ï¼‰ - RentPipe</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <header>
        <div class="header-content">
            <h1>ğŸ  RentPipe</h1>
            <nav class="nav-container">
                <a href="index.html">ãƒ›ãƒ¼ãƒ </a>
                <a href="customer-no-auth.html" class="active">é¡§å®¢ç®¡ç†ï¼ˆãƒ†ã‚¹ãƒˆç‰ˆï¼‰</a>
                <a href="customer.html">é€šå¸¸ç‰ˆ</a>
                <a href="pipeline.html">ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³</a>
            </nav>
        </div>
    </header>

    <main class="main-content">
        <div class="page-header">
            <h2>ğŸ‘¥ é¡§å®¢ç®¡ç†ï¼ˆèªè¨¼ãƒã‚¤ãƒ‘ã‚¹ç‰ˆï¼‰</h2>
            <p>Google Driveçµ±åˆã®ãƒ†ã‚¹ãƒˆç‰ˆ - èªè¨¼å•é¡Œã®å›é¿</p>
        </div>

        <!-- Google DriveåŒæœŸçŠ¶æ³è¡¨ç¤º -->
        <div id="google-drive-sync-panel" style="margin: 1rem 0; padding: 1rem; border-radius: 8px; background: #f3f4f6;">
            <h3>â˜ï¸ Google Drive åŒæœŸãƒ†ã‚¹ãƒˆ</h3>
            <div id="sync-status" class="sync-status-disconnected">
                <span id="sync-status-text">æœªæ¥ç¶š - ãƒ†ã‚¹ãƒˆæº–å‚™ä¸­...</span>
                <div id="sync-controls" style="margin-top: 10px;">
                    <button id="btn-connect-drive" onclick="connectToDrive()" class="btn btn-primary">
                        ğŸ”— Google Driveæ¥ç¶šãƒ†ã‚¹ãƒˆ
                    </button>
                    <button id="btn-sync-now" onclick="syncNow()" disabled class="btn btn-success">
                        ğŸ”„ ä»Šã™ãåŒæœŸ
                    </button>
                    <button id="btn-load-local" onclick="loadLocalData()" class="btn btn-outline">
                        ğŸ“± ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º
                    </button>
                </div>
                <div id="sync-info" style="margin-top: 10px; font-size: 14px; color: #666;">
                    <span id="last-sync-time">æœªåŒæœŸ</span> â€¢ 
                    <span id="sync-mode">ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰</span>
                </div>
            </div>
        </div>

        <!-- é¡§å®¢æ“ä½œãƒœã‚¿ãƒ³ -->
        <div class="page-actions" style="margin: 1rem 0;">
            <button onclick="addTestCustomer()" class="btn btn-primary">
                â• ãƒ†ã‚¹ãƒˆé¡§å®¢è¿½åŠ 
            </button>
            <button onclick="loadLocalData()" class="btn btn-outline">
                ğŸ”„ ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿å†èª­è¾¼
            </button>
            <button onclick="clearAllData()" class="btn btn-danger">
                ğŸ—‘ï¸ ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢
            </button>
        </div>

        <!-- é¡§å®¢ãƒªã‚¹ãƒˆ -->
        <div id="customer-list" class="customer-grid">
            <div style="text-align: center; padding: 40px; color: #6b7280;">
                <div style="font-size: 24px;">ğŸ“‹</div>
                <p>ãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™ä¸­...</p>
            </div>
        </div>
        
        <!-- ãƒ­ã‚°è¡¨ç¤º -->
        <div style="margin: 2rem 0; padding: 1rem; border-radius: 8px; background: #f8f9fa;">
            <h3>ğŸ“ å®Ÿè¡Œãƒ­ã‚°</h3>
            <pre id="log-output" style="max-height: 200px; overflow-y: auto;">ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†...</pre>
        </div>
    </main>

    <!-- Google Driveçµ±åˆã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆèªè¨¼ãªã—ç‰ˆï¼‰ -->
    <script src="js/google-drive-api-v2.js"></script>
    <script src="js/google-drive-data-manager.js"></script>
    
    <script>
        // ğŸš€ èªè¨¼ãƒã‚¤ãƒ‘ã‚¹ç‰ˆã®é¡§å®¢ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 
        console.log('ğŸš€ èªè¨¼ãƒã‚¤ãƒ‘ã‚¹ç‰ˆ é¡§å®¢ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–');
        
        let logs = [];
        
        // ãƒ­ã‚°è¿½åŠ 
        function addLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            logs.push(logMessage);
            
            const logElement = document.getElementById('log-output');
            if (logElement) {
                logElement.textContent = logs.join('\n');
                logElement.scrollTop = logElement.scrollHeight;
            }
            
            console.log(logMessage);
        }
        
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        function updateStatus(message, status = 'info') {
            const statusText = document.getElementById('sync-status-text');
            const statusContainer = document.getElementById('sync-status');
            
            if (statusText) {
                statusText.textContent = message;
            }
            
            if (statusContainer) {
                statusContainer.className = `sync-status-${status}`;
            }
        }
        
        // Google Driveæ¥ç¶š
        async function connectToDrive() {
            addLog('ğŸ”— Google Driveæ¥ç¶šãƒ†ã‚¹ãƒˆé–‹å§‹...');
            updateStatus('æ¥ç¶šä¸­...', 'connecting');
            
            try {
                // Google Drive API v2 åˆæœŸåŒ–
                if (!window.GoogleDriveAPIv2) {
                    throw new Error('Google Drive API v2 ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                }
                
                const apiInitialized = await window.GoogleDriveAPIv2.initialize();
                if (!apiInitialized) {
                    throw new Error('Google Drive APIåˆæœŸåŒ–å¤±æ•—');
                }
                addLog('âœ… Google Drive APIåˆæœŸåŒ–æˆåŠŸ');
                
                // èªè¨¼å®Ÿè¡Œ
                const userInfo = await window.GoogleDriveAPIv2.authenticate();
                addLog(`âœ… Googleèªè¨¼æˆåŠŸ: ${userInfo.email}`);
                
                // ãƒ‡ãƒ¼ã‚¿ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–
                if (!window.GoogleDriveDataManager) {
                    throw new Error('Google Drive ãƒ‡ãƒ¼ã‚¿ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                }
                
                const dataManagerReady = await window.GoogleDriveDataManager.initialize();
                if (!dataManagerReady) {
                    throw new Error('ãƒ‡ãƒ¼ã‚¿ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å¤±æ•—');
                }
                addLog('âœ… ãƒ‡ãƒ¼ã‚¿ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–æˆåŠŸ');
                
                updateStatus(`æ¥ç¶šå®Œäº†: ${userInfo.email}`, 'connected');
                
                // ãƒœã‚¿ãƒ³çŠ¶æ…‹æ›´æ–°
                document.getElementById('btn-connect-drive').disabled = true;
                document.getElementById('btn-sync-now').disabled = false;
                document.getElementById('sync-mode').textContent = 'ã‚¯ãƒ©ã‚¦ãƒ‰æ¥ç¶šæ¸ˆã¿';
                
                // åˆå›åŒæœŸå®Ÿè¡Œ
                setTimeout(() => syncNow(), 1000);
                
            } catch (error) {
                addLog(`âŒ æ¥ç¶šã‚¨ãƒ©ãƒ¼: ${error.message}`);
                updateStatus(`æ¥ç¶šå¤±æ•—: ${error.message}`, 'error');
            }
        }
        
        // ãƒ‡ãƒ¼ã‚¿åŒæœŸ
        async function syncNow() {
            addLog('ğŸ”„ ãƒ‡ãƒ¼ã‚¿åŒæœŸé–‹å§‹...');
            updateStatus('åŒæœŸä¸­...', 'syncing');
            
            try {
                const customers = await window.GoogleDriveDataManager.syncWithLocalStorage();
                
                addLog(`âœ… ãƒ‡ãƒ¼ã‚¿åŒæœŸå®Œäº†: ${customers.length}ä»¶`);
                updateStatus(`åŒæœŸå®Œäº†: ${customers.length}ä»¶`, 'connected');
                
                document.getElementById('last-sync-time').textContent = `æœ€çµ‚åŒæœŸ: ${new Date().toLocaleTimeString()}`;
                
                // é¡§å®¢ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºæ›´æ–°
                loadLocalData();
                
            } catch (error) {
                addLog(`âŒ åŒæœŸã‚¨ãƒ©ãƒ¼: ${error.message}`);
                updateStatus(`åŒæœŸå¤±æ•—: ${error.message}`, 'error');
            }
        }
        
        // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        function loadLocalData() {
            addLog('ğŸ“± ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿...');
            
            try {
                const customers = JSON.parse(localStorage.getItem('rentpipe_customers') || '[]');
                displayCustomers(customers);
                addLog(`ğŸ“Š ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º: ${customers.length}ä»¶`);
                
            } catch (error) {
                addLog(`âŒ ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }
        
        // é¡§å®¢ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º
        function displayCustomers(customers) {
            const customerList = document.getElementById('customer-list');
            
            if (customers.length === 0) {
                customerList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6b7280;">
                        <div style="font-size: 48px; margin-bottom: 15px;">ğŸ‘¥</div>
                        <h3>é¡§å®¢ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</h3>
                        <p>ãƒ†ã‚¹ãƒˆé¡§å®¢ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</p>
                        <button onclick="addTestCustomer()" class="btn btn-primary" style="margin-top: 15px;">
                            â• ãƒ†ã‚¹ãƒˆé¡§å®¢è¿½åŠ 
                        </button>
                    </div>
                `;
                return;
            }
            
            customerList.innerHTML = customers.map(customer => `
                <div class="customer-card" data-customer-id="${customer.id}">
                    <div class="customer-header">
                        <div class="customer-info">
                            <h3>${customer.name || 'åå‰æœªè¨­å®š'}</h3>
                            <div class="customer-meta">
                                ${customer.email || 'ãƒ¡ãƒ¼ãƒ«æœªè¨­å®š'} â€¢ ${customer.phone || 'é›»è©±æœªè¨­å®š'}
                            </div>
                            <div class="customer-status">
                                ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${customer.pipelineStatus || customer.status || 'æœªè¨­å®š'}
                            </div>
                        </div>
                        <div class="customer-actions">
                            <button onclick="editCustomer('${customer.id}')" class="btn btn-outline">ç·¨é›†</button>
                            <button onclick="deleteCustomer('${customer.id}')" class="btn btn-danger">å‰Šé™¤</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // ãƒ†ã‚¹ãƒˆé¡§å®¢è¿½åŠ 
        function addTestCustomer() {
            const testCustomer = {
                id: 'test_' + Date.now(),
                name: 'ãƒ†ã‚¹ãƒˆé¡§å®¢_' + Math.floor(Math.random() * 1000),
                email: `test${Math.floor(Math.random() * 1000)}@example.com`,
                phone: '090-' + Math.floor(Math.random() * 10000) + '-' + Math.floor(Math.random() * 10000),
                pipelineStatus: 'åˆå›ç›¸è«‡',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                notes: 'Google Driveçµ±åˆãƒ†ã‚¹ãƒˆç”¨ã®ãƒ‡ãƒ¼ã‚¿ã§ã™'
            };
            
            try {
                const customers = JSON.parse(localStorage.getItem('rentpipe_customers') || '[]');
                customers.push(testCustomer);
                localStorage.setItem('rentpipe_customers', JSON.stringify(customers));
                
                addLog(`â• ãƒ†ã‚¹ãƒˆé¡§å®¢è¿½åŠ : ${testCustomer.name}`);
                loadLocalData();
                
            } catch (error) {
                addLog(`âŒ ãƒ†ã‚¹ãƒˆé¡§å®¢è¿½åŠ ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }
        
        // é¡§å®¢å‰Šé™¤
        function deleteCustomer(customerId) {
            if (!confirm('ã“ã®é¡§å®¢ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            
            try {
                const customers = JSON.parse(localStorage.getItem('rentpipe_customers') || '[]');
                const updatedCustomers = customers.filter(c => c.id !== customerId);
                localStorage.setItem('rentpipe_customers', JSON.stringify(updatedCustomers));
                
                addLog(`ğŸ—‘ï¸ é¡§å®¢å‰Šé™¤: ${customerId}`);
                loadLocalData();
                
            } catch (error) {
                addLog(`âŒ é¡§å®¢å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }
        
        // é¡§å®¢ç·¨é›†ï¼ˆç°¡æ˜“ç‰ˆï¼‰
        function editCustomer(customerId) {
            const newName = prompt('æ–°ã—ã„åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
            if (!newName) return;
            
            try {
                const customers = JSON.parse(localStorage.getItem('rentpipe_customers') || '[]');
                const customer = customers.find(c => c.id === customerId);
                if (customer) {
                    customer.name = newName;
                    customer.updatedAt = new Date().toISOString();
                    localStorage.setItem('rentpipe_customers', JSON.stringify(customers));
                    
                    addLog(`âœï¸ é¡§å®¢ç·¨é›†: ${customer.name}`);
                    loadLocalData();
                }
                
            } catch (error) {
                addLog(`âŒ é¡§å®¢ç·¨é›†ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }
        
        // å…¨ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢
        function clearAllData() {
            if (!confirm('ã™ã¹ã¦ã®é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã—ã§ãã¾ã›ã‚“ã€‚')) return;
            
            localStorage.removeItem('rentpipe_customers');
            addLog('ğŸ—‘ï¸ å…¨ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢å®Œäº†');
            loadLocalData();
        }
        
        // CSSè¿½åŠ 
        const style = document.createElement('style');
        style.textContent = `
            .sync-status-disconnected { padding: 15px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 6px; }
            .sync-status-connecting { padding: 15px; background: #cce5ff; border: 1px solid #66b3ff; border-radius: 6px; }
            .sync-status-connected { padding: 15px; background: #d1fae5; border: 1px solid #10b981; border-radius: 6px; }
            .sync-status-syncing { padding: 15px; background: #e0e7ff; border: 1px solid #8b5cf6; border-radius: 6px; }
            .sync-status-error { padding: 15px; background: #fee2e2; border: 1px solid #f87171; border-radius: 6px; }
            
            .customer-card { border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem; margin: 1rem 0; background: white; }
            .customer-header { display: flex; justify-content: space-between; align-items: center; }
            .customer-info h3 { margin: 0 0 0.5rem 0; }
            .customer-meta { color: #6b7280; font-size: 14px; margin-bottom: 0.5rem; }
            .customer-status { color: #059669; font-weight: 500; font-size: 14px; }
            .customer-actions button { margin-left: 0.5rem; }
            
            @media (max-width: 768px) {
                .customer-header { flex-direction: column; align-items: flex-start; }
                .customer-actions { margin-top: 1rem; width: 100%; }
                .customer-actions button { margin: 0.25rem; }
            }
        `;
        document.head.appendChild(style);
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†æ™‚
        document.addEventListener('DOMContentLoaded', function() {
            addLog('ğŸ“„ èªè¨¼ãƒã‚¤ãƒ‘ã‚¹ç‰ˆ ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†');
            addLog('ğŸ¯ æ‰‹é †: 1. Google Driveæ¥ç¶šãƒ†ã‚¹ãƒˆ â†’ 2. ãƒ‡ãƒ¼ã‚¿åŒæœŸãƒ†ã‚¹ãƒˆ â†’ 3. æ©Ÿèƒ½ç¢ºèª');
            
            // åˆæœŸãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
            loadLocalData();
        });
        
    </script>
</body>
</html>
