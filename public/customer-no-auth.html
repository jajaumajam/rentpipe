<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>顧客管理（認証なし） - RentPipe</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <header>
        <div class="header-content">
            <h1>🏠 RentPipe</h1>
            <nav class="nav-container">
                <a href="index.html">ホーム</a>
                <a href="customer-no-auth.html" class="active">顧客管理（テスト版）</a>
                <a href="customer.html">通常版</a>
                <a href="pipeline.html">パイプライン</a>
            </nav>
        </div>
    </header>

    <main class="main-content">
        <div class="page-header">
            <h2>👥 顧客管理（認証バイパス版）</h2>
            <p>Google Drive統合のテスト版 - 認証問題の回避</p>
        </div>

        <!-- Google Drive同期状況表示 -->
        <div id="google-drive-sync-panel" style="margin: 1rem 0; padding: 1rem; border-radius: 8px; background: #f3f4f6;">
            <h3>☁️ Google Drive 同期テスト</h3>
            <div id="sync-status" class="sync-status-disconnected">
                <span id="sync-status-text">未接続 - テスト準備中...</span>
                <div id="sync-controls" style="margin-top: 10px;">
                    <button id="btn-connect-drive" onclick="connectToDrive()" class="btn btn-primary">
                        🔗 Google Drive接続テスト
                    </button>
                    <button id="btn-sync-now" onclick="syncNow()" disabled class="btn btn-success">
                        🔄 今すぐ同期
                    </button>
                    <button id="btn-load-local" onclick="loadLocalData()" class="btn btn-outline">
                        📱 ローカルデータ表示
                    </button>
                </div>
                <div id="sync-info" style="margin-top: 10px; font-size: 14px; color: #666;">
                    <span id="last-sync-time">未同期</span> • 
                    <span id="sync-mode">テストモード</span>
                </div>
            </div>
        </div>

        <!-- 顧客操作ボタン -->
        <div class="page-actions" style="margin: 1rem 0;">
            <button onclick="addTestCustomer()" class="btn btn-primary">
                ➕ テスト顧客追加
            </button>
            <button onclick="loadLocalData()" class="btn btn-outline">
                🔄 ローカルデータ再読込
            </button>
            <button onclick="clearAllData()" class="btn btn-danger">
                🗑️ データクリア
            </button>
        </div>

        <!-- 顧客リスト -->
        <div id="customer-list" class="customer-grid">
            <div style="text-align: center; padding: 40px; color: #6b7280;">
                <div style="font-size: 24px;">📋</div>
                <p>データを準備中...</p>
            </div>
        </div>
        
        <!-- ログ表示 -->
        <div style="margin: 2rem 0; padding: 1rem; border-radius: 8px; background: #f8f9fa;">
            <h3>📝 実行ログ</h3>
            <pre id="log-output" style="max-height: 200px; overflow-y: auto;">ページ読み込み完了...</pre>
        </div>
    </main>

    <!-- Google Drive統合スクリプト（認証なし版） -->
    <script src="js/google-drive-api-v2.js"></script>
    <script src="js/google-drive-data-manager.js"></script>
    
    <script>
        // 🚀 認証バイパス版の顧客管理システム
        console.log('🚀 認証バイパス版 顧客管理システム初期化');
        
        let logs = [];
        
        // ログ追加
        function addLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            logs.push(logMessage);
            
            const logElement = document.getElementById('log-output');
            if (logElement) {
                logElement.textContent = logs.join('\n');
                logElement.scrollTop = logElement.scrollHeight;
            }
            
            console.log(logMessage);
        }
        
        // ステータス更新
        function updateStatus(message, status = 'info') {
            const statusText = document.getElementById('sync-status-text');
            const statusContainer = document.getElementById('sync-status');
            
            if (statusText) {
                statusText.textContent = message;
            }
            
            if (statusContainer) {
                statusContainer.className = `sync-status-${status}`;
            }
        }
        
        // Google Drive接続
        async function connectToDrive() {
            addLog('🔗 Google Drive接続テスト開始...');
            updateStatus('接続中...', 'connecting');
            
            try {
                // Google Drive API v2 初期化
                if (!window.GoogleDriveAPIv2) {
                    throw new Error('Google Drive API v2 スクリプトが読み込まれていません');
                }
                
                const apiInitialized = await window.GoogleDriveAPIv2.initialize();
                if (!apiInitialized) {
                    throw new Error('Google Drive API初期化失敗');
                }
                addLog('✅ Google Drive API初期化成功');
                
                // 認証実行
                const userInfo = await window.GoogleDriveAPIv2.authenticate();
                addLog(`✅ Google認証成功: ${userInfo.email}`);
                
                // データ管理システム初期化
                if (!window.GoogleDriveDataManager) {
                    throw new Error('Google Drive データ管理システムが読み込まれていません');
                }
                
                const dataManagerReady = await window.GoogleDriveDataManager.initialize();
                if (!dataManagerReady) {
                    throw new Error('データ管理システム初期化失敗');
                }
                addLog('✅ データ管理システム初期化成功');
                
                updateStatus(`接続完了: ${userInfo.email}`, 'connected');
                
                // ボタン状態更新
                document.getElementById('btn-connect-drive').disabled = true;
                document.getElementById('btn-sync-now').disabled = false;
                document.getElementById('sync-mode').textContent = 'クラウド接続済み';
                
                // 初回同期実行
                setTimeout(() => syncNow(), 1000);
                
            } catch (error) {
                addLog(`❌ 接続エラー: ${error.message}`);
                updateStatus(`接続失敗: ${error.message}`, 'error');
            }
        }
        
        // データ同期
        async function syncNow() {
            addLog('🔄 データ同期開始...');
            updateStatus('同期中...', 'syncing');
            
            try {
                const customers = await window.GoogleDriveDataManager.syncWithLocalStorage();
                
                addLog(`✅ データ同期完了: ${customers.length}件`);
                updateStatus(`同期完了: ${customers.length}件`, 'connected');
                
                document.getElementById('last-sync-time').textContent = `最終同期: ${new Date().toLocaleTimeString()}`;
                
                // 顧客データ表示更新
                loadLocalData();
                
            } catch (error) {
                addLog(`❌ 同期エラー: ${error.message}`);
                updateStatus(`同期失敗: ${error.message}`, 'error');
            }
        }
        
        // ローカルデータ読み込み
        function loadLocalData() {
            addLog('📱 ローカルデータ読み込み...');
            
            try {
                const customers = JSON.parse(localStorage.getItem('rentpipe_customers') || '[]');
                displayCustomers(customers);
                addLog(`📊 ローカルデータ表示: ${customers.length}件`);
                
            } catch (error) {
                addLog(`❌ ローカルデータ読み込みエラー: ${error.message}`);
            }
        }
        
        // 顧客データ表示
        function displayCustomers(customers) {
            const customerList = document.getElementById('customer-list');
            
            if (customers.length === 0) {
                customerList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6b7280;">
                        <div style="font-size: 48px; margin-bottom: 15px;">👥</div>
                        <h3>顧客データがありません</h3>
                        <p>テスト顧客を追加してください。</p>
                        <button onclick="addTestCustomer()" class="btn btn-primary" style="margin-top: 15px;">
                            ➕ テスト顧客追加
                        </button>
                    </div>
                `;
                return;
            }
            
            customerList.innerHTML = customers.map(customer => `
                <div class="customer-card" data-customer-id="${customer.id}">
                    <div class="customer-header">
                        <div class="customer-info">
                            <h3>${customer.name || '名前未設定'}</h3>
                            <div class="customer-meta">
                                ${customer.email || 'メール未設定'} • ${customer.phone || '電話未設定'}
                            </div>
                            <div class="customer-status">
                                ステータス: ${customer.pipelineStatus || customer.status || '未設定'}
                            </div>
                        </div>
                        <div class="customer-actions">
                            <button onclick="editCustomer('${customer.id}')" class="btn btn-outline">編集</button>
                            <button onclick="deleteCustomer('${customer.id}')" class="btn btn-danger">削除</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // テスト顧客追加
        function addTestCustomer() {
            const testCustomer = {
                id: 'test_' + Date.now(),
                name: 'テスト顧客_' + Math.floor(Math.random() * 1000),
                email: `test${Math.floor(Math.random() * 1000)}@example.com`,
                phone: '090-' + Math.floor(Math.random() * 10000) + '-' + Math.floor(Math.random() * 10000),
                pipelineStatus: '初回相談',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                notes: 'Google Drive統合テスト用のデータです'
            };
            
            try {
                const customers = JSON.parse(localStorage.getItem('rentpipe_customers') || '[]');
                customers.push(testCustomer);
                localStorage.setItem('rentpipe_customers', JSON.stringify(customers));
                
                addLog(`➕ テスト顧客追加: ${testCustomer.name}`);
                loadLocalData();
                
            } catch (error) {
                addLog(`❌ テスト顧客追加エラー: ${error.message}`);
            }
        }
        
        // 顧客削除
        function deleteCustomer(customerId) {
            if (!confirm('この顧客を削除しますか？')) return;
            
            try {
                const customers = JSON.parse(localStorage.getItem('rentpipe_customers') || '[]');
                const updatedCustomers = customers.filter(c => c.id !== customerId);
                localStorage.setItem('rentpipe_customers', JSON.stringify(updatedCustomers));
                
                addLog(`🗑️ 顧客削除: ${customerId}`);
                loadLocalData();
                
            } catch (error) {
                addLog(`❌ 顧客削除エラー: ${error.message}`);
            }
        }
        
        // 顧客編集（簡易版）
        function editCustomer(customerId) {
            const newName = prompt('新しい名前を入力してください:');
            if (!newName) return;
            
            try {
                const customers = JSON.parse(localStorage.getItem('rentpipe_customers') || '[]');
                const customer = customers.find(c => c.id === customerId);
                if (customer) {
                    customer.name = newName;
                    customer.updatedAt = new Date().toISOString();
                    localStorage.setItem('rentpipe_customers', JSON.stringify(customers));
                    
                    addLog(`✏️ 顧客編集: ${customer.name}`);
                    loadLocalData();
                }
                
            } catch (error) {
                addLog(`❌ 顧客編集エラー: ${error.message}`);
            }
        }
        
        // 全データクリア
        function clearAllData() {
            if (!confirm('すべての顧客データを削除しますか？この操作は取り消しできません。')) return;
            
            localStorage.removeItem('rentpipe_customers');
            addLog('🗑️ 全データクリア完了');
            loadLocalData();
        }
        
        // CSS追加
        const style = document.createElement('style');
        style.textContent = `
            .sync-status-disconnected { padding: 15px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 6px; }
            .sync-status-connecting { padding: 15px; background: #cce5ff; border: 1px solid #66b3ff; border-radius: 6px; }
            .sync-status-connected { padding: 15px; background: #d1fae5; border: 1px solid #10b981; border-radius: 6px; }
            .sync-status-syncing { padding: 15px; background: #e0e7ff; border: 1px solid #8b5cf6; border-radius: 6px; }
            .sync-status-error { padding: 15px; background: #fee2e2; border: 1px solid #f87171; border-radius: 6px; }
            
            .customer-card { border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem; margin: 1rem 0; background: white; }
            .customer-header { display: flex; justify-content: space-between; align-items: center; }
            .customer-info h3 { margin: 0 0 0.5rem 0; }
            .customer-meta { color: #6b7280; font-size: 14px; margin-bottom: 0.5rem; }
            .customer-status { color: #059669; font-weight: 500; font-size: 14px; }
            .customer-actions button { margin-left: 0.5rem; }
            
            @media (max-width: 768px) {
                .customer-header { flex-direction: column; align-items: flex-start; }
                .customer-actions { margin-top: 1rem; width: 100%; }
                .customer-actions button { margin: 0.25rem; }
            }
        `;
        document.head.appendChild(style);
        
        // ページ読み込み完了時
        document.addEventListener('DOMContentLoaded', function() {
            addLog('📄 認証バイパス版 ページ読み込み完了');
            addLog('🎯 手順: 1. Google Drive接続テスト → 2. データ同期テスト → 3. 機能確認');
            
            // 初期データ読み込み
            loadLocalData();
        });
        
    </script>
</body>
</html>
