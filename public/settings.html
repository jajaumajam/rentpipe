<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¨­å®š - RentPipe</title>
    <link rel="stylesheet" href="css/main.css">
    <!-- Tailwind CSS (local build) -->
    <link rel="stylesheet" href="css/tailwind-output.css">

    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @keyframes skeleton-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        .settings-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .page-header {
            margin-bottom: 30px;
        }

        .page-header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .page-header p {
            color: #6b7280;
        }

        .settings-section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .settings-section h2 {
            margin: 0 0 8px 0;
            font-size: 18px;
            color: #1e3a8a;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-description {
            color: #6b7280;
            font-size: 14px;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        /* ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±è¡¨ç¤º */
        .account-info {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 20px;
            border-radius: 8px;
            background: #f0fdf4;
            border: 1px solid #86efac;
        }

        .account-icon {
            font-size: 32px;
        }

        .account-details h3 {
            margin: 0 0 4px 0;
            font-size: 16px;
            color: #166534;
        }

        .account-details p {
            margin: 0;
            font-size: 13px;
            color: #15803d;
        }

        /* ãƒ•ã‚©ãƒ¼ãƒ è¨­å®š */
        .form-config-status {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .form-config-status.has-form {
            background: #ecfdf5;
            border: 1px solid #10b981;
        }

        .form-config-status.no-form {
            background: #f3f4f6;
            border: 1px solid #d1d5db;
        }

        .config-icon {
            font-size: 28px;
        }

        .config-info h3 {
            margin: 0 0 4px 0;
            font-size: 15px;
            color: #1f2937;
        }

        .config-info p {
            margin: 0;
            font-size: 13px;
            color: #6b7280;
        }

        /* ãƒœã‚¿ãƒ³ */
        .action-buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .action-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .action-btn.primary {
            background: #3b82f6;
            color: white;
        }

        .action-btn.primary:hover {
            background: #2563eb;
        }

        .action-btn.secondary {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
        }

        .action-btn.secondary:hover {
            background: #e5e7eb;
        }

        .action-btn.danger {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }

        .action-btn.danger:hover {
            background: #fee2e2;
        }

        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* æ³¨æ„æ›¸ã */
        .notice {
            background: #fffbeb;
            border: 1px solid #fcd34d;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }

        .notice h4 {
            margin: 0 0 10px 0;
            color: #92400e;
            font-size: 14px;
        }

        .notice ul {
            margin: 0;
            padding-left: 20px;
            color: #78350f;
            font-size: 13px;
        }

        .notice li {
            margin-bottom: 5px;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 12px;
            padding: 25px;
            max-width: 500px;
            width: 90%;
        }

        .modal h3 {
            margin: 0 0 15px 0;
            color: #1f2937;
        }

        .modal-content {
            color: #4b5563;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .modal-content p {
            margin: 0 0 12px 0;
        }

        .modal-content .warning-list {
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 8px;
            padding: 12px 16px;
            margin: 12px 0;
        }

        .modal-content .warning-list h4 {
            margin: 0 0 8px 0;
            color: #dc2626;
            font-size: 14px;
        }

        .modal-content .warning-list ul {
            margin: 0;
            padding-left: 20px;
            font-size: 13px;
            color: #7f1d1d;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        /* ãƒ‡ãƒ¼ã‚¿ç®¡ç† */
        .data-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .data-stat {
            background: #f8fafc;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .data-stat .value {
            font-size: 28px;
            font-weight: 700;
            color: #1e3a8a;
        }

        .data-stat .label {
            font-size: 12px;
            color: #6b7280;
            margin-top: 5px;
        }

        /* UIè¨­å®š */
        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .settings-item:last-child {
            border-bottom: none;
        }

        .settings-item-info h4 {
            margin: 0 0 4px 0;
            font-size: 15px;
            color: #1f2937;
        }

        .settings-item-info p {
            margin: 0;
            font-size: 13px;
            color: #6b7280;
        }

        /* ãƒˆã‚°ãƒ«ã‚¹ã‚¤ãƒƒãƒ */
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 28px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #cbd5e1;
            transition: 0.3s;
            border-radius: 28px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: #3b82f6;
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(22px);
        }
    </style>
</head>
<body>
    <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <div id="navigation"></div>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <div class="max-w-3xl mx-auto px-5 py-6">
        <div class="mb-6">
            <h1 class="text-2xl font-bold text-gray-900">âš™ï¸ è¨­å®š</h1>
            <p class="text-sm text-gray-500 mt-1">ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å„ç¨®è¨­å®šã‚’ç®¡ç†ã—ã¾ã™</p>
        </div>

        <!-- èª­ã¿è¾¼ã¿ä¸­ã‚¹ã‚±ãƒ«ãƒˆãƒ³ -->
        <div id="settings-skeleton" class="space-y-4">
            <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 flex items-center gap-4">
                <div class="w-10 h-10 rounded-full border-4 border-gray-200 border-t-rentpipe-primary flex-shrink-0" style="animation: spin 1s linear infinite;"></div>
                <div class="flex-1 space-y-2">
                    <div class="h-4 bg-gray-200 rounded w-3/5" style="animation: skeleton-pulse 1.5s ease-in-out infinite;"></div>
                    <div class="h-3 bg-gray-200 rounded w-2/5" style="animation: skeleton-pulse 1.5s ease-in-out infinite;"></div>
                </div>
            </div>
            <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 space-y-3">
                <div class="h-5 bg-gray-200 rounded w-2/5" style="animation: skeleton-pulse 1.5s ease-in-out infinite;"></div>
                <div class="h-3 bg-gray-200 rounded w-full" style="animation: skeleton-pulse 1.5s ease-in-out infinite;"></div>
                <div class="h-3 bg-gray-200 rounded w-4/5" style="animation: skeleton-pulse 1.5s ease-in-out infinite;"></div>
            </div>
            <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 space-y-3">
                <div class="h-5 bg-gray-200 rounded w-1/3" style="animation: skeleton-pulse 1.5s ease-in-out infinite;"></div>
                <div class="h-3 bg-gray-200 rounded w-full" style="animation: skeleton-pulse 1.5s ease-in-out infinite;"></div>
                <div class="h-3 bg-gray-200 rounded w-3/4" style="animation: skeleton-pulse 1.5s ease-in-out infinite;"></div>
            </div>
        </div>

        <!-- è¨­å®šã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼ˆèª­ã¿è¾¼ã¿å®Œäº†å¾Œã«è¡¨ç¤ºï¼‰ -->
        <div id="settings-content" class="space-y-4" style="display: none;">

        <!-- ãƒ­ã‚°ã‚¤ãƒ³ä¸­ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ± -->
        <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
            <h2 class="text-lg font-bold text-gray-900 mb-1">ğŸ‘¤ ãƒ­ã‚°ã‚¤ãƒ³ä¸­ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</h2>
            <p class="text-sm text-gray-500 mb-4">ç¾åœ¨ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ã™</p>
            <div class="flex items-center gap-4 p-4 bg-green-50 rounded-xl border border-green-100">
                <span class="text-2xl">âœ…</span>
                <div>
                    <div class="font-semibold text-gray-900" id="accountEmail">èª­ã¿è¾¼ã¿ä¸­...</div>
                    <div class="text-sm text-gray-500">Google Driveãƒ»Sheetsã¨åŒæœŸä¸­</div>
                </div>
            </div>
        </div>

        <!-- ãƒ—ãƒ©ãƒ³ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
            <h2 class="text-lg font-bold text-gray-900 mb-1">ğŸ’ ãƒ—ãƒ©ãƒ³ç®¡ç†</h2>
            <p class="text-sm text-gray-500 mb-4">ç¾åœ¨ã®ãƒ—ãƒ©ãƒ³ã¨æ©Ÿèƒ½ã‚’ç¢ºèªã§ãã¾ã™</p>

            <!-- ãƒ™ãƒ¼ã‚¿ç‰ˆãƒãƒŠãƒ¼ï¼ˆBETA_MODE = true ã®å ´åˆã®ã¿è¡¨ç¤ºï¼‰ -->
            <div id="betaBanner" style="display: none; margin-bottom: 20px; padding: 16px; background: linear-gradient(135deg, #4CAF50, #45a049); border-radius: 8px; color: white; box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <span style="font-size: 32px;">ğŸš€</span>
                    <div>
                        <h3 style="margin: 0 0 4px 0; font-size: 18px; font-weight: bold;">ãƒ™ãƒ¼ã‚¿ç‰ˆæœŸé–“ä¸­ï¼šå…¨æ©Ÿèƒ½ç„¡æ–™é–‹æ”¾ï¼</h3>
                        <p style="margin: 0; font-size: 14px; opacity: 0.95;">
                            ç¾åœ¨ã€ãƒ™ãƒ¼ã‚¿ç‰ˆã¨ã—ã¦å…¨ã¦ã®æ©Ÿèƒ½ã‚’ç„¡æ–™ã§ã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã™ã€‚<br>
                            æ­£å¼ç‰ˆç§»è¡Œæ™‚ã«æ”¹ã‚ã¦ãŠçŸ¥ã‚‰ã›ã„ãŸã—ã¾ã™ã€‚ã“ã®æœŸé–“ä¸­ã«å­˜åˆ†ã«ãŠè©¦ã—ãã ã•ã„ï¼
                        </p>
                    </div>
                </div>
            </div>

            <div id="planInfo" style="margin-bottom: 20px;">
                <div style="padding: 20px; background: #f8fafc; border-radius: 8px; border: 2px solid #e2e8f0;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <div>
                            <h3 style="margin: 0 0 4px 0; font-size: 18px; color: #1e3a8a;">
                                ç¾åœ¨ã®ãƒ—ãƒ©ãƒ³: <span id="currentPlanName">Free</span>
                            </h3>
                            <p style="margin: 0; color: #64748b; font-size: 14px;">ç„¡åˆ¶é™ã®é¡§å®¢ç®¡ç†ãŒå¯èƒ½ã§ã™</p>
                        </div>
                        <button id="upgradeButton" class="btn-primary" style="padding: 10px 20px;">
                            ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰
                        </button>
                    </div>

                    <div style="border-top: 1px solid #e2e8f0; padding-top: 16px; margin-top: 16px;">
                        <h4 style="margin: 0 0 12px 0; font-size: 14px; color: #64748b;">åˆ©ç”¨å¯èƒ½ãªæ©Ÿèƒ½</h4>
                        <ul id="planFeaturesList" style="margin: 0; padding-left: 20px; color: #334155; font-size: 14px; line-height: 1.8;">
                            <li>é¡§å®¢ç®¡ç†ï¼ˆç„¡åˆ¶é™ï¼‰</li>
                            <li>ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ç®¡ç†</li>
                            <li>Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é€£æºï¼ˆåŸºæœ¬ï¼‰</li>
                        </ul>
                    </div>
                </div>

                <!-- ãƒ—ãƒ©ãƒ³æ¯”è¼ƒãƒ†ãƒ¼ãƒ–ãƒ« -->
                <div id="planComparison" style="margin-top: 20px; display: none;">
                    <h4 style="margin-bottom: 16px; color: #1e3a8a;">ãƒ—ãƒ©ãƒ³æ¯”è¼ƒ</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <!-- Free Plan -->
                        <div style="border: 2px solid #e2e8f0; border-radius: 8px; padding: 20px; background: white;">
                            <h3 style="margin: 0 0 8px 0; color: #1e3a8a;">Free</h3>
                            <p style="margin: 0 0 16px 0; font-size: 24px; font-weight: bold;">Â¥0</p>
                            <ul style="margin: 0; padding-left: 20px; font-size: 14px; line-height: 1.8;">
                                <li>é¡§å®¢ç®¡ç†ï¼ˆç„¡åˆ¶é™ï¼‰</li>
                                <li>ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ç®¡ç†</li>
                                <li>Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é€£æºï¼ˆåŸºæœ¬ï¼‰</li>
                            </ul>
                        </div>

                        <!-- Senior Agent Plan -->
                        <div style="border: 2px solid #3b82f6; border-radius: 8px; padding: 20px; background: linear-gradient(135deg, #eff6ff, #dbeafe); position: relative;">
                            <div style="position: absolute; top: -12px; right: 16px; background: #3b82f6; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: bold;">
                                ãŠã™ã™ã‚
                            </div>
                            <h3 style="margin: 0 0 8px 0; color: #1e3a8a;">Senior Agent</h3>
                            <p style="margin: 0 0 16px 0; font-size: 24px; font-weight: bold; color: #3b82f6;">Â¥2,480<span style="font-size: 14px; color: #64748b;">/æœˆ</span></p>
                            <ul style="margin: 0 0 16px 0; padding-left: 20px; font-size: 14px; line-height: 1.8;">
                                <li>ã™ã¹ã¦ã®Freeæ©Ÿèƒ½</li>
                                <li>Googleãƒ•ã‚©ãƒ¼ãƒ é€£æº</li>
                                <li>Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é€£æºï¼ˆæ‹¡å¼µï¼‰</li>
                                <li>é€£çµ¡ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç®¡ç†</li>
                            </ul>
                            <button id="upgradeSeniorButton" class="btn-primary" style="width: 100%; padding: 10px;">
                                ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ç®¡ç†ï¼ˆæœ‰æ–™ãƒ—ãƒ©ãƒ³åŠ å…¥è€…ã®ã¿è¡¨ç¤ºï¼‰ -->
                <div id="subscriptionManagement" style="margin-top: 20px; display: none;">
                    <button id="manageBillingButton" class="btn-secondary" style="width: 100%; padding: 12px;">
                        ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ç®¡ç†ï¼ˆè«‹æ±‚ãƒ»ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼‰
                    </button>
                </div>
            </div>
        </div>

        <!-- UIè¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
            <h2 class="text-lg font-bold text-gray-900 mb-1">ğŸ¨ è¡¨ç¤ºè¨­å®š</h2>
            <p class="text-sm text-gray-500 mb-4">ç”»é¢ã®è¡¨ç¤ºã«é–¢ã™ã‚‹è¨­å®šã§ã™</p>

            <div class="settings-item">
                <div class="settings-item-info">
                    <h4>çµ±è¨ˆã‚«ãƒ¼ãƒ‰ã‚’è¡¨ç¤º</h4>
                    <p>é¡§å®¢ç®¡ç†ç”»é¢ã§çµ±è¨ˆæƒ…å ±ï¼ˆé€²è¡Œä¸­ãƒ»æˆç´„æ¸ˆã¿ãƒ»å¤±æ³¨ãƒ»ä»Šæœˆã®æ–°è¦ï¼‰ã‚’è¡¨ç¤ºã—ã¾ã™</p>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="showStatsToggle" checked onchange="toggleStats()">
                    <span class="toggle-slider"></span>
                </label>
            </div>
        </div>

        <!-- å€‹äººæƒ…å ±å–æ‰±ã„è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
            <h2 class="text-lg font-bold text-gray-900 mb-1">ğŸ”’ å€‹äººæƒ…å ±å–æ‰±ã„è¨­å®š</h2>
            <p class="text-sm text-gray-500 mb-4">
                ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ãƒ ã«è¡¨ç¤ºã•ã‚Œã‚‹å€‹äººæƒ…å ±ã®å–æ‰±ã„ã«é–¢ã™ã‚‹èª¬æ˜æ–‡ã®è¨­å®šã§ã™ã€‚<br>
                ç¬¬ä¸‰è€…æä¾›å…ˆã‚’ç™»éŒ²ã—ã¦ãŠãã¨ã€ãƒ•ã‚©ãƒ¼ãƒ ç”Ÿæˆæ™‚ã«èª¬æ˜æ–‡ã¸è‡ªå‹•çš„ã«æŒ¿å…¥ã•ã‚Œã¾ã™ã€‚
            </p>

            <div style="margin-bottom: 16px;">
                <label class="block text-sm font-medium text-gray-700 mb-1">æ‹…å½“è€…åï¼ˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆåï¼‰</label>
                <input type="text" id="privacyAgentName" placeholder="ä¾‹: å±±ç”° å¤ªéƒ"
                       style="width: 100%; border: 1px solid #d1d5db; border-radius: 8px; padding: 8px 12px; font-size: 14px; box-sizing: border-box;"
                       oninput="updatePrivacyPreview()">
            </div>
            <div style="margin-bottom: 16px;">
                <label class="block text-sm font-medium text-gray-700 mb-1">æ‰€å±ä¼šç¤¾å <span style="color: #ef4444; font-size: 12px;">ï¼ˆå¿…é ˆãƒ»ãƒ•ã‚©ãƒ¼ãƒ ç”Ÿæˆå‰ã«ä¿å­˜ã—ã¦ãã ã•ã„ï¼‰</span></label>
                <input type="text" id="privacyAgentCompany" placeholder="ä¾‹: ã€‡ã€‡ä¸å‹•ç”£æ ªå¼ä¼šç¤¾"
                       style="width: 100%; border: 1px solid #d1d5db; border-radius: 8px; padding: 8px 12px; font-size: 14px; box-sizing: border-box;"
                       oninput="updatePrivacyPreview()">
            </div>

            <div style="margin-bottom: 16px;">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    ç¬¬ä¸‰è€…æä¾›å…ˆä¼æ¥­
                    <span style="font-size: 12px; color: #9ca3af; margin-left: 4px;">ï¼ˆé¡§å®¢æƒ…å ±ã‚’å…±æœ‰ã™ã‚‹ææºä¼æ¥­ï¼‰</span>
                </label>
                <div id="thirdPartyList" style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 8px;"></div>
                <button onclick="addThirdParty()"
                        style="background: none; border: none; color: #2563eb; font-size: 14px; cursor: pointer; padding: 4px 0; display: flex; align-items: center; gap: 4px;">
                    ï¼‹ ä¼æ¥­ã‚’è¿½åŠ 
                </button>
            </div>

            <div style="margin-bottom: 16px; padding: 16px; background: #eff6ff; border-radius: 8px; border: 1px solid #bfdbfe;">
                <p style="font-size: 12px; font-weight: 600; color: #1d4ed8; margin: 0 0 8px 0;">ğŸ“‹ ãƒ•ã‚©ãƒ¼ãƒ ã«æŒ¿å…¥ã•ã‚Œã‚‹èª¬æ˜æ–‡ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</p>
                <pre id="privacyPreview" style="font-size: 12px; color: #374151; white-space: pre-wrap; margin: 0; font-family: inherit; line-height: 1.6;">ï¼ˆæ‹…å½“è€…åãƒ»ä¼æ¥­åãƒ»æä¾›å…ˆã‚’å…¥åŠ›ã™ã‚‹ã¨è¡¨ç¤ºã•ã‚Œã¾ã™ï¼‰</pre>
            </div>

            <div class="action-buttons">
                <button onclick="savePrivacySettings()" class="action-btn primary">
                    ğŸ’¾ ä¿å­˜ã™ã‚‹
                </button>
            </div>
            <p id="privacySaveStatus" style="display:none; font-size: 14px; margin-top: 8px;"></p>
        </div>

        <!-- ãƒ•ã‚©ãƒ¼ãƒ è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
            <h2 class="text-lg font-bold text-gray-900 mb-1">ğŸ“ ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ãƒ è¨­å®š</h2>
            <p class="text-sm text-gray-500 mb-4">
                ãŠå®¢æ§˜ãŒã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ç­‰ã§å…¥åŠ›ã§ãã‚‹ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‚’ä½œæˆãƒ»ç®¡ç†ã—ã¾ã™ã€‚<br>
                ä¸€åº¦ä½œæˆã™ã‚Œã°ã€ãƒ•ã‚©ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã§å›ç­”ã‚’å–ã‚Šè¾¼ã‚ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
            </p>

            <div id="formConfigStatus" class="form-config-status no-form">
                <span class="config-icon">ğŸ“‹</span>
                <div class="config-info">
                    <h3>ãƒ•ã‚©ãƒ¼ãƒ æœªä½œæˆ</h3>
                    <p>ãƒ•ã‚©ãƒ¼ãƒ ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„</p>
                </div>
            </div>

            <div class="action-buttons">
                <button id="createFormBtn" class="action-btn primary" onclick="createForm()">
                    âœ¨ ãƒ•ã‚©ãƒ¼ãƒ ã‚’ç”Ÿæˆ
                </button>
                <button id="resetFormBtn" class="action-btn danger" onclick="confirmResetForm()" style="display: none;">
                    ğŸ—‘ï¸ ãƒ•ã‚©ãƒ¼ãƒ è¨­å®šã‚’ãƒªã‚»ãƒƒãƒˆ
                </button>
            </div>

            <div class="notice">
                <h4>ğŸ’¡ ãƒ•ã‚©ãƒ¼ãƒ ã«ã¤ã„ã¦</h4>
                <ul>
                    <li>ãƒ•ã‚©ãƒ¼ãƒ ã‚’ç”Ÿæˆã™ã‚‹ã¨ã€Googleãƒ‰ãƒ©ã‚¤ãƒ–ã«ãƒ•ã‚©ãƒ¼ãƒ ãŒä½œæˆã•ã‚Œã¾ã™</li>
                    <li>ä½œæˆå¾Œã¯ã€Œãƒ•ã‚©ãƒ¼ãƒ ã€ãƒšãƒ¼ã‚¸ã§URLã¨QRã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèªã§ãã¾ã™</li>
                </ul>
            </div>
        </div>

        <!-- ãƒ‡ãƒ¼ã‚¿ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
            <h2 class="text-lg font-bold text-gray-900 mb-1">ğŸ“Š ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h2>
            <p class="text-sm text-gray-500 mb-4">é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã®çŠ¶æ…‹ã¨åŒæœŸã‚’ç®¡ç†ã—ã¾ã™</p>

            <div class="data-info">
                <div class="data-stat">
                    <div class="value" id="totalCustomers">-</div>
                    <div class="label">é¡§å®¢æ•°</div>
                </div>
                <div class="data-stat">
                    <div class="value" id="activeCustomers">-</div>
                    <div class="label">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–</div>
                </div>
                <div class="data-stat">
                    <div class="value" id="lastSync">-</div>
                    <div class="label">æœ€çµ‚åŒæœŸ</div>
                </div>
            </div>

            <div class="action-buttons">
                <a href="customer-import.html" class="action-btn primary" style="text-decoration: none; display: inline-flex; align-items: center; justify-content: center;">
                    ğŸ“¥ é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                </a>
                <button class="action-btn secondary" onclick="syncData(event)">
                    ğŸ”„ ãƒ‡ãƒ¼ã‚¿ã‚’åŒæœŸ
                </button>
                <button class="action-btn danger" onclick="confirmClearData()">
                    ğŸ—‘ï¸ ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
                </button>
            </div>
        </div>

        <!-- æ„è¦‹ç®±ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
            <h2 class="text-lg font-bold text-gray-900 mb-1">ğŸ’¬ ã”æ„è¦‹ãƒ»ã”è¦æœ›</h2>
            <p class="text-sm text-gray-500 mb-4">æ©Ÿèƒ½æ”¹å–„ã®ãŸã‚ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ï¼ˆLINEã‚ªãƒ¼ãƒ—ãƒ³ãƒãƒ£ãƒƒãƒˆï¼‰ã§ãœã²ã”æ„è¦‹ã‚’ãŠèã‹ã›ãã ã•ã„</p>

            <div style="background: linear-gradient(135deg, #06b6d4 0%, #3b82f6 100%); padding: 24px; border-radius: 12px; color: white; margin-top: 16px;">
                <div style="display: flex; align-items: start; gap: 16px;">
                    <div style="font-size: 48px; line-height: 1;">ğŸ’¡</div>
                    <div style="flex: 1;">
                        <h3 style="margin: 0 0 8px 0; font-size: 18px; font-weight: 600;">RentPipe ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£</h3>
                        <p style="margin: 0 0 16px 0; opacity: 0.95; line-height: 1.6;">
                            LINEã‚ªãƒ¼ãƒ—ãƒ³ãƒãƒ£ãƒƒãƒˆã§ã€æ©Ÿèƒ½ã®ã”è¦æœ›ã‚„ãƒã‚°å ±å‘Šã€æ”¹å–„æ¡ˆãªã©ã‚’ãŠæ°—è»½ã«ãŠå¯„ã›ãã ã•ã„ã€‚<br>
                            çš†æ§˜ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãŒã€ã‚ˆã‚Šè‰¯ã„ã‚µãƒ¼ãƒ“ã‚¹ã¥ãã‚Šã«å½¹ç«‹ã¡ã¾ã™ï¼
                        </p>
                        <a href="https://line.me/ti/g2/DsmrFz_36bh5BDMJ80DpDtNQ-0fjGDKx_cdoCg?utm_source=invitation&utm_medium=link_copy&utm_campaign=default"
                           target="_blank"
                           rel="noopener noreferrer"
                           style="display: inline-flex; align-items: center; gap: 8px; background: white; color: #06b6d4; padding: 12px 24px; border-radius: 8px; text-decoration: none; font-weight: 600; transition: transform 0.2s, box-shadow 0.2s;"
                           onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.2)';"
                           onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                            <span style="font-size: 20px;">ğŸ’¬</span>
                            <span>ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã«å‚åŠ ã™ã‚‹</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        </div><!-- /settings-content -->
    </div><!-- /settings-container -->

    <!-- ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal-overlay" id="confirmModal">
        <div class="modal">
            <h3 id="modalTitle">ç¢ºèª</h3>
            <div class="modal-content" id="modalContent">
                <p id="modalMessage">æœ¬å½“ã«å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ</p>
            </div>
            <div class="modal-buttons">
                <button class="action-btn secondary" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="action-btn danger" id="modalConfirmBtn" onclick="executeAction()">å®Ÿè¡Œã™ã‚‹</button>
            </div>
        </div>
    </div>

    <!-- ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/config.js"></script>
    <script src="js/feature-flags.js"></script>
    <script src="js/session-manager.js"></script>
    <script src="js/plan-manager.js"></script>
    <script src="js/supabase-google-sync.js"></script>
    <script src="js/navigation.js"></script>
    <script src="js/integrated-auth-manager-v2.js"></script>
    <script src="js/google-drive-api-v2.js"></script>
    <script src="js/google-sheets-api.js"></script>
    <script src="js/data-migration.js"></script>
    <script src="js/unified-sheets-manager.js"></script>
    <script src="js/unified-data-manager.js"></script>
    <script src="js/google-forms-api.js"></script>
    <script src="js/app-initializer.js"></script>

    <script>
        console.log('âš™ï¸ è¨­å®šãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿é–‹å§‹...');

        // ã‚¹ã‚±ãƒ«ãƒˆãƒ³é™¤å»ãƒ»ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è¡¨ç¤º
        function hideLoading() {
            const skeleton = document.getElementById('settings-skeleton');
            if (skeleton) skeleton.remove();
            const content = document.getElementById('settings-content');
            if (content) content.style.display = 'block';
        }

        // æœ€å¤§5ç§’ã§ã‚¹ã‚±ãƒ«ãƒˆãƒ³ã‚’å¼·åˆ¶é™¤å»ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
        setTimeout(hideLoading, 5000);

        let pendingAction = null;

        // ãƒšãƒ¼ã‚¸åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³è¡¨ç¤º
                loadNavigation();

                loadUISettings();

                if (window.IntegratedAuthManager && !window.IntegratedAuthManager.isInitialized) {
                    await window.IntegratedAuthManager.initialize();
                }

                await ensureAuthentication();

                if (window.AppInitializer) {
                    try {
                        await window.AppInitializer.initialize({ requireAuth: false });
                    } catch (e) {
                        console.warn('AppInitializeråˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', e);
                    }
                }

                if (window.GoogleFormsManager) {
                    await GoogleFormsManager.initialize();
                }

                updateAccountInfo();
                updateFormStatus();
                updateDataStats();
                loadPrivacySettings();

                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çµ‚äº†
                hideLoading();

            } catch (error) {
                console.error('è¨­å®šãƒšãƒ¼ã‚¸åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                hideLoading();
            }
        });

        // UIè¨­å®šã‚’èª­ã¿è¾¼ã¿
        function loadUISettings() {
            const settings = JSON.parse(localStorage.getItem('rentpipe_ui_settings') || '{}');
            const showStatsToggle = document.getElementById('showStatsToggle');
            if (showStatsToggle) {
                showStatsToggle.checked = settings.showStats !== false;
            }
        }

        // çµ±è¨ˆè¡¨ç¤ºã®ãƒˆã‚°ãƒ«
        function toggleStats() {
            const showStats = document.getElementById('showStatsToggle').checked;
            const settings = JSON.parse(localStorage.getItem('rentpipe_ui_settings') || '{}');
            settings.showStats = showStats;
            localStorage.setItem('rentpipe_ui_settings', JSON.stringify(settings));
        }

        // èªè¨¼ã‚’ç¢ºå®Ÿã«å¼•ãç¶™ã
        async function ensureAuthentication() {
            let accessToken = null;

            try {
                const googleAuthData = localStorage.getItem('google_auth_data');
                if (googleAuthData) {
                    const authData = JSON.parse(googleAuthData);
                    if (authData.accessToken) {
                        accessToken = authData.accessToken;
                    }
                }
            } catch (e) {}

            if (!accessToken) {
                const authState = window.IntegratedAuthManager?.getAuthState();
                accessToken = authState?.googleAuth?.accessToken;
            }

            if (accessToken && window.GoogleDriveAPIv2) {
                if (!window.GoogleDriveAPIv2.isInitialized) {
                    await window.GoogleDriveAPIv2.initialize();
                }
                window.GoogleDriveAPIv2.accessToken = accessToken;
                window.GoogleDriveAPIv2.isAuthenticated = true;
            }
        }

        // ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±ã‚’è¡¨ç¤º
        function updateAccountInfo() {
            const emailEl = document.getElementById('accountEmail');
            let email = window.IntegratedAuthManager?.getUserEmail() || '';

            if (!email) {
                try {
                    const googleAuthData = localStorage.getItem('google_auth_data');
                    if (googleAuthData) {
                        const authData = JSON.parse(googleAuthData);
                        email = authData.user?.email || authData.email || '';
                    }
                } catch (e) {}
            }

            if (emailEl) {
                emailEl.textContent = email || 'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±ã‚’å–å¾—ä¸­...';
            }
        }

        // ãƒ•ã‚©ãƒ¼ãƒ çŠ¶æ…‹ã‚’æ›´æ–°
        function updateFormStatus() {
            const statusEl = document.getElementById('formConfigStatus');
            const createBtn = document.getElementById('createFormBtn');
            const resetBtn = document.getElementById('resetFormBtn');
            const config = window.GoogleFormsManager?.formConfig;

            if (config && config.formId) {
                const createdAt = new Date(config.createdAt).toLocaleString('ja-JP');
                statusEl.className = 'form-config-status has-form';
                statusEl.innerHTML = `
                    <span class="config-icon">âœ…</span>
                    <div class="config-info">
                        <h3>ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆæ¸ˆã¿</h3>
                        <p>ä½œæˆæ—¥: ${createdAt}</p>
                    </div>
                `;
                createBtn.style.display = 'none';
                resetBtn.style.display = 'inline-flex';
            } else {
                statusEl.className = 'form-config-status no-form';
                statusEl.innerHTML = `
                    <span class="config-icon">ğŸ“‹</span>
                    <div class="config-info">
                        <h3>ãƒ•ã‚©ãƒ¼ãƒ æœªä½œæˆ</h3>
                        <p>ã€Œãƒ•ã‚©ãƒ¼ãƒ ã‚’ç”Ÿæˆã€ãƒœã‚¿ãƒ³ã§ä½œæˆã—ã¦ãã ã•ã„</p>
                    </div>
                `;
                createBtn.style.display = 'inline-flex';
                resetBtn.style.display = 'none';
            }
        }

        // ===== å€‹äººæƒ…å ±å–æ‰±ã„è¨­å®š =====
        let privacyThirdParties = []; // [{ id, name }]

        // èª¬æ˜æ–‡ã‚’ç”Ÿæˆï¼ˆgoogle-forms-api.js ã¨å…±æœ‰ã™ã‚‹ãŸã‚ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å®šç¾©ï¼‰
        window.buildPrivacyDescription = function(agentName, agentCompany, thirdParties) {
            const parties = (thirdParties || []).filter(p => p.name && p.name.trim());
            const lines = [];
            lines.push('ã“ã®ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã§ã”æä¾›ã„ãŸã ã„ãŸãŠå®¢æ§˜ã®å€‹äººæƒ…å ±ã¯ã€ãŠéƒ¨å±‹æ¢ã—ã«é–¢ã™ã‚‹ã”æ¡ˆå†…ã€ã”é€£çµ¡åŠã³' + (agentCompany || 'ï¼ˆä¼šç¤¾åæœªè¨­å®šï¼‰') + 'ã«ã‚ˆã‚‹ä»²ä»‹æ¥­å‹™ã®ãŸã‚ã«åˆ©ç”¨ã•ã›ã¦ã„ãŸã ãã¾ã™ã€‚');
            if (parties.length > 0) {
                const names = parties.map(p => p.name.trim()).join('ã€');
                lines.push('ã¾ãŸã€ãŠå®¢æ§˜ã®ã”è¦æœ›ã«å¿œã˜ãŸã”æ¡ˆå†…ã®ãŸã‚ã€' + names + 'ã«æƒ…å ±ã‚’æä¾›ã™ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚');
            }
            if (agentName) {
                lines.push('æ‹…å½“ï¼š' + agentName);
            }
            return lines.join('\n');
        };

        function renderThirdPartyList() {
            const list = document.getElementById('thirdPartyList');
            if (!list) return;
            if (privacyThirdParties.length === 0) {
                list.innerHTML = '';
                return;
            }
            list.innerHTML = privacyThirdParties.map((p, i) => `
                <div style="display: flex; align-items: center; gap: 8px;">
                    <input type="text" value="${p.name.replace(/"/g, '&quot;')}" placeholder="ä¾‹: ABCä»²ä»‹æ ªå¼ä¼šç¤¾"
                           style="flex: 1; border: 1px solid #d1d5db; border-radius: 8px; padding: 8px 12px; font-size: 14px;"
                           oninput="updateThirdParty(${i}, this.value)">
                    <button onclick="removeThirdParty(${i})"
                            style="background: none; border: none; color: #f87171; font-size: 18px; cursor: pointer; padding: 4px; line-height: 1;">âœ•</button>
                </div>
            `).join('');
        }

        function addThirdParty() {
            privacyThirdParties.push({ id: crypto.randomUUID(), name: '' });
            renderThirdPartyList();
        }

        function removeThirdParty(index) {
            privacyThirdParties.splice(index, 1);
            renderThirdPartyList();
            updatePrivacyPreview();
        }

        function updateThirdParty(index, value) {
            if (privacyThirdParties[index]) privacyThirdParties[index].name = value;
            updatePrivacyPreview();
        }

        function updatePrivacyPreview() {
            const agentName = (document.getElementById('privacyAgentName')?.value || '').trim();
            const company = (document.getElementById('privacyAgentCompany')?.value || '').trim();
            const parties = privacyThirdParties.filter(p => p.name.trim());
            const preview = document.getElementById('privacyPreview');
            if (preview) {
                if (!agentName && !company && parties.length === 0) {
                    preview.textContent = 'ï¼ˆæ‹…å½“è€…åãƒ»ä¼æ¥­åãƒ»æä¾›å…ˆã‚’å…¥åŠ›ã™ã‚‹ã¨è¡¨ç¤ºã•ã‚Œã¾ã™ï¼‰';
                } else {
                    preview.textContent = window.buildPrivacyDescription(agentName, company, parties);
                }
            }
        }

        async function loadPrivacySettings() {
            try {
                // ã¾ãš localStorage ã‹ã‚‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’èª­ã¿è¾¼ã‚€ï¼ˆé«˜é€Ÿè¡¨ç¤ºï¼‰
                const cached = localStorage.getItem('rentpipe_privacy_settings');
                if (cached) {
                    const settings = JSON.parse(cached);
                    document.getElementById('privacyAgentName').value = settings.agentName || '';
                    document.getElementById('privacyAgentCompany').value = settings.agentCompany || '';
                    privacyThirdParties = settings.thirdParties || [];
                    renderThirdPartyList();
                    updatePrivacyPreview();
                }

                // Supabase ã‹ã‚‰ã‚‚å–å¾—ï¼ˆæœ€æ–°ãƒ‡ãƒ¼ã‚¿ã§ä¸Šæ›¸ãï¼‰
                // plan-simple.js ã¨åŒã˜ã userId+email ã‚’ãƒœãƒ‡ã‚£ã§é€ã‚‹POSTãƒ‘ã‚¿ãƒ¼ãƒ³
                const savedUser = window.supabaseGoogleSync?.getSavedUser();
                if (!savedUser?.id || !savedUser?.email) return;

                const res2 = await fetch('/api/user/privacy-settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: savedUser.id, email: savedUser.email, _action: 'get' })
                });

                if (res2.ok) {
                    const { settings } = await res2.json();
                    if (settings) {
                        document.getElementById('privacyAgentName').value = settings.agentName || '';
                        document.getElementById('privacyAgentCompany').value = settings.agentCompany || '';
                        privacyThirdParties = settings.thirdParties || [];
                        renderThirdPartyList();
                        updatePrivacyPreview();
                        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æ›´æ–°
                        localStorage.setItem('rentpipe_privacy_settings', JSON.stringify(settings));
                    }
                }
            } catch (e) {
                console.warn('å€‹äººæƒ…å ±è¨­å®šèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
            }
        }

        async function savePrivacySettings() {
            const agentName = (document.getElementById('privacyAgentName')?.value || '').trim();
            const agentCompany = (document.getElementById('privacyAgentCompany')?.value || '').trim();
            const thirdParties = privacyThirdParties.filter(p => p.name.trim());

            const status = document.getElementById('privacySaveStatus');
            status.style.display = 'block';
            status.textContent = 'ä¿å­˜ä¸­...';
            status.style.color = '#6b7280';

            try {
                const savedUser = window.supabaseGoogleSync?.getSavedUser();
                if (!savedUser?.id || !savedUser?.email) {
                    throw new Error('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚å†åº¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚');
                }

                const res = await fetch('/api/user/privacy-settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: savedUser.id,
                        email: savedUser.email,
                        agentName,
                        agentCompany,
                        thirdParties
                    })
                });

                if (!res.ok) {
                    const errData = await res.json();
                    throw new Error(errData.error || 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }

                // localStorage ã«ã‚‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆãƒ•ã‚©ãƒ¼ãƒ ç”Ÿæˆæ™‚ã«ä½¿ç”¨ï¼‰
                localStorage.setItem('rentpipe_privacy_settings',
                    JSON.stringify({ agentName, agentCompany, thirdParties }));

                status.textContent = 'âœ… ä¿å­˜ã—ã¾ã—ãŸ';
                status.style.color = '#16a34a';
                updatePrivacyPreview();
            } catch (e) {
                console.error('å€‹äººæƒ…å ±è¨­å®šä¿å­˜ã‚¨ãƒ©ãƒ¼:', e);
                status.textContent = 'âŒ ' + e.message;
                status.style.color = '#dc2626';
            }
        }
        // ===== å€‹äººæƒ…å ±å–æ‰±ã„è¨­å®š ã“ã“ã¾ã§ =====

        // ãƒ•ã‚©ãƒ¼ãƒ ç”Ÿæˆ
        async function createForm() {
            const btn = document.getElementById('createFormBtn');
            const originalText = btn.innerHTML;

            try {
                const isAuthenticated = window.GoogleDriveAPIv2?.isAuthenticated ||
                                        window.IntegratedAuthManager?.getAuthState()?.googleAuth?.accessToken;
                if (!isAuthenticated) {
                    alert('âš ï¸ èªè¨¼ãŒå¿…è¦ã§ã™ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
                    return;
                }

                btn.disabled = true;
                btn.innerHTML = 'â³ ç”Ÿæˆä¸­...';

                await window.GoogleFormsManager.createForm();
                updateFormStatus();
                alert('âœ… ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‚’ç”Ÿæˆã—ã¾ã—ãŸï¼\n\nã€Œãƒ•ã‚©ãƒ¼ãƒ ã€ãƒšãƒ¼ã‚¸ã§URLã¨QRã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèªã§ãã¾ã™ã€‚');

            } catch (error) {
                console.error('ãƒ•ã‚©ãƒ¼ãƒ ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
                if (error.message === 'PRIVACY_NOT_SET') {
                    alert('âš ï¸ ãƒ•ã‚©ãƒ¼ãƒ ã‚’ç”Ÿæˆã™ã‚‹å‰ã«ã€Œå€‹äººæƒ…å ±å–æ‰±ã„è¨­å®šã€ã§æ‰€å±ä¼šç¤¾åã‚’å…¥åŠ›ãƒ»ä¿å­˜ã—ã¦ãã ã•ã„ã€‚\n\nç”»é¢ã‚’ä¸Šã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦ã€Œå€‹äººæƒ…å ±å–æ‰±ã„è¨­å®šã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ã”ç¢ºèªãã ã•ã„ã€‚');
                    document.getElementById('privacyAgentCompany')?.focus();
                    document.getElementById('privacyAgentCompany')?.scrollIntoView({ behavior: 'smooth', block: 'center' });
                } else {
                    alert('âŒ ãƒ•ã‚©ãƒ¼ãƒ ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                }
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆç¢ºèªï¼ˆè©³ç´°ãªè­¦å‘Šä»˜ãï¼‰
        function confirmResetForm() {
            pendingAction = 'resetForm';
            document.getElementById('modalTitle').textContent = 'âš ï¸ ãƒ•ã‚©ãƒ¼ãƒ è¨­å®šã‚’ãƒªã‚»ãƒƒãƒˆ';
            document.getElementById('modalContent').innerHTML = `
                <p>ãƒ•ã‚©ãƒ¼ãƒ è¨­å®šã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ</p>
                <div class="warning-list">
                    <h4>âš ï¸ ã“ã®æ“ä½œã‚’è¡Œã†ã¨:</h4>
                    <ul>
                        <li>RentPipeã¨ãƒ•ã‚©ãƒ¼ãƒ ã®é€£æºãŒè§£é™¤ã•ã‚Œã¾ã™</li>
                        <li>ã€Œãƒ•ã‚©ãƒ¼ãƒ ã€ãƒšãƒ¼ã‚¸ã§QRã‚³ãƒ¼ãƒ‰ãŒè¡¨ç¤ºã•ã‚Œãªããªã‚Šã¾ã™</li>
                        <li>æ–°ã—ã„ãƒ•ã‚©ãƒ¼ãƒ ã‚’ç”Ÿæˆã—ç›´ã™å¿…è¦ãŒã‚ã‚Šã¾ã™</li>
                    </ul>
                </div>
                <p style="font-size: 13px; color: #6b7280;">
                    â€» Googleãƒ‰ãƒ©ã‚¤ãƒ–ä¸Šã®ãƒ•ã‚©ãƒ¼ãƒ è‡ªä½“ã¯å‰Šé™¤ã•ã‚Œã¾ã›ã‚“
                </p>
            `;
            document.getElementById('confirmModal').classList.add('active');
        }

        // ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢ç¢ºèªï¼ˆè©³ç´°ãªè­¦å‘Šä»˜ãï¼‰
        function confirmClearData() {
            pendingAction = 'clearData';
            const customers = window.UnifiedDataManager?.getCustomers() || [];

            document.getElementById('modalTitle').textContent = 'âš ï¸ ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢';
            document.getElementById('modalContent').innerHTML = `
                <p>ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜ã•ã‚ŒãŸé¡§å®¢ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ</p>
                <div class="warning-list">
                    <h4>âš ï¸ ã“ã®æ“ä½œã‚’è¡Œã†ã¨:</h4>
                    <ul>
                        <li>ç¾åœ¨ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ <strong>${customers.length}ä»¶</strong> ã®é¡§å®¢ãƒ‡ãƒ¼ã‚¿ãŒãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰å‰Šé™¤ã•ã‚Œã¾ã™</li>
                        <li>æ¬¡å›ãƒšãƒ¼ã‚¸ã‚’é–‹ã„ãŸæ™‚ã«Google Sheetsã‹ã‚‰å†åŒæœŸã•ã‚Œã¾ã™</li>
                        <li>åŒæœŸå‰ã«ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã§è¿½åŠ ã—ãŸãƒ‡ãƒ¼ã‚¿ã¯å¤±ã‚ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™</li>
                    </ul>
                </div>
                <p style="font-size: 13px; color: #6b7280;">
                    â€» Google Sheetsä¸Šã®ãƒ‡ãƒ¼ã‚¿ã¯å‰Šé™¤ã•ã‚Œã¾ã›ã‚“
                </p>
            `;
            document.getElementById('confirmModal').classList.add('active');
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeModal() {
            document.getElementById('confirmModal').classList.remove('active');
            pendingAction = null;
        }

        // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
        async function executeAction() {
            if (pendingAction === 'resetForm') {
                await window.GoogleFormsManager.resetFormConfig();
                updateFormStatus();
                alert('âœ… ãƒ•ã‚©ãƒ¼ãƒ è¨­å®šã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
            } else if (pendingAction === 'clearData') {
                localStorage.removeItem('rentpipe_customers');
                updateDataStats();
                alert('âœ… ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ\n\næ¬¡å›ãƒšãƒ¼ã‚¸ã‚’é–‹ã„ãŸæ™‚ã«Google Sheetsã‹ã‚‰å†åŒæœŸã•ã‚Œã¾ã™ã€‚');
            }
            closeModal();
        }

        // ãƒ‡ãƒ¼ã‚¿çµ±è¨ˆã‚’æ›´æ–°
        function updateDataStats() {
            try {
                const customers = window.UnifiedDataManager?.getCustomers() || [];
                const active = customers.filter(c => c.isActive !== false);

                document.getElementById('totalCustomers').textContent = customers.length;
                document.getElementById('activeCustomers').textContent = active.length;

                const lastSyncTime = localStorage.getItem('rentpipe_last_sync');
                if (lastSyncTime) {
                    const date = new Date(lastSyncTime);
                    const now = new Date();
                    const diff = Math.floor((now - date) / 1000 / 60);
                    if (diff < 1) {
                        document.getElementById('lastSync').textContent = 'ä»Š';
                    } else if (diff < 60) {
                        document.getElementById('lastSync').textContent = diff + 'åˆ†å‰';
                    } else {
                        document.getElementById('lastSync').textContent = date.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
                    }
                } else {
                    document.getElementById('lastSync').textContent = '-';
                }
            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿çµ±è¨ˆæ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // ãƒ‡ãƒ¼ã‚¿åŒæœŸ
        async function syncData(event) {
            const btn = event.target;
            const originalText = btn.innerHTML;

            try {
                btn.disabled = true;
                btn.textContent = 'ğŸ”„ åŒæœŸä¸­...';

                if (window.UnifiedDataManager) {
                    const result = await UnifiedDataManager.syncFromSheetsImmediately();
                    if (result.success) {
                        localStorage.setItem('rentpipe_last_sync', new Date().toISOString());
                        updateDataStats();
                        alert('âœ… ãƒ‡ãƒ¼ã‚¿ã‚’åŒæœŸã—ã¾ã—ãŸ');
                    } else {
                        throw new Error(result.error || 'åŒæœŸã«å¤±æ•—ã—ã¾ã—ãŸ');
                    }
                }
            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿åŒæœŸã‚¨ãƒ©ãƒ¼:', error);
                alert('âŒ åŒæœŸã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // ãƒ—ãƒ©ãƒ³æƒ…å ±ã‚’æ›´æ–°
        async function updatePlanInfo() {
            try {
                // ãƒ™ãƒ¼ã‚¿ç‰ˆãƒãƒŠãƒ¼ã®è¡¨ç¤ºåˆ¶å¾¡
                const betaBanner = document.getElementById('betaBanner');
                if (betaBanner && window.featureFlags) {
                    if (window.featureFlags.isBetaMode()) {
                        betaBanner.style.display = 'block';
                    } else {
                        betaBanner.style.display = 'none';
                    }
                }

                if (!window.planManager) {
                    console.warn('PlanManager not available');
                    return;
                }

                await window.planManager.initialize();

                // Supabaseã‹ã‚‰æœ€æ–°ã®ãƒ—ãƒ©ãƒ³æƒ…å ±ã‚’å–å¾—
                await window.planManager.fetchPlan();

                const plan = window.planManager.getPlan();
                const isSignedIn = window.planManager.isSignedIn();

                const planNames = {
                    'free': 'Free',
                    'senior_agent': 'Senior Agent',
                    'top_agent': 'Top Agent'
                };

                const planFeatures = {
                    'free': [
                        'é¡§å®¢ç®¡ç†ï¼ˆç„¡åˆ¶é™ï¼‰',
                        'ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ç®¡ç†',
                        'Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é€£æºï¼ˆåŸºæœ¬ï¼‰'
                    ],
                    'senior_agent': [
                        'ã™ã¹ã¦ã®Freeæ©Ÿèƒ½',
                        'Googleãƒ•ã‚©ãƒ¼ãƒ é€£æº',
                        'Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é€£æºï¼ˆæ‹¡å¼µï¼‰',
                        'é€£çµ¡ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç®¡ç†'
                    ],
                    'top_agent': [
                        'ã™ã¹ã¦ã®Senior Agentæ©Ÿèƒ½',
                        'é«˜åº¦ãªåˆ†ææ©Ÿèƒ½',
                        'å„ªå…ˆã‚µãƒãƒ¼ãƒˆ'
                    ]
                };

                // ãƒ—ãƒ©ãƒ³åã‚’æ›´æ–°
                const planNameElement = document.getElementById('currentPlanName');
                if (planNameElement) {
                    planNameElement.textContent = planNames[plan] || 'Free';
                }

                // æ©Ÿèƒ½ãƒªã‚¹ãƒˆã‚’æ›´æ–°
                const featuresList = document.getElementById('planFeaturesList');
                if (featuresList) {
                    let features;
                    // ãƒ™ãƒ¼ã‚¿ç‰ˆãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯å…¨æ©Ÿèƒ½ã‚’è¡¨ç¤º
                    if (window.featureFlags && window.featureFlags.isBetaMode()) {
                        features = [
                            'é¡§å®¢ç®¡ç†ï¼ˆç„¡åˆ¶é™ï¼‰',
                            'ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ç®¡ç†',
                            'Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é€£æºï¼ˆåŸºæœ¬ãƒ»æ‹¡å¼µï¼‰',
                            'Googleãƒ•ã‚©ãƒ¼ãƒ é€£æº',
                            'é€£çµ¡ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç®¡ç†',
                            'ãƒ•ã‚©ãƒ­ãƒ¼ã‚¢ãƒƒãƒ—è‡ªå‹•åŒ–'
                        ];
                    } else {
                        features = planFeatures[plan] || planFeatures['free'];
                    }
                    featuresList.innerHTML = features.map(f => `<li>${f}</li>`).join('');
                }

                // ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºåˆ¶å¾¡
                const upgradeButton = document.getElementById('upgradeButton');
                const planComparison = document.getElementById('planComparison');

                // ãƒ™ãƒ¼ã‚¿ç‰ˆãƒ¢ãƒ¼ãƒ‰ã§ã¯ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
                if (window.featureFlags && window.featureFlags.isBetaMode()) {
                    if (upgradeButton) upgradeButton.style.display = 'none';
                    if (planComparison) planComparison.style.display = 'none';
                } else if (plan === 'free') {
                    if (upgradeButton) {
                        upgradeButton.style.display = 'block';
                        upgradeButton.onclick = () => {
                            planComparison.style.display = planComparison.style.display === 'none' ? 'block' : 'none';
                        };
                    }
                } else {
                    if (upgradeButton) upgradeButton.style.display = 'none';
                }

                // ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ç®¡ç†ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºåˆ¶å¾¡
                const subscriptionManagement = document.getElementById('subscriptionManagement');
                // ãƒ™ãƒ¼ã‚¿ç‰ˆãƒ¢ãƒ¼ãƒ‰ã§ã¯éè¡¨ç¤ºï¼ˆæ±ºæ¸ˆãŒç™ºç”Ÿã—ãªã„ãŸã‚ï¼‰
                if (window.featureFlags && window.featureFlags.isBetaMode()) {
                    if (subscriptionManagement) {
                        subscriptionManagement.style.display = 'none';
                    }
                } else if (plan !== 'free' && isSignedIn) {
                    if (subscriptionManagement) {
                        subscriptionManagement.style.display = 'block';
                    }
                } else {
                    if (subscriptionManagement) {
                        subscriptionManagement.style.display = 'none';
                    }
                }

            } catch (error) {
                console.error('ãƒ—ãƒ©ãƒ³æƒ…å ±æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // Stripe Checkout ã«ç§»å‹•
        async function handleUpgrade() {
            try {
                // ãƒ™ãƒ¼ã‚¿ç‰ˆãƒ¢ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯
                if (window.featureFlags && window.featureFlags.isBetaMode()) {
                    alert('ç¾åœ¨ãƒ™ãƒ¼ã‚¿ç‰ˆæœŸé–“ä¸­ã®ãŸã‚ã€å…¨æ©Ÿèƒ½ã‚’ç„¡æ–™ã§ã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã™ã€‚\n\næ­£å¼ç‰ˆãƒªãƒªãƒ¼ã‚¹æ™‚ã«æ”¹ã‚ã¦ãƒ—ãƒ©ãƒ³æ©Ÿèƒ½ã‚’ã”æ¡ˆå†…ã„ãŸã—ã¾ã™ã€‚\nã“ã®æœŸé–“ä¸­ã«å­˜åˆ†ã«ãŠè©¦ã—ãã ã•ã„ï¼');
                    return;
                }

                if (!window.planManager || !window.planManager.isSignedIn()) {
                    alert('ãƒ—ãƒ©ãƒ³ã‚’ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã™ã‚‹ã«ã¯ã€ã¾ãšSupabaseã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚');
                    return;
                }

                // localStorageã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
                const savedUser = window.supabaseGoogleSync?.getSavedUser();
                if (!savedUser || !savedUser.id || !savedUser.email) {
                    alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚å†åº¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚');
                    return;
                }

                // Stripe Price IDï¼ˆconfig.js çµŒç”±ã§ç’°å¢ƒå¤‰æ•°ã‹ã‚‰æ³¨å…¥ï¼‰
                const priceId = window.STRIPE_PRICE_SENIOR_AGENT;
                if (!priceId) {
                    alert('æ±ºæ¸ˆè¨­å®šãŒæœªå®Œäº†ã§ã™ã€‚ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚');
                    return;
                }

                console.log('Creating checkout session for:', savedUser.email);

                const response = await fetch('/api/stripe/create-checkout-simple', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        userId: savedUser.id,
                        email: savedUser.email,
                        priceId: priceId,
                        planName: 'Senior Agent'
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to create checkout session');
                }

                const data = await response.json();
                console.log('Checkout session created:', data.sessionId);

                // Stripeãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
                window.location.href = data.url;

            } catch (error) {
                console.error('ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
                alert('ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        // ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ç®¡ç†ãƒãƒ¼ã‚¿ãƒ«ã‚’é–‹ã
        async function handleManageBilling() {
            try {
                // localStorageã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
                const savedUser = window.supabaseGoogleSync?.getSavedUser();
                if (!savedUser || !savedUser.id || !savedUser.email) {
                    alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚å†åº¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚');
                    return;
                }

                console.log('Creating billing portal session for:', savedUser.email);

                const response = await fetch('/api/stripe/create-portal-simple', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        userId: savedUser.id,
                        email: savedUser.email,
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to create portal session');
                }

                const data = await response.json();
                console.log('Billing portal session created');

                // Stripeè«‹æ±‚ç®¡ç†ãƒãƒ¼ã‚¿ãƒ«ã‚’æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ã
                window.open(data.url, '_blank');

                // æ•°ç§’å¾Œã«ãƒ—ãƒ©ãƒ³æƒ…å ±ã‚’æ›´æ–°ï¼ˆã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ãŸå ´åˆã®åæ˜ ï¼‰
                setTimeout(async () => {
                    console.log('ãƒ—ãƒ©ãƒ³æƒ…å ±ã‚’æ›´æ–°ä¸­...');
                    await updatePlanInfo();
                }, 3000);

            } catch (error) {
                console.error('ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ç®¡ç†ã‚¨ãƒ©ãƒ¼:', error);
                alert('ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ç®¡ç†ç”»é¢ã®è¡¨ç¤ºä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
        document.addEventListener('DOMContentLoaded', () => {
            const upgradeSeniorButton = document.getElementById('upgradeSeniorButton');
            if (upgradeSeniorButton) {
                upgradeSeniorButton.onclick = handleUpgrade;
            }

            const manageBillingButton = document.getElementById('manageBillingButton');
            if (manageBillingButton) {
                manageBillingButton.onclick = handleManageBilling;
            }

            // ãƒ—ãƒ©ãƒ³æƒ…å ±ã‚’æ›´æ–°
            updatePlanInfo();

            // ãƒšãƒ¼ã‚¸ãŒå†åº¦è¡¨ç¤ºã•ã‚ŒãŸã¨ãã«ãƒ—ãƒ©ãƒ³æƒ…å ±ã‚’æ›´æ–°
            // ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒåˆ¥ã‚¿ãƒ–ã‹ã‚‰æˆ»ã£ã¦ããŸã¨ãï¼‰
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden) {
                    console.log('ãƒšãƒ¼ã‚¸ãŒå†è¡¨ç¤ºã•ã‚Œã¾ã—ãŸã€‚ãƒ—ãƒ©ãƒ³æƒ…å ±ã‚’æ›´æ–°ä¸­...');
                    setTimeout(() => {
                        updatePlanInfo();
                    }, 1000);
                }
            });
        });

        console.log('âœ… è¨­å®šãƒšãƒ¼ã‚¸æº–å‚™å®Œäº†');
    </script>
</body>
</html>
