<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/svg+xml" href="img/logo-icon.svg">
    <title>ãƒ‡ãƒ¼ã‚¿ç®¡ç† | RentPipe</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/tailwind-output.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', sans-serif;
            background: #f9fafb;
            color: #111827;
            margin: 0;
            padding: 0;
        }

        .page-container {
            max-width: 720px;
            margin: 0 auto;
            padding: 24px 16px 60px;
        }

        .page-header {
            margin-bottom: 24px;
        }

        .page-title {
            font-size: 22px;
            font-weight: 700;
            color: #1f2937;
            margin: 0 0 4px 0;
        }

        .page-desc {
            font-size: 14px;
            color: #6b7280;
            margin: 0;
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            border: 1px solid #f3f4f6;
            margin-bottom: 16px;
        }

        .card-title {
            font-size: 16px;
            font-weight: 700;
            color: #1f2937;
            margin: 0 0 16px 0;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 16px;
        }

        .action-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
        }

        .action-btn.primary {
            background: #3d4e6b;
            color: white;
        }

        .action-btn.primary:hover {
            background: #2e3c52;
        }

        .action-btn.secondary {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
        }

        .action-btn.secondary:hover {
            background: #e5e7eb;
        }

        .action-btn.danger {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }

        .action-btn.danger:hover {
            background: #fee2e2;
        }

        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ãƒ‡ãƒ¼ã‚¿çµ±è¨ˆ */
        .data-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .data-stat {
            background: #f8fafc;
            padding: 16px;
            border-radius: 10px;
            text-align: center;
        }

        .data-stat .value {
            font-size: 28px;
            font-weight: 700;
            color: #3d4e6b;
        }

        .data-stat .label {
            font-size: 12px;
            color: #6b7280;
            margin-top: 4px;
        }

        /* æ³¨æ„æ›¸ã */
        .notice {
            background: #fffbeb;
            border: 1px solid #fcd34d;
            border-radius: 8px;
            padding: 14px 16px;
            margin-top: 16px;
        }

        .notice h4 {
            margin: 0 0 8px 0;
            color: #92400e;
            font-size: 14px;
        }

        .notice ul {
            margin: 0;
            padding-left: 18px;
            color: #78350f;
            font-size: 13px;
        }

        .notice li {
            margin-bottom: 4px;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 12px;
            padding: 24px;
            max-width: 480px;
            width: 90%;
        }

        .modal h3 {
            margin: 0 0 14px 0;
            color: #1f2937;
        }

        .modal-content {
            color: #4b5563;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .modal-content p { margin: 0 0 10px 0; }

        .modal-content .warning-list {
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 8px;
            padding: 12px 16px;
            margin: 10px 0;
        }

        .modal-content .warning-list h4 {
            margin: 0 0 8px 0;
            color: #dc2626;
            font-size: 14px;
        }

        .modal-content .warning-list ul {
            margin: 0;
            padding-left: 18px;
            font-size: 13px;
            color: #7f1d1d;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
    </style>
</head>
<body>
    <div id="navigation"></div>

    <div class="page-container">
        <div class="page-header">
            <h1 class="page-title">ğŸ“Š ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h1>
            <p class="page-desc">é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã®çŠ¶æ…‹ç¢ºèªãƒ»åŒæœŸãƒ»ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’è¡Œã„ã¾ã™</p>
        </div>

        <!-- çµ±è¨ˆã‚«ãƒ¼ãƒ‰ -->
        <div class="card">
            <h2 class="card-title">ãƒ‡ãƒ¼ã‚¿æ¦‚è¦</h2>
            <div class="data-info">
                <div class="data-stat">
                    <div class="value" id="totalCustomers">-</div>
                    <div class="label">é¡§å®¢æ•°</div>
                </div>
                <div class="data-stat">
                    <div class="value" id="activeCustomers">-</div>
                    <div class="label">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–</div>
                </div>
                <div class="data-stat">
                    <div class="value" id="lastSync">-</div>
                    <div class="label">æœ€çµ‚åŒæœŸ</div>
                </div>
            </div>

            <div class="action-buttons">
                <button class="action-btn secondary" onclick="syncData(event)">
                    ğŸ”„ ãƒ‡ãƒ¼ã‚¿ã‚’åŒæœŸ
                </button>
            </div>
        </div>

        <!-- ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚«ãƒ¼ãƒ‰ -->
        <div class="card">
            <h2 class="card-title">ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h2>
            <p style="font-size:14px;color:#6b7280;margin:0 0 16px;">CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚„ä»–ã®ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã‚’å–ã‚Šè¾¼ã¿ã¾ã™ã€‚</p>
            <div class="action-buttons">
                <a href="customer-import.html" class="action-btn primary">
                    ğŸ“¥ é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                </a>
            </div>
        </div>

        <!-- å±é™ºã‚¾ãƒ¼ãƒ³ -->
        <div class="card" style="border-color:#fecaca;">
            <h2 class="card-title" style="color:#dc2626;">âš ï¸ å±é™ºãªæ“ä½œ</h2>
            <p style="font-size:14px;color:#6b7280;margin:0 0 16px;">ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã€‚Google Sheetsã®ãƒ‡ãƒ¼ã‚¿ã«ã¯å½±éŸ¿ã—ã¾ã›ã‚“ã€‚</p>
            <div class="action-buttons">
                <button class="action-btn danger" onclick="confirmClearData()">
                    ğŸ—‘ï¸ ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
                </button>
            </div>
            <div class="notice">
                <h4>ğŸ’¡ ã‚¯ãƒªã‚¢å¾Œã®å‹•ä½œ</h4>
                <ul>
                    <li>æ¬¡å›ãƒšãƒ¼ã‚¸ã‚’é–‹ã„ãŸéš›ã«Google Sheetsã‹ã‚‰è‡ªå‹•ã§å†åŒæœŸã•ã‚Œã¾ã™</li>
                    <li>Google Sheetsä¸Šã®ãƒ‡ãƒ¼ã‚¿ã¯å‰Šé™¤ã•ã‚Œã¾ã›ã‚“</li>
                    <li>åŒæœŸå‰ã«ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã§è¿½åŠ ã—ãŸãƒ‡ãƒ¼ã‚¿ã¯å¤±ã‚ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal-overlay" id="confirmModal">
        <div class="modal">
            <h3 id="modalTitle">ç¢ºèª</h3>
            <div class="modal-content" id="modalContent">
                <p id="modalMessage">æœ¬å½“ã«å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ</p>
            </div>
            <div class="modal-buttons">
                <button class="action-btn secondary" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="action-btn danger" id="modalConfirmBtn" onclick="executeAction()">å®Ÿè¡Œã™ã‚‹</button>
            </div>
        </div>
    </div>

    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/config.js"></script>
    <script src="js/feature-flags.js"></script>
    <script src="js/session-manager.js"></script>
    <script src="js/plan-manager.js"></script>
    <script src="js/supabase-google-sync.js"></script>
    <script src="js/navigation.js"></script>
    <script src="js/integrated-auth-manager-v2.js"></script>
    <script src="js/google-drive-api-v2.js"></script>
    <script src="js/google-sheets-api.js"></script>
    <script src="js/data-migration.js"></script>
    <script src="js/unified-sheets-manager.js"></script>
    <script src="js/unified-data-manager.js"></script>
    <script src="js/app-initializer.js"></script>

    <script>
        let pendingAction = null;

        // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³è¡¨ç¤º
        document.addEventListener('DOMContentLoaded', () => {
            loadNavigation();
            // AppInitializer å®Œäº†å¾Œã«çµ±è¨ˆã‚’æ›´æ–°
            if (window.AppInitializer && window.AppInitializer.initializationPromise) {
                window.AppInitializer.initializationPromise.then(() => {
                    updateDataStats();
                });
            } else {
                setTimeout(updateDataStats, 500);
            }
        });

        // ãƒ‡ãƒ¼ã‚¿çµ±è¨ˆã‚’æ›´æ–°
        function updateDataStats() {
            try {
                const customers = window.UnifiedDataManager?.getCustomers() || [];
                const active = customers.filter(c => c.isActive !== false);

                document.getElementById('totalCustomers').textContent = customers.length;
                document.getElementById('activeCustomers').textContent = active.length;

                const lastSyncTime = localStorage.getItem('rentpipe_last_sync');
                if (lastSyncTime) {
                    const date = new Date(lastSyncTime);
                    const now = new Date();
                    const diff = Math.floor((now - date) / 1000 / 60);
                    if (diff < 1) {
                        document.getElementById('lastSync').textContent = 'ä»Š';
                    } else if (diff < 60) {
                        document.getElementById('lastSync').textContent = diff + 'åˆ†å‰';
                    } else {
                        document.getElementById('lastSync').textContent = date.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
                    }
                } else {
                    document.getElementById('lastSync').textContent = '-';
                }
            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿çµ±è¨ˆæ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // ãƒ‡ãƒ¼ã‚¿åŒæœŸ
        async function syncData(event) {
            const btn = event.target;
            const originalText = btn.innerHTML;
            try {
                btn.disabled = true;
                btn.textContent = 'ğŸ”„ åŒæœŸä¸­...';
                if (window.UnifiedDataManager) {
                    const result = await UnifiedDataManager.syncFromSheetsImmediately();
                    if (result.success) {
                        localStorage.setItem('rentpipe_last_sync', new Date().toISOString());
                        updateDataStats();
                        alert('âœ… ãƒ‡ãƒ¼ã‚¿ã‚’åŒæœŸã—ã¾ã—ãŸ');
                    } else {
                        throw new Error(result.error || 'åŒæœŸã«å¤±æ•—ã—ã¾ã—ãŸ');
                    }
                }
            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿åŒæœŸã‚¨ãƒ©ãƒ¼:', error);
                alert('âŒ åŒæœŸã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢ç¢ºèª
        function confirmClearData() {
            pendingAction = 'clearData';
            const customers = window.UnifiedDataManager?.getCustomers() || [];
            document.getElementById('modalTitle').textContent = 'âš ï¸ ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢';
            document.getElementById('modalContent').innerHTML = `
                <p>ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜ã•ã‚ŒãŸé¡§å®¢ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ</p>
                <div class="warning-list">
                    <h4>âš ï¸ ã“ã®æ“ä½œã‚’è¡Œã†ã¨:</h4>
                    <ul>
                        <li>ç¾åœ¨ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ <strong>${customers.length}ä»¶</strong> ã®é¡§å®¢ãƒ‡ãƒ¼ã‚¿ãŒãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰å‰Šé™¤ã•ã‚Œã¾ã™</li>
                        <li>æ¬¡å›ãƒšãƒ¼ã‚¸ã‚’é–‹ã„ãŸæ™‚ã«Google Sheetsã‹ã‚‰å†åŒæœŸã•ã‚Œã¾ã™</li>
                        <li>åŒæœŸå‰ã«ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã§è¿½åŠ ã—ãŸãƒ‡ãƒ¼ã‚¿ã¯å¤±ã‚ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™</li>
                    </ul>
                </div>
                <p style="font-size:13px;color:#6b7280;">â€» Google Sheetsä¸Šã®ãƒ‡ãƒ¼ã‚¿ã¯å‰Šé™¤ã•ã‚Œã¾ã›ã‚“</p>
            `;
            document.getElementById('confirmModal').classList.add('active');
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeModal() {
            document.getElementById('confirmModal').classList.remove('active');
            pendingAction = null;
        }

        // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
        async function executeAction() {
            if (pendingAction === 'clearData') {
                localStorage.removeItem('rentpipe_customers');
                updateDataStats();
                alert('âœ… ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ\n\næ¬¡å›ãƒšãƒ¼ã‚¸ã‚’é–‹ã„ãŸæ™‚ã«Google Sheetsã‹ã‚‰å†åŒæœŸã•ã‚Œã¾ã™ã€‚');
            }
            closeModal();
        }
    </script>
</body>
</html>
