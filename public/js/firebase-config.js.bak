// Firebaseè¨­å®š - æœ¬ç•ªãƒ¢ãƒ¼ãƒ‰ï¼ˆPhase2ï¼‰æ–°APIã‚­ãƒ¼ç‰ˆ
console.log('ðŸ”§ RentPipe Phase2æœ¬ç•ªãƒ¢ãƒ¼ãƒ‰ã§èµ·å‹•ä¸­...');

// è¨­å®šãƒ•ãƒ©ã‚°
const DEMO_MODE = false; // Phase2: æœ¬ç•ªãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ
const DEBUG_MODE = true;

// ç„¡é™ãƒ«ãƒ¼ãƒ—é˜²æ­¢
const urlParams = new URLSearchParams(window.location.search);
const fallbackRequested = urlParams.has('fallback');

if (!DEMO_MODE && !fallbackRequested) {
    console.log('ðŸ”¥ æœ¬ç•ªãƒ¢ãƒ¼ãƒ‰: FirebaseæŽ¥ç¶šé–‹å§‹...');
    
    // Firebaseæœ¬ç•ªè¨­å®šï¼ˆåˆ¶é™ãªã—æ–°APIã‚­ãƒ¼ï¼‰
    const firebaseConfig = {
        apiKey: "AIzaSyBvJGdan0lvVSkaAbbSXQkoh6YyPoGyTgM",
        authDomain: "rentpipe-ab04e.firebaseapp.com",
        projectId: "rentpipe-ab04e",
        storageBucket: "rentpipe-ab04e.firebasestorage.app",
        messagingSenderId: "586040985916",
        appId: "1:586040985916:web:3cdb5db072f1a6569fb639"
    };

    try {
        // FirebaseåˆæœŸåŒ–
        if (typeof firebase !== 'undefined') {
            const app = firebase.initializeApp(firebaseConfig);
            window.db = firebase.firestore();
            window.auth = firebase.auth();
            
            console.log('âœ… FirebaseåˆæœŸåŒ–æˆåŠŸ');
            console.log(`ðŸ¢ Project ID: ${firebaseConfig.projectId}`);
            console.log(`ðŸ”‘ APIã‚­ãƒ¼: ${firebaseConfig.apiKey.substring(0, 20)}...`);
            
            // æŽ¥ç¶šãƒ†ã‚¹ãƒˆï¼ˆéžåŒæœŸãƒ»ã‚¨ãƒ©ãƒ¼ã§ã‚‚ç¶šè¡Œï¼‰
            window.db.collection('system').doc('connection-test').get()
                .then((doc) => {
                    console.log('âœ… FirestoreæŽ¥ç¶šç¢ºèªå®Œäº†');
                    console.log(`ðŸ“Š æŽ¥ç¶šãƒ†ã‚¹ãƒˆçµæžœ: exists=${doc.exists}`);
                })
                .catch(error => {
                    console.warn('âš ï¸ FirestoreæŽ¥ç¶šãƒ†ã‚¹ãƒˆ:', error.message);
                });
            
        } else {
            throw new Error('Firebase SDKãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
        }
        
    } catch (error) {
        console.error('âŒ FirebaseåˆæœŸåŒ–å¤±æ•—:', error);
        console.log('ðŸ”„ ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ã§ç¶šè¡Œã—ã¾ã™...');
        initializeDemoMode();
    }
    
} else {
    console.log('ðŸ“± ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰: ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã§å‹•ä½œã—ã¾ã™');
    initializeDemoMode();
}

// ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰åˆæœŸåŒ–é–¢æ•°
function initializeDemoMode() {
    window.db = {
        collection: function(name) {
            if (DEBUG_MODE) console.log(`ðŸ“Š ãƒ‡ãƒ¢: ${name}ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚¢ã‚¯ã‚»ã‚¹`);
            return {
                orderBy: function() { return this; },
                limit: function() { return this; },
                get: function() {
                    if (DEBUG_MODE) console.log('ðŸ“Š ãƒ‡ãƒ¢: ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆç©ºã®çµæžœï¼‰');
                    return Promise.resolve({
                        docs: [],
                        size: 0,
                        empty: true,
                        map: function() { return []; },
                        forEach: function() {}
                    });
                },
                add: function(data) {
                    if (DEBUG_MODE) console.log('ðŸ“Š ãƒ‡ãƒ¢: ãƒ‡ãƒ¼ã‚¿è¿½åŠ ', data);
                    return Promise.resolve({ 
                        id: `demo-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`
                    });
                },
                doc: function(id) {
                    return {
                        get: function() {
                            return Promise.resolve({ 
                                exists: false, 
                                data: () => null,
                                id: id
                            });
                        },
                        set: function(data) {
                            if (DEBUG_MODE) console.log('ðŸ“Š ãƒ‡ãƒ¢: ãƒ‡ãƒ¼ã‚¿è¨­å®š', id, data);
                            return Promise.resolve();
                        },
                        update: function(data) {
                            if (DEBUG_MODE) console.log('ðŸ“Š ãƒ‡ãƒ¢: ãƒ‡ãƒ¼ã‚¿æ›´æ–°', id, data);
                            return Promise.resolve();
                        },
                        delete: function() {
                            if (DEBUG_MODE) console.log('ðŸ“Š ãƒ‡ãƒ¢: ãƒ‡ãƒ¼ã‚¿å‰Šé™¤', id);
                            return Promise.resolve();
                        }
                    };
                }
            };
        }
    };
    
    window.auth = {
        onAuthStateChanged: function(callback) {
            setTimeout(() => callback(null), 100);
        },
        signInAnonymously: function() {
            return Promise.resolve({ 
                user: { 
                    uid: 'demo-user-' + Date.now(),
                    isAnonymous: true,
                    metadata: {
                        creationTime: new Date().toISOString()
                    },
                    providerData: []
                } 
            });
        },
        get currentUser() {
            return null;
        }
    };
    
    window.firebase = {
        initializeApp: function() { return { name: '[DEFAULT]', options: { projectId: 'demo' } }; },
        firestore: function() { return window.db; },
        auth: function() { return window.auth; }
    };
    
    console.log('âœ… ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰åˆæœŸåŒ–å®Œäº†');
}

// ãƒžãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆå¯¾å¿œãƒ‡ãƒ¼ã‚¿ãƒžãƒãƒ¼ã‚¸ãƒ£ãƒ¼ï¼ˆPhase2ç‰ˆï¼‰
window.FirebaseDataManager = {
    getCurrentTenantId: function() {
        if (window.auth && window.auth.currentUser) {
            return window.auth.currentUser.uid;
        }
        return 'demo-tenant-001';
    },
    
    getCustomers: async function() {
        try {
            if (DEMO_MODE || fallbackRequested) {
                // ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ï¼šãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰å–å¾—
                const stored = localStorage.getItem('rentpipe_demo_customers');
                return stored ? JSON.parse(stored) : [];
            }
            
            // æœ¬ç•ªãƒ¢ãƒ¼ãƒ‰ï¼šFirestoreã‹ã‚‰å–å¾—
            const tenantId = this.getCurrentTenantId();
            if (!tenantId || tenantId === 'demo-tenant-001') {
                console.warn('æœ‰åŠ¹ãªãƒ†ãƒŠãƒ³ãƒˆIDãŒã‚ã‚Šã¾ã›ã‚“');
                return [];
            }
            
            const snapshot = await window.db
                .collection(`tenants/${tenantId}/customers`)
                .orderBy('updatedAt', 'desc')
                .get();
            
            const customers = [];
            snapshot.forEach(doc => {
                customers.push({
                    id: doc.id,
                    ...doc.data()
                });
            });
            
            console.log(`âœ… Firestoreé¡§å®¢ãƒ‡ãƒ¼ã‚¿å–å¾—: ${customers.length}ä»¶`);
            return customers;
            
        } catch (error) {
            console.error('é¡§å®¢ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            return [];
        }
    },
    
    saveCustomer: async function(customerData) {
        try {
            if (DEMO_MODE || fallbackRequested) {
                // ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ï¼šãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
                const customers = await this.getCustomers();
                const existingIndex = customers.findIndex(c => c.id === customerData.id);
                
                if (existingIndex !== -1) {
                    customers[existingIndex] = customerData;
                } else {
                    customers.push(customerData);
                }
                
                localStorage.setItem('rentpipe_demo_customers', JSON.stringify(customers));
                return customerData.id || `customer_${Date.now()}`;
            }
            
            // æœ¬ç•ªãƒ¢ãƒ¼ãƒ‰ï¼šFirestoreã«ä¿å­˜
            const tenantId = this.getCurrentTenantId();
            if (!tenantId || tenantId === 'demo-tenant-001') {
                throw new Error('æœ‰åŠ¹ãªãƒ†ãƒŠãƒ³ãƒˆIDãŒã‚ã‚Šã¾ã›ã‚“');
            }
            
            const docRef = customerData.id ? 
                window.db.collection(`tenants/${tenantId}/customers`).doc(customerData.id) :
                window.db.collection(`tenants/${tenantId}/customers`).doc();
            
            const saveData = {
                ...customerData,
                tenantId: tenantId,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                ...(customerData.id ? {} : { 
                    id: docRef.id,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp() 
                })
            };
            
            await docRef.set(saveData, { merge: true });
            console.log(`âœ… Firestoreé¡§å®¢ãƒ‡ãƒ¼ã‚¿ä¿å­˜å®Œäº†: ${docRef.id}`);
            return docRef.id;
            
        } catch (error) {
            console.error('é¡§å®¢ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
            return false;
        }
    },
    
    testConnection: async function() {
        try {
            if (DEMO_MODE || fallbackRequested) {
                console.log('ðŸ“± ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ï¼šæŽ¥ç¶šãƒ†ã‚¹ãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—');
                return true;
            }
            
            if (!window.db) {
                return false;
            }
            
            await window.db.collection('system').doc('connection-test').get();
            console.log('âœ… FirebaseæŽ¥ç¶šãƒ†ã‚¹ãƒˆæˆåŠŸ');
            return true;
            
        } catch (error) {
            console.error('âŒ FirebaseæŽ¥ç¶šãƒ†ã‚¹ãƒˆå¤±æ•—:', error);
            return false;
        }
    }
};

// å®‰å…¨ãªåˆæœŸåŒ–
document.addEventListener('DOMContentLoaded', function() {
    console.log('ðŸš€ RentPipe Phase2 å®‰å…¨åˆæœŸåŒ–é–‹å§‹...');
    
    // é…å»¶å®Ÿè¡Œã§å®‰å…¨æ€§ã‚’ç¢ºä¿
    setTimeout(() => {
        if (window.FirebaseDataManager) {
            window.FirebaseDataManager.testConnection()
                .then(result => {
                    console.log(`ðŸ”— æŽ¥ç¶šçŠ¶æ³: ${result ? 'FirebaseæˆåŠŸ' : 'ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ç¶™ç¶š'}`);
                })
                .catch(error => {
                    console.warn('æŽ¥ç¶šãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚¨ãƒ©ãƒ¼:', error.message);
                });
        }
    }, 1000);
    
    console.log('âœ… RentPipe Phase2 æº–å‚™å®Œäº†');
});

console.log('ðŸŽ‰ Firebase Phase2è¨­å®šãƒ­ãƒ¼ãƒ‰å®Œäº†ï¼ˆæ–°APIã‚­ãƒ¼ç‰ˆï¼‰');
