<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¡§å®¢ç®¡ç†ï¼ˆç°¡æ˜“ç‰ˆï¼‰ - RentPipe</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <header>
        <div class="header-content">
            <h1>ğŸ  RentPipe</h1>
            <nav class="nav-container">
                <a href="index.html">ãƒ›ãƒ¼ãƒ </a>
                <a href="customer.html">é¡§å®¢ç®¡ç†</a>
                <a href="customer-minimal.html" class="active">ç°¡æ˜“ç‰ˆ</a>
                <a href="pipeline.html">ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³</a>
                <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                <div class="nav-user-info"></div>
                <button onclick="handleLogout()" class="btn btn-outline nav-logout">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            </nav>
        </div>
    </header>

    <main class="main-content">
        <div class="page-header">
            <h2>ğŸ‘¥ é¡§å®¢ç®¡ç†ï¼ˆç°¡æ˜“ç‰ˆï¼‰</h2>
            <p>ã‚·ãƒ³ãƒ—ãƒ«ãªé¡§å®¢æƒ…å ±ã®è¡¨ç¤º</p>
        </div>

        <!-- èªè¨¼çŠ¶æ…‹è¡¨ç¤º -->
        <div id="auth-status" style="margin: 1rem 0; padding: 1rem; border-radius: 8px; background: #f3f4f6;"></div>

        <!-- é¡§å®¢ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div id="customer-data-status" style="margin: 1rem 0; padding: 1rem; border-radius: 8px; background: #e5f3ff;">
            <h3>ğŸ“Š ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿çŠ¶æ³</h3>
            <p id="data-loading-info">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
        </div>

        <!-- é¡§å®¢ãƒªã‚¹ãƒˆ -->
        <div id="customer-simple-list" class="customer-grid">
            <!-- é¡§å®¢ã‚«ãƒ¼ãƒ‰ãŒã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã¾ã™ -->
        </div>
    </main>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <script>
        // ğŸ”§ customer-minimal.html çµ±åˆèªè¨¼ã‚·ã‚¹ãƒ†ãƒ 
        console.log('ğŸš€ Customer Minimal çµ±åˆèªè¨¼ç‰ˆ åˆæœŸåŒ–é–‹å§‹');

        // Firebaseè¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyBvJGdan0lvVSkaAbbSXQkoh6YyPoGyTgM",
            authDomain: "rentpipe-ab04e.firebaseapp.com",
            projectId: "rentpipe-ab04e",
            storageBucket: "rentpipe-ab04e.firebasestorage.app",
            messagingSenderId: "586040985916",
            appId: "1:586040985916:web:3cdb5db072f1a6569fb639"
        };
        firebase.initializeApp(firebaseConfig);

        // çµ±åˆèªè¨¼ã‚·ã‚¹ãƒ†ãƒ 
        const IntegratedAuth = {
            // è¤‡æ•°ã®èªè¨¼æ–¹å¼ã‹ã‚‰çµ±ä¸€ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
            getAuthenticatedUser: function() {
                console.log('ğŸ” çµ±åˆèªè¨¼ãƒã‚§ãƒƒã‚¯é–‹å§‹...');
                
                // æ–¹æ³•1: simple-reliable-authæ–¹å¼
                const authSimple = localStorage.getItem('rentpipe_auth_simple');
                const userSimple = localStorage.getItem('rentpipe_user_simple');
                
                if (authSimple === 'logged_in' && userSimple) {
                    try {
                        const user = JSON.parse(userSimple);
                        console.log('âœ… simple-reliable-authæ–¹å¼ã§èªè¨¼ç¢ºèª:', user.email);
                        return { method: 'simple-reliable-auth', user: user };
                    } catch (e) {
                        console.warn('simple-reliable-auth ãƒ‡ãƒ¼ã‚¿ãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼:', e);
                    }
                }
                
                // æ–¹æ³•2: Googleèªè¨¼ãƒ•ãƒ©ã‚°æ–¹å¼
                const tempAuth = localStorage.getItem('rentpipe_temp_auth');
                const userInfo = localStorage.getItem('rentpipe_user_info');
                
                if (tempAuth === 'google_authenticated' && userInfo) {
                    try {
                        const user = JSON.parse(userInfo);
                        console.log('âœ… Googleèªè¨¼ãƒ•ãƒ©ã‚°æ–¹å¼ã§èªè¨¼ç¢ºèª:', user.email);
                        
                        // èªè¨¼ãƒ‡ãƒ¼ã‚¿ã‚’ simple-reliable-auth å½¢å¼ã«çµ±ä¸€
                        this.unifyAuthData(user);
                        
                        return { method: 'google-auth-flag', user: user };
                    } catch (e) {
                        console.warn('Googleèªè¨¼ãƒ‡ãƒ¼ã‚¿ãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼:', e);
                    }
                }
                
                // æ–¹æ³•3: Firebaseèªè¨¼ï¼ˆéåŒæœŸï¼‰
                return new Promise((resolve) => {
                    firebase.auth().onAuthStateChanged((user) => {
                        if (user) {
                            console.log('âœ… Firebaseèªè¨¼ã§èªè¨¼ç¢ºèª:', user.email);
                            
                            const userData = {
                                uid: user.uid,
                                email: user.email,
                                displayName: user.displayName,
                                photoURL: user.photoURL
                            };
                            
                            // èªè¨¼ãƒ‡ãƒ¼ã‚¿ã‚’çµ±ä¸€
                            this.unifyAuthData(userData);
                            
                            resolve({ method: 'firebase-auth', user: userData });
                        } else {
                            console.log('âŒ å…¨ã¦ã®èªè¨¼æ–¹å¼ã§æœªèªè¨¼');
                            resolve(null);
                        }
                    });
                });
            },
            
            // èªè¨¼ãƒ‡ãƒ¼ã‚¿ã‚’çµ±ä¸€ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«å¤‰æ›
            unifyAuthData: function(user) {
                console.log('ğŸ”§ èªè¨¼ãƒ‡ãƒ¼ã‚¿ã‚’çµ±ä¸€ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«å¤‰æ›:', user.email);
                
                // simple-reliable-auth å½¢å¼ã§ä¿å­˜
                localStorage.setItem('rentpipe_auth_simple', 'logged_in');
                localStorage.setItem('rentpipe_user_simple', JSON.stringify(user));
                
                // Googleèªè¨¼ãƒ•ãƒ©ã‚°ã‚‚ä¿å­˜ï¼ˆäº’æ›æ€§ï¼‰
                localStorage.setItem('rentpipe_temp_auth', 'google_authenticated');
                localStorage.setItem('rentpipe_user_info', JSON.stringify(user));
                
                console.log('âœ… èªè¨¼ãƒ‡ãƒ¼ã‚¿çµ±ä¸€å®Œäº†');
            },
            
            // èªè¨¼çŠ¶æ…‹ç¢ºèªï¼ˆåŒæœŸãƒ»éåŒæœŸä¸¡å¯¾å¿œï¼‰
            isAuthenticated: function() {
                const syncResult = this.getAuthenticatedUser();
                
                if (syncResult && typeof syncResult === 'object' && !syncResult.then) {
                    // åŒæœŸçš„ã«èªè¨¼ç¢ºèªæ¸ˆã¿
                    return true;
                } else if (syncResult && syncResult.then) {
                    // éåŒæœŸï¼ˆFirebaseèªè¨¼ï¼‰
                    return syncResult.then(result => !!result);
                } else {
                    // æœªèªè¨¼
                    return false;
                }
            }
        };

        // DOMèª­ã¿è¾¼ã¿å®Œäº†æ™‚ã®å‡¦ç†
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('ğŸ“„ DOMèª­ã¿è¾¼ã¿å®Œäº†');
            
            // çµ±åˆèªè¨¼ãƒã‚§ãƒƒã‚¯
            await performIntegratedAuthCheck();
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±è¡¨ç¤º
            displayAuthStatus();
            
            // é¡§å®¢ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
            loadCustomerData();
        });

        // çµ±åˆèªè¨¼ãƒã‚§ãƒƒã‚¯
        async function performIntegratedAuthCheck() {
            console.log('ğŸ” çµ±åˆèªè¨¼ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ');
            
            try {
                const authResult = IntegratedAuth.getAuthenticatedUser();
                
                if (authResult && authResult.then) {
                    // éåŒæœŸï¼ˆFirebaseèªè¨¼ï¼‰
                    const result = await authResult;
                    if (!result) {
                        console.log('ğŸ”’ æœªèªè¨¼ - ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ');
                        window.location.href = 'login-google-simple.html';
                        return;
                    }
                    window.currentUser = result.user;
                    console.log('âœ… Firebaseèªè¨¼çµŒç”±ã§èªè¨¼ç¢ºèª:', result.user.email);
                    
                } else if (authResult) {
                    // åŒæœŸçš„ã«èªè¨¼ç¢ºèªæ¸ˆã¿
                    window.currentUser = authResult.user;
                    console.log('âœ… åŒæœŸèªè¨¼ã§èªè¨¼ç¢ºèª:', authResult.user.email);
                    
                } else {
                    // æœªèªè¨¼
                    console.log('ğŸ”’ çµ±åˆèªè¨¼ãƒã‚§ãƒƒã‚¯çµæœ: æœªèªè¨¼');
                    window.location.href = 'login-google-simple.html';
                    return;
                }
                
            } catch (error) {
                console.error('âŒ çµ±åˆèªè¨¼ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', error);
                window.location.href = 'login-google-simple.html';
            }
        }

        // èªè¨¼çŠ¶æ…‹è¡¨ç¤º
        function displayAuthStatus() {
            const authDiv = document.getElementById('auth-status');
            
            if (window.currentUser) {
                authDiv.innerHTML = `
                    <h3 style="color: #059669; margin: 0 0 0.5rem 0;">âœ… èªè¨¼çŠ¶æ…‹: ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿</h3>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        ${window.currentUser.photoURL ? 
                            `<img src="${window.currentUser.photoURL}" style="width: 40px; height: 40px; border-radius: 50%;" alt="User">` : 
                            '<div style="width: 40px; height: 40px; border-radius: 50%; background: #e5e7eb; display: flex; align-items: center; justify-content: center; font-size: 18px;">ğŸ‘¤</div>'
                        }
                        <div>
                            <div style="font-weight: bold;">${window.currentUser.displayName || 'ãƒ¦ãƒ¼ã‚¶ãƒ¼'}</div>
                            <div style="font-size: 0.9rem; color: #6b7280;">${window.currentUser.email}</div>
                        </div>
                    </div>
                `;
                authDiv.style.background = '#d1fae5';
                
                // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã«ã‚‚ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±è¡¨ç¤º
                updateNavigation();
                
            } else {
                authDiv.innerHTML = `
                    <h3 style="color: #dc2626; margin: 0 0 0.5rem 0;">âŒ èªè¨¼çŠ¶æ…‹: æœªãƒ­ã‚°ã‚¤ãƒ³</h3>
                    <p style="margin: 0;">ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™</p>
                    <button onclick="window.location.href='login-google-simple.html'" style="margin-top: 10px; padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        Googleãƒ­ã‚°ã‚¤ãƒ³
                    </button>
                `;
                authDiv.style.background = '#fee2e2';
            }
        }

        // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³æ›´æ–°
        function updateNavigation() {
            if (!window.currentUser) return;
            
            const navUserInfo = document.querySelector('.nav-user-info');
            if (navUserInfo && !navUserInfo.hasChildNodes()) {
                navUserInfo.innerHTML = `
                    <div style="color: white; font-size: 14px; display: flex; align-items: center; gap: 8px; margin-right: 15px;">
                        ${window.currentUser.photoURL ? 
                            `<img src="${window.currentUser.photoURL}" style="width: 24px; height: 24px; border-radius: 50%;" alt="User">` : 
                            'ğŸ‘¤'
                        }
                        <span>${window.currentUser.displayName || window.currentUser.email.split('@')[0]}</span>
                    </div>
                `;
            }
        }

        // é¡§å®¢ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        function loadCustomerData() {
            console.log('ğŸ“Š é¡§å®¢ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–‹å§‹');
            
            const statusDiv = document.getElementById('data-loading-info');
            const customerList = document.getElementById('customer-simple-list');
            
            // è¤‡æ•°ã®ã‚­ãƒ¼ã‹ã‚‰é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œç´¢
            const possibleKeys = [
                'rentpipe_demo_customers',
                'rentpipe_customers', 
                'customers',
                'rentpipe_unified_customers'
            ];
            
            let customers = [];
            let foundKey = null;
            
            for (const key of possibleKeys) {
                const data = localStorage.getItem(key);
                console.log(`ğŸ” ãƒã‚§ãƒƒã‚¯ä¸­: ${key} = ${data ? 'ãƒ‡ãƒ¼ã‚¿ã‚ã‚Š' : 'ãƒ‡ãƒ¼ã‚¿ãªã—'}`);
                
                if (data) {
                    try {
                        const parsed = JSON.parse(data);
                        if (Array.isArray(parsed) && parsed.length > 0) {
                            customers = parsed;
                            foundKey = key;
                            console.log(`âœ… ãƒ‡ãƒ¼ã‚¿ç™ºè¦‹: ${key} (${parsed.length}ä»¶)`);
                            break;
                        }
                    } catch (e) {
                        console.warn(`âŒ ãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼: ${key}`, e);
                    }
                }
            }
            
            // çŠ¶æ³ã‚’è¡¨ç¤º
            if (customers.length > 0) {
                statusDiv.innerHTML = `
                    âœ… é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ<br>
                    ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹: <code>${foundKey}</code><br>
                    ä»¶æ•°: <strong>${customers.length}ä»¶</strong>
                `;
                statusDiv.parentElement.style.background = '#d1fae5';
                
                // é¡§å®¢ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
                displayCustomers(customers);
                
            } else {
                statusDiv.innerHTML = `
                    âŒ é¡§å®¢ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“<br>
                    <small>ç¢ºèªã—ãŸã‚­ãƒ¼: ${possibleKeys.join(', ')}</small><br>
                    <button onclick="createDemoData()" class="btn btn-primary" style="margin-top: 10px;">ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ</button>
                `;
                statusDiv.parentElement.style.background = '#fee2e2';
            }
        }

        // é¡§å®¢ãƒªã‚¹ãƒˆè¡¨ç¤º
        function displayCustomers(customers) {
            const container = document.getElementById('customer-simple-list');
            container.innerHTML = '';
            
            customers.forEach((customer, index) => {
                const customerCard = document.createElement('div');
                customerCard.className = 'customer-card';
                customerCard.innerHTML = `
                    <div class="customer-header">
                        <h3>${customer.name || 'åå‰ãªã—'}</h3>
                        <span class="status-badge status-${(customer.pipelineStatus || customer.status || 'unknown').replace(/\s+/g, '-')}">${customer.pipelineStatus || customer.status || 'æœªè¨­å®š'}</span>
                    </div>
                    <div class="customer-info">
                        <p>ğŸ“ ${customer.phone || 'é›»è©±ç•ªå·ãªã—'}</p>
                        <p>ğŸ“§ ${customer.email || 'ãƒ¡ãƒ¼ãƒ«ãªã—'}</p>
                        <p>ğŸ’° äºˆç®—: ${customer.preferences?.budget || customer.budget || 'æœªè¨­å®š'}</p>
                    </div>
                    <div class="customer-actions">
                        <button onclick="showCustomerDetail('${customer.id}')" class="btn btn-outline">è©³ç´°</button>
                    </div>
                `;
                container.appendChild(customerCard);
            });
        }

        // é¡§å®¢è©³ç´°è¡¨ç¤º
        function showCustomerDetail(customerId) {
            if (customerId) {
                window.location.href = `customer-detail.html?id=${customerId}`;
            } else {
                alert('é¡§å®¢IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }
        }

        // ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ä½œæˆ
        function createDemoData() {
            const demoCustomers = [
                {
                    id: 'demo1',
                    name: 'ç”°ä¸­å¤ªéƒ',
                    phone: '090-1234-5678',
                    email: 'tanaka@example.com',
                    pipelineStatus: 'åˆå›ç›¸è«‡',
                    preferences: { budget: '10-15ä¸‡å††' },
                    createdAt: new Date().toISOString()
                },
                {
                    id: 'demo2', 
                    name: 'ä½è—¤èŠ±å­',
                    phone: '080-9876-5432',
                    email: 'sato@example.com',
                    pipelineStatus: 'ç‰©ä»¶ç´¹ä»‹',
                    preferences: { budget: '8-12ä¸‡å††' },
                    createdAt: new Date().toISOString()
                },
                {
                    id: 'demo3',
                    name: 'éˆ´æœ¨ä¸€éƒ',
                    phone: '070-1111-2222',
                    email: 'suzuki@example.com',
                    pipelineStatus: 'å†…è¦‹',
                    preferences: { budget: '12-18ä¸‡å††' },
                    createdAt: new Date().toISOString()
                }
            ];
            
            localStorage.setItem('rentpipe_demo_customers', JSON.stringify(demoCustomers));
            console.log('âœ… ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ä½œæˆå®Œäº†');
            
            // å†èª­ã¿è¾¼ã¿
            loadCustomerData();
        }

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
        function handleLogout() {
            if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                // å…¨ã¦ã®èªè¨¼ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
                const authKeys = [
                    'rentpipe_auth_simple',
                    'rentpipe_user_simple',
                    'rentpipe_temp_auth',
                    'rentpipe_user_info'
                ];
                
                authKeys.forEach(key => {
                    localStorage.removeItem(key);
                });
                
                // Firebaseèªè¨¼ã‚‚ã‚µã‚¤ãƒ³ã‚¢ã‚¦ãƒˆ
                firebase.auth().signOut();
                
                console.log('ğŸ”’ ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå®Œäº†');
                window.location.href = 'login-google-simple.html';
            }
        }

        console.log('âœ… Customer Minimal çµ±åˆèªè¨¼ç‰ˆã‚¹ã‚¯ãƒªãƒ—ãƒˆæº–å‚™å®Œäº†');
    </script>
</body>
</html>
