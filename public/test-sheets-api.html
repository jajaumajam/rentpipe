<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Sheets API テスト - RentPipe</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 {
            color: #1e40af;
            border-bottom: 3px solid #3b82f6;
            padding-bottom: 10px;
        }
        .status-box {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: bold;
        }
        .status-loading {
            background: #fef3c7;
            color: #92400e;
        }
        .status-success {
            background: #d1fae5;
            color: #065f46;
        }
        .status-error {
            background: #fee2e2;
            color: #991b1b;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin: 10px 5px;
            transition: all 0.2s;
        }
        .btn-primary {
            background: #3b82f6;
            color: white;
        }
        .btn-primary:hover {
            background: #2563eb;
        }
        .btn-success {
            background: #10b981;
            color: white;
        }
        .btn-success:hover {
            background: #059669;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .info-box {
            background: #eff6ff;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #3b82f6;
        }
        .log-box {
            background: #1f2937;
            color: #10b981;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 300px;
            overflow-y: auto;
            margin: 15px 0;
        }
        .log-entry {
            margin: 5px 0;
        }
        .data-display {
            background: #f9fafb;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        .customer-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #e5e7eb;
        }
        .spreadsheet-link {
            display: inline-block;
            padding: 10px 20px;
            background: #059669;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            margin: 10px 0;
        }
        .spreadsheet-link:hover {
            background: #047857;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>📊 Google Sheets API テスト</h1>
        
        <div id="statusBox" class="status-box status-loading">
            初期化中...
        </div>
        
        <div class="info-box">
            <strong>🎯 このテストページでできること：</strong>
            <ul>
                <li>Google認証（Drive + Sheets アクセス）</li>
                <li>新しいスプレッドシート作成</li>
                <li>既存データの読み込み</li>
                <li>データの保存テスト</li>
            </ul>
        </div>
        
        <div style="margin: 20px 0;">
            <button id="btnAuth" class="btn btn-primary" onclick="handleAuth()">
                🔐 Google認証
            </button>
            <button id="btnCreateSheet" class="btn btn-success" onclick="handleCreateSpreadsheet()" disabled>
                📄 スプレッドシート作成
            </button>
            <button id="btnLoadData" class="btn btn-success" onclick="handleLoadData()" disabled>
                📖 データ読み込み
            </button>
            <button id="btnSaveData" class="btn btn-success" onclick="handleSaveData()" disabled>
                💾 テストデータ保存
            </button>
        </div>
        
        <div id="spreadsheetInfo" style="display: none;">
            <h3>📋 スプレッドシート情報</h3>
            <div class="info-box">
                <strong>スプレッドシートID:</strong> <span id="sheetId"></span><br>
                <a id="sheetLink" href="#" target="_blank" class="spreadsheet-link">
                    📊 Googleスプレッドシートを開く
                </a>
            </div>
        </div>
        
        <div id="dataDisplay" class="data-display" style="display: none;">
            <h3>👥 読み込まれた顧客データ</h3>
            <div id="customerList"></div>
        </div>
        
        <h3>📝 実行ログ</h3>
        <div id="logBox" class="log-box"></div>
    </div>

    <!-- Google API Client & Identity Services -->
    <script src="https://accounts.google.com/gsi/client"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    
    <!-- RentPipe Scripts -->
    <script src="js/google-drive-api-v2.js"></script>
    <script src="js/google-sheets-api.js"></script>
    
    <script>
        // ログ表示
        function addLog(message, type = 'info') {
            const logBox = document.getElementById('logBox');
            const timestamp = new Date().toLocaleTimeString('ja-JP');
            const icon = type === 'success' ? '✅' : type === 'error' ? '❌' : '📝';
            logBox.innerHTML += `<div class="log-entry">[${timestamp}] ${icon} ${message}</div>`;
            logBox.scrollTop = logBox.scrollHeight;
        }
        
        // ステータス更新
        function updateStatus(message, type = 'loading') {
            const statusBox = document.getElementById('statusBox');
            statusBox.className = `status-box status-${type}`;
            statusBox.textContent = message;
        }
        
        // ボタン状態更新
        function updateButtons(authenticated, hasSpreadsheet) {
            document.getElementById('btnAuth').disabled = authenticated;
            document.getElementById('btnCreateSheet').disabled = !authenticated || hasSpreadsheet;
            document.getElementById('btnLoadData').disabled = !authenticated || !hasSpreadsheet;
            document.getElementById('btnSaveData').disabled = !authenticated || !hasSpreadsheet;
        }
        
        // 初期化
        async function initialize() {
            try {
                addLog('🚀 システム初期化開始');
                
                // Google Drive API 初期化
                const driveReady = await GoogleDriveAPIv2.initialize();
                if (driveReady) {
                    addLog('✅ Google Drive API 初期化完了', 'success');
                } else {
                    throw new Error('Google Drive API 初期化失敗');
                }
                
                // Google Sheets API 初期化
                const sheetsReady = await GoogleSheetsAPI.initialize();
                if (sheetsReady) {
                    addLog('✅ Google Sheets API 初期化完了', 'success');
                } else {
                    throw new Error('Google Sheets API 初期化失敗');
                }
                
                // 保存されたスプレッドシートIDを確認
                const savedId = GoogleSheetsAPI.loadSpreadsheetId();
                if (savedId) {
                    addLog('💾 保存されたスプレッドシートID発見: ' + savedId);
                    displaySpreadsheetInfo(savedId);
                }
                
                updateStatus('✅ 初期化完了 - Google認証をクリックしてください', 'success');
                updateButtons(false, !!savedId);
                
            } catch (error) {
                addLog('❌ 初期化エラー: ' + error.message, 'error');
                updateStatus('❌ 初期化エラー', 'error');
            }
        }
        
        // Google認証（既存の動作パターンを使用）
        async function handleAuth() {
            try {
                addLog('🔐 Google認証開始...');
                updateStatus('🔐 Google認証中...', 'loading');
                
                // 既存のauthenticate()メソッドを使用（customer.htmlと同じパターン）
                const userInfo = await GoogleDriveAPIv2.authenticate();
                
                if (!userInfo) {
                    throw new Error('認証失敗：ユーザー情報を取得できませんでした');
                }
                
                if (!GoogleDriveAPIv2.accessToken) {
                    throw new Error('認証失敗：アクセストークンを取得できませんでした');
                }
                
                addLog('✅ Google Drive API 認証成功: ' + userInfo.email, 'success');
                
                // Sheets API にトークン設定
                GoogleSheetsAPI.setAccessToken(GoogleDriveAPIv2.accessToken);
                addLog('✅ Google Sheets API トークン設定完了', 'success');
                
                updateStatus('✅ 認証完了 - スプレッドシートを作成できます', 'success');
                
                const hasSpreadsheet = !!GoogleSheetsAPI.spreadsheetId;
                updateButtons(true, hasSpreadsheet);
                
            } catch (error) {
                addLog('❌ 認証エラー: ' + error.message, 'error');
                updateStatus('❌ 認証エラー', 'error');
                console.error('認証エラー詳細:', error);
            }
        }
        
        // スプレッドシート作成
        async function handleCreateSpreadsheet() {
            try {
                addLog('📄 スプレッドシート作成開始...');
                updateStatus('📄 スプレッドシート作成中...', 'loading');
                
                const timestamp = new Date().toLocaleString('ja-JP').replace(/\//g, '-').replace(/:/g, '-');
                const title = `RentPipe_データベース_${timestamp}`;
                
                const spreadsheetId = await GoogleSheetsAPI.createSpreadsheet(title);
                
                addLog('✅ スプレッドシート作成成功: ' + spreadsheetId, 'success');
                addLog('🔗 URL: https://docs.google.com/spreadsheets/d/' + spreadsheetId);
                
                // スプレッドシートIDを保存
                GoogleSheetsAPI.saveSpreadsheetId(spreadsheetId);
                
                displaySpreadsheetInfo(spreadsheetId);
                updateStatus('✅ スプレッドシート作成完了', 'success');
                updateButtons(true, true);
                
            } catch (error) {
                addLog('❌ スプレッドシート作成エラー: ' + error.message, 'error');
                updateStatus('❌ スプレッドシート作成エラー', 'error');
                console.error('スプレッドシート作成エラー詳細:', error);
            }
        }
        
        // データ読み込み
        async function handleLoadData() {
            try {
                addLog('📖 データ読み込み開始...');
                updateStatus('📖 データ読み込み中...', 'loading');
                
                const customers = await GoogleSheetsAPI.getCustomers();
                
                addLog('✅ データ読み込み成功: ' + customers.length + '件', 'success');
                
                displayCustomers(customers);
                updateStatus('✅ データ読み込み完了: ' + customers.length + '件', 'success');
                
            } catch (error) {
                addLog('❌ データ読み込みエラー: ' + error.message, 'error');
                updateStatus('❌ データ読み込みエラー', 'error');
                console.error('データ読み込みエラー詳細:', error);
            }
        }
        
        // テストデータ保存
        async function handleSaveData() {
            try {
                addLog('💾 テストデータ保存開始...');
                updateStatus('💾 テストデータ保存中...', 'loading');
                
                // テストデータ生成
                const testCustomers = [
                    {
                        id: 'test-001',
                        name: '田中太郎',
                        email: 'tanaka@example.com',
                        phone: '090-1234-5678',
                        pipelineStatus: '見込み客',
                        preferences: {
                            budgetMin: 80000,
                            budgetMax: 120000,
                            areas: ['渋谷区', '新宿区'],
                            roomType: '1K',
                            requirements: ['駅近', 'バストイレ別']
                        },
                        notes: 'できるだけ早く契約したい',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    {
                        id: 'test-002',
                        name: '佐藤花子',
                        email: 'sato@example.com',
                        phone: '080-9876-5432',
                        pipelineStatus: '内見予定',
                        preferences: {
                            budgetMin: 100000,
                            budgetMax: 150000,
                            areas: ['港区', '目黒区'],
                            roomType: '1LDK',
                            requirements: ['ペット可', '2階以上']
                        },
                        notes: '猫を飼っている',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    {
                        id: 'test-003',
                        name: '山田次郎',
                        email: 'yamada@example.com',
                        phone: '070-5555-6666',
                        pipelineStatus: '商談中',
                        preferences: {
                            budgetMin: 60000,
                            budgetMax: 90000,
                            areas: ['世田谷区', '杉並区'],
                            roomType: 'ワンルーム',
                            requirements: ['駅近', '築浅']
                        },
                        notes: '学生、保証人は親',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    }
                ];
                
                await GoogleSheetsAPI.saveCustomers(testCustomers);
                
                addLog('✅ テストデータ保存成功: ' + testCustomers.length + '件', 'success');
                updateStatus('✅ テストデータ保存完了', 'success');
                
                // 保存後、データを再読み込み
                setTimeout(() => handleLoadData(), 1000);
                
            } catch (error) {
                addLog('❌ データ保存エラー: ' + error.message, 'error');
                updateStatus('❌ データ保存エラー', 'error');
                console.error('データ保存エラー詳細:', error);
            }
        }
        
        // スプレッドシート情報表示
        function displaySpreadsheetInfo(spreadsheetId) {
            const infoDiv = document.getElementById('spreadsheetInfo');
            const sheetIdSpan = document.getElementById('sheetId');
            const sheetLink = document.getElementById('sheetLink');
            
            sheetIdSpan.textContent = spreadsheetId;
            sheetLink.href = `https://docs.google.com/spreadsheets/d/${spreadsheetId}`;
            infoDiv.style.display = 'block';
        }
        
        // 顧客データ表示
        function displayCustomers(customers) {
            const displayDiv = document.getElementById('dataDisplay');
            const listDiv = document.getElementById('customerList');
            
            if (customers.length === 0) {
                listDiv.innerHTML = '<p>データがありません。「テストデータ保存」ボタンでサンプルデータを追加できます。</p>';
            } else {
                listDiv.innerHTML = customers.map(customer => `
                    <div class="customer-card">
                        <strong>${customer.name}</strong> (${customer.pipelineStatus})<br>
                        📧 ${customer.email} | 📱 ${customer.phone}<br>
                        💰 ${customer.preferences.budgetMin?.toLocaleString()}〜${customer.preferences.budgetMax?.toLocaleString()}円<br>
                        📍 ${customer.preferences.areas?.join('、') || '未設定'}<br>
                        📝 ${customer.notes || 'なし'}
                    </div>
                `).join('');
            }
            
            displayDiv.style.display = 'block';
        }
        
        // ページ読み込み時に初期化
        window.addEventListener('load', initialize);
    </script>
</body>
</html>
