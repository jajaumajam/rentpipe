<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Sheets API ãƒ†ã‚¹ãƒˆ - RentPipe</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 {
            color: #1e40af;
            border-bottom: 3px solid #3b82f6;
            padding-bottom: 10px;
        }
        .status-box {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: bold;
        }
        .status-loading {
            background: #fef3c7;
            color: #92400e;
        }
        .status-success {
            background: #d1fae5;
            color: #065f46;
        }
        .status-error {
            background: #fee2e2;
            color: #991b1b;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin: 10px 5px;
            transition: all 0.2s;
        }
        .btn-primary {
            background: #3b82f6;
            color: white;
        }
        .btn-primary:hover {
            background: #2563eb;
        }
        .btn-success {
            background: #10b981;
            color: white;
        }
        .btn-success:hover {
            background: #059669;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .info-box {
            background: #eff6ff;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #3b82f6;
        }
        .log-box {
            background: #1f2937;
            color: #10b981;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 300px;
            overflow-y: auto;
            margin: 15px 0;
        }
        .log-entry {
            margin: 5px 0;
        }
        .data-display {
            background: #f9fafb;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        .customer-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #e5e7eb;
        }
        .spreadsheet-link {
            display: inline-block;
            padding: 10px 20px;
            background: #059669;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            margin: 10px 0;
        }
        .spreadsheet-link:hover {
            background: #047857;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“Š Google Sheets API ãƒ†ã‚¹ãƒˆ</h1>
        
        <div id="statusBox" class="status-box status-loading">
            åˆæœŸåŒ–ä¸­...
        </div>
        
        <div class="info-box">
            <strong>ğŸ¯ ã“ã®ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸ã§ã§ãã‚‹ã“ã¨ï¼š</strong>
            <ul>
                <li>Googleèªè¨¼ï¼ˆDrive + Sheets ã‚¢ã‚¯ã‚»ã‚¹ï¼‰</li>
                <li>æ–°ã—ã„ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆä½œæˆ</li>
                <li>æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿</li>
                <li>ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ãƒ†ã‚¹ãƒˆ</li>
            </ul>
        </div>
        
        <div style="margin: 20px 0;">
            <button id="btnAuth" class="btn btn-primary" onclick="handleAuth()">
                ğŸ” Googleèªè¨¼
            </button>
            <button id="btnCreateSheet" class="btn btn-success" onclick="handleCreateSpreadsheet()" disabled>
                ğŸ“„ ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆä½œæˆ
            </button>
            <button id="btnLoadData" class="btn btn-success" onclick="handleLoadData()" disabled>
                ğŸ“– ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
            </button>
            <button id="btnSaveData" class="btn btn-success" onclick="handleSaveData()" disabled>
                ğŸ’¾ ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ä¿å­˜
            </button>
        </div>
        
        <div id="spreadsheetInfo" style="display: none;">
            <h3>ğŸ“‹ ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆæƒ…å ±</h3>
            <div class="info-box">
                <strong>ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆID:</strong> <span id="sheetId"></span><br>
                <a id="sheetLink" href="#" target="_blank" class="spreadsheet-link">
                    ğŸ“Š Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’é–‹ã
                </a>
            </div>
        </div>
        
        <div id="dataDisplay" class="data-display" style="display: none;">
            <h3>ğŸ‘¥ èª­ã¿è¾¼ã¾ã‚ŒãŸé¡§å®¢ãƒ‡ãƒ¼ã‚¿</h3>
            <div id="customerList"></div>
        </div>
        
        <h3>ğŸ“ å®Ÿè¡Œãƒ­ã‚°</h3>
        <div id="logBox" class="log-box"></div>
    </div>

    <!-- Google API Client & Identity Services -->
    <script src="https://accounts.google.com/gsi/client"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    
    <!-- RentPipe Scripts -->
    <script src="js/google-drive-api-v2.js"></script>
    <script src="js/google-sheets-api.js"></script>
    
    <script>
        // ãƒ­ã‚°è¡¨ç¤º
        function addLog(message, type = 'info') {
            const logBox = document.getElementById('logBox');
            const timestamp = new Date().toLocaleTimeString('ja-JP');
            const icon = type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : 'ğŸ“';
            logBox.innerHTML += `<div class="log-entry">[${timestamp}] ${icon} ${message}</div>`;
            logBox.scrollTop = logBox.scrollHeight;
        }
        
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        function updateStatus(message, type = 'loading') {
            const statusBox = document.getElementById('statusBox');
            statusBox.className = `status-box status-${type}`;
            statusBox.textContent = message;
        }
        
        // ãƒœã‚¿ãƒ³çŠ¶æ…‹æ›´æ–°
        function updateButtons(authenticated, hasSpreadsheet) {
            document.getElementById('btnAuth').disabled = authenticated;
            document.getElementById('btnCreateSheet').disabled = !authenticated || hasSpreadsheet;
            document.getElementById('btnLoadData').disabled = !authenticated || !hasSpreadsheet;
            document.getElementById('btnSaveData').disabled = !authenticated || !hasSpreadsheet;
        }
        
        // åˆæœŸåŒ–
        async function initialize() {
            try {
                addLog('ğŸš€ ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–é–‹å§‹');
                
                // Google Drive API åˆæœŸåŒ–
                const driveReady = await GoogleDriveAPIv2.initialize();
                if (driveReady) {
                    addLog('âœ… Google Drive API åˆæœŸåŒ–å®Œäº†', 'success');
                } else {
                    throw new Error('Google Drive API åˆæœŸåŒ–å¤±æ•—');
                }
                
                // Google Sheets API åˆæœŸåŒ–
                const sheetsReady = await GoogleSheetsAPI.initialize();
                if (sheetsReady) {
                    addLog('âœ… Google Sheets API åˆæœŸåŒ–å®Œäº†', 'success');
                } else {
                    throw new Error('Google Sheets API åˆæœŸåŒ–å¤±æ•—');
                }
                
                // ä¿å­˜ã•ã‚ŒãŸã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆIDã‚’ç¢ºèª
                const savedId = GoogleSheetsAPI.loadSpreadsheetId();
                if (savedId) {
                    addLog('ğŸ’¾ ä¿å­˜ã•ã‚ŒãŸã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆIDç™ºè¦‹: ' + savedId);
                    displaySpreadsheetInfo(savedId);
                }
                
                updateStatus('âœ… åˆæœŸåŒ–å®Œäº† - Googleèªè¨¼ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„', 'success');
                updateButtons(false, !!savedId);
                
            } catch (error) {
                addLog('âŒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
                updateStatus('âŒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼', 'error');
            }
        }
        
        // Googleèªè¨¼ï¼ˆæ—¢å­˜ã®å‹•ä½œãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ä½¿ç”¨ï¼‰
        async function handleAuth() {
            try {
                addLog('ğŸ” Googleèªè¨¼é–‹å§‹...');
                updateStatus('ğŸ” Googleèªè¨¼ä¸­...', 'loading');
                
                // æ—¢å­˜ã®authenticate()ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨ï¼ˆcustomer.htmlã¨åŒã˜ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
                const userInfo = await GoogleDriveAPIv2.authenticate();
                
                if (!userInfo) {
                    throw new Error('èªè¨¼å¤±æ•—ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
                }
                
                if (!GoogleDriveAPIv2.accessToken) {
                    throw new Error('èªè¨¼å¤±æ•—ï¼šã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
                }
                
                addLog('âœ… Google Drive API èªè¨¼æˆåŠŸ: ' + userInfo.email, 'success');
                
                // Sheets API ã«ãƒˆãƒ¼ã‚¯ãƒ³è¨­å®š
                GoogleSheetsAPI.setAccessToken(GoogleDriveAPIv2.accessToken);
                addLog('âœ… Google Sheets API ãƒˆãƒ¼ã‚¯ãƒ³è¨­å®šå®Œäº†', 'success');
                
                updateStatus('âœ… èªè¨¼å®Œäº† - ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’ä½œæˆã§ãã¾ã™', 'success');
                
                const hasSpreadsheet = !!GoogleSheetsAPI.spreadsheetId;
                updateButtons(true, hasSpreadsheet);
                
            } catch (error) {
                addLog('âŒ èªè¨¼ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
                updateStatus('âŒ èªè¨¼ã‚¨ãƒ©ãƒ¼', 'error');
                console.error('èªè¨¼ã‚¨ãƒ©ãƒ¼è©³ç´°:', error);
            }
        }
        
        // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆä½œæˆ
        async function handleCreateSpreadsheet() {
            try {
                addLog('ğŸ“„ ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆä½œæˆé–‹å§‹...');
                updateStatus('ğŸ“„ ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆä½œæˆä¸­...', 'loading');
                
                const timestamp = new Date().toLocaleString('ja-JP').replace(/\//g, '-').replace(/:/g, '-');
                const title = `RentPipe_ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹_${timestamp}`;
                
                const spreadsheetId = await GoogleSheetsAPI.createSpreadsheet(title);
                
                addLog('âœ… ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆä½œæˆæˆåŠŸ: ' + spreadsheetId, 'success');
                addLog('ğŸ”— URL: https://docs.google.com/spreadsheets/d/' + spreadsheetId);
                
                // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆIDã‚’ä¿å­˜
                GoogleSheetsAPI.saveSpreadsheetId(spreadsheetId);
                
                displaySpreadsheetInfo(spreadsheetId);
                updateStatus('âœ… ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆä½œæˆå®Œäº†', 'success');
                updateButtons(true, true);
                
            } catch (error) {
                addLog('âŒ ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆä½œæˆã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
                updateStatus('âŒ ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆä½œæˆã‚¨ãƒ©ãƒ¼', 'error');
                console.error('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆä½œæˆã‚¨ãƒ©ãƒ¼è©³ç´°:', error);
            }
        }
        
        // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        async function handleLoadData() {
            try {
                addLog('ğŸ“– ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–‹å§‹...');
                updateStatus('ğŸ“– ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...', 'loading');
                
                const customers = await GoogleSheetsAPI.getCustomers();
                
                addLog('âœ… ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿æˆåŠŸ: ' + customers.length + 'ä»¶', 'success');
                
                displayCustomers(customers);
                updateStatus('âœ… ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†: ' + customers.length + 'ä»¶', 'success');
                
            } catch (error) {
                addLog('âŒ ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
                updateStatus('âŒ ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼', 'error');
                console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼è©³ç´°:', error);
            }
        }
        
        // ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ä¿å­˜
        async function handleSaveData() {
            try {
                addLog('ğŸ’¾ ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ä¿å­˜é–‹å§‹...');
                updateStatus('ğŸ’¾ ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ä¿å­˜ä¸­...', 'loading');
                
                // ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
                const testCustomers = [
                    {
                        id: 'test-001',
                        name: 'ç”°ä¸­å¤ªéƒ',
                        email: 'tanaka@example.com',
                        phone: '090-1234-5678',
                        pipelineStatus: 'è¦‹è¾¼ã¿å®¢',
                        preferences: {
                            budgetMin: 80000,
                            budgetMax: 120000,
                            areas: ['æ¸‹è°·åŒº', 'æ–°å®¿åŒº'],
                            roomType: '1K',
                            requirements: ['é§…è¿‘', 'ãƒã‚¹ãƒˆã‚¤ãƒ¬åˆ¥']
                        },
                        notes: 'ã§ãã‚‹ã ã‘æ—©ãå¥‘ç´„ã—ãŸã„',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    {
                        id: 'test-002',
                        name: 'ä½è—¤èŠ±å­',
                        email: 'sato@example.com',
                        phone: '080-9876-5432',
                        pipelineStatus: 'å†…è¦‹äºˆå®š',
                        preferences: {
                            budgetMin: 100000,
                            budgetMax: 150000,
                            areas: ['æ¸¯åŒº', 'ç›®é»’åŒº'],
                            roomType: '1LDK',
                            requirements: ['ãƒšãƒƒãƒˆå¯', '2éšä»¥ä¸Š']
                        },
                        notes: 'çŒ«ã‚’é£¼ã£ã¦ã„ã‚‹',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    {
                        id: 'test-003',
                        name: 'å±±ç”°æ¬¡éƒ',
                        email: 'yamada@example.com',
                        phone: '070-5555-6666',
                        pipelineStatus: 'å•†è«‡ä¸­',
                        preferences: {
                            budgetMin: 60000,
                            budgetMax: 90000,
                            areas: ['ä¸–ç”°è°·åŒº', 'æ‰ä¸¦åŒº'],
                            roomType: 'ãƒ¯ãƒ³ãƒ«ãƒ¼ãƒ ',
                            requirements: ['é§…è¿‘', 'ç¯‰æµ…']
                        },
                        notes: 'å­¦ç”Ÿã€ä¿è¨¼äººã¯è¦ª',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    }
                ];
                
                await GoogleSheetsAPI.saveCustomers(testCustomers);
                
                addLog('âœ… ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ä¿å­˜æˆåŠŸ: ' + testCustomers.length + 'ä»¶', 'success');
                updateStatus('âœ… ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ä¿å­˜å®Œäº†', 'success');
                
                // ä¿å­˜å¾Œã€ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
                setTimeout(() => handleLoadData(), 1000);
                
            } catch (error) {
                addLog('âŒ ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
                updateStatus('âŒ ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã‚¨ãƒ©ãƒ¼', 'error');
                console.error('ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã‚¨ãƒ©ãƒ¼è©³ç´°:', error);
            }
        }
        
        // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆæƒ…å ±è¡¨ç¤º
        function displaySpreadsheetInfo(spreadsheetId) {
            const infoDiv = document.getElementById('spreadsheetInfo');
            const sheetIdSpan = document.getElementById('sheetId');
            const sheetLink = document.getElementById('sheetLink');
            
            sheetIdSpan.textContent = spreadsheetId;
            sheetLink.href = `https://docs.google.com/spreadsheets/d/${spreadsheetId}`;
            infoDiv.style.display = 'block';
        }
        
        // é¡§å®¢ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º
        function displayCustomers(customers) {
            const displayDiv = document.getElementById('dataDisplay');
            const listDiv = document.getElementById('customerList');
            
            if (customers.length === 0) {
                listDiv.innerHTML = '<p>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã€Œãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ä¿å­˜ã€ãƒœã‚¿ãƒ³ã§ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ã§ãã¾ã™ã€‚</p>';
            } else {
                listDiv.innerHTML = customers.map(customer => `
                    <div class="customer-card">
                        <strong>${customer.name}</strong> (${customer.pipelineStatus})<br>
                        ğŸ“§ ${customer.email} | ğŸ“± ${customer.phone}<br>
                        ğŸ’° ${customer.preferences.budgetMin?.toLocaleString()}ã€œ${customer.preferences.budgetMax?.toLocaleString()}å††<br>
                        ğŸ“ ${customer.preferences.areas?.join('ã€') || 'æœªè¨­å®š'}<br>
                        ğŸ“ ${customer.notes || 'ãªã—'}
                    </div>
                `).join('');
            }
            
            displayDiv.style.display = 'block';
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆæœŸåŒ–
        window.addEventListener('load', initialize);
    </script>
</body>
</html>
