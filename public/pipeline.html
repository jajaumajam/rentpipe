<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>パイプライン管理 - RentPipe</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/pipeline-responsive.css">
    
    <!-- Google Sheets統合用のスタイル -->
    <style>
        /* Google Sheets統合パネル */
        .sheets-panel {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .sheets-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .sheets-status-disconnected {
            background-color: #fef3c7;
            border: 1px solid #f59e0b;
            color: #92400e;
        }
        
        .sheets-status-connected {
            background-color: #d1fae5;
            border: 1px solid #10b981;
            color: #065f46;
        }
        
        .sheets-status-syncing {
            background-color: #dbeafe;
            border: 1px solid #3b82f6;
            color: #1e40af;
        }
        
        .sheets-status-error {
            background-color: #fee2e2;
            border: 1px solid #ef4444;
            color: #991b1b;
        }
        
        .sheets-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .sheets-info {
            background: #f8fafc;
            padding: 15px;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .sheets-info div {
            margin-bottom: 8px;
        }
        
        .auth-status {
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }
        
        .auth-status.success {
            background-color: #d1fae5;
            border: 1px solid #10b981;
            color: #065f46;
        }
        
        .auth-status.warning {
            background-color: #fef3c7;
            border: 1px solid #f59e0b;
            color: #92400e;
        }
        
        .auth-status.error {
            background-color: #fee2e2;
            border: 1px solid #ef4444;
            color: #991b1b;
        }
        
        .sync-icon {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- ナビゲーション -->
    <div id="navigation"></div>

    <div class="pipeline-container">
        <!-- 認証ステータス -->
        <div id="auth-sync-status" class="auth-status warning">
            🔧 システム初期化中...
        </div>
        
        <!-- Google Sheets統合パネル -->
        <div class="sheets-panel">
            <h3>📊 Google Sheets データ同期</h3>
            
            <div id="sheets-status" class="sheets-status sheets-status-disconnected">
                <div>
                    <strong>ステータス:</strong>
                    <span id="sheets-status-text">Google Sheets統合を初期化中...</span>
                </div>
                <div class="sheets-controls">
                    <!-- 通常は表示されない - エラー時のみ表示 -->
                    <button id="btn-sheets-connect" class="btn btn-primary" onclick="connectGoogleSheets()" style="display: none;">
                        📊 Google Sheets接続
                    </button>
                    <button id="btn-sheets-create" class="btn btn-success" onclick="createNewSpreadsheet()" style="display: none;">
                        📄 新規作成
                    </button>
                    <button id="btn-sheets-sync" class="btn btn-success" onclick="syncWithSheets()" style="display: none;">
                        🔄 今すぐ同期
                    </button>
                </div>
            </div>
            
            <div id="sheets-info" class="sheets-info" style="display: none;">
                <div><strong>スプレッドシートID:</strong> <span id="sheets-spreadsheet-id">-</span></div>
                <div><strong>最終同期:</strong> <span id="sheets-last-sync">-</span></div>
                <div><strong>同期モード:</strong> <span id="sheets-sync-mode">手動</span></div>
                <div style="margin-top: 10px;">
                    <a id="sheets-link" href="#" target="_blank" class="btn btn-secondary" style="display: none;">
                        🔗 スプレッドシートを開く
                    </a>
                </div>
            </div>
        </div>

        <div class="pipeline-header">
            <div class="header-left">
                <h1>パイプライン管理</h1>
                <p style="color: #64748b; margin-top: 5px;">顧客の進捗状況を可視化・管理 + Google Sheets自動同期</p>
            </div>
            <div class="header-actions">
                <button onclick="refreshPipeline()" class="btn btn-primary" id="refreshPipeline">
                    更新
                </button>
            </div>
        </div>

        <!-- パイプラインボード -->
        <div class="pipeline-board" id="pipelineBoard">
            <div class="pipeline-column" data-status="初回相談">
                <div class="column-header status-initial">
                    <span class="column-title">初回相談</span>
                    <span class="column-count" data-count="初回相談">0</span>
                </div>
                <div class="pipeline-cards" data-column="初回相談"></div>
            </div>

            <div class="pipeline-column" data-status="物件紹介">
                <div class="column-header status-presentation">
                    <span class="column-title">物件紹介</span>
                    <span class="column-count" data-count="物件紹介">0</span>
                </div>
                <div class="pipeline-cards" data-column="物件紹介"></div>
            </div>

            <div class="pipeline-column" data-status="内見">
                <div class="column-header status-viewing">
                    <span class="column-title">内見</span>
                    <span class="column-count" data-count="内見">0</span>
                </div>
                <div class="pipeline-cards" data-column="内見"></div>
            </div>

            <div class="pipeline-column" data-status="申込">
                <div class="column-header status-application">
                    <span class="column-title">申込</span>
                    <span class="column-count" data-count="申込">0</span>
                </div>
                <div class="pipeline-cards" data-column="申込"></div>
            </div>

            <div class="pipeline-column" data-status="審査">
                <div class="column-header status-screening">
                    <span class="column-title">審査</span>
                    <span class="column-count" data-count="審査">0</span>
                </div>
                <div class="pipeline-cards" data-column="審査"></div>
            </div>

            <div class="pipeline-column" data-status="契約">
                <div class="column-header status-contract">
                    <span class="column-title">契約</span>
                    <span class="column-count" data-count="契約">0</span>
                </div>
                <div class="pipeline-cards" data-column="契約"></div>
            </div>

            <div class="pipeline-column" data-status="完了">
                <div class="column-header status-complete">
                    <span class="column-title">完了</span>
                    <span class="column-count" data-count="完了">0</span>
                </div>
                <div class="pipeline-cards" data-column="完了"></div>
            </div>
        </div>
    </div>

    <!-- Google API Client & Identity Services -->
    <script src="https://accounts.google.com/gsi/client"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    
    <!-- RentPipe Core Scripts -->
    <script src="js/navigation.js"></script>
    <script src="js/integrated-auth-manager-v2.js"></script>
    <script src="js/unified-data-manager.js"></script>
    
    <!-- Google Integration Scripts -->
    <script src="js/google-drive-api-v2.js"></script>
    <script src="js/google-sheets-api.js"></script>
    <script src="js/unified-sheets-manager.js"></script>
    
    <!-- Pipeline Management Scripts -->
    <script src="js/pipeline-unified.js"></script>
    <script src="js/data-key-unifier.js"></script>
    <script src="js/local-first-sync.js"></script>
    <script src="js/cross-page-sync.js"></script>

    <!-- Pipeline Google Sheets完全自動化統合 -->
    <script>
        // 🚀 Pipeline Google Sheets完全自動化統合システム
        console.log('🚀 Pipeline Google Sheets完全自動化統合システム初期化中...');
        
        // グローバル変数
        let systemInitialized = false;
        let currentAuthState = null;
        
        // 認証状況表示
        function showAuthStatus(message, type) {
            const statusDiv = document.getElementById('auth-sync-status');
            if (statusDiv) {
                statusDiv.textContent = message;
                statusDiv.className = `auth-status ${type}`;
            }
        }
        
        // 認証システム初期化
        async function initializeAuthenticationSystem() {
            try {
                console.log('🔧 認証システム初期化中...');
                showAuthStatus('🔧 認証システム初期化中...', 'warning');
                
                // 統合認証マネージャーV2を使用
                if (!window.IntegratedAuthManagerV2) {
                    throw new Error('統合認証マネージャーV2が見つかりません');
                }
                
                // 既存の認証状態確認
                currentAuthState = window.IntegratedAuthManagerV2.getAuthState();
                
                if (currentAuthState.isAuthenticated) {
                    showAuthStatus(`✅ ログイン済み: ${currentAuthState.rentpipeAuth.user?.email || 'ユーザー'}`, 'success');
                    return true;
                } else {
                    // ログインページにリダイレクト
                    console.log('🔄 未認証のためログインページにリダイレクト...');
                    showAuthStatus('🔄 ログインページにリダイレクト中...', 'warning');
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 1000);
                    return false;
                }
                
            } catch (error) {
                console.error('❌ 認証システム初期化エラー:', error);
                showAuthStatus(`認証エラー: ${error.message}`, 'error');
                return false;
            }
        }
        
        // Google Sheets完全自動統合
        async function setupGoogleSheetsIntegration() {
            try {
                console.log('📊 Google Sheets完全自動統合開始...');
                updateSheetsStatus('📊 Google Sheets統合を自動設定中...', 'syncing');
                
                // ステップ1: Google Sheets API初期化
                if (!window.GoogleSheetsAPI?.isInitialized) {
                    await window.GoogleSheetsAPI.initialize();
                }
                
                // ステップ2: ログイン時のGoogle認証情報を自動設定
                if (currentAuthState?.googleAuth?.isSignedIn && currentAuthState?.googleAuth?.accessToken) {
                    console.log('✅ ログイン認証情報をGoogle Sheetsで自動使用');
                    
                    // アクセストークンを設定
                    window.GoogleSheetsAPI.setAccessToken(currentAuthState.googleAuth.accessToken);
                    
                    // ステップ3: 既存スプレッドシートの自動検出
                    const savedId = localStorage.getItem('rentpipe_spreadsheet_id');
                    
                    if (savedId) {
                        console.log('🔍 既存スプレッドシート自動検出:', savedId);
                        
                        // 既存スプレッドシートに自動接続
                        await window.UnifiedSheetsManager.enableSheetsIntegration(savedId);
                        
                        // UI更新
                        showSheetsInfo(savedId);
                        document.getElementById('btn-sheets-sync').style.display = 'inline-block';
                        updateSheetsStatus('✅ 既存スプレッドシートに自動接続完了', 'connected');
                        
                        console.log('✅ 既存スプレッドシート自動接続完了');
                        return 'existing_connected';
                        
                    } else {
                        console.log('ℹ️ 既存スプレッドシートなし - 新規作成が必要');
                        
                        // 新規作成ボタンを表示
                        document.getElementById('btn-sheets-create').style.display = 'inline-block';
                        updateSheetsStatus('✅ Google Sheets準備完了 - 新規スプレッドシートを作成してください', 'connected');
                        
                        return 'ready_for_creation';
                    }
                    
                } else {
                    console.warn('⚠️ Google認証情報が不完全');
                    
                    // 追加認証が必要な場合のみボタン表示
                    document.getElementById('btn-sheets-connect').style.display = 'inline-block';
                    updateSheetsStatus('⚠️ Google認証が必要です', 'disconnected');
                    
                    return 'auth_required';
                }
                
            } catch (error) {
                console.error('❌ Google Sheets自動統合エラー:', error);
                updateSheetsStatus('❌ 自動統合エラー: ' + error.message, 'error');
                
                // エラー時のフォールバック
                document.getElementById('btn-sheets-connect').style.display = 'inline-block';
                return 'error';
            }
        }
        
        // 新規スプレッドシート作成（簡素化）
        async function createNewSpreadsheet() {
            const btn = document.getElementById('btn-sheets-create');
            const originalText = btn.textContent;
            
            try {
                btn.textContent = '作成中...';
                btn.disabled = true;
                
                updateSheetsStatus('📄 スプレッドシート作成中...', 'syncing');
                
                const timestamp = new Date().toLocaleString('ja-JP').replace(/\//g, '-').replace(/:/g, '-').replace(/\s/g, '_');
                const title = `RentPipe_パイプライン_${timestamp}`;
                
                const spreadsheetId = await window.GoogleSheetsAPI.createSpreadsheet(title);
                
                await window.UnifiedSheetsManager.enableSheetsIntegration(spreadsheetId);
                
                updateSheetsStatus('✅ スプレッドシート作成完了 - 自動同期有効', 'connected');
                showSheetsInfo(spreadsheetId);
                
                btn.style.display = 'none';
                document.getElementById('btn-sheets-sync').style.display = 'inline-block';
                
                // パイプラインデータを再読み込み
                if (window.pipelineManager) {
                    await window.pipelineManager.loadPipeline();
                }
                
            } catch (error) {
                console.error('❌ スプレッドシート作成エラー:', error);
                updateSheetsStatus('❌ 作成エラー: ' + error.message, 'error');
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }
        
        // Google Sheets手動接続（エラー時のフォールバック）
        async function connectGoogleSheets() {
            const btn = document.getElementById('btn-sheets-connect');
            const originalText = btn.textContent;
            
            try {
                btn.textContent = '接続中...';
                btn.disabled = true;
                
                updateSheetsStatus('🔐 Google認証中...', 'syncing');
                
                // Google Drive API経由で認証
                if (!window.GoogleDriveAPIv2?.isInitialized) {
                    await window.GoogleDriveAPIv2.initialize();
                }
                
                const userInfo = await window.GoogleDriveAPIv2.authenticate();
                
                if (!userInfo || !window.GoogleDriveAPIv2.accessToken) {
                    throw new Error('Google認証に失敗しました');
                }
                
                // 認証情報を保存
                await window.IntegratedAuthManagerV2.updateGoogleAuth({
                    isSignedIn: true,
                    user: userInfo,
                    accessToken: window.GoogleDriveAPIv2.accessToken,
                    tokenExpiry: Date.now() + (3600 * 1000)
                });
                
                // Sheets APIにトークン設定
                window.GoogleSheetsAPI.setAccessToken(window.GoogleDriveAPIv2.accessToken);
                
                // 再度自動統合を試行
                btn.style.display = 'none';
                await setupGoogleSheetsIntegration();
                
            } catch (error) {
                console.error('❌ Google Sheets手動接続エラー:', error);
                updateSheetsStatus('❌ 接続エラー: ' + error.message, 'error');
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }
        
        // 手動同期
        async function syncWithSheets() {
            const btn = document.getElementById('btn-sheets-sync');
            const originalText = btn.textContent;
            
            try {
                btn.innerHTML = '<span class="sync-icon">🔄</span> 同期中...';
                btn.disabled = true;
                
                updateSheetsStatus('🔄 データ同期中...', 'syncing');
                
                await window.UnifiedSheetsManager.syncToSheets();
                
                updateSheetsStatus('✅ 同期完了', 'connected');
                updateLastSyncTime();
                
                btn.textContent = originalText;
                btn.disabled = false;
                
            } catch (error) {
                console.error('❌ 同期エラー:', error);
                updateSheetsStatus('❌ 同期エラー: ' + error.message, 'error');
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }
        
        // ステータス更新
        function updateSheetsStatus(message, type) {
            const statusDiv = document.getElementById('sheets-status');
            const statusText = document.getElementById('sheets-status-text');
            
            if (statusText) {
                statusText.textContent = message;
            }
            if (statusDiv) {
                statusDiv.className = `sheets-status sheets-status-${type}`;
            }
        }
        
        // スプレッドシート情報表示
        function showSheetsInfo(spreadsheetId) {
            const infoDiv = document.getElementById('sheets-info');
            const idSpan = document.getElementById('sheets-spreadsheet-id');
            const link = document.getElementById('sheets-link');
            
            if (idSpan) idSpan.textContent = spreadsheetId;
            if (link) {
                link.href = `https://docs.google.com/spreadsheets/d/${spreadsheetId}`;
                link.style.display = 'inline-block';
            }
            if (infoDiv) infoDiv.style.display = 'block';
            
            const syncMode = document.getElementById('sheets-sync-mode');
            if (syncMode) syncMode.textContent = '自動（5分ごと）';
            
            updateLastSyncTime();
        }
        
        // 最終同期時刻更新
        function updateLastSyncTime() {
            const status = window.UnifiedSheetsManager.getStatus();
            const lastSyncSpan = document.getElementById('sheets-last-sync');
            
            if (lastSyncSpan) {
                if (status.lastSyncTime) {
                    lastSyncSpan.textContent = status.lastSyncTime.toLocaleString('ja-JP');
                } else {
                    lastSyncSpan.textContent = '未同期';
                }
            }
        }
        
        // メイン初期化（完全自動化）
        async function initialize() {
            try {
                console.log('🚀 Pipeline Google Sheets完全自動化統合システム初期化開始...');
                
                // ステップ1: 認証システム初期化
                const authReady = await initializeAuthenticationSystem();
                if (!authReady) {
                    return; // ログインページにリダイレクトされる
                }
                
                // ステップ2: 統合データ管理システム初期化
                if (window.UnifiedSheetsManager) {
                    await window.UnifiedSheetsManager.initialize();
                }
                
                // ステップ3: Google Sheets完全自動統合
                const integrationResult = await setupGoogleSheetsIntegration();
                
                console.log('📊 Google Sheets統合結果:', integrationResult);
                
                systemInitialized = true;
                console.log('✅ Pipeline Google Sheets完全自動化統合システム初期化完了');
                
            } catch (error) {
                console.error('❌ Pipeline Google Sheets完全自動化統合システム初期化エラー:', error);
                showAuthStatus(`初期化失敗: ${error.message}`, 'error');
            }
        }
        
        // ページ読み込み時に初期化
        window.addEventListener('load', initialize);
    </script>

    <!-- デバッグ機能 -->
    <script src="js/debug-customer-detail.js"></script>
    <script src="js/customer-detail-links.js"></script>
</body>
</html>
