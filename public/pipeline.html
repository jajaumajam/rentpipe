<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>パイプライン管理 - RentPipe</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/pipeline-responsive.css">
    
    <!-- Google Sheets統合用のスタイル -->
    <style>
        /* Google Sheets統合パネル */
        .sheets-panel {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .sheets-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .sheets-status-disconnected {
            background-color: #fef3c7;
            border: 1px solid #f59e0b;
            color: #92400e;
        }
        
        .sheets-status-connected {
            background-color: #d1fae5;
            border: 1px solid #10b981;
            color: #065f46;
        }
        
        .sheets-status-syncing {
            background-color: #dbeafe;
            border: 1px solid #3b82f6;
            color: #1e40af;
        }
        
        .sheets-status-error {
            background-color: #fee2e2;
            border: 1px solid #ef4444;
            color: #991b1b;
        }
        
        .sheets-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .sheets-info {
            background: #f8fafc;
            padding: 15px;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .sheets-info div {
            margin-bottom: 8px;
        }
        
        .auth-status {
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }
        
        .auth-status.success {
            background-color: #d1fae5;
            border: 1px solid #10b981;
            color: #065f46;
        }
        
        .auth-status.warning {
            background-color: #fef3c7;
            border: 1px solid #f59e0b;
            color: #92400e;
        }
        
        .auth-status.error {
            background-color: #fee2e2;
            border: 1px solid #ef4444;
            color: #991b1b;
        }
        
        .sync-icon {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .existing-sheets-list {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .existing-sheet-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }
        
        .existing-sheet-item:last-child {
            margin-bottom: 0;
        }
        
        .sheet-name {
            font-weight: 500;
            color: #374151;
        }
        
        .sheet-date {
            font-size: 12px;
            color: #6b7280;
        }
    </style>
</head>
<body>
    <!-- ナビゲーション -->
    <div id="navigation"></div>

    <div class="pipeline-container">
        <!-- 認証ステータス -->
        <div id="auth-sync-status" class="auth-status warning">
            🔧 システム初期化中...
        </div>
        
        <!-- Google Sheets統合パネル -->
        <div class="sheets-panel">
            <h3>📊 Google Sheets データ同期</h3>
            
            <div id="sheets-status" class="sheets-status sheets-status-disconnected">
                <div>
                    <strong>ステータス:</strong>
                    <span id="sheets-status-text">RentPipeデータベースを検索中...</span>
                </div>
                <div class="sheets-controls">
                    <button id="btn-sheets-connect" class="btn btn-primary" onclick="connectGoogleSheets()" style="display: none;">
                        📊 Google Sheets接続
                    </button>
                    <button id="btn-sheets-create" class="btn btn-success" onclick="createNewSpreadsheet()" style="display: none;">
                        📄 新規データベース作成
                    </button>
                    <button id="btn-sheets-sync" class="btn btn-success" onclick="syncWithSheets()" style="display: none;">
                        🔄 今すぐ同期
                    </button>
                </div>
            </div>
            
            <!-- 既存スプレッドシート一覧 -->
            <div id="existing-sheets-container" class="existing-sheets-list" style="display: none;">
                <h4>既存のRentPipeデータベース:</h4>
                <div id="existing-sheets-list"></div>
            </div>
            
            <div id="sheets-info" class="sheets-info" style="display: none;">
                <div><strong>スプレッドシートID:</strong> <span id="sheets-spreadsheet-id">-</span></div>
                <div><strong>データベース名:</strong> <span id="sheets-spreadsheet-name">-</span></div>
                <div><strong>最終同期:</strong> <span id="sheets-last-sync">-</span></div>
                <div><strong>同期モード:</strong> <span id="sheets-sync-mode">手動</span></div>
                <div style="margin-top: 10px;">
                    <a id="sheets-link" href="#" target="_blank" class="btn btn-secondary" style="display: none;">
                        🔗 データベースを開く
                    </a>
                </div>
            </div>
        </div>

        <div class="pipeline-header">
            <div class="header-left">
                <h1>パイプライン管理</h1>
                <p style="color: #64748b; margin-top: 5px;">顧客の進捗状況を可視化・管理 + Google Sheets自動同期</p>
            </div>
            <div class="header-actions">
                <button onclick="refreshPipeline()" class="btn btn-primary" id="refreshPipeline">
                    更新
                </button>
            </div>
        </div>

        <!-- パイプラインボード -->
        <div class="pipeline-board" id="pipelineBoard">
            <div class="pipeline-column" data-status="初回相談">
                <div class="column-header status-initial">
                    <span class="column-title">初回相談</span>
                    <span class="column-count" data-count="初回相談">0</span>
                </div>
                <div class="pipeline-cards" data-column="初回相談"></div>
            </div>

            <div class="pipeline-column" data-status="物件紹介">
                <div class="column-header status-presentation">
                    <span class="column-title">物件紹介</span>
                    <span class="column-count" data-count="物件紹介">0</span>
                </div>
                <div class="pipeline-cards" data-column="物件紹介"></div>
            </div>

            <div class="pipeline-column" data-status="内見">
                <div class="column-header status-viewing">
                    <span class="column-title">内見</span>
                    <span class="column-count" data-count="内見">0</span>
                </div>
                <div class="pipeline-cards" data-column="内見"></div>
            </div>

            <div class="pipeline-column" data-status="申込">
                <div class="column-header status-application">
                    <span class="column-title">申込</span>
                    <span class="column-count" data-count="申込">0</span>
                </div>
                <div class="pipeline-cards" data-column="申込"></div>
            </div>

            <div class="pipeline-column" data-status="審査">
                <div class="column-header status-screening">
                    <span class="column-title">審査</span>
                    <span class="column-count" data-count="審査">0</span>
                </div>
                <div class="pipeline-cards" data-column="審査"></div>
            </div>

            <div class="pipeline-column" data-status="契約">
                <div class="column-header status-contract">
                    <span class="column-title">契約</span>
                    <span class="column-count" data-count="契約">0</span>
                </div>
                <div class="pipeline-cards" data-column="契約"></div>
            </div>

            <div class="pipeline-column" data-status="完了">
                <div class="column-header status-complete">
                    <span class="column-title">完了</span>
                    <span class="column-count" data-count="完了">0</span>
                </div>
                <div class="pipeline-cards" data-column="完了"></div>
            </div>
        </div>
    </div>

    <!-- Google API Client & Identity Services -->
    <script src="https://accounts.google.com/gsi/client"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    
    <!-- RentPipe Core Scripts -->
    <script src="js/navigation.js"></script>
    <script src="js/integrated-auth-manager-v2.js"></script>
    <script src="js/unified-data-manager.js"></script>
    
    <!-- Google Integration Scripts -->
    <script src="js/google-drive-api-v2.js"></script>
    <script src="js/google-sheets-api.js"></script>
    <script src="js/unified-sheets-manager.js"></script>
    
    <!-- Pipeline Management Scripts -->
    <script src="js/pipeline-unified.js"></script>
    <script src="js/data-key-unifier.js"></script>
    <script src="js/local-first-sync.js"></script>
    <script src="js/cross-page-sync.js"></script>

    <!-- Pipeline RentPipeデータベース統一検索システム -->
    <script>
        // 🚀 Pipeline RentPipeデータベース統一検索システム
        console.log('🚀 Pipeline RentPipeデータベース統一検索システム初期化中...');
        
        // グローバル変数
        let systemInitialized = false;
        let currentAuthState = null;
        let foundSpreadsheets = [];
        
        // 認証状況表示
        function showAuthStatus(message, type) {
            const statusDiv = document.getElementById('auth-sync-status');
            if (statusDiv) {
                statusDiv.textContent = message;
                statusDiv.className = `auth-status ${type}`;
            }
        }
        
        // 認証システム初期化
        async function initializeAuthenticationSystem() {
            try {
                console.log('🔧 認証システム初期化中...');
                showAuthStatus('🔧 認証システム初期化中...', 'warning');
                
                if (!window.IntegratedAuthManagerV2) {
                    throw new Error('統合認証マネージャーV2が見つかりません');
                }
                
                currentAuthState = window.IntegratedAuthManagerV2.getAuthState();
                
                if (currentAuthState.isAuthenticated) {
                    showAuthStatus(`✅ ログイン済み: ${currentAuthState.rentpipeAuth.user?.email || 'ユーザー'}`, 'success');
                    return true;
                } else {
                    console.log('🔄 未認証のためログインページにリダイレクト...');
                    showAuthStatus('🔄 ログインページにリダイレクト中...', 'warning');
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 1000);
                    return false;
                }
                
            } catch (error) {
                console.error('❌ 認証システム初期化エラー:', error);
                showAuthStatus(`認証エラー: ${error.message}`, 'error');
                return false;
            }
        }
        
        // RentPipeデータベースを検索
        async function searchRentPipeDatabase() {
            try {
                console.log('🔍 RentPipeデータベースを検索中...');
                updateSheetsStatus('🔍 RentPipeデータベースを検索中...', 'syncing');
                
                // 「RentPipe_データベース」を含むスプレッドシートを検索
                const query = "name contains 'RentPipe_データベース' and mimeType='application/vnd.google-apps.spreadsheet' and trashed=false";
                
                const response = await gapi.client.request({
                    path: 'https://www.googleapis.com/drive/v3/files',
                    params: {
                        q: query,
                        fields: 'files(id,name,createdTime,modifiedTime)',
                        orderBy: 'modifiedTime desc'
                    }
                });
                
                foundSpreadsheets = response.result.files || [];
                console.log('🔍 検索結果:', foundSpreadsheets.length, '件のRentPipeデータベースが見つかりました');
                
                if (foundSpreadsheets.length > 0) {
                    foundSpreadsheets.forEach(sheet => {
                        console.log(`📄 発見: ${sheet.name} (ID: ${sheet.id})`);
                    });
                }
                
                return foundSpreadsheets;
                
            } catch (error) {
                console.error('❌ RentPipeデータベース検索エラー:', error);
                foundSpreadsheets = [];
                return [];
            }
        }
        
        // 既存データベース一覧表示
        function displayExistingDatabases(spreadsheets) {
            const container = document.getElementById('existing-sheets-container');
            const listDiv = document.getElementById('existing-sheets-list');
            
            if (spreadsheets.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'block';
            
            listDiv.innerHTML = spreadsheets.map(sheet => `
                <div class="existing-sheet-item">
                    <div>
                        <div class="sheet-name">${sheet.name}</div>
                        <div class="sheet-date">最終更新: ${new Date(sheet.modifiedTime).toLocaleDateString('ja-JP')}</div>
                    </div>
                    <button class="btn btn-primary" onclick="connectToExistingDatabase('${sheet.id}', '${sheet.name}')">
                        🔗 このデータベースを使用
                    </button>
                </div>
            `).join('');
        }
        
        // 既存データベースに接続
        async function connectToExistingDatabase(spreadsheetId, sheetName) {
            try {
                console.log('🔗 既存RentPipeデータベースに接続中:', sheetName);
                updateSheetsStatus('🔗 既存データベースに接続中...', 'syncing');
                
                // GoogleSheetsAPIとUnifiedSheetsManagerでスプレッドシートを設定
                await window.UnifiedSheetsManager.enableSheetsIntegration(spreadsheetId);
                
                // LocalStorageに統一キーで保存
                localStorage.setItem('rentpipe_spreadsheet_id', spreadsheetId);
                
                // UI更新
                showSheetsInfo(spreadsheetId, sheetName);
                document.getElementById('existing-sheets-container').style.display = 'none';
                document.getElementById('btn-sheets-sync').style.display = 'inline-block';
                updateSheetsStatus(`✅ 「${sheetName}」に接続完了`, 'connected');
                
                // パイプラインデータを再読み込み
                if (window.pipelineManager) {
                    await window.pipelineManager.loadPipeline();
                }
                
                console.log('✅ 既存RentPipeデータベース接続完了');
                
            } catch (error) {
                console.error('❌ 既存データベース接続エラー:', error);
                updateSheetsStatus('❌ 接続エラー: ' + error.message, 'error');
            }
        }
        
        // Google Sheets統合の完全自動設定
        async function setupGoogleSheetsIntegration() {
            try {
                console.log('📊 Google Sheets統合の完全自動設定開始...');
                
                // ステップ1: Google Sheets API初期化
                if (!window.GoogleSheetsAPI?.isInitialized) {
                    await window.GoogleSheetsAPI.initialize();
                }
                
                // ステップ2: ログイン認証情報を自動設定
                if (currentAuthState?.googleAuth?.isSignedIn && currentAuthState?.googleAuth?.accessToken) {
                    console.log('✅ ログイン認証情報をGoogle Sheetsで使用');
                    window.GoogleSheetsAPI.setAccessToken(currentAuthState.googleAuth.accessToken);
                    
                    // ステップ3a: LocalStorageから確認
                    const savedId = localStorage.getItem('rentpipe_spreadsheet_id');
                    
                    if (savedId) {
                        console.log('💾 LocalStorageから既存スプレッドシートID検出:', savedId);
                        
                        try {
                            // スプレッドシート名を取得
                            const sheetInfo = await gapi.client.request({
                                path: `https://www.googleapis.com/drive/v3/files/${savedId}`,
                                params: { fields: 'id,name' }
                            });
                            
                            await window.UnifiedSheetsManager.enableSheetsIntegration(savedId);
                            showSheetsInfo(savedId, sheetInfo.result.name);
                            document.getElementById('btn-sheets-sync').style.display = 'inline-block';
                            updateSheetsStatus(`✅ 「${sheetInfo.result.name}」に自動接続完了`, 'connected');
                            
                            return 'local_connected';
                            
                        } catch (error) {
                            console.warn('⚠️ LocalStorageのスプレッドシートIDが無効:', error);
                            localStorage.removeItem('rentpipe_spreadsheet_id');
                        }
                    }
                    
                    // ステップ3b: Googleドライブで「RentPipe_データベース」を検索
                    const spreadsheets = await searchRentPipeDatabase();
                    
                    if (spreadsheets.length > 0) {
                        console.log('🔍 RentPipeデータベースが見つかりました:', spreadsheets.length, '件');
                        
                        // 最新のデータベースに自動接続
                        const latestDatabase = spreadsheets[0];
                        await connectToExistingDatabase(latestDatabase.id, latestDatabase.name);
                        
                        // 複数ある場合は選択肢として表示
                        if (spreadsheets.length > 1) {
                            displayExistingDatabases(spreadsheets.slice(1));
                        }
                        
                        return 'database_connected';
                        
                    } else {
                        console.log('ℹ️ RentPipeデータベースが見つかりません - 新規作成が必要');
                        document.getElementById('btn-sheets-create').style.display = 'inline-block';
                        updateSheetsStatus('📄 RentPipeデータベースが見つかりません。新規作成してください。', 'disconnected');
                        
                        return 'database_not_found';
                    }
                    
                } else {
                    console.warn('⚠️ Google認証情報が不完全');
                    document.getElementById('btn-sheets-connect').style.display = 'inline-block';
                    updateSheetsStatus('⚠️ Google認証が必要です', 'disconnected');
                    
                    return 'auth_required';
                }
                
            } catch (error) {
                console.error('❌ Google Sheets統合エラー:', error);
                updateSheetsStatus('❌ 統合エラー: ' + error.message, 'error');
                document.getElementById('btn-sheets-connect').style.display = 'inline-block';
                
                return 'error';
            }
        }
        
        // 新規RentPipeデータベース作成
        async function createNewSpreadsheet() {
            const btn = document.getElementById('btn-sheets-create');
            const originalText = btn.textContent;
            
            try {
                btn.textContent = '作成中...';
                btn.disabled = true;
                
                updateSheetsStatus('📄 RentPipeデータベース作成中...', 'syncing');
                
                // 統一された命名規則: RentPipe_データベース_タイムスタンプ
                const timestamp = new Date().toLocaleString('ja-JP').replace(/\//g, '-').replace(/:/g, '-').replace(/\s/g, '_');
                const title = `RentPipe_データベース_${timestamp}`;
                
                const spreadsheetId = await window.GoogleSheetsAPI.createSpreadsheet(title);
                
                // 統一キーで保存
                localStorage.setItem('rentpipe_spreadsheet_id', spreadsheetId);
                
                await window.UnifiedSheetsManager.enableSheetsIntegration(spreadsheetId);
                
                updateSheetsStatus('✅ RentPipeデータベース作成完了 - 自動同期有効', 'connected');
                showSheetsInfo(spreadsheetId, title);
                
                btn.style.display = 'none';
                document.getElementById('btn-sheets-sync').style.display = 'inline-block';
                
                if (window.pipelineManager) {
                    await window.pipelineManager.loadPipeline();
                }
                
                console.log('✅ 新規RentPipeデータベース作成完了:', title);
                
            } catch (error) {
                console.error('❌ RentPipeデータベース作成エラー:', error);
                updateSheetsStatus('❌ 作成エラー: ' + error.message, 'error');
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }
        
        // Google Sheets手動接続
        async function connectGoogleSheets() {
            const btn = document.getElementById('btn-sheets-connect');
            const originalText = btn.textContent;
            
            try {
                btn.textContent = '接続中...';
                btn.disabled = true;
                
                updateSheetsStatus('🔐 Google認証中...', 'syncing');
                
                if (!window.GoogleDriveAPIv2?.isInitialized) {
                    await window.GoogleDriveAPIv2.initialize();
                }
                
                const userInfo = await window.GoogleDriveAPIv2.authenticate();
                
                if (!userInfo || !window.GoogleDriveAPIv2.accessToken) {
                    throw new Error('Google認証に失敗しました');
                }
                
                await window.IntegratedAuthManagerV2.updateGoogleAuth({
                    isSignedIn: true,
                    user: userInfo,
                    accessToken: window.GoogleDriveAPIv2.accessToken,
                    tokenExpiry: Date.now() + (3600 * 1000)
                });
                
                window.GoogleSheetsAPI.setAccessToken(window.GoogleDriveAPIv2.accessToken);
                
                btn.style.display = 'none';
                await setupGoogleSheetsIntegration();
                
            } catch (error) {
                console.error('❌ Google Sheets手動接続エラー:', error);
                updateSheetsStatus('❌ 接続エラー: ' + error.message, 'error');
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }
        
        // 手動同期
        async function syncWithSheets() {
            const btn = document.getElementById('btn-sheets-sync');
            const originalText = btn.textContent;
            
            try {
                btn.innerHTML = '<span class="sync-icon">🔄</span> 同期中...';
                btn.disabled = true;
                
                updateSheetsStatus('🔄 データ同期中...', 'syncing');
                
                await window.UnifiedSheetsManager.syncToSheets();
                
                updateSheetsStatus('✅ 同期完了', 'connected');
                updateLastSyncTime();
                
                btn.textContent = originalText;
                btn.disabled = false;
                
            } catch (error) {
                console.error('❌ 同期エラー:', error);
                updateSheetsStatus('❌ 同期エラー: ' + error.message, 'error');
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }
        
        // ステータス更新
        function updateSheetsStatus(message, type) {
            const statusDiv = document.getElementById('sheets-status');
            const statusText = document.getElementById('sheets-status-text');
            
            if (statusText) {
                statusText.textContent = message;
            }
            if (statusDiv) {
                statusDiv.className = `sheets-status sheets-status-${type}`;
            }
        }
        
        // スプレッドシート情報表示
        function showSheetsInfo(spreadsheetId, sheetName = '') {
            const infoDiv = document.getElementById('sheets-info');
            const idSpan = document.getElementById('sheets-spreadsheet-id');
            const nameSpan = document.getElementById('sheets-spreadsheet-name');
            const link = document.getElementById('sheets-link');
            
            if (idSpan) idSpan.textContent = spreadsheetId;
            if (nameSpan) nameSpan.textContent = sheetName || '不明';
            if (link) {
                link.href = `https://docs.google.com/spreadsheets/d/${spreadsheetId}`;
                link.style.display = 'inline-block';
            }
            if (infoDiv) infoDiv.style.display = 'block';
            
            const syncMode = document.getElementById('sheets-sync-mode');
            if (syncMode) syncMode.textContent = '自動（5分ごと）';
            
            updateLastSyncTime();
        }
        
        // 最終同期時刻更新
        function updateLastSyncTime() {
            const status = window.UnifiedSheetsManager.getStatus();
            const lastSyncSpan = document.getElementById('sheets-last-sync');
            
            if (lastSyncSpan) {
                if (status.lastSyncTime) {
                    lastSyncSpan.textContent = status.lastSyncTime.toLocaleString('ja-JP');
                } else {
                    lastSyncSpan.textContent = '未同期';
                }
            }
        }
        
        // メイン初期化
        async function initialize() {
            try {
                console.log('🚀 Pipeline RentPipeデータベース統一検索システム初期化開始...');
                
                const authReady = await initializeAuthenticationSystem();
                if (!authReady) {
                    return;
                }
                
                if (window.UnifiedSheetsManager) {
                    await window.UnifiedSheetsManager.initialize();
                }
                
                const integrationResult = await setupGoogleSheetsIntegration();
                console.log('📊 Google Sheets統合結果:', integrationResult);
                
                systemInitialized = true;
                console.log('✅ Pipeline RentPipeデータベース統一検索システム初期化完了');
                
            } catch (error) {
                console.error('❌ Pipeline RentPipeデータベース統一検索システム初期化エラー:', error);
                showAuthStatus(`初期化失敗: ${error.message}`, 'error');
            }
        }
        
        // ページ読み込み時に初期化
        window.addEventListener('load', initialize);
    </script>

    <!-- デバッグ機能 -->
    <script src="js/debug-customer-detail.js"></script>
    <script src="js/customer-detail-links.js"></script>
</body>
</html>
