<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ç®¡ç† - RentPipe</title>
    <link rel="stylesheet" href="css/main.css">
    <!-- Tailwind CSS (local build) -->
    <link rel="stylesheet" href="css/tailwind-output.css">

    <style>
        @keyframes skeleton-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .status-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }
        .status-modal-overlay.active {
            display: flex;
        }
        .status-option.current {
            border-color: #10b981 !important;
            background: #ecfdf5 !important;
        }
        .status-option:hover {
            border-color: #667eea !important;
            background: #eef2ff !important;
        }

        /* ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
        #pipeline-container {
            display: grid;
            grid-template-columns: repeat(6, minmax(230px, 1fr));
            gap: 16px;
            overflow-x: auto;
            padding-bottom: 12px;
        }
        @media (max-width: 768px) {
            #pipeline-container {
                grid-template-columns: 1fr;
                overflow-x: visible;
            }
        }
    </style>
</head>
<body>
    <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="status-modal-overlay" id="status-modal">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl">
            <h3 id="status-modal-title" class="text-lg font-bold text-gray-900 text-center mb-4">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å¤‰æ›´</h3>
            <div class="status-options flex flex-col gap-2 mb-4" id="status-options">
                <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒå‹•çš„ã«ç”Ÿæˆã•ã‚Œã¾ã™ -->
            </div>
            <button class="status-option w-full py-2.5 bg-gray-100 hover:bg-gray-200 text-gray-600 rounded-xl text-sm font-medium transition-colors border-0 cursor-pointer" onclick="closeStatusModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
    </div>

    <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <div id="navigation"></div>

    <!-- ãŠçŸ¥ã‚‰ã›ãƒãƒŠãƒ¼ -->
    <div id="notification-banners" class="max-w-screen-xl mx-auto px-5 pt-4"></div>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <div class="max-w-screen-xl mx-auto px-5 py-6">
        <!-- ãƒšãƒ¼ã‚¸ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="flex items-center justify-between mb-6">
            <div>
                <h1 class="text-2xl font-bold text-gray-900">ğŸ“Š ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ç®¡ç†</h1>
                <p class="text-sm text-gray-500 mt-1">é¡§å®¢ã®é€²æ—çŠ¶æ³ã‚’å¯è¦–åŒ–ãƒ»ç®¡ç†</p>
            </div>
            <a href="customer.html" class="inline-flex items-center gap-2 px-4 py-2 text-sm font-semibold text-gray-600 bg-white border border-gray-200 rounded-xl shadow-sm hover:shadow-md hover:-translate-y-0.5 transition-all duration-200">
                ğŸ‘¥ é¡§å®¢ä¸€è¦§ã¸
            </a>
        </div>

        <!-- ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ -->
        <div id="pipeline-container">
            <!-- åˆæœŸã‚¹ã‚±ãƒ«ãƒˆãƒ³ -->
            <div id="pipeline-skeleton" style="display:flex;gap:16px;width:100%;padding:8px 0;grid-column:1/-1;">
                <div style="flex:1;background:#f1f5f9;border-radius:12px;min-height:300px;animation:skeleton-pulse 1.5s ease-in-out infinite;"></div>
                <div style="flex:1;background:#f1f5f9;border-radius:12px;min-height:300px;animation:skeleton-pulse 1.5s ease-in-out infinite 0.2s;"></div>
                <div style="flex:1;background:#f1f5f9;border-radius:12px;min-height:300px;animation:skeleton-pulse 1.5s ease-in-out infinite 0.4s;"></div>
                <div style="flex:1;background:#f1f5f9;border-radius:12px;min-height:300px;animation:skeleton-pulse 1.5s ease-in-out infinite 0.6s;"></div>
            </div>
        </div>
    </div>

    <!-- Google API Client & Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="js/config.js"></script>
    <script src="js/session-manager.js"></script>
    <script src="js/navigation.js"></script>
    <script src="js/integrated-auth-manager-v2.js"></script>
    <script src="js/google-drive-api-v2.js"></script>
    <script src="js/google-sheets-api.js"></script>
    <script src="js/data-migration.js"></script>
    <script src="js/unified-sheets-manager.js"></script>
    <script src="js/unified-data-manager.js"></script>
    <script src="js/archive-manager.js"></script>
    <script src="js/app-initializer.js"></script>
    <script src="js/page-initializer.js"></script>
    <script src="js/pipeline-unified.js"></script>

    <script>
        console.log('ğŸ“Š ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿é–‹å§‹...');

        // ã‚¹ã‚±ãƒ«ãƒˆãƒ³é™¤å»
        function hideLoading() {
            const skeleton = document.getElementById('pipeline-skeleton');
            if (skeleton) skeleton.remove();
        }

        // æœ€å¤§5ç§’ã§ã‚¹ã‚±ãƒ«ãƒˆãƒ³ã‚’å¼·åˆ¶é™¤å»ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
        setTimeout(hideLoading, 5000);

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeStatusModal() {
            document.getElementById('status-modal').classList.remove('active');
            if (window.pipelineManager) {
                window.pipelineManager.pendingStatusChange = null;
            }
        }

        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–å¾Œã®å‡¦ç†
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³è¡¨ç¤º
                loadNavigation();

                // PageInitializerã§å…±é€šåˆæœŸåŒ–ï¼ˆèªè¨¼ãƒ»ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ï¼‰
                await PageInitializer.initialize({
                    onDataUpdated: () => {
                        console.log('ğŸ”” ãƒ‡ãƒ¼ã‚¿æ›´æ–°é€šçŸ¥å—ä¿¡ - å†æç”»');
                        if (window.pipelineManager) {
                            window.pipelineManager.renderPipeline();
                        }
                    }
                });

                // ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³æç”»
                if (window.pipelineManager) {
                    window.pipelineManager.renderPipeline();
                }

                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çµ‚äº†
                hideLoading();

            } catch (error) {
                console.error('pipeline.html åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                hideLoading();
            }
        });

        // ãƒšãƒ¼ã‚¸ãŒãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’å¾—ãŸã¨ãï¼ˆã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆç­‰ï¼‰ã«è‡ªå‹•æ›´æ–°
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                console.log('ğŸ‘ï¸ ãƒšãƒ¼ã‚¸ãŒãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’å¾—ã¾ã—ãŸ - ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å†æç”»');
                if (window.pipelineManager) {
                    window.pipelineManager.renderPipeline();
                }
            }
        });

        // ä»–ã®ã‚¿ãƒ–/ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§localStorageãŒå¤‰æ›´ã•ã‚ŒãŸã¨ãã«è‡ªå‹•æ›´æ–°
        window.addEventListener('storage', (event) => {
            if (event.key && event.key.includes('rentpipe')) {
                console.log('ğŸ’¾ ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å¤‰æ›´æ¤œå‡º - ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å†æç”»');
                if (window.pipelineManager) {
                    window.pipelineManager.renderPipeline();
                }
            }
        });

        // ãƒšãƒ¼ã‚¸ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãŒæˆ»ã£ãŸã¨ãã«ã‚‚æ›´æ–°ï¼ˆwindow.onfocusï¼‰
        window.addEventListener('focus', () => {
            console.log('ğŸ¯ ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’å¾—ã¾ã—ãŸ - ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å†æç”»');
            setTimeout(() => {
                if (window.pipelineManager) {
                    window.pipelineManager.renderPipeline();
                }
            }, 100);
        });
    </script>
</body>
</html>
