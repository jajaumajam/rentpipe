<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ç®¡ç† - RentPipe</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/pipeline-responsive.css">
    
    <!-- Google Sheetsçµ±åˆç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« -->
    <style>
        /* Google Sheetsçµ±åˆãƒ‘ãƒãƒ« */
        .sheets-panel {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .sheets-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .sheets-status-disconnected {
            background-color: #fef3c7;
            border: 1px solid #f59e0b;
            color: #92400e;
        }
        
        .sheets-status-connected {
            background-color: #d1fae5;
            border: 1px solid #10b981;
            color: #065f46;
        }
        
        .sheets-status-syncing {
            background-color: #dbeafe;
            border: 1px solid #3b82f6;
            color: #1e40af;
        }
        
        .sheets-status-error {
            background-color: #fee2e2;
            border: 1px solid #ef4444;
            color: #991b1b;
        }
        
        .sheets-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .sheets-info {
            background: #f8fafc;
            padding: 15px;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .sheets-info div {
            margin-bottom: 8px;
        }
        
        .auth-status {
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }
        
        .auth-status.success {
            background-color: #d1fae5;
            border: 1px solid #10b981;
            color: #065f46;
        }
        
        .auth-status.warning {
            background-color: #fef3c7;
            border: 1px solid #f59e0b;
            color: #92400e;
        }
        
        .auth-status.error {
            background-color: #fee2e2;
            border: 1px solid #ef4444;
            color: #991b1b;
        }
        
        .sync-icon {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <div id="navigation"></div>

    <div class="pipeline-container">
        <!-- èªè¨¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
        <div id="auth-sync-status" class="auth-status warning">
            ğŸ”§ ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ä¸­...
        </div>
        
        <!-- Google Sheetsçµ±åˆãƒ‘ãƒãƒ« -->
        <div class="sheets-panel">
            <h3>ğŸ“Š Google Sheets ãƒ‡ãƒ¼ã‚¿åŒæœŸ</h3>
            
            <div id="sheets-status" class="sheets-status sheets-status-disconnected">
                <div>
                    <strong>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:</strong>
                    <span id="sheets-status-text">æœªæ¥ç¶š - Google Sheetsã¨é€£æºã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’åŒæœŸã§ãã¾ã™</span>
                </div>
                <div class="sheets-controls">
                    <button id="btn-sheets-connect" class="btn btn-primary" onclick="connectGoogleSheets()">
                        ğŸ“Š Google Sheetsæ¥ç¶š
                    </button>
                    <button id="btn-sheets-create" class="btn btn-success" onclick="createNewSpreadsheet()" style="display: none;">
                        ğŸ“„ æ–°è¦ä½œæˆ
                    </button>
                    <button id="btn-sheets-sync" class="btn btn-success" onclick="syncWithSheets()" style="display: none;">
                        ğŸ”„ ä»Šã™ãåŒæœŸ
                    </button>
                </div>
            </div>
            
            <div id="sheets-info" class="sheets-info" style="display: none;">
                <div><strong>ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆID:</strong> <span id="sheets-spreadsheet-id">-</span></div>
                <div><strong>æœ€çµ‚åŒæœŸ:</strong> <span id="sheets-last-sync">-</span></div>
                <div><strong>åŒæœŸãƒ¢ãƒ¼ãƒ‰:</strong> <span id="sheets-sync-mode">æ‰‹å‹•</span></div>
                <div style="margin-top: 10px;">
                    <a id="sheets-link" href="#" target="_blank" class="btn btn-secondary" style="display: none;">
                        ğŸ”— ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’é–‹ã
                    </a>
                </div>
            </div>
        </div>

        <div class="pipeline-header">
            <div class="header-left">
                <h1>ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ç®¡ç†</h1>
                <p style="color: #64748b; margin-top: 5px;">é¡§å®¢ã®é€²æ—çŠ¶æ³ã‚’å¯è¦–åŒ–ãƒ»ç®¡ç† + Google Sheetsè‡ªå‹•åŒæœŸ</p>
            </div>
            <div class="header-actions">
                <button onclick="refreshPipeline()" class="btn btn-primary" id="refreshPipeline">
                    æ›´æ–°
                </button>
            </div>
        </div>

        <!-- ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ãƒœãƒ¼ãƒ‰ -->
        <div class="pipeline-board" id="pipelineBoard">
            <div class="pipeline-column" data-status="åˆå›ç›¸è«‡">
                <div class="column-header status-initial">
                    <span class="column-title">åˆå›ç›¸è«‡</span>
                    <span class="column-count" data-count="åˆå›ç›¸è«‡">0</span>
                </div>
                <div class="pipeline-cards" data-column="åˆå›ç›¸è«‡"></div>
            </div>

            <div class="pipeline-column" data-status="ç‰©ä»¶ç´¹ä»‹">
                <div class="column-header status-presentation">
                    <span class="column-title">ç‰©ä»¶ç´¹ä»‹</span>
                    <span class="column-count" data-count="ç‰©ä»¶ç´¹ä»‹">0</span>
                </div>
                <div class="pipeline-cards" data-column="ç‰©ä»¶ç´¹ä»‹"></div>
            </div>

            <div class="pipeline-column" data-status="å†…è¦‹">
                <div class="column-header status-viewing">
                    <span class="column-title">å†…è¦‹</span>
                    <span class="column-count" data-count="å†…è¦‹">0</span>
                </div>
                <div class="pipeline-cards" data-column="å†…è¦‹"></div>
            </div>

            <div class="pipeline-column" data-status="ç”³è¾¼">
                <div class="column-header status-application">
                    <span class="column-title">ç”³è¾¼</span>
                    <span class="column-count" data-count="ç”³è¾¼">0</span>
                </div>
                <div class="pipeline-cards" data-column="ç”³è¾¼"></div>
            </div>

            <div class="pipeline-column" data-status="å¯©æŸ»">
                <div class="column-header status-screening">
                    <span class="column-title">å¯©æŸ»</span>
                    <span class="column-count" data-count="å¯©æŸ»">0</span>
                </div>
                <div class="pipeline-cards" data-column="å¯©æŸ»"></div>
            </div>

            <div class="pipeline-column" data-status="å¥‘ç´„">
                <div class="column-header status-contract">
                    <span class="column-title">å¥‘ç´„</span>
                    <span class="column-count" data-count="å¥‘ç´„">0</span>
                </div>
                <div class="pipeline-cards" data-column="å¥‘ç´„"></div>
            </div>

            <div class="pipeline-column" data-status="å®Œäº†">
                <div class="column-header status-complete">
                    <span class="column-title">å®Œäº†</span>
                    <span class="column-count" data-count="å®Œäº†">0</span>
                </div>
                <div class="pipeline-cards" data-column="å®Œäº†"></div>
            </div>
        </div>
    </div>

    <!-- Google API Client & Identity Services -->
    <script src="https://accounts.google.com/gsi/client"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    
    <!-- RentPipe Core Scripts -->
    <script src="js/navigation.js"></script>
    <script src="js/integrated-auth-manager-v2.js"></script>
    <script src="js/unified-data-manager.js"></script>
    
    <!-- Google Integration Scripts -->
    <script src="js/google-drive-api-v2.js"></script>
    <script src="js/google-sheets-api.js"></script>
    <script src="js/unified-sheets-manager.js"></script>
    
    <!-- Pipeline Management Scripts -->
    <script src="js/pipeline-unified.js"></script>
    <script src="js/data-key-unifier.js"></script>
    <script src="js/local-first-sync.js"></script>
    <script src="js/cross-page-sync.js"></script>

    <!-- Pipeline Google Sheets Integration Script -->
    <script>
        // ğŸš€ Pipeline Google Sheetsçµ±åˆã‚·ã‚¹ãƒ†ãƒ 
        console.log('ğŸš€ Pipeline Google Sheetsçµ±åˆã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ä¸­...');
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let systemInitialized = false;
        
        // èªè¨¼çŠ¶æ³è¡¨ç¤º
        function showAuthStatus(message, type) {
            const statusDiv = document.getElementById('auth-sync-status');
            if (statusDiv) {
                statusDiv.textContent = message;
                statusDiv.className = `auth-status ${type}`;
            }
        }
        
        // èªè¨¼ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ï¼ˆcustomer.htmlã¨åŒã˜å®Ÿè£…ï¼‰
        async function initializeAuthenticationSystem() {
            try {
                console.log('ğŸ”§ èªè¨¼ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ä¸­...');
                showAuthStatus('ğŸ”§ èªè¨¼ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ä¸­...', 'warning');
                
                // çµ±åˆèªè¨¼ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼V2ã‚’ä½¿ç”¨ï¼ˆæ­£ã—ã„åå‰ï¼‰
                if (!window.IntegratedAuthManagerV2) {
                    throw new Error('çµ±åˆèªè¨¼ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼V2ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
                
                // æ—¢å­˜ã®èªè¨¼çŠ¶æ…‹ç¢ºèª
                const authState = window.IntegratedAuthManagerV2.getAuthState();
                
                if (authState.isAuthenticated) {
                    showAuthStatus(`âœ… ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿: ${authState.rentpipeAuth.user?.email || 'ãƒ¦ãƒ¼ã‚¶ãƒ¼'}`, 'success');
                    return true;
                } else {
                    // ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
                    console.log('ğŸ”„ æœªèªè¨¼ã®ãŸã‚ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ...');
                    showAuthStatus('ğŸ”„ ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆä¸­...', 'warning');
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 1000);
                    return false;
                }
                
            } catch (error) {
                console.error('âŒ èªè¨¼ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                showAuthStatus(`èªè¨¼ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                return false;
            }
        }
        
        // Google Sheetsæ¥ç¶š
        async function connectGoogleSheets() {
            const btn = document.getElementById('btn-sheets-connect');
            const originalText = btn.textContent;
            
            try {
                btn.innerHTML = '<span class="sync-icon">ğŸ”„</span> æ¥ç¶šä¸­...';
                btn.disabled = true;
                
                updateSheetsStatus('ğŸ”„ Google Sheetsæ¥ç¶šä¸­...', 'syncing');
                
                // çµ±åˆãƒ‡ãƒ¼ã‚¿ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã§Sheetsçµ±åˆã‚’æœ‰åŠ¹åŒ–
                const success = await window.UnifiedSheetsManager.enableSheetsIntegration();
                
                if (success) {
                    updateSheetsStatus('âœ… Google Sheetsæ¥ç¶šå®Œäº†', 'connected');
                    btn.style.display = 'none';
                    document.getElementById('btn-sheets-create').style.display = 'inline-block';
                } else {
                    throw new Error('Google Sheetsæ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
                
                btn.textContent = originalText;
                btn.disabled = false;
                
            } catch (error) {
                console.error('âŒ Google Sheetsæ¥ç¶šã‚¨ãƒ©ãƒ¼:', error);
                updateSheetsStatus('âŒ æ¥ç¶šã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }
        
        // æ–°è¦ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆä½œæˆ
        async function createNewSpreadsheet() {
            const btn = document.getElementById('btn-sheets-create');
            const originalText = btn.textContent;
            
            try {
                btn.innerHTML = '<span class="sync-icon">ğŸ”„</span> ä½œæˆä¸­...';
                btn.disabled = true;
                
                updateSheetsStatus('ğŸ“„ ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆä½œæˆä¸­...', 'syncing');
                
                const timestamp = new Date().toLocaleString('ja-JP').replace(/\//g, '-').replace(/:/g, '-').replace(/\s/g, '_');
                const title = `RentPipe_ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³_${timestamp}`;
                
                const spreadsheetId = await window.GoogleSheetsAPI.createSpreadsheet(title);
                
                await window.UnifiedSheetsManager.enableSheetsIntegration(spreadsheetId);
                
                updateSheetsStatus('âœ… ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆä½œæˆå®Œäº† - è‡ªå‹•åŒæœŸæœ‰åŠ¹', 'connected');
                showSheetsInfo(spreadsheetId);
                
                btn.style.display = 'none';
                document.getElementById('btn-sheets-sync').style.display = 'inline-block';
                
                // ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
                if (window.pipelineManager) {
                    await window.pipelineManager.loadPipeline();
                }
                
            } catch (error) {
                console.error('âŒ ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆä½œæˆã‚¨ãƒ©ãƒ¼:', error);
                updateSheetsStatus('âŒ ä½œæˆã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }
        
        // æ‰‹å‹•åŒæœŸ
        async function syncWithSheets() {
            const btn = document.getElementById('btn-sheets-sync');
            const originalText = btn.textContent;
            
            try {
                btn.innerHTML = '<span class="sync-icon">ğŸ”„</span> åŒæœŸä¸­...';
                btn.disabled = true;
                
                updateSheetsStatus('ğŸ”„ ãƒ‡ãƒ¼ã‚¿åŒæœŸä¸­...', 'syncing');
                
                await window.UnifiedSheetsManager.syncToSheets();
                
                updateSheetsStatus('âœ… åŒæœŸå®Œäº†', 'connected');
                updateLastSyncTime();
                
                btn.textContent = originalText;
                btn.disabled = false;
                
            } catch (error) {
                console.error('âŒ åŒæœŸã‚¨ãƒ©ãƒ¼:', error);
                updateSheetsStatus('âŒ åŒæœŸã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }
        
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        function updateSheetsStatus(message, type) {
            const statusDiv = document.getElementById('sheets-status');
            const statusText = document.getElementById('sheets-status-text');
            
            if (statusText) {
                statusText.textContent = message;
            }
            if (statusDiv) {
                statusDiv.className = `sheets-status sheets-status-${type}`;
            }
        }
        
        // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆæƒ…å ±è¡¨ç¤º
        function showSheetsInfo(spreadsheetId) {
            const infoDiv = document.getElementById('sheets-info');
            const idSpan = document.getElementById('sheets-spreadsheet-id');
            const link = document.getElementById('sheets-link');
            
            if (idSpan) idSpan.textContent = spreadsheetId;
            if (link) {
                link.href = `https://docs.google.com/spreadsheets/d/${spreadsheetId}`;
                link.style.display = 'inline-block';
            }
            if (infoDiv) infoDiv.style.display = 'block';
            
            const syncMode = document.getElementById('sheets-sync-mode');
            if (syncMode) syncMode.textContent = 'è‡ªå‹•ï¼ˆ5åˆ†ã”ã¨ï¼‰';
            
            updateLastSyncTime();
        }
        
        // æœ€çµ‚åŒæœŸæ™‚åˆ»æ›´æ–°
        function updateLastSyncTime() {
            const status = window.UnifiedSheetsManager.getStatus();
            const lastSyncSpan = document.getElementById('sheets-last-sync');
            
            if (lastSyncSpan) {
                if (status.lastSyncTime) {
                    lastSyncSpan.textContent = status.lastSyncTime.toLocaleString('ja-JP');
                } else {
                    lastSyncSpan.textContent = 'æœªåŒæœŸ';
                }
            }
        }
        
        // åˆæœŸåŒ–
        async function initialize() {
            try {
                console.log('ğŸš€ Pipeline Google Sheetsçµ±åˆã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–é–‹å§‹...');
                
                // èªè¨¼ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–
                const authReady = await initializeAuthenticationSystem();
                if (!authReady) {
                    return; // ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã‚‹
                }
                
                // çµ±åˆãƒ‡ãƒ¼ã‚¿ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–
                if (window.UnifiedSheetsManager) {
                    await window.UnifiedSheetsManager.initialize();
                
                    // æ—¢å­˜ã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆIDãŒã‚ã‚Œã°ãƒœã‚¿ãƒ³è¡¨ç¤ºã‚’èª¿æ•´
                    const savedId = window.GoogleSheetsAPI?.loadSpreadsheetId();
                    if (savedId && window.UnifiedSheetsManager.isSheetsEnabled) {
                        document.getElementById('btn-sheets-connect').style.display = 'none';
                        document.getElementById('btn-sheets-sync').style.display = 'inline-block';
                        showSheetsInfo(savedId);
                        updateSheetsStatus('âœ… Google Sheetsçµ±åˆæœ‰åŠ¹', 'connected');
                    }
                }
                
                systemInitialized = true;
                console.log('âœ… Pipeline Google Sheetsçµ±åˆã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†');
                
            } catch (error) {
                console.error('âŒ Pipeline Google Sheetsçµ±åˆã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                showAuthStatus(`åˆæœŸåŒ–å¤±æ•—: ${error.message}`, 'error');
            }
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆæœŸåŒ–
        window.addEventListener('load', initialize);
    </script>

    <!-- ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½ -->
    <script src="js/debug-customer-detail.js"></script>
    <script src="js/customer-detail-links.js"></script>
</body>
</html>
