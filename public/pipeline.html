<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ç®¡ç† - RentPipe</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/pipeline-responsive.css">
    
    <!-- Google Sheetsçµ±åˆç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« -->
    <style>
        /* Google Sheetsçµ±åˆãƒ‘ãƒãƒ« */
        .sheets-panel {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .sheets-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .sheets-status-disconnected {
            background-color: #fef3c7;
            border: 1px solid #f59e0b;
            color: #92400e;
        }
        
        .sheets-status-connected {
            background-color: #d1fae5;
            border: 1px solid #10b981;
            color: #065f46;
        }
        
        .sheets-status-syncing {
            background-color: #dbeafe;
            border: 1px solid #3b82f6;
            color: #1e40af;
        }
        
        .sheets-status-error {
            background-color: #fee2e2;
            border: 1px solid #ef4444;
            color: #991b1b;
        }
        
        .sheets-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .sheets-info {
            background: #f8fafc;
            padding: 15px;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .sheets-info div {
            margin-bottom: 8px;
        }
        
        .auth-status {
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }
        
        .auth-status.success {
            background-color: #d1fae5;
            border: 1px solid #10b981;
            color: #065f46;
        }
        
        .auth-status.warning {
            background-color: #fef3c7;
            border: 1px solid #f59e0b;
            color: #92400e;
        }
        
        .auth-status.error {
            background-color: #fee2e2;
            border: 1px solid #ef4444;
            color: #991b1b;
        }
        
        .sync-icon {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .existing-sheets-list {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .existing-sheet-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }
        
        .existing-sheet-item:last-child {
            margin-bottom: 0;
        }
        
        .sheet-name {
            font-weight: 500;
            color: #374151;
        }
        
        .sheet-date {
            font-size: 12px;
            color: #6b7280;
        }
    </style>
</head>
<body>
    <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <div id="navigation"></div>

    <div class="pipeline-container">
        <!-- èªè¨¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
        <div id="auth-sync-status" class="auth-status warning">
            ğŸ”§ ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ä¸­...
        </div>
        
        <!-- Google Sheetsçµ±åˆãƒ‘ãƒãƒ« -->
        <div class="sheets-panel">
            <h3>ğŸ“Š Google Sheets ãƒ‡ãƒ¼ã‚¿åŒæœŸ</h3>
            
            <div id="sheets-status" class="sheets-status sheets-status-disconnected">
                <div>
                    <strong>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:</strong>
                    <span id="sheets-status-text">RentPipeãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’æ¤œç´¢ä¸­...</span>
                </div>
                <div class="sheets-controls">
                    <button id="btn-sheets-connect" class="btn btn-primary" onclick="connectGoogleSheets()" style="display: none;">
                        ğŸ“Š Google Sheetsæ¥ç¶š
                    </button>
                    <button id="btn-sheets-create" class="btn btn-success" onclick="createNewSpreadsheet()" style="display: none;">
                        ğŸ“„ æ–°è¦ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä½œæˆ
                    </button>
                    <button id="btn-sheets-sync" class="btn btn-success" onclick="syncWithSheets()" style="display: none;">
                        ğŸ”„ ä»Šã™ãåŒæœŸ
                    </button>
                </div>
            </div>
            
            <!-- æ—¢å­˜ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆä¸€è¦§ -->
            <div id="existing-sheets-container" class="existing-sheets-list" style="display: none;">
                <h4>æ—¢å­˜ã®RentPipeãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹:</h4>
                <div id="existing-sheets-list"></div>
            </div>
            
            <div id="sheets-info" class="sheets-info" style="display: none;">
                <div><strong>ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆID:</strong> <span id="sheets-spreadsheet-id">-</span></div>
                <div><strong>ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å:</strong> <span id="sheets-spreadsheet-name">-</span></div>
                <div><strong>æœ€çµ‚åŒæœŸ:</strong> <span id="sheets-last-sync">-</span></div>
                <div><strong>åŒæœŸãƒ¢ãƒ¼ãƒ‰:</strong> <span id="sheets-sync-mode">æ‰‹å‹•</span></div>
                <div style="margin-top: 10px;">
                    <a id="sheets-link" href="#" target="_blank" class="btn btn-secondary" style="display: none;">
                        ğŸ”— ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’é–‹ã
                    </a>
                </div>
            </div>
        </div>

        <div class="pipeline-header">
            <div class="header-left">
                <h1>ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ç®¡ç†</h1>
                <p style="color: #64748b; margin-top: 5px;">é¡§å®¢ã®é€²æ—çŠ¶æ³ã‚’å¯è¦–åŒ–ãƒ»ç®¡ç† + Google Sheetsè‡ªå‹•åŒæœŸ</p>
            </div>
            <div class="header-actions">
                <button onclick="refreshPipeline()" class="btn btn-primary" id="refreshPipeline">
                    æ›´æ–°
                </button>
            </div>
        </div>

        <!-- ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ãƒœãƒ¼ãƒ‰ -->
        <div class="pipeline-board" id="pipelineBoard">
            <div class="pipeline-column" data-status="åˆå›ç›¸è«‡">
                <div class="column-header status-initial">
                    <span class="column-title">åˆå›ç›¸è«‡</span>
                    <span class="column-count" data-count="åˆå›ç›¸è«‡">0</span>
                </div>
                <div class="pipeline-cards" data-column="åˆå›ç›¸è«‡"></div>
            </div>

            <div class="pipeline-column" data-status="ç‰©ä»¶ç´¹ä»‹">
                <div class="column-header status-presentation">
                    <span class="column-title">ç‰©ä»¶ç´¹ä»‹</span>
                    <span class="column-count" data-count="ç‰©ä»¶ç´¹ä»‹">0</span>
                </div>
                <div class="pipeline-cards" data-column="ç‰©ä»¶ç´¹ä»‹"></div>
            </div>

            <div class="pipeline-column" data-status="å†…è¦‹">
                <div class="column-header status-viewing">
                    <span class="column-title">å†…è¦‹</span>
                    <span class="column-count" data-count="å†…è¦‹">0</span>
                </div>
                <div class="pipeline-cards" data-column="å†…è¦‹"></div>
            </div>

            <div class="pipeline-column" data-status="ç”³è¾¼">
                <div class="column-header status-application">
                    <span class="column-title">ç”³è¾¼</span>
                    <span class="column-count" data-count="ç”³è¾¼">0</span>
                </div>
                <div class="pipeline-cards" data-column="ç”³è¾¼"></div>
            </div>

            <div class="pipeline-column" data-status="å¯©æŸ»">
                <div class="column-header status-screening">
                    <span class="column-title">å¯©æŸ»</span>
                    <span class="column-count" data-count="å¯©æŸ»">0</span>
                </div>
                <div class="pipeline-cards" data-column="å¯©æŸ»"></div>
            </div>

            <div class="pipeline-column" data-status="å¥‘ç´„">
                <div class="column-header status-contract">
                    <span class="column-title">å¥‘ç´„</span>
                    <span class="column-count" data-count="å¥‘ç´„">0</span>
                </div>
                <div class="pipeline-cards" data-column="å¥‘ç´„"></div>
            </div>

            <div class="pipeline-column" data-status="å®Œäº†">
                <div class="column-header status-complete">
                    <span class="column-title">å®Œäº†</span>
                    <span class="column-count" data-count="å®Œäº†">0</span>
                </div>
                <div class="pipeline-cards" data-column="å®Œäº†"></div>
            </div>
        </div>
    </div>

    <!-- Google API Client & Identity Services -->
    <script src="https://accounts.google.com/gsi/client"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    
    <!-- RentPipe Core Scripts -->
    <script src="js/navigation.js"></script>
    <script src="js/integrated-auth-manager-v2.js"></script>
    <script src="js/unified-data-manager.js"></script>
    
    <!-- Google Integration Scripts -->
    <script src="js/google-drive-api-v2.js"></script>
    <script src="js/google-sheets-api.js"></script>
    <script src="js/unified-sheets-manager.js"></script>
    
    <!-- Pipeline Management Scripts -->
    <script src="js/pipeline-unified.js"></script>
    <script src="js/data-key-unifier.js"></script>
    <script src="js/local-first-sync.js"></script>
    <script src="js/cross-page-sync.js"></script>

    <!-- Pipeline RentPipeãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹çµ±ä¸€æ¤œç´¢ã‚·ã‚¹ãƒ†ãƒ  -->
    <script>
        // ğŸš€ Pipeline RentPipeãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹çµ±ä¸€æ¤œç´¢ã‚·ã‚¹ãƒ†ãƒ 
        console.log('ğŸš€ Pipeline RentPipeãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹çµ±ä¸€æ¤œç´¢ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ä¸­...');
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let systemInitialized = false;
        let currentAuthState = null;
        let foundSpreadsheets = [];
        
        // èªè¨¼çŠ¶æ³è¡¨ç¤º
        function showAuthStatus(message, type) {
            const statusDiv = document.getElementById('auth-sync-status');
            if (statusDiv) {
                statusDiv.textContent = message;
                statusDiv.className = `auth-status ${type}`;
            }
        }
        
        // èªè¨¼ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–
        async function initializeAuthenticationSystem() {
            try {
                console.log('ğŸ”§ èªè¨¼ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ä¸­...');
                showAuthStatus('ğŸ”§ èªè¨¼ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ä¸­...', 'warning');
                
                if (!window.IntegratedAuthManagerV2) {
                    throw new Error('çµ±åˆèªè¨¼ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼V2ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
                
                currentAuthState = window.IntegratedAuthManagerV2.getAuthState();
                
                if (currentAuthState.isAuthenticated) {
                    showAuthStatus(`âœ… ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿: ${currentAuthState.rentpipeAuth.user?.email || 'ãƒ¦ãƒ¼ã‚¶ãƒ¼'}`, 'success');
                    return true;
                } else {
                    console.log('ğŸ”„ æœªèªè¨¼ã®ãŸã‚ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ...');
                    showAuthStatus('ğŸ”„ ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆä¸­...', 'warning');
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 1000);
                    return false;
                }
                
            } catch (error) {
                console.error('âŒ èªè¨¼ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                showAuthStatus(`èªè¨¼ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                return false;
            }
        }
        
        // RentPipeãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’æ¤œç´¢
        async function searchRentPipeDatabase() {
            try {
                console.log('ğŸ” RentPipeãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’æ¤œç´¢ä¸­...');
                updateSheetsStatus('ğŸ” RentPipeãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’æ¤œç´¢ä¸­...', 'syncing');
                
                // ã€ŒRentPipe_ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã€ã‚’å«ã‚€ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’æ¤œç´¢
                const query = "name contains 'RentPipe_ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹' and mimeType='application/vnd.google-apps.spreadsheet' and trashed=false";
                
                const response = await gapi.client.request({
                    path: 'https://www.googleapis.com/drive/v3/files',
                    params: {
                        q: query,
                        fields: 'files(id,name,createdTime,modifiedTime)',
                        orderBy: 'modifiedTime desc'
                    }
                });
                
                foundSpreadsheets = response.result.files || [];
                console.log('ğŸ” æ¤œç´¢çµæœ:', foundSpreadsheets.length, 'ä»¶ã®RentPipeãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ');
                
                if (foundSpreadsheets.length > 0) {
                    foundSpreadsheets.forEach(sheet => {
                        console.log(`ğŸ“„ ç™ºè¦‹: ${sheet.name} (ID: ${sheet.id})`);
                    });
                }
                
                return foundSpreadsheets;
                
            } catch (error) {
                console.error('âŒ RentPipeãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¤œç´¢ã‚¨ãƒ©ãƒ¼:', error);
                foundSpreadsheets = [];
                return [];
            }
        }
        
        // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä¸€è¦§è¡¨ç¤º
        function displayExistingDatabases(spreadsheets) {
            const container = document.getElementById('existing-sheets-container');
            const listDiv = document.getElementById('existing-sheets-list');
            
            if (spreadsheets.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'block';
            
            listDiv.innerHTML = spreadsheets.map(sheet => `
                <div class="existing-sheet-item">
                    <div>
                        <div class="sheet-name">${sheet.name}</div>
                        <div class="sheet-date">æœ€çµ‚æ›´æ–°: ${new Date(sheet.modifiedTime).toLocaleDateString('ja-JP')}</div>
                    </div>
                    <button class="btn btn-primary" onclick="connectToExistingDatabase('${sheet.id}', '${sheet.name}')">
                        ğŸ”— ã“ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½¿ç”¨
                    </button>
                </div>
            `).join('');
        }
        
        // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ¥ç¶š
        async function connectToExistingDatabase(spreadsheetId, sheetName) {
            try {
                console.log('ğŸ”— æ—¢å­˜RentPipeãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ¥ç¶šä¸­:', sheetName);
                updateSheetsStatus('ğŸ”— æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ¥ç¶šä¸­...', 'syncing');
                
                // GoogleSheetsAPIã¨UnifiedSheetsManagerã§ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’è¨­å®š
                await window.UnifiedSheetsManager.enableSheetsIntegration(spreadsheetId);
                
                // LocalStorageã«çµ±ä¸€ã‚­ãƒ¼ã§ä¿å­˜
                localStorage.setItem('rentpipe_spreadsheet_id', spreadsheetId);
                
                // UIæ›´æ–°
                showSheetsInfo(spreadsheetId, sheetName);
                document.getElementById('existing-sheets-container').style.display = 'none';
                document.getElementById('btn-sheets-sync').style.display = 'inline-block';
                updateSheetsStatus(`âœ… ã€Œ${sheetName}ã€ã«æ¥ç¶šå®Œäº†`, 'connected');
                
                // ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
                if (window.pipelineManager) {
                    await window.pipelineManager.loadPipeline();
                }
                
                console.log('âœ… æ—¢å­˜RentPipeãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šå®Œäº†');
                
            } catch (error) {
                console.error('âŒ æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚¨ãƒ©ãƒ¼:', error);
                updateSheetsStatus('âŒ æ¥ç¶šã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
            }
        }
        
        // Google Sheetsçµ±åˆã®å®Œå…¨è‡ªå‹•è¨­å®š
        async function setupGoogleSheetsIntegration() {
            try {
                console.log('ğŸ“Š Google Sheetsçµ±åˆã®å®Œå…¨è‡ªå‹•è¨­å®šé–‹å§‹...');
                
                // ã‚¹ãƒ†ãƒƒãƒ—1: Google Sheets APIåˆæœŸåŒ–
                if (!window.GoogleSheetsAPI?.isInitialized) {
                    await window.GoogleSheetsAPI.initialize();
                }
                
                // ã‚¹ãƒ†ãƒƒãƒ—2: ãƒ­ã‚°ã‚¤ãƒ³èªè¨¼æƒ…å ±ã‚’è‡ªå‹•è¨­å®š
                if (currentAuthState?.googleAuth?.isSignedIn && currentAuthState?.googleAuth?.accessToken) {
                    console.log('âœ… ãƒ­ã‚°ã‚¤ãƒ³èªè¨¼æƒ…å ±ã‚’Google Sheetsã§ä½¿ç”¨');
                    window.GoogleSheetsAPI.setAccessToken(currentAuthState.googleAuth.accessToken);
                    
                    // ã‚¹ãƒ†ãƒƒãƒ—3a: LocalStorageã‹ã‚‰ç¢ºèª
                    const savedId = localStorage.getItem('rentpipe_spreadsheet_id');
                    
                    if (savedId) {
                        console.log('ğŸ’¾ LocalStorageã‹ã‚‰æ—¢å­˜ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆIDæ¤œå‡º:', savedId);
                        
                        try {
                            // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆåã‚’å–å¾—
                            const sheetInfo = await gapi.client.request({
                                path: `https://www.googleapis.com/drive/v3/files/${savedId}`,
                                params: { fields: 'id,name' }
                            });
                            
                            await window.UnifiedSheetsManager.enableSheetsIntegration(savedId);
                            showSheetsInfo(savedId, sheetInfo.result.name);
                            document.getElementById('btn-sheets-sync').style.display = 'inline-block';
                            updateSheetsStatus(`âœ… ã€Œ${sheetInfo.result.name}ã€ã«è‡ªå‹•æ¥ç¶šå®Œäº†`, 'connected');
                            
                            return 'local_connected';
                            
                        } catch (error) {
                            console.warn('âš ï¸ LocalStorageã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆIDãŒç„¡åŠ¹:', error);
                            localStorage.removeItem('rentpipe_spreadsheet_id');
                        }
                    }
                    
                    // ã‚¹ãƒ†ãƒƒãƒ—3b: Googleãƒ‰ãƒ©ã‚¤ãƒ–ã§ã€ŒRentPipe_ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã€ã‚’æ¤œç´¢
                    const spreadsheets = await searchRentPipeDatabase();
                    
                    if (spreadsheets.length > 0) {
                        console.log('ğŸ” RentPipeãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ:', spreadsheets.length, 'ä»¶');
                        
                        // æœ€æ–°ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«è‡ªå‹•æ¥ç¶š
                        const latestDatabase = spreadsheets[0];
                        await connectToExistingDatabase(latestDatabase.id, latestDatabase.name);
                        
                        // è¤‡æ•°ã‚ã‚‹å ´åˆã¯é¸æŠè‚¢ã¨ã—ã¦è¡¨ç¤º
                        if (spreadsheets.length > 1) {
                            displayExistingDatabases(spreadsheets.slice(1));
                        }
                        
                        return 'database_connected';
                        
                    } else {
                        console.log('â„¹ï¸ RentPipeãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ - æ–°è¦ä½œæˆãŒå¿…è¦');
                        document.getElementById('btn-sheets-create').style.display = 'inline-block';
                        updateSheetsStatus('ğŸ“„ RentPipeãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚æ–°è¦ä½œæˆã—ã¦ãã ã•ã„ã€‚', 'disconnected');
                        
                        return 'database_not_found';
                    }
                    
                } else {
                    console.warn('âš ï¸ Googleèªè¨¼æƒ…å ±ãŒä¸å®Œå…¨');
                    document.getElementById('btn-sheets-connect').style.display = 'inline-block';
                    updateSheetsStatus('âš ï¸ Googleèªè¨¼ãŒå¿…è¦ã§ã™', 'disconnected');
                    
                    return 'auth_required';
                }
                
            } catch (error) {
                console.error('âŒ Google Sheetsçµ±åˆã‚¨ãƒ©ãƒ¼:', error);
                updateSheetsStatus('âŒ çµ±åˆã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
                document.getElementById('btn-sheets-connect').style.display = 'inline-block';
                
                return 'error';
            }
        }
        
        // æ–°è¦RentPipeãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä½œæˆ
        async function createNewSpreadsheet() {
            const btn = document.getElementById('btn-sheets-create');
            const originalText = btn.textContent;
            
            try {
                btn.textContent = 'ä½œæˆä¸­...';
                btn.disabled = true;
                
                updateSheetsStatus('ğŸ“„ RentPipeãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä½œæˆä¸­...', 'syncing');
                
                // çµ±ä¸€ã•ã‚ŒãŸå‘½åè¦å‰‡: RentPipe_ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹_ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
                const timestamp = new Date().toLocaleString('ja-JP').replace(/\//g, '-').replace(/:/g, '-').replace(/\s/g, '_');
                const title = `RentPipe_ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹_${timestamp}`;
                
                const spreadsheetId = await window.GoogleSheetsAPI.createSpreadsheet(title);
                
                // çµ±ä¸€ã‚­ãƒ¼ã§ä¿å­˜
                localStorage.setItem('rentpipe_spreadsheet_id', spreadsheetId);
                
                await window.UnifiedSheetsManager.enableSheetsIntegration(spreadsheetId);
                
                updateSheetsStatus('âœ… RentPipeãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä½œæˆå®Œäº† - è‡ªå‹•åŒæœŸæœ‰åŠ¹', 'connected');
                showSheetsInfo(spreadsheetId, title);
                
                btn.style.display = 'none';
                document.getElementById('btn-sheets-sync').style.display = 'inline-block';
                
                if (window.pipelineManager) {
                    await window.pipelineManager.loadPipeline();
                }
                
                console.log('âœ… æ–°è¦RentPipeãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä½œæˆå®Œäº†:', title);
                
            } catch (error) {
                console.error('âŒ RentPipeãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä½œæˆã‚¨ãƒ©ãƒ¼:', error);
                updateSheetsStatus('âŒ ä½œæˆã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }
        
        // Google Sheetsæ‰‹å‹•æ¥ç¶š
        async function connectGoogleSheets() {
            const btn = document.getElementById('btn-sheets-connect');
            const originalText = btn.textContent;
            
            try {
                btn.textContent = 'æ¥ç¶šä¸­...';
                btn.disabled = true;
                
                updateSheetsStatus('ğŸ” Googleèªè¨¼ä¸­...', 'syncing');
                
                if (!window.GoogleDriveAPIv2?.isInitialized) {
                    await window.GoogleDriveAPIv2.initialize();
                }
                
                const userInfo = await window.GoogleDriveAPIv2.authenticate();
                
                if (!userInfo || !window.GoogleDriveAPIv2.accessToken) {
                    throw new Error('Googleèªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
                
                await window.IntegratedAuthManagerV2.updateGoogleAuth({
                    isSignedIn: true,
                    user: userInfo,
                    accessToken: window.GoogleDriveAPIv2.accessToken,
                    tokenExpiry: Date.now() + (3600 * 1000)
                });
                
                window.GoogleSheetsAPI.setAccessToken(window.GoogleDriveAPIv2.accessToken);
                
                btn.style.display = 'none';
                await setupGoogleSheetsIntegration();
                
            } catch (error) {
                console.error('âŒ Google Sheetsæ‰‹å‹•æ¥ç¶šã‚¨ãƒ©ãƒ¼:', error);
                updateSheetsStatus('âŒ æ¥ç¶šã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }
        
        // æ‰‹å‹•åŒæœŸ
        async function syncWithSheets() {
            const btn = document.getElementById('btn-sheets-sync');
            const originalText = btn.textContent;
            
            try {
                btn.innerHTML = '<span class="sync-icon">ğŸ”„</span> åŒæœŸä¸­...';
                btn.disabled = true;
                
                updateSheetsStatus('ğŸ”„ ãƒ‡ãƒ¼ã‚¿åŒæœŸä¸­...', 'syncing');
                
                await window.UnifiedSheetsManager.syncToSheets();
                
                updateSheetsStatus('âœ… åŒæœŸå®Œäº†', 'connected');
                updateLastSyncTime();
                
                btn.textContent = originalText;
                btn.disabled = false;
                
            } catch (error) {
                console.error('âŒ åŒæœŸã‚¨ãƒ©ãƒ¼:', error);
                updateSheetsStatus('âŒ åŒæœŸã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }
        
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        function updateSheetsStatus(message, type) {
            const statusDiv = document.getElementById('sheets-status');
            const statusText = document.getElementById('sheets-status-text');
            
            if (statusText) {
                statusText.textContent = message;
            }
            if (statusDiv) {
                statusDiv.className = `sheets-status sheets-status-${type}`;
            }
        }
        
        // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆæƒ…å ±è¡¨ç¤º
        function showSheetsInfo(spreadsheetId, sheetName = '') {
            const infoDiv = document.getElementById('sheets-info');
            const idSpan = document.getElementById('sheets-spreadsheet-id');
            const nameSpan = document.getElementById('sheets-spreadsheet-name');
            const link = document.getElementById('sheets-link');
            
            if (idSpan) idSpan.textContent = spreadsheetId;
            if (nameSpan) nameSpan.textContent = sheetName || 'ä¸æ˜';
            if (link) {
                link.href = `https://docs.google.com/spreadsheets/d/${spreadsheetId}`;
                link.style.display = 'inline-block';
            }
            if (infoDiv) infoDiv.style.display = 'block';
            
            const syncMode = document.getElementById('sheets-sync-mode');
            if (syncMode) syncMode.textContent = 'è‡ªå‹•ï¼ˆ5åˆ†ã”ã¨ï¼‰';
            
            updateLastSyncTime();
        }
        
        // æœ€çµ‚åŒæœŸæ™‚åˆ»æ›´æ–°
        function updateLastSyncTime() {
            const status = window.UnifiedSheetsManager.getStatus();
            const lastSyncSpan = document.getElementById('sheets-last-sync');
            
            if (lastSyncSpan) {
                if (status.lastSyncTime) {
                    lastSyncSpan.textContent = status.lastSyncTime.toLocaleString('ja-JP');
                } else {
                    lastSyncSpan.textContent = 'æœªåŒæœŸ';
                }
            }
        }
        
        // ãƒ¡ã‚¤ãƒ³åˆæœŸåŒ–
        async function initialize() {
            try {
                console.log('ğŸš€ Pipeline RentPipeãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹çµ±ä¸€æ¤œç´¢ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–é–‹å§‹...');
                
                const authReady = await initializeAuthenticationSystem();
                if (!authReady) {
                    return;
                }
                
                if (window.UnifiedSheetsManager) {
                    await window.UnifiedSheetsManager.initialize();
                }
                
                const integrationResult = await setupGoogleSheetsIntegration();
                console.log('ğŸ“Š Google Sheetsçµ±åˆçµæœ:', integrationResult);
                
                systemInitialized = true;
                console.log('âœ… Pipeline RentPipeãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹çµ±ä¸€æ¤œç´¢ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†');
                
            } catch (error) {
                console.error('âŒ Pipeline RentPipeãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹çµ±ä¸€æ¤œç´¢ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                showAuthStatus(`åˆæœŸåŒ–å¤±æ•—: ${error.message}`, 'error');
            }
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆæœŸåŒ–
        window.addEventListener('load', initialize);
    </script>

    <!-- ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½ -->
    <script src="js/debug-customer-detail.js"></script>
    <script src="js/customer-detail-links.js"></script>
</body>
</html>
