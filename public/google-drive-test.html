<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Drive API ãƒ†ã‚¹ãƒˆ - RentPipe</title>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #0056b3; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 5px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>ğŸ§ª Google Drive API ãƒ†ã‚¹ãƒˆ</h1>
    
    <div class="test-section">
        <h2>1. èªè¨¼çŠ¶æ…‹ç¢ºèª</h2>
        <button onclick="checkAuth()">èªè¨¼çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯</button>
        <div id="auth-result"></div>
    </div>
    
    <div class="test-section">
        <h2>2. Google Drive APIåˆæœŸåŒ–</h2>
        <button onclick="initializeDriveAPI()">Drive APIåˆæœŸåŒ–</button>
        <div id="drive-init-result"></div>
    </div>
    
    <div class="test-section">
        <h2>3. RentPipeãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ä½œæˆ</h2>
        <button onclick="createRentPipeFolder()">ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ä½œæˆ</button>
        <div id="folder-result"></div>
    </div>
    
    <div class="test-section">
        <h2>4. CSVå¤‰æ›ãƒ†ã‚¹ãƒˆ</h2>
        <button onclick="testCSVConversion()">CSVå¤‰æ›ãƒ†ã‚¹ãƒˆ</button>
        <div id="csv-result"></div>
    </div>

    <!-- Firebaseè¨­å®šï¼ˆæ—¢å­˜ï¼‰ -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    
    <!-- æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ  -->
    <script src="js/firebase-config-google.js"></script>
    <script src="js/unified-data-manager.js"></script>
    
    <!-- æ–°è¦æ©Ÿèƒ½ -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="js/google-drive-api.js"></script>
    <script src="js/csv-data-manager.js"></script>
    
    <script>
        // ãƒ†ã‚¹ãƒˆé–¢æ•°ç¾¤
        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : '';
            element.innerHTML = `<div class="${className}"><pre>${message}</pre></div>`;
        }
        
        async function checkAuth() {
            try {
                log('auth-result', 'èªè¨¼çŠ¶æ…‹ç¢ºèªä¸­...');
                
                if (window.auth && window.auth.currentUser) {
                    const user = window.auth.currentUser;
                    log('auth-result', `âœ… èªè¨¼æ¸ˆã¿\nUID: ${user.uid}\nEmail: ${user.email || 'ãªã—'}`, 'success');
                } else {
                    log('auth-result', 'âŒ æœªèªè¨¼ã§ã™ã€‚Googleãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚', 'error');
                }
            } catch (error) {
                log('auth-result', `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }
        
        async function initializeDriveAPI() {
            try {
                log('drive-init-result', 'Google Drive APIåˆæœŸåŒ–ä¸­...');
                
                const result = await window.GoogleDriveAPI.initialize();
                if (result) {
                    log('drive-init-result', 'âœ… Google Drive APIåˆæœŸåŒ–æˆåŠŸ', 'success');
                } else {
                    log('drive-init-result', 'âŒ Google Drive APIåˆæœŸåŒ–å¤±æ•—', 'error');
                }
            } catch (error) {
                log('drive-init-result', `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }
        
        async function createRentPipeFolder() {
            try {
                log('folder-result', 'RentPipeãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ä½œæˆä¸­...');
                
                const folderId = await window.GoogleDriveAPI.ensureRentPipeFolder();
                if (folderId) {
                    log('folder-result', `âœ… RentPipeãƒ•ã‚©ãƒ«ãƒ€ãƒ¼æº–å‚™å®Œäº†\nãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ID: ${folderId}`, 'success');
                } else {
                    log('folder-result', 'âŒ ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ä½œæˆå¤±æ•—', 'error');
                }
            } catch (error) {
                log('folder-result', `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }
        
        function testCSVConversion() {
            try {
                log('csv-result', 'CSVå¤‰æ›ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...');
                
                // ãƒ†ã‚¹ãƒˆç”¨é¡§å®¢ãƒ‡ãƒ¼ã‚¿
                const testCustomers = [
                    {
                        id: 'test-001',
                        name: 'ãƒ†ã‚¹ãƒˆå¤ªéƒ',
                        email: 'test@example.com',
                        phone: '090-1234-5678',
                        pipelineStatus: 'åˆå›ç›¸è«‡',
                        preferences: {
                            budgetMin: 50000,
                            budgetMax: 100000,
                            areas: ['æ¸‹è°·', 'æ–°å®¿'],
                            roomType: '1K',
                            requirements: ['é§…è¿‘', 'ãƒšãƒƒãƒˆå¯']
                        },
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    }
                ];
                
                // CSVå¤‰æ›ãƒ†ã‚¹ãƒˆ
                const csvContent = window.CSVDataManager.customersToCSV(testCustomers);
                
                // CSV â†’ é¡§å®¢ãƒ‡ãƒ¼ã‚¿å¤‰æ›ãƒ†ã‚¹ãƒˆ
                const convertedCustomers = window.CSVDataManager.csvToCustomers(csvContent);
                
                const result = `âœ… CSVå¤‰æ›ãƒ†ã‚¹ãƒˆæˆåŠŸ
                
å…ƒãƒ‡ãƒ¼ã‚¿: ${testCustomers.length}ä»¶
CSVå¤‰æ›å¾Œ:
${csvContent.split('\n').slice(0, 3).join('\n')}
...

é€†å¤‰æ›å¾Œ: ${convertedCustomers.length}ä»¶
é¡§å®¢å: ${convertedCustomers[0]?.name}
äºˆç®—: ${convertedCustomers[0]?.preferences?.budgetMin}ã€œ${convertedCustomers[0]?.preferences?.budgetMax}å††`;
                
                log('csv-result', result, 'success');
                
            } catch (error) {
                log('csv-result', `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // Firebaseèªè¨¼ã®åˆæœŸåŒ–ã‚’å¾…ã¤
            setTimeout(() => {
                if (window.auth) {
                    window.auth.onAuthStateChanged(function(user) {
                        console.log('èªè¨¼çŠ¶æ…‹å¤‰æ›´:', user ? 'èªè¨¼æ¸ˆã¿' : 'æœªèªè¨¼');
                    });
                }
            }, 1000);
        });
    </script>
</body>
</html>
