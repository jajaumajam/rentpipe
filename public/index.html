<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RentPipe - è³ƒè²¸å–¶æ¥­ã‚’ã€æµã‚Œã‚‹ã‚ˆã†ã«</title>
    <link rel="stylesheet" href="css/main.css">
</head>
<body>
    <div class="dashboard-container">
        <div class="welcome-message">
            <h1>ãŠã‹ãˆã‚Šãªã•ã„ï¼ğŸ‘‹</h1>
            <p id="currentDate">ä»Šæ—¥ã‚‚ç´ æ™´ã‚‰ã—ã„ä¸€æ—¥ã«ãªã‚Šã¾ã™ã‚ˆã†ã«</p>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">ğŸ‘¥</div>
                <div class="stat-value" id="totalCustomers">0</div>
                <div class="stat-label">ç·é¡§å®¢æ•°</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">ğŸ”„</div>
                <div class="stat-value" id="activeDeals">0</div>
                <div class="stat-label">é€²è¡Œä¸­ã®å•†è«‡</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">âœ…</div>
                <div class="stat-value" id="completedDeals">0</div>
                <div class="stat-label">ä»Šæœˆã®æˆç´„</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">ğŸ“ˆ</div>
                <div class="stat-value" id="conversionRate">0%</div>
                <div class="stat-label">æˆç´„ç‡</div>
            </div>
        </div>

        <div class="quick-actions">
            <a href="customer.html" class="action-btn">
                <span>â•</span>
                <span>æ–°è¦é¡§å®¢ç™»éŒ²</span>
            </a>
            <a href="pipeline.html" class="action-btn">
                <span>ğŸ“Š</span>
                <span>ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ç¢ºèª</span>
            </a>
            <button onclick="exportData()" class="action-btn">
                <span>ğŸ’¾</span>
                <span>ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</span>
            </button>
        </div>

        <div class="activity-section">
            <div class="activity-header">
                <h2>æœ€è¿‘ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£</h2>
                <button class="btn btn-sm btn-outline" onclick="refreshActivities()">æ›´æ–°</button>
            </div>
            <div class="activity-list" id="activityList">
                <div class="activity-item">
                    <div class="activity-icon">ğŸ“</div>
                    <div class="activity-content">
                        <div class="activity-title">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
                        <div class="activity-time">ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="js/unified-auth.js"></script>
    <script src="js/unified-data-manager.js"></script>
    <script src="js/navigation.js"></script>
    <script src="js/firebase-config.js"></script>
    
    <script>
        // ç¾åœ¨ã®æ—¥ä»˜ã‚’è¡¨ç¤º
        const currentDate = new Date();
        const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
        document.getElementById('currentDate').textContent = 
            currentDate.toLocaleDateString('ja-JP', options) + ' - ä»Šæ—¥ã‚‚ç´ æ™´ã‚‰ã—ã„ä¸€æ—¥ã«ãªã‚Šã¾ã™ã‚ˆã†ã«';

        // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®çµ±è¨ˆã‚’æ›´æ–°
        function updateDashboardStats() {
            const customers = JSON.parse(localStorage.getItem('rentpipe_demo_customers') || '[]');
            
            // ç·é¡§å®¢æ•°
            document.getElementById('totalCustomers').textContent = customers.length;
            
            // é€²è¡Œä¸­ã®å•†è«‡ï¼ˆåˆå›ç›¸è«‡ã€œå¥‘ç´„ã¾ã§ï¼‰
            const activeStatuses = ['åˆå›ç›¸è«‡', 'ç‰©ä»¶ç´¹ä»‹', 'å†…è¦‹', 'ç”³è¾¼', 'å¯©æŸ»', 'å¥‘ç´„'];
            const activeDeals = customers.filter(c => activeStatuses.includes(c.pipelineStatus)).length;
            document.getElementById('activeDeals').textContent = activeDeals;
            
            // ä»Šæœˆã®æˆç´„
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const completedThisMonth = customers.filter(c => {
                if (c.pipelineStatus !== 'å®Œäº†') return false;
                const updatedDate = new Date(c.updatedAt);
                return updatedDate.getMonth() === currentMonth && 
                       updatedDate.getFullYear() === currentYear;
            }).length;
            document.getElementById('completedDeals').textContent = completedThisMonth;
            
            // æˆç´„ç‡
            const completed = customers.filter(c => c.pipelineStatus === 'å®Œäº†').length;
            const rate = customers.length > 0 ? Math.round((completed / customers.length) * 100) : 0;
            document.getElementById('conversionRate').textContent = rate + '%';
        }

        // ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ãƒªã‚¹ãƒˆã‚’æ›´æ–°
        function updateActivityList() {
            const customers = JSON.parse(localStorage.getItem('rentpipe_demo_customers') || '[]');
            const activities = [];
            
            // é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚’ç”Ÿæˆ
            customers.forEach(customer => {
                activities.push({
                    icon: 'ğŸ‘¤',
                    title: `${customer.name}ã•ã‚“ - ${customer.pipelineStatus}`,
                    time: new Date(customer.updatedAt),
                    type: 'customer'
                });
            });
            
            // æ™‚é–“é †ã«ã‚½ãƒ¼ãƒˆï¼ˆæ–°ã—ã„é †ï¼‰
            activities.sort((a, b) => b.time - a.time);
            
            // æœ€æ–°5ä»¶ã‚’è¡¨ç¤º
            const activityList = document.getElementById('activityList');
            const recentActivities = activities.slice(0, 5);
            
            if (recentActivities.length === 0) {
                activityList.innerHTML = `
                    <div class="activity-item">
                        <div class="activity-icon">ğŸ’¤</div>
                        <div class="activity-content">
                            <div class="activity-title">ã¾ã ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ãŒã‚ã‚Šã¾ã›ã‚“</div>
                            <div class="activity-time">æ–°è¦é¡§å®¢ã‚’ç™»éŒ²ã—ã¦ã¿ã¾ã—ã‚‡ã†</div>
                        </div>
                    </div>
                `;
                return;
            }
            
            activityList.innerHTML = recentActivities.map(activity => {
                const timeAgo = getTimeAgo(activity.time);
                return `
                    <div class="activity-item">
                        <div class="activity-icon">${activity.icon}</div>
                        <div class="activity-content">
                            <div class="activity-title">${activity.title}</div>
                            <div class="activity-time">${timeAgo}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // æ™‚é–“å·®ã‚’è¨ˆç®—
        function getTimeAgo(date) {
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (minutes < 1) return 'ãŸã£ãŸä»Š';
            if (minutes < 60) return `${minutes}åˆ†å‰`;
            if (hours < 24) return `${hours}æ™‚é–“å‰`;
            if (days < 30) return `${days}æ—¥å‰`;
            return date.toLocaleDateString('ja-JP');
        }

        // ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚’æ›´æ–°
        function refreshActivities() {
            updateActivityList();
            updateDashboardStats();
        }

        // ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        function exportData() {
            const customers = localStorage.getItem('rentpipe_demo_customers') || '[]';
            const blob = new Blob([customers], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `rentpipe_backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            updateDashboardStats();
            updateActivityList();
            
            // ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ã®ç”Ÿæˆï¼ˆåˆå›ã®ã¿ï¼‰
            if (!localStorage.getItem('rentpipe_demo_initialized')) {
                generateDemoData();
                localStorage.setItem('rentpipe_demo_initialized', 'true');
                refreshActivities();
            }
        });

        // ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
        function generateDemoData() {
            const demoCustomers = [
                {
                    id: 'demo-1',
                    name: 'ç”°ä¸­ ä¸€éƒ',
                    email: 'tanaka@example.com',
                    phone: '090-1234-5678',
                    pipelineStatus: 'ç‰©ä»¶ç´¹ä»‹',
                    preferences: {
                        budgetMin: 8,
                        budgetMax: 12,
                        areas: ['æ¸‹è°·', 'æ–°å®¿'],
                        roomType: '1LDK'
                    },
                    notes: '3æœˆæœ«ã¾ã§ã«å¼•ã£è¶Šã—å¸Œæœ›',
                    createdAt: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString(),
                    updatedAt: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString()
                },
                {
                    id: 'demo-2',
                    name: 'ä½è—¤ èŠ±å­',
                    email: 'sato@example.com',
                    phone: '080-9876-5432',
                    pipelineStatus: 'å†…è¦‹',
                    preferences: {
                        budgetMin: 10,
                        budgetMax: 15,
                        areas: ['ç›®é»’', 'ä¸–ç”°è°·'],
                        roomType: '2LDK'
                    },
                    notes: 'ãƒšãƒƒãƒˆå¯ç‰©ä»¶å¸Œæœ›',
                    createdAt: new Date(Date.now() - 14 * 24 * 60 * 60 * 1000).toISOString(),
                    updatedAt: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString()
                },
                {
                    id: 'demo-3',
                    name: 'éˆ´æœ¨ å¤ªéƒ',
                    email: 'suzuki@example.com',
                    phone: '070-1111-2222',
                    pipelineStatus: 'å¯©æŸ»',
                    preferences: {
                        budgetMin: 6,
                        budgetMax: 9,
                        areas: ['æ¸‹è°·'],
                        roomType: '1K'
                    },
                    notes: 'é§…è¿‘å¸Œæœ›',
                    createdAt: new Date(Date.now() - 21 * 24 * 60 * 60 * 1000).toISOString(),
                    updatedAt: new Date().toISOString()
                }
            ];
            
            localStorage.setItem('rentpipe_demo_customers', JSON.stringify(demoCustomers));
        }
    </script>
</body>
</html>
