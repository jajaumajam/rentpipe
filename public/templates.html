<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ - RentPipe</title>
    <link rel="stylesheet" href="css/main.css">
    <!-- Tailwind CSS (local build) -->
    <link rel="stylesheet" href="css/tailwind-output.css">

    <style>
        .templates-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        .page-header {
            margin-bottom: 30px;
        }

        .page-header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .page-header p {
            color: #6b7280;
        }

        /* è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .settings-panel {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 24px;
        }

        .settings-panel h3 {
            margin: 0 0 16px 0;
            font-size: 16px;
            color: #374151;
        }

        .settings-row {
            display: flex;
            gap: 16px;
            align-items: flex-end;
            flex-wrap: wrap;
        }

        .settings-field {
            flex: 1;
            min-width: 200px;
        }

        .settings-field label {
            display: block;
            font-size: 13px;
            color: #6b7280;
            margin-bottom: 6px;
        }

        .settings-field input {
            width: 100%;
            padding: 10px 14px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
        }

        .settings-field input:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .settings-actions {
            display: flex;
            gap: 8px;
        }

        .settings-btn {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .settings-btn.primary {
            background: #3b82f6;
            color: white;
        }

        .settings-btn.primary:hover {
            background: #2563eb;
        }

        .settings-btn.secondary {
            background: #f3f4f6;
            color: #374151;
        }

        .settings-btn.secondary:hover {
            background: #e5e7eb;
        }

        /* ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚¿ãƒ– */
        .category-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .category-tab {
            padding: 10px 20px;
            border: 2px solid #e5e7eb;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .category-tab:hover {
            border-color: #3b82f6;
        }

        .category-tab.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        /* é¡§å®¢é¸æŠ */
        .customer-select-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 24px;
        }

        .customer-select-section h3 {
            margin: 0 0 12px 0;
            font-size: 16px;
            color: #374151;
        }

        .customer-select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            background: white;
        }

        .customer-select:focus {
            outline: none;
            border-color: #3b82f6;
        }

        /* ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚«ãƒ¼ãƒ‰ */
        .template-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 16px;
        }

        .template-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .template-title {
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
            margin: 0 0 4px 0;
        }

        .template-description {
            font-size: 13px;
            color: #6b7280;
            margin: 0;
        }

        .template-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            white-space: nowrap;
        }

        .template-badge.pipeline {
            background: #dbeafe;
            color: #1e40af;
        }

        .template-badge.followup {
            background: #d1fae5;
            color: #065f46;
        }

        .template-content {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            font-size: 14px;
            line-height: 1.8;
            color: #334155;
            white-space: pre-wrap;
            font-family: inherit;
        }

        .template-content.editing {
            background: white;
            border-color: #3b82f6;
        }

        .template-textarea {
            width: 100%;
            min-height: 200px;
            padding: 16px;
            border: 2px solid #3b82f6;
            border-radius: 8px;
            font-size: 14px;
            line-height: 1.8;
            color: #334155;
            font-family: inherit;
            resize: vertical;
        }

        .template-textarea:focus {
            outline: none;
        }

        .template-actions {
            display: flex;
            gap: 10px;
            margin-top: 16px;
            flex-wrap: wrap;
        }

        .template-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 10px 18px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .template-btn.copy {
            background: #3b82f6;
            color: white;
        }

        .template-btn.copy:hover {
            background: #2563eb;
        }

        .template-btn.copy.copied {
            background: #10b981;
        }

        .template-btn.edit {
            background: #f3f4f6;
            color: #374151;
        }

        .template-btn.edit:hover {
            background: #e5e7eb;
        }

        .template-btn.save {
            background: #10b981;
            color: white;
        }

        .template-btn.save:hover {
            background: #059669;
        }

        .template-btn.cancel {
            background: #f3f4f6;
            color: #374151;
        }

        .template-btn.reset {
            background: #fef2f2;
            color: #dc2626;
        }

        .template-btn.reset:hover {
            background: #fee2e2;
        }

        /* ã‚«ã‚¹ã‚¿ãƒ ãƒãƒƒã‚¸ */
        .custom-badge {
            background: #fef3c7;
            color: #92400e;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            margin-left: 8px;
        }

        /* ç©ºçŠ¶æ…‹ */
        .empty-templates {
            text-align: center;
            padding: 60px 20px;
            color: #9ca3af;
        }

        .empty-templates .empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        /* ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºãƒ’ãƒ³ãƒˆ */
        .customization-hint {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 24px;
        }

        .customization-hint h4 {
            margin: 0 0 8px 0;
            color: #1e40af;
            font-size: 14px;
        }

        .customization-hint p {
            margin: 0;
            font-size: 13px;
            color: #1e3a8a;
        }

        .variable-list {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 8px;
        }

        .variable-tag {
            background: #dbeafe;
            color: #1e40af;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <div id="navigation"></div>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <div class="templates-container">
        <div class="page-header">
            <h1>ğŸ“ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</h1>
            <p>é¡§å®¢ã¸ã®é€£çµ¡æ–‡æ¡ˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ã€LINEãƒ»ãƒ¡ãƒ¼ãƒ«ãƒ»SMSãªã©ã§ã”åˆ©ç”¨ãã ã•ã„</p>
        </div>

        <!-- æ‹…å½“è€…åè¨­å®š -->
        <div class="settings-panel">
            <h3>âš™ï¸ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆè¨­å®š</h3>
            <div class="settings-row">
                <div class="settings-field">
                    <label>æ‹…å½“è€…åï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«åæ˜ ã•ã‚Œã¾ã™ï¼‰</label>
                    <input type="text" id="agentNameInput" placeholder="ä¾‹ï¼šå±±ç”°å¤ªéƒ" value="">
                </div>
                <div class="settings-actions">
                    <button class="settings-btn primary" onclick="saveAgentName()">ä¿å­˜</button>
                </div>
            </div>
        </div>

        <!-- ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚¿ãƒ– -->
        <div class="category-tabs">
            <button class="category-tab active" data-category="all" onclick="filterByCategory('all')">ã™ã¹ã¦</button>
            <button class="category-tab" data-category="pipeline" onclick="filterByCategory('pipeline')">ğŸ“‹ å•†è«‡é€²è¡Œä¸­</button>
            <button class="category-tab" data-category="followup" onclick="filterByCategory('followup')">ğŸ”„ æˆç´„å¾Œãƒ•ã‚©ãƒ­ãƒ¼</button>
        </div>

        <!-- é¡§å®¢é¸æŠ -->
        <div class="customer-select-section">
            <h3>ğŸ‘¤ é¡§å®¢ã‚’é¸æŠï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«åå‰ã‚’åæ˜ ï¼‰</h3>
            <select class="customer-select" id="customerSelect" onchange="updateTemplates()">
                <option value="">-- é¡§å®¢ã‚’é¸æŠã—ã¦ãã ã•ã„ --</option>
            </select>
        </div>

        <!-- ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºãƒ’ãƒ³ãƒˆ -->
        <div class="customization-hint">
            <h4>ğŸ’¡ ä½¿ã„æ–¹ãƒ»åˆ©ç”¨å¯èƒ½ãªå¤‰æ•°</h4>
            <p>ã€Œç·¨é›†ã€ãƒœã‚¿ãƒ³ã§ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã§ãã¾ã™ã€‚ç·¨é›†å¾Œã¯ã€Œä¿å­˜ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚<br>
            ä»¥ä¸‹ã®å¤‰æ•°ã‚’ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«è¨˜å…¥ã™ã‚‹ã¨ã€é¡§å®¢é¸æŠæ™‚ã«è‡ªå‹•ã§ç½®ãæ›ã‚ã‚Šã¾ã™ã€‚</p>
            <div class="variable-list">
                <span class="variable-tag">{ãŠå®¢æ§˜å}</span>
                <span class="variable-tag">{æ‹…å½“è€…å}</span>
                <span class="variable-tag">{ç‰©ä»¶å}</span>
                <span class="variable-tag">{è³ƒæ–™}</span>
                <span class="variable-tag">{å…¥å±…æ—¥}</span>
                <span class="variable-tag">{ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹}</span>
                <span class="variable-tag">{é›»è©±ç•ªå·}</span>
                <span class="variable-tag">{å¸Œæœ›ã‚¨ãƒªã‚¢}</span>
                <span class="variable-tag">{å¸Œæœ›é–“å–ã‚Š}</span>
                <span class="variable-tag">{äºˆç®—}</span>
                <span class="variable-tag">{æ—¥æ™‚}</span>
            </div>
        </div>

        <!-- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¸€è¦§ -->
        <div id="templates-list">
            <!-- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
        </div>
    </div>

    <!-- ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/config.js"></script>
    <script src="js/feature-flags.js"></script>
    <script src="js/plan-manager.js"></script>
    <script src="js/supabase-google-sync.js"></script>
    <script src="js/session-manager.js"></script>
    <script src="js/navigation.js"></script>
    <script src="js/integrated-auth-manager-v2.js"></script>
    <script src="js/google-drive-api-v2.js"></script>
    <script src="js/google-sheets-api.js"></script>
    <script src="js/data-migration.js"></script>
    <script src="js/unified-sheets-manager.js"></script>
    <script src="js/unified-data-manager.js"></script>
    <script src="js/app-initializer.js"></script>
    <script src="js/page-initializer.js"></script>

    <script>
        let currentCategory = 'all';
        let selectedCustomer = null;
        let agentName = '';
        let editingTemplateId = null;
        let customTemplates = {}; // ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ãŸãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä¿å­˜

        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå®šç¾©
        const defaultTemplates = [
            // ===== å•†è«‡é€²è¡Œä¸­ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ =====
            {
                id: 'initial-contact',
                category: 'pipeline',
                status: 'åˆå›ç›¸è«‡',
                title: 'åˆå›ç›¸è«‡å¾Œã®ãŠç¤¼ãƒ»æ¬¡å›é€£çµ¡',
                description: 'åˆå›ãƒ’ã‚¢ãƒªãƒ³ã‚°å¾Œã«ãŠé€ã‚Šã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸',
                template: `{ãŠå®¢æ§˜å}æ§˜

æœ¬æ—¥ã¯ãŠæ™‚é–“ã‚’ã„ãŸã ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚
{æ‹…å½“è€…å}ã§ã™ã€‚

ãŠèãã—ãŸæ¡ä»¶ã‚’ã‚‚ã¨ã«ã€ã”å¸Œæœ›ã«åˆã†ç‰©ä»¶ã‚’ãŠæ¢ã—ã„ãŸã—ã¾ã™ã€‚
ã„ãã¤ã‹å€™è£œãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã‚‰ã”é€£çµ¡ã•ã›ã¦ã„ãŸã ãã¾ã™ã€‚

ã”ä¸æ˜ãªç‚¹ãŒã”ã–ã„ã¾ã—ãŸã‚‰ã€ã„ã¤ã§ã‚‚ãŠæ°—è»½ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚
å¼•ãç¶šãã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚`
            },
            {
                id: 'property-intro',
                category: 'pipeline',
                status: 'ç‰©ä»¶ç´¹ä»‹',
                title: 'ç‰©ä»¶ç´¹ä»‹ã®ã”æ¡ˆå†…',
                description: 'å€™è£œç‰©ä»¶ã‚’ã”ç´¹ä»‹ã™ã‚‹éš›ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸',
                template: `{ãŠå®¢æ§˜å}æ§˜

ãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚
{æ‹…å½“è€…å}ã§ã™ã€‚

ã”å¸Œæœ›ã®æ¡ä»¶ã«åˆã†ç‰©ä»¶ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã®ã§ã”ç´¹ä»‹ã•ã›ã¦ã„ãŸã ãã¾ã™ã€‚

ã€ã”ç´¹ä»‹ç‰©ä»¶ã€‘
ãƒ»ç‰©ä»¶åï¼š{ç‰©ä»¶å}
ãƒ»æ‰€åœ¨åœ°ï¼š
ãƒ»è³ƒæ–™ï¼š
ãƒ»é–“å–ã‚Šï¼š
ãƒ»ãã®ä»–ç‰¹å¾´ï¼š

ã”èˆˆå‘³ãŒã”ã–ã„ã¾ã—ãŸã‚‰ã€å†…è¦‹ã®ã”äºˆç´„ã‚‚æ‰¿ã£ã¦ãŠã‚Šã¾ã™ã€‚
ã”éƒ½åˆã®è‰¯ã„æ—¥æ™‚ã‚’ãŠçŸ¥ã‚‰ã›ã„ãŸã ã‘ã¾ã™ã§ã—ã‚‡ã†ã‹ã€‚

ã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚`
            },
            {
                id: 'viewing-schedule',
                category: 'pipeline',
                status: 'å†…è¦‹èª¿æ•´',
                title: 'å†…è¦‹æ—¥ç¨‹ç¢ºå®šã®ã”é€£çµ¡',
                description: 'å†…è¦‹æ—¥ç¨‹ãŒæ±ºã¾ã£ãŸéš›ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸',
                template: `{ãŠå®¢æ§˜å}æ§˜

ãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚
{æ‹…å½“è€…å}ã§ã™ã€‚

å†…è¦‹ã®æ—¥ç¨‹ãŒç¢ºå®šã„ãŸã—ã¾ã—ãŸã®ã§ã”é€£çµ¡ã„ãŸã—ã¾ã™ã€‚

ã€å†…è¦‹äºˆå®šã€‘
ãƒ»æ—¥æ™‚ï¼š{æ—¥æ™‚}
ãƒ»ç‰©ä»¶ï¼š{ç‰©ä»¶å}
ãƒ»é›†åˆå ´æ‰€ï¼šç¾åœ°ï¼ˆä½æ‰€ã‚’ãŠé€ã‚Šã—ã¾ã™ï¼‰

å½“æ—¥ã¯ç§ãŒã”æ¡ˆå†…ã„ãŸã—ã¾ã™ã€‚
ã”ä¸æ˜ãªç‚¹ã‚„ã”è³ªå•ãŒã”ã–ã„ã¾ã—ãŸã‚‰ã€ãŠæ°—è»½ã«ãŠç”³ã—ä»˜ã‘ãã ã•ã„ã€‚

ã©ã†ãã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚`
            },
            {
                id: 'viewing-reminder',
                category: 'pipeline',
                status: 'å†…è¦‹èª¿æ•´',
                title: 'å†…è¦‹å‰æ—¥ãƒªãƒã‚¤ãƒ³ãƒ‰',
                description: 'å†…è¦‹å‰æ—¥ã«é€ã‚‹ç¢ºèªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸',
                template: `{ãŠå®¢æ§˜å}æ§˜

ãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚
{æ‹…å½“è€…å}ã§ã™ã€‚

æ˜æ—¥ã®å†…è¦‹ã«ã¤ã„ã¦ã€æ”¹ã‚ã¦ã”æ¡ˆå†…ç”³ã—ä¸Šã’ã¾ã™ã€‚

ã€æ˜æ—¥ã®äºˆå®šã€‘
ãƒ»æ—¥æ™‚ï¼š{æ—¥æ™‚}
ãƒ»ç‰©ä»¶ï¼š{ç‰©ä»¶å}
ãƒ»é›†åˆå ´æ‰€ï¼šç¾åœ°

ãŠæ°—ã‚’ã¤ã‘ã¦ãŠè¶Šã—ãã ã•ã„ã€‚
æ˜æ—¥ãŠä¼šã„ã§ãã‚‹ã“ã¨ã‚’æ¥½ã—ã¿ã«ã—ã¦ãŠã‚Šã¾ã™ã€‚`
            },
            {
                id: 'after-viewing',
                category: 'pipeline',
                status: 'å†…è¦‹èª¿æ•´',
                title: 'å†…è¦‹å¾Œã®ãƒ•ã‚©ãƒ­ãƒ¼',
                description: 'å†…è¦‹çµ‚äº†å¾Œã«é€ã‚‹ãƒ•ã‚©ãƒ­ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸',
                template: `{ãŠå®¢æ§˜å}æ§˜

æœ¬æ—¥ã¯å†…è¦‹ã«ãŠè¶Šã—ã„ãŸã ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚
{æ‹…å½“è€…å}ã§ã™ã€‚

ã”è¦§ã„ãŸã ã„ãŸç‰©ä»¶ã¯ã„ã‹ãŒã§ã—ãŸã§ã—ã‚‡ã†ã‹ï¼Ÿ

ã”è³ªå•ã‚„ã”ä¸æ˜ãªç‚¹ãŒã”ã–ã„ã¾ã—ãŸã‚‰ã€ãŠæ°—è»½ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚
ã¾ãŸã€ä»–ã«ã‚‚æ¡ä»¶ã«åˆã†ç‰©ä»¶ãŒã”ã–ã„ã¾ã—ãŸã‚‰ã€ã”ç´¹ä»‹ã•ã›ã¦ã„ãŸã ãã¾ã™ã€‚

ã”æ¤œè¨ã®ã»ã©ã€ã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚`
            },
            {
                id: 'application-guide',
                category: 'pipeline',
                status: 'ç”³è¾¼æº–å‚™',
                title: 'ãŠç”³è¾¼ã¿æ‰‹ç¶šãã®ã”æ¡ˆå†…',
                description: 'ç”³è¾¼æ‰‹ç¶šãã®æµã‚Œã‚’ã”æ¡ˆå†…ã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸',
                template: `{ãŠå®¢æ§˜å}æ§˜

ãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚
{æ‹…å½“è€…å}ã§ã™ã€‚

ã“ã®åº¦ã¯{ç‰©ä»¶å}ã¸ã®ãŠç”³è¾¼ã¿ã‚’ã”æ¤œè¨ã„ãŸã ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚

ã€ãŠç”³è¾¼ã¿ã«å¿…è¦ãªæ›¸é¡ã€‘
ãƒ»ã”æœ¬äººç¢ºèªæ›¸é¡ï¼ˆå…è¨±è¨¼ãƒ»ä¿é™ºè¨¼ãªã©ï¼‰
ãƒ»åå…¥è¨¼æ˜æ›¸ï¼ˆæºæ³‰å¾´åç¥¨ãƒ»çµ¦ä¸æ˜ç´°ãªã©ï¼‰
ãƒ»å°é‘‘

ã€ä»Šå¾Œã®æµã‚Œã€‘
1. å…¥å±…ç”³è¾¼æ›¸ã®ã”è¨˜å…¥
2. å¯©æŸ»ï¼ˆé€šå¸¸3ã€œ5å–¶æ¥­æ—¥ï¼‰
3. å¥‘ç´„æ‰‹ç¶šã
4. éµã®ãŠæ¸¡ã—ãƒ»å…¥å±…

ã”ä¸æ˜ãªç‚¹ãŒã”ã–ã„ã¾ã—ãŸã‚‰ã€ãŠæ°—è»½ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚`
            },
            {
                id: 'screening-progress',
                category: 'pipeline',
                status: 'å¯©æŸ»ä¸­',
                title: 'å¯©æŸ»çŠ¶æ³ã®ã”å ±å‘Š',
                description: 'å¯©æŸ»ã®é€²æ—ã‚’ãŠçŸ¥ã‚‰ã›ã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸',
                template: `{ãŠå®¢æ§˜å}æ§˜

ãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚
{æ‹…å½“è€…å}ã§ã™ã€‚

ç¾åœ¨ã€{ç‰©ä»¶å}ã®å…¥å±…å¯©æŸ»ã‚’é€²ã‚ã¦ãŠã‚Šã¾ã™ã€‚
å¯©æŸ»çµæœãŒå‡ºã¾ã—ãŸã‚‰ã€æ”¹ã‚ã¦ã”é€£çµ¡ã•ã›ã¦ã„ãŸã ãã¾ã™ã€‚

é€šå¸¸ã€å¯©æŸ»ã«ã¯3ã€œ5å–¶æ¥­æ—¥ã»ã©ãŠæ™‚é–“ã‚’ã„ãŸã ã„ã¦ãŠã‚Šã¾ã™ã€‚
ä»Šã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã¾ã™ã‚ˆã†ãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚

ã”è³ªå•ãŒã”ã–ã„ã¾ã—ãŸã‚‰ã€ãŠæ°—è»½ã«ã”é€£çµ¡ãã ã•ã„ã€‚`
            },
            {
                id: 'screening-passed',
                category: 'pipeline',
                status: 'å¯©æŸ»ä¸­',
                title: 'å¯©æŸ»é€šéã®ãŠçŸ¥ã‚‰ã›',
                description: 'å¯©æŸ»é€šéã‚’ãŠçŸ¥ã‚‰ã›ã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸',
                template: `{ãŠå®¢æ§˜å}æ§˜

ãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚
{æ‹…å½“è€…å}ã§ã™ã€‚

ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼
{ç‰©ä»¶å}ã®å…¥å±…å¯©æŸ»ãŒç„¡äº‹é€šéã„ãŸã—ã¾ã—ãŸã€‚

æ¬¡ã¯å¥‘ç´„æ‰‹ç¶šãã«é€²ã¿ã¾ã™ã€‚
ã”éƒ½åˆã®è‰¯ã„æ—¥ç¨‹ã‚’ãŠçŸ¥ã‚‰ã›ã„ãŸã ã‘ã¾ã™ã§ã—ã‚‡ã†ã‹ã€‚

ã€å¥‘ç´„æ™‚ã«ãŠæŒã¡ã„ãŸã ãã‚‚ã®ã€‘
ãƒ»ã”æœ¬äººç¢ºèªæ›¸é¡
ãƒ»å°é‘‘ï¼ˆèªå°å¯ï¼‰
ãƒ»åˆæœŸè²»ç”¨

è©³ç´°ã¯æ”¹ã‚ã¦ã”æ¡ˆå†…ã„ãŸã—ã¾ã™ã€‚
å¼•ãç¶šãã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚`
            },
            {
                id: 'contract-schedule',
                category: 'pipeline',
                status: 'å¥‘ç´„æ‰‹ç¶šã',
                title: 'å¥‘ç´„æ—¥ç¨‹ã®ã”æ¡ˆå†…',
                description: 'å¥‘ç´„æ—¥ç¨‹ãŒæ±ºã¾ã£ãŸéš›ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸',
                template: `{ãŠå®¢æ§˜å}æ§˜

ãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚
{æ‹…å½“è€…å}ã§ã™ã€‚

å¥‘ç´„æ—¥ç¨‹ãŒç¢ºå®šã„ãŸã—ã¾ã—ãŸã®ã§ã”æ¡ˆå†…ã„ãŸã—ã¾ã™ã€‚

ã€å¥‘ç´„äºˆå®šã€‘
ãƒ»æ—¥æ™‚ï¼š{æ—¥æ™‚}
ãƒ»å ´æ‰€ï¼šå¼Šç¤¾äº‹å‹™æ‰€
ãƒ»æ‰€è¦æ™‚é–“ï¼šç´„1ã€œ2æ™‚é–“

ã€ãŠæŒã¡ã„ãŸã ãã‚‚ã®ã€‘
ãƒ»ã”æœ¬äººç¢ºèªæ›¸é¡
ãƒ»å°é‘‘
ãƒ»åˆæœŸè²»ç”¨ï¼ˆæŒ¯è¾¼ã§ã‚‚å¯ï¼‰

ã”ä¸æ˜ãªç‚¹ãŒã”ã–ã„ã¾ã—ãŸã‚‰ã€ãŠæ°—è»½ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚
å½“æ—¥ãŠä¼šã„ã§ãã‚‹ã“ã¨ã‚’æ¥½ã—ã¿ã«ã—ã¦ãŠã‚Šã¾ã™ã€‚`
            },

            // ===== æˆç´„å¾Œãƒ•ã‚©ãƒ­ãƒ¼ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ =====
            // â€» ä»²ä»‹æ¥­è€…ã®æ¥­å‹™ç¯„å›²ã«ç•™æ„ã—ãŸãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
            {
                id: 'move-in-thanks',
                category: 'followup',
                title: 'ã”å…¥å±…å¾Œã®ãŠç¤¼',
                description: 'å…¥å±…å¾Œã™ãã«ãŠé€ã‚Šã™ã‚‹ãŠç¤¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸',
                template: `{ãŠå®¢æ§˜å}æ§˜

ãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚
{æ‹…å½“è€…å}ã§ã™ã€‚

ã“ã®åº¦ã¯ã”å…¥å±…ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼
æ–°ç”Ÿæ´»ã®ã‚¹ã‚¿ãƒ¼ãƒˆã«æºã‚ã‚‹ã“ã¨ãŒã§ãã€å¤§å¤‰å¬‰ã—ãæ€ã£ã¦ãŠã‚Šã¾ã™ã€‚

ä»Šå¾Œã€ãŠå¼•è¶Šã—ã‚„ãŠéƒ¨å±‹æ¢ã—ã®ã”äºˆå®šãŒã”ã–ã„ã¾ã—ãŸã‚‰ã€ã„ã¤ã§ã‚‚ãŠæ°—è»½ã«ã”ç›¸è«‡ãã ã•ã„ã€‚
ã”å‹äººã‚„ãŠçŸ¥ã‚Šåˆã„ã®æ–¹ã§ãŠéƒ¨å±‹ã‚’ãŠæ¢ã—ã®æ–¹ãŒã„ã‚‰ã£ã—ã‚ƒã„ã¾ã—ãŸã‚‰ã€ãœã²ã”ç´¹ä»‹ã„ãŸã ã‘ã‚‹ã¨å¹¸ã„ã§ã™ã€‚

å¿«é©ãªæ–°ç”Ÿæ´»ã‚’ãŠç¥ˆã‚Šã—ã¦ãŠã‚Šã¾ã™ã€‚
ä»Šå¾Œã¨ã‚‚ã©ã†ãã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚`
            },
            {
                id: 'one-month-followup',
                category: 'followup',
                title: '1ãƒ¶æœˆå¾Œãƒ•ã‚©ãƒ­ãƒ¼',
                description: 'å…¥å±…1ãƒ¶æœˆå¾Œã®ã”æŒ¨æ‹¶ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸',
                template: `{ãŠå®¢æ§˜å}æ§˜

ãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚
{æ‹…å½“è€…å}ã§ã™ã€‚

ã”å…¥å±…ã‹ã‚‰1ãƒ¶æœˆã»ã©çµŒã¡ã¾ã—ãŸãŒã€æ–°ç”Ÿæ´»ã¯ã„ã‹ãŒã§ã—ã‚‡ã†ã‹ï¼Ÿ

ä»Šå›ã®ãŠéƒ¨å±‹æ¢ã—ã§ãŠå½¹ã«ç«‹ã¦ã¦ãŠã‚Šã¾ã—ãŸã‚‰å¹¸ã„ã§ã™ã€‚
ã‚‚ã—ãŠçŸ¥ã‚Šåˆã„ã®æ–¹ã§ãŠéƒ¨å±‹ã‚’ãŠæ¢ã—ã®æ–¹ãŒã„ã‚‰ã£ã—ã‚ƒã„ã¾ã—ãŸã‚‰ã€ãœã²ãŠå£°ãŒã‘ãã ã•ã„ã€‚

ä»Šå¾Œã¨ã‚‚ã©ã†ãã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚`
            },
            {
                id: 'six-month-followup',
                category: 'followup',
                title: '6ãƒ¶æœˆå¾Œãƒ•ã‚©ãƒ­ãƒ¼',
                description: 'å…¥å±…6ãƒ¶æœˆå¾Œã®ã”æŒ¨æ‹¶ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸',
                template: `{ãŠå®¢æ§˜å}æ§˜

ãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚
{æ‹…å½“è€…å}ã§ã™ã€‚

ã”å…¥å±…ã‹ã‚‰åŠå¹´ãŒçµŒã¡ã¾ã—ãŸãŒã€ãŠå¤‰ã‚ã‚ŠãªããŠéã”ã—ã§ã—ã‚‡ã†ã‹ã€‚

ã‚‚ã—ä»Šå¾Œã€ä½ã¿æ›¿ãˆã‚„ãŠéƒ¨å±‹æ¢ã—ã®ã”äºˆå®šãŒã”ã–ã„ã¾ã—ãŸã‚‰ã€ãœã²ãŠå£°ãŒã‘ãã ã•ã„ã€‚
ã¾ãŸã€ã”å‹äººã‚„ãŠçŸ¥ã‚Šåˆã„ã§ãŠéƒ¨å±‹ã‚’ãŠæ¢ã—ã®æ–¹ãŒã„ã‚‰ã£ã—ã‚ƒã„ã¾ã—ãŸã‚‰ã€ã”ç´¹ä»‹ã„ãŸã ã‘ã‚‹ã¨å¤§å¤‰å¬‰ã—ãæ€ã„ã¾ã™ã€‚

ä»Šå¾Œã¨ã‚‚ã©ã†ãã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚`
            },
            {
                id: 'one-year-followup',
                category: 'followup',
                title: '1å¹´å¾Œãƒ•ã‚©ãƒ­ãƒ¼',
                description: 'å…¥å±…1å¹´å¾Œã®ã”æŒ¨æ‹¶ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸',
                template: `{ãŠå®¢æ§˜å}æ§˜

ãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚
{æ‹…å½“è€…å}ã§ã™ã€‚

æ—©ã„ã‚‚ã®ã§ã”å…¥å±…ã‹ã‚‰1å¹´ãŒçµŒã¡ã¾ã—ãŸã€‚

ä»Šå¾Œã€ä½ã¿æ›¿ãˆã‚’ã”æ¤œè¨ã•ã‚Œã‚‹ã“ã¨ãŒã”ã–ã„ã¾ã—ãŸã‚‰ã€ãŠæ°—è»½ã«ã”ç›¸è«‡ãã ã•ã„ã€‚
ã”å¸Œæœ›ã®æ¡ä»¶ã«åˆã£ãŸç‰©ä»¶ã‚’ãŠæ¢ã—ã„ãŸã—ã¾ã™ã€‚

ã¾ãŸã€ãŠçŸ¥ã‚Šåˆã„ã®æ–¹ã§ãŠéƒ¨å±‹æ¢ã—ã‚’ã•ã‚Œã¦ã„ã‚‹æ–¹ãŒã„ã‚‰ã£ã—ã‚ƒã„ã¾ã—ãŸã‚‰ã€ãœã²ã”ç´¹ä»‹ãã ã•ã„ã€‚

ä»Šå¾Œã¨ã‚‚ã©ã†ãã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚`
            },
            {
                id: 'referral-request',
                category: 'followup',
                title: 'ã”ç´¹ä»‹ã®ãŠé¡˜ã„',
                description: 'ãŠçŸ¥ã‚Šåˆã„ã®ç´¹ä»‹ã‚’ãŠé¡˜ã„ã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸',
                template: `{ãŠå®¢æ§˜å}æ§˜

ã„ã¤ã‚‚å¤§å¤‰ãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚
{æ‹…å½“è€…å}ã§ã™ã€‚

çªç„¶ã®ã”é€£çµ¡å¤±ç¤¼ã„ãŸã—ã¾ã™ã€‚

ã‚‚ã—ãŠçŸ¥ã‚Šåˆã„ã‚„ã”å‹äººã®æ–¹ã§ãŠéƒ¨å±‹æ¢ã—ã‚’ã•ã‚Œã¦ã„ã‚‹æ–¹ãŒã„ã‚‰ã£ã—ã‚ƒã„ã¾ã—ãŸã‚‰ã€ãœã²ã”ç´¹ä»‹ã„ãŸã ã‘ã‚‹ã¨å¹¸ã„ã§ã™ã€‚
{ãŠå®¢æ§˜å}æ§˜ã‹ã‚‰ã®ã”ç´¹ä»‹ã®ãŠå®¢æ§˜ã«ã¯ã€ç‰¹å…¸ã‚’ã”ç”¨æ„ã—ã¦ãŠã‚Šã¾ã™ã€‚

ã”æ¤œè¨ã„ãŸã ã‘ã¾ã—ãŸã‚‰å¬‰ã—ãæ€ã„ã¾ã™ã€‚
ä»Šå¾Œã¨ã‚‚ã©ã†ãã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚`
            },
            {
                id: 'moving-consultation',
                category: 'followup',
                title: 'ä½ã¿æ›¿ãˆã®ã”ç›¸è«‡æ¡ˆå†…',
                description: 'ä½ã¿æ›¿ãˆæ¤œè¨ã®æ–¹ã¸ã®ã”æ¡ˆå†…ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸',
                template: `{ãŠå®¢æ§˜å}æ§˜

ãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚
{æ‹…å½“è€…å}ã§ã™ã€‚

ãã®å¾Œã€ãŠå¤‰ã‚ã‚ŠãªããŠéã”ã—ã§ã—ã‚‡ã†ã‹ã€‚

ã‚‚ã—ç¾åœ¨ã€ä½ã¿æ›¿ãˆã‚„ãŠå¼•è¶Šã—ã‚’ã”æ¤œè¨ã§ã—ãŸã‚‰ã€ãœã²ã”ç›¸è«‡ãã ã•ã„ã€‚
ã”å¸Œæœ›ã®æ¡ä»¶ï¼ˆã‚¨ãƒªã‚¢ã€é–“å–ã‚Šã€ã”äºˆç®—ãªã©ï¼‰ã«åˆã‚ã›ã¦ã€æœ€é©ãªç‰©ä»¶ã‚’ãŠæ¢ã—ã„ãŸã—ã¾ã™ã€‚

ãŠæ°—è»½ã«ãŠå•ã„åˆã‚ã›ã„ãŸã ã‘ã‚Œã°å¹¸ã„ã§ã™ã€‚
ã©ã†ãã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚`
            }
        ];

        // ãƒšãƒ¼ã‚¸åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³è¡¨ç¤º
                loadNavigation();

                await PageInitializer.initialize({
                    onDataUpdated: () => {
                        loadCustomerList();
                    }
                });

                await loadSettings();
                await loadCustomTemplates();
                loadCustomerList();
                renderTemplates();

                // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«ã‚ˆã‚‹ãƒ‡ã‚£ãƒ¼ãƒ—ãƒªãƒ³ã‚¯å‡¦ç†ï¼ˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹å¯¾å¿œï¼‰
                handleUrlParams();

            } catch (error) {
                console.error('templates.html åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
            }
        });

        // è¨­å®šã‚’èª­ã¿è¾¼ã¿ï¼ˆGoogle Sheetså„ªå…ˆï¼‰
        async function loadSettings() {
            try {
                // Google Sheetsã‹ã‚‰èª­ã¿è¾¼ã¿
                if (window.UnifiedSheetsManager?.isEnabled || window.UnifiedSheetsManager?.spreadsheetId) {
                    const settings = await window.UnifiedSheetsManager.loadSetting('templateSettings');
                    if (settings && settings.agentName) {
                        agentName = settings.agentName;
                        document.getElementById('agentNameInput').value = agentName;
                        console.log('ğŸ“‹ Google Sheets ã‹ã‚‰æ‹…å½“è€…åèª­ã¿è¾¼ã¿:', agentName);
                        return;
                    }
                }
            } catch (e) {
                console.warn('Google Sheets ã‹ã‚‰ã®èª­ã¿è¾¼ã¿ã‚¹ã‚­ãƒƒãƒ—:', e.message);
            }
            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: localStorage
            const localSettings = JSON.parse(localStorage.getItem('rentpipe_template_settings') || '{}');
            agentName = localSettings.agentName || '';
            document.getElementById('agentNameInput').value = agentName;
        }

        // æ‹…å½“è€…åã‚’ä¿å­˜ï¼ˆGoogle Sheets + localStorageï¼‰
        async function saveAgentName() {
            agentName = document.getElementById('agentNameInput').value.trim();

            const settings = { agentName: agentName };

            // Google Sheetsã«ä¿å­˜
            if (window.UnifiedSheetsManager) {
                try {
                    await window.UnifiedSheetsManager.saveSetting('templateSettings', settings);
                    console.log('ğŸ’¾ Google Sheets ã«æ‹…å½“è€…åä¿å­˜');
                } catch (e) {
                    console.warn('Google Sheets ã¸ã®ä¿å­˜å¤±æ•—:', e.message);
                }
            }

            // localStorageã«ã‚‚ä¿å­˜ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¨ã—ã¦ï¼‰
            localStorage.setItem('rentpipe_template_settings', JSON.stringify(settings));

            renderTemplates();
            alert('âœ… æ‹…å½“è€…åã‚’ä¿å­˜ã—ã¾ã—ãŸ');
        }

        // ã‚«ã‚¹ã‚¿ãƒ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã¿ï¼ˆGoogle Sheetså„ªå…ˆï¼‰
        async function loadCustomTemplates() {
            try {
                // Google Sheetsã‹ã‚‰èª­ã¿è¾¼ã¿
                if (window.UnifiedSheetsManager?.isEnabled || window.UnifiedSheetsManager?.spreadsheetId) {
                    const templates = await window.UnifiedSheetsManager.loadSetting('customTemplates');
                    if (templates && Object.keys(templates).length > 0) {
                        customTemplates = templates;
                        console.log('ğŸ“‹ Google Sheets ã‹ã‚‰ã‚«ã‚¹ã‚¿ãƒ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆèª­ã¿è¾¼ã¿');
                        return;
                    }
                }
            } catch (e) {
                console.warn('Google Sheets ã‹ã‚‰ã®èª­ã¿è¾¼ã¿ã‚¹ã‚­ãƒƒãƒ—:', e.message);
            }
            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: localStorage
            const saved = localStorage.getItem('rentpipe_custom_templates');
            if (saved) {
                try {
                    customTemplates = JSON.parse(saved);
                } catch (e) {
                    customTemplates = {};
                }
            }
        }

        // ã‚«ã‚¹ã‚¿ãƒ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä¿å­˜ï¼ˆGoogle Sheets + localStorageï¼‰
        async function saveCustomTemplates() {
            // Google Sheetsã«ä¿å­˜
            if (window.UnifiedSheetsManager) {
                try {
                    await window.UnifiedSheetsManager.saveSetting('customTemplates', customTemplates);
                    console.log('ğŸ’¾ Google Sheets ã«ã‚«ã‚¹ã‚¿ãƒ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¿å­˜');
                } catch (e) {
                    console.warn('Google Sheets ã¸ã®ä¿å­˜å¤±æ•—:', e.message);
                }
            }

            // localStorageã«ã‚‚ä¿å­˜ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¨ã—ã¦ï¼‰
            localStorage.setItem('rentpipe_custom_templates', JSON.stringify(customTemplates));
        }

        /**
         * URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’èª­ã¿å–ã‚Šã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¨é¡§å®¢ã‚’è‡ªå‹•é¸æŠã™ã‚‹
         * ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆã‹ã‚‰ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸå ´åˆã«ä½¿ç”¨
         * ä¾‹: templates.html?templateId=move-in-thanks&customerId=customer_abc123
         */
        function handleUrlParams() {
            const params = new URLSearchParams(window.location.search);
            const templateId = params.get('templateId');
            const customerId = params.get('customerId');

            if (!templateId && !customerId) return;

            // é¡§å®¢IDãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã€ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã«åæ˜ ã—ã¦ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’æ›´æ–°
            if (customerId) {
                const select = document.getElementById('customerSelect');
                if (select) {
                    select.value = customerId;
                    updateTemplates(); // selectedCustomer ã‚’ã‚»ãƒƒãƒˆã— renderTemplates() ã‚’å‘¼ã³å‡ºã™
                }
            }

            // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆIDãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã€å¯¾è±¡ã‚«ãƒ¼ãƒ‰ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦ãƒã‚¤ãƒ©ã‚¤ãƒˆ
            if (templateId) {
                const scrollToTemplate = () => {
                    let card = document.getElementById(`template-card-${templateId}`);

                    // ã‚«ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ã€Œã™ã¹ã¦ã€ã‚«ãƒ†ã‚´ãƒªã«åˆ‡ã‚Šæ›¿ãˆã¦å†è©¦è¡Œ
                    if (!card) {
                        filterByCategory('all');
                        card = document.getElementById(`template-card-${templateId}`);
                    }

                    if (card) {
                        card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        // é’ã„ã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³ã§3ç§’é–“ãƒã‚¤ãƒ©ã‚¤ãƒˆ
                        card.style.outline = '3px solid #3b82f6';
                        card.style.outlineOffset = '4px';
                        card.style.transition = 'outline 0.5s ease';
                        setTimeout(() => { card.style.outline = 'none'; }, 3000);
                    }
                };

                // renderTemplates() ã®DOMåæ˜ ã‚’å¾…ã£ã¦ã‹ã‚‰ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                setTimeout(scrollToTemplate, 150);
            }
        }

        // é¡§å®¢ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿
        function loadCustomerList() {
            const select = document.getElementById('customerSelect');
            const customers = window.UnifiedDataManager ? window.UnifiedDataManager.getCustomers() : [];
            const activeCustomers = customers.filter(c => c.isActive !== false);

            select.innerHTML = '<option value="">-- é¡§å®¢ã‚’é¸æŠã—ã¦ãã ã•ã„ --</option>';

            activeCustomers.forEach(customer => {
                const name = customer.basicInfo?.name || customer.name || 'åå‰æœªè¨­å®š';
                const status = customer.pipelineStatus || '';
                const option = document.createElement('option');
                option.value = customer.id;
                option.textContent = `${name}ï¼ˆ${status}ï¼‰`;
                select.appendChild(option);
            });
        }

        // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’æ›´æ–°
        function updateTemplates() {
            const customerId = document.getElementById('customerSelect').value;

            if (customerId) {
                const customers = window.UnifiedDataManager ? window.UnifiedDataManager.getCustomers() : [];
                selectedCustomer = customers.find(c => c.id === customerId);
            } else {
                selectedCustomer = null;
            }

            renderTemplates();
        }

        // ã‚«ãƒ†ã‚´ãƒªã§ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        function filterByCategory(category) {
            currentCategory = category;

            document.querySelectorAll('.category-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.category === category);
            });

            renderTemplates();
        }

        // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå†…å®¹ã‚’å–å¾—ï¼ˆã‚«ã‚¹ã‚¿ãƒ ãŒã‚ã‚Œã°ã‚«ã‚¹ã‚¿ãƒ ã€ãªã‘ã‚Œã°ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
        function getTemplateContent(templateId) {
            if (customTemplates[templateId]) {
                return customTemplates[templateId];
            }
            const defaultTemplate = defaultTemplates.find(t => t.id === templateId);
            return defaultTemplate ? defaultTemplate.template : '';
        }

        // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã•ã‚Œã¦ã„ã‚‹ã‹
        function isCustomized(templateId) {
            return !!customTemplates[templateId];
        }

        // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’æç”»
        function renderTemplates() {
            const container = document.getElementById('templates-list');
            container.innerHTML = '';

            let templates = [...defaultTemplates];

            // ã‚«ãƒ†ã‚´ãƒªã§ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
            if (currentCategory !== 'all') {
                templates = templates.filter(t => t.category === currentCategory);
            }

            // é¸æŠã—ãŸé¡§å®¢ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«é–¢é€£ã™ã‚‹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å„ªå…ˆè¡¨ç¤º
            if (selectedCustomer && selectedCustomer.pipelineStatus) {
                const status = selectedCustomer.pipelineStatus;
                templates = templates.sort((a, b) => {
                    const aMatch = a.status === status ? 0 : 1;
                    const bMatch = b.status === status ? 0 : 1;
                    return aMatch - bMatch;
                });
            }

            if (templates.length === 0) {
                container.innerHTML = `
                    <div class="empty-templates">
                        <div class="empty-icon">ğŸ“­</div>
                        <p>è©²å½“ã™ã‚‹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</p>
                    </div>
                `;
                return;
            }

            templates.forEach(template => {
                const card = createTemplateCard(template);
                container.appendChild(card);
            });
        }

        // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚«ãƒ¼ãƒ‰ã‚’ä½œæˆ
        function createTemplateCard(template) {
            const card = document.createElement('div');
            card.className = 'template-card';
            card.id = `template-card-${template.id}`;

            const badgeClass = template.category === 'pipeline' ? 'pipeline' : 'followup';
            const badgeText = template.category === 'pipeline' ? `ğŸ“‹ ${template.status || 'å•†è«‡ä¸­'}` : 'ğŸ”„ æˆç´„å¾Œ';
            const customBadge = isCustomized(template.id) ? '<span class="custom-badge">ã‚«ã‚¹ã‚¿ãƒ </span>' : '';

            // å¤‰æ•°ã‚’ç½®æ›ã—ãŸãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå†…å®¹
            const templateContent = getTemplateContent(template.id);
            const content = replaceVariables(templateContent);

            const isEditing = editingTemplateId === template.id;

            if (isEditing) {
                card.innerHTML = `
                    <div class="template-header">
                        <div>
                            <h3 class="template-title">${template.title}${customBadge}</h3>
                            <p class="template-description">${template.description}</p>
                        </div>
                        <span class="template-badge ${badgeClass}">${badgeText}</span>
                    </div>
                    <textarea class="template-textarea" id="edit-textarea-${template.id}">${escapeHtml(templateContent)}</textarea>
                    <div class="template-actions">
                        <button class="template-btn save" onclick="saveTemplate('${template.id}')">
                            ğŸ’¾ ä¿å­˜
                        </button>
                        <button class="template-btn cancel" onclick="cancelEdit()">
                            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                        </button>
                        ${isCustomized(template.id) ? `<button class="template-btn reset" onclick="resetTemplate('${template.id}')">ğŸ”„ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã™</button>` : ''}
                    </div>
                `;
            } else {
                card.innerHTML = `
                    <div class="template-header">
                        <div>
                            <h3 class="template-title">${template.title}${customBadge}</h3>
                            <p class="template-description">${template.description}</p>
                        </div>
                        <span class="template-badge ${badgeClass}">${badgeText}</span>
                    </div>
                    <div class="template-content">${escapeHtml(content)}</div>
                    <div class="template-actions">
                        <button class="template-btn copy" onclick="copyTemplate(this, '${template.id}')">
                            ğŸ“‹ ã‚³ãƒ”ãƒ¼
                        </button>
                        <button class="template-btn edit" onclick="editTemplate('${template.id}')">
                            âœï¸ ç·¨é›†
                        </button>
                    </div>
                `;
            }

            return card;
        }

        // å¤‰æ•°ã‚’ç½®æ›
        function replaceVariables(template) {
            let result = template;

            if (selectedCustomer) {
                const basicInfo = selectedCustomer.basicInfo || {};
                const preferences = selectedCustomer.preferences || {};
                const contractInfo = selectedCustomer.contractInfo || {};
                const budget = preferences.budget || {};

                // åŸºæœ¬æƒ…å ±
                const name = basicInfo.name || selectedCustomer.name || 'ãŠå®¢æ§˜';
                result = result.replace(/{ãŠå®¢æ§˜å}/g, name);
                result = result.replace(/{ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹}/g, basicInfo.email || 'ï¼ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼‰');
                result = result.replace(/{é›»è©±ç•ªå·}/g, basicInfo.phone || 'ï¼ˆé›»è©±ç•ªå·ï¼‰');

                // å¥‘ç´„æƒ…å ±: ç‰©ä»¶åãƒ»è³ƒæ–™ãƒ»å…¥å±…æ—¥
                const propertyName = contractInfo.propertyAddress || contractInfo.propertyName || 'ï¼ˆç‰©ä»¶åï¼‰';
                result = result.replace(/{ç‰©ä»¶å}/g, propertyName);

                const rent = contractInfo.monthlyRent
                    ? contractInfo.monthlyRent.toLocaleString('ja-JP') + 'å††'
                    : 'ï¼ˆè³ƒæ–™ï¼‰';
                result = result.replace(/{è³ƒæ–™}/g, rent);

                const moveInDate = contractInfo.moveInDate || preferences.moveInDate || 'ï¼ˆå…¥å±…æ—¥ï¼‰';
                result = result.replace(/{å…¥å±…æ—¥}/g, moveInDate);

                // å¸Œæœ›æ¡ä»¶
                result = result.replace(/{å¸Œæœ›ã‚¨ãƒªã‚¢}/g, preferences.areas || 'ï¼ˆå¸Œæœ›ã‚¨ãƒªã‚¢ï¼‰');
                result = result.replace(/{å¸Œæœ›é–“å–ã‚Š}/g, preferences.layout || 'ï¼ˆå¸Œæœ›é–“å–ã‚Šï¼‰');

                let budgetStr = 'ï¼ˆäºˆç®—ï¼‰';
                if (budget.min && budget.max) {
                    budgetStr = budget.min.toLocaleString('ja-JP') + 'å††ã€œ' + budget.max.toLocaleString('ja-JP') + 'å††';
                } else if (budget.max) {
                    budgetStr = budget.max.toLocaleString('ja-JP') + 'å††ä»¥ä¸‹';
                } else if (budget.min) {
                    budgetStr = budget.min.toLocaleString('ja-JP') + 'å††ä»¥ä¸Š';
                }
                result = result.replace(/{äºˆç®—}/g, budgetStr);

            } else {
                // é¡§å®¢æœªé¸æŠæ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                result = result.replace(/{ãŠå®¢æ§˜å}/g, 'ãŠå®¢æ§˜');
                result = result.replace(/{ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹}/g, 'ï¼ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼‰');
                result = result.replace(/{é›»è©±ç•ªå·}/g, 'ï¼ˆé›»è©±ç•ªå·ï¼‰');
                result = result.replace(/{ç‰©ä»¶å}/g, 'ï¼ˆç‰©ä»¶åï¼‰');
                result = result.replace(/{è³ƒæ–™}/g, 'ï¼ˆè³ƒæ–™ï¼‰');
                result = result.replace(/{å…¥å±…æ—¥}/g, 'ï¼ˆå…¥å±…æ—¥ï¼‰');
                result = result.replace(/{å¸Œæœ›ã‚¨ãƒªã‚¢}/g, 'ï¼ˆå¸Œæœ›ã‚¨ãƒªã‚¢ï¼‰');
                result = result.replace(/{å¸Œæœ›é–“å–ã‚Š}/g, 'ï¼ˆå¸Œæœ›é–“å–ã‚Šï¼‰');
                result = result.replace(/{äºˆç®—}/g, 'ï¼ˆäºˆç®—ï¼‰');
            }

            // æ‹…å½“è€…åãƒ»æ—¥æ™‚ã¯é¡§å®¢é¸æŠã«é–¢ä¿‚ãªãç½®æ›
            result = result.replace(/{æ‹…å½“è€…å}/g, agentName || 'ï¼ˆæ‹…å½“è€…åï¼‰');
            result = result.replace(/{æ—¥æ™‚}/g, 'ï¼ˆæ—¥æ™‚ï¼‰');

            return result;
        }

        // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ã‚³ãƒ”ãƒ¼
        function copyTemplate(button, templateId) {
            const templateContent = getTemplateContent(templateId);
            const content = replaceVariables(templateContent);

            navigator.clipboard.writeText(content).then(() => {
                button.innerHTML = 'âœ… ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ';
                button.classList.add('copied');

                setTimeout(() => {
                    button.innerHTML = 'ğŸ“‹ ã‚³ãƒ”ãƒ¼';
                    button.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                console.error('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—:', err);
                alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§ãƒ†ã‚­ã‚¹ãƒˆã‚’é¸æŠã—ã¦ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚');
            });
        }

        // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã«
        async function editTemplate(templateId) {
            // ãƒ—ãƒ©ãƒ³ãƒã‚§ãƒƒã‚¯
            if (window.planManager) {
                const hasAccess = await window.planManager.checkFeatureAccess('templates', 'ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç·¨é›†');
                if (!hasAccess) {
                    return;
                }
            }

            editingTemplateId = templateId;
            renderTemplates();

            // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
            setTimeout(() => {
                const textarea = document.getElementById(`edit-textarea-${templateId}`);
                if (textarea) {
                    textarea.focus();
                }
            }, 100);
        }

        // ç·¨é›†ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        function cancelEdit() {
            editingTemplateId = null;
            renderTemplates();
        }

        // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä¿å­˜
        async function saveTemplate(templateId) {
            // ãƒ—ãƒ©ãƒ³ãƒã‚§ãƒƒã‚¯
            if (window.planManager) {
                const hasAccess = await window.planManager.checkFeatureAccess('templates', 'ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç·¨é›†');
                if (!hasAccess) {
                    return;
                }
            }

            const textarea = document.getElementById(`edit-textarea-${templateId}`);
            if (!textarea) return;

            const newContent = textarea.value;
            customTemplates[templateId] = newContent;
            await saveCustomTemplates();

            editingTemplateId = null;
            renderTemplates();
            alert('âœ… ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä¿å­˜ã—ã¾ã—ãŸ');
        }

        // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã™
        async function resetTemplate(templateId) {
            if (confirm('ã“ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ\nã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ãŸå†…å®¹ã¯å‰Šé™¤ã•ã‚Œã¾ã™ã€‚')) {
                delete customTemplates[templateId];
                await saveCustomTemplates();
                renderTemplates();
            }
        }

        console.log('âœ… ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒšãƒ¼ã‚¸æº–å‚™å®Œäº†');
    </script>
</body>
</html>
