<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>直接認証ログイン - RentPipe</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 2rem;
            background: #f5f5f5;
        }
        .login-container {
            background: white;
            border-radius: 10px;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .status-box {
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            text-align: center;
        }
        .status-loading { background: #dbeafe; border: 2px solid #3b82f6; color: #1e40af; }
        .status-success { background: #d1fae5; border: 2px solid #10b981; color: #065f46; }
        .status-error { background: #fee2e2; border: 2px solid #f87171; color: #991b1b; }
        .status-warning { background: #fff3cd; border: 2px solid #ffc107; color: #856404; }
        
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            margin: 10px 0;
            transition: background 0.3s;
        }
        button:hover { background: #2563eb; }
        button:disabled { background: #9ca3af; cursor: not-allowed; }
        
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
        }
        .step {
            flex: 1;
            text-align: center;
            padding: 10px;
            margin: 0 5px;
            border-radius: 6px;
            background: #f3f4f6;
            font-size: 14px;
        }
        .step.active { background: #3b82f6; color: white; }
        .step.completed { background: #10b981; color: white; }
        .step.error { background: #f87171; color: white; }
        
        .debug-section {
            margin-top: 2rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 6px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="login-container">
        <div style="text-align: center; margin-bottom: 2rem;">
            <h1>🏠 RentPipe</h1>
            <p>Google Drive統合対応版ログイン</p>
        </div>

        <!-- ステップ表示 -->
        <div class="step-indicator">
            <div class="step" id="step-init">🔧 初期化</div>
            <div class="step" id="step-auth">🔑 認証</div>
            <div class="step" id="step-save">💾 保存</div>
            <div class="step" id="step-redirect">🚀 完了</div>
        </div>

        <!-- ステータス表示 -->
        <div id="status" class="status-box status-warning">
            <strong>準備中...</strong><br>
            Google Identity Services を読み込み中です
        </div>

        <!-- 操作ボタン -->
        <div style="text-align: center;">
            <button id="loginBtn" disabled>
                🔐 Google認証を開始
            </button>
            <button onclick="mockLogin()" style="background: #f59e0b;">
                🧪 テスト用モックログイン
            </button>
        </div>

        <!-- デバッグ情報 -->
        <div id="debugInfo" class="debug-section" style="display: none;">
            <strong>🔍 デバッグ情報:</strong>
            <pre id="debugContent"></pre>
        </div>

        <!-- ナビゲーション -->
        <div style="margin-top: 2rem; text-align: center; font-size: 14px; color: #6b7280;">
            <p>
                <a href="customer-no-auth.html">認証なし版でテスト</a> |
                <a href="google-drive-integration-test.html">統合テスト</a> |
                <button onclick="toggleDebug()" style="background: none; border: none; color: #3b82f6; cursor: pointer; padding: 0; font-size: inherit;">デバッグ表示</button>
            </p>
        </div>
    </div>

    <!-- Google Drive API v2 スクリプト -->
    <script src="js/google-drive-api-v2.js"></script>

    <script>
        // 🚀 直接認証システム
        console.log('🚀 直接認証ログインシステム開始');
        
        let authState = {
            initialized: false,
            authenticated: false,
            userInfo: null
        };
        
        // ステータス更新
        function updateStatus(message, type, details = '') {
            const status = document.getElementById('status');
            status.innerHTML = '<strong>' + message + '</strong>' + (details ? '<br>' + details : '');
            status.className = 'status-box status-' + type;
        }
        
        // ステップ更新
        function updateStep(stepId, status) {
            const step = document.getElementById(stepId);
            if (step) {
                step.className = 'step ' + status;
            }
        }
        
        // デバッグ情報表示
        function updateDebugInfo(info) {
            const debugContent = document.getElementById('debugContent');
            if (debugContent) {
                debugContent.textContent = JSON.stringify(info, null, 2);
            }
        }
        
        // デバッグ表示切り替え
        function toggleDebug() {
            const debugInfo = document.getElementById('debugInfo');
            debugInfo.style.display = debugInfo.style.display === 'none' ? 'block' : 'none';
            
            if (debugInfo.style.display === 'block') {
                updateDebugInfo({
                    authState: authState,
                    localStorage: {
                        rentpipe_auth_simple: localStorage.getItem('rentpipe_auth_simple'),
                        rentpipe_user_simple: !!localStorage.getItem('rentpipe_user_simple')
                    },
                    googleAPIv2: window.GoogleDriveAPIv2?.getDebugInfo() || '未読み込み'
                });
            }
        }
        
        // 認証データ保存
        function saveAuthData(userInfo) {
            try {
                const userData = {
                    uid: userInfo.id,
                    email: userInfo.email,
                    name: userInfo.name,
                    picture: userInfo.picture
                };
                
                // 統一形式で保存
                localStorage.setItem('rentpipe_auth_simple', 'logged_in');
                localStorage.setItem('rentpipe_user_simple', JSON.stringify(userData));
                localStorage.setItem('rentpipe_temp_auth', 'google_authenticated');
                localStorage.setItem('rentpipe_user_info', JSON.stringify(userData));
                
                console.log('✅ 認証データ保存完了:', userInfo.email);
                return true;
                
            } catch (error) {
                console.error('❌ 認証データ保存エラー:', error);
                return false;
            }
        }
        
        // Google認証実行
        async function performGoogleAuth() {
            const loginBtn = document.getElementById('loginBtn');
            loginBtn.disabled = true;
            loginBtn.textContent = '認証中...';
            
            try {
                updateStep('step-init', 'active');
                updateStatus('システム初期化中...', 'loading');
                
                // Google Drive API v2 初期化
                if (!window.GoogleDriveAPIv2) {
                    throw new Error('Google Drive API v2 が読み込まれていません');
                }
                
                const initialized = await window.GoogleDriveAPIv2.initialize();
                if (!initialized) {
                    throw new Error('Google Drive API 初期化に失敗しました');
                }
                
                updateStep('step-init', 'completed');
                updateStep('step-auth', 'active');
                updateStatus('Google認証実行中...', 'loading', 'ポップアップウィンドウを確認してください');
                
                // Google認証実行
                const userInfo = await window.GoogleDriveAPIv2.authenticate();
                authState.userInfo = userInfo;
                authState.authenticated = true;
                
                updateStep('step-auth', 'completed');
                updateStep('step-save', 'active');
                updateStatus('認証成功 - データ保存中...', 'success', '認証データを保存しています');
                
                // 認証データ保存
                const saved = saveAuthData(userInfo);
                if (!saved) {
                    throw new Error('認証データの保存に失敗しました');
                }
                
                updateStep('step-save', 'completed');
                updateStep('step-redirect', 'active');
                updateStatus('ログイン完了！', 'success', userInfo.email + ' でログインしました。まもなくリダイレクトします...');
                
                // 3秒後にリダイレクト
                setTimeout(function() {
                    window.location.href = 'customer-no-auth.html';
                }, 3000);
                
            } catch (error) {
                console.error('❌ 認証エラー:', error);
                
                let errorMessage = '認証に失敗しました';
                if (error.message.includes('popup')) {
                    errorMessage = 'ポップアップに問題があります';
                } else if (error.message.includes('client_id')) {
                    errorMessage = 'Google OAuth設定に問題があります';
                }
                
                updateStatus(errorMessage, 'error', error.message);
                
                // エラーステップの更新
                if (authState.initialized) {
                    updateStep('step-auth', 'error');
                } else {
                    updateStep('step-init', 'error');
                }
                
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = '🔐 Google認証を開始';
            }
        }
        
        // モックログイン
        function mockLogin() {
            updateStep('step-init', 'completed');
            updateStep('step-auth', 'completed');
            updateStep('step-save', 'active');
            
            const mockUser = {
                id: 'mock_user_' + Date.now(),
                email: 'test@example.com',
                name: 'テストユーザー',
                picture: null
            };
            
            const saved = saveAuthData(mockUser);
            
            if (saved) {
                updateStep('step-save', 'completed');
                updateStep('step-redirect', 'active');
                updateStatus('モックログイン完了！', 'success', 'テストアカウントでログインしました');
                
                setTimeout(function() {
                    window.location.href = 'customer-no-auth.html';
                }, 2000);
            } else {
                updateStatus('モックログインに失敗しました', 'error');
            }
        }
        
        // 初期化
        async function initializeSystem() {
            try {
                console.log('🔧 システム初期化開始...');
                updateStep('step-init', 'active');
                
                // 既存ログインチェック
                const authStatus = localStorage.getItem('rentpipe_auth_simple');
                if (authStatus === 'logged_in') {
                    updateStatus('既にログイン済みです', 'success', 'まもなくリダイレクトします...');
                    updateStep('step-init', 'completed');
                    updateStep('step-auth', 'completed');
                    updateStep('step-save', 'completed');
                    updateStep('step-redirect', 'active');
                    
                    setTimeout(function() {
                        window.location.href = 'customer-no-auth.html';
                    }, 2000);
                    return;
                }
                
                // Google Drive API v2 準備確認
                if (window.GoogleDriveAPIv2) {
                    updateStatus('システム準備完了', 'success', 'Google認証を開始できます');
                    document.getElementById('loginBtn').disabled = false;
                    authState.initialized = true;
                } else {
                    throw new Error('Google Drive API v2 スクリプトが読み込まれていません');
                }
                
            } catch (error) {
                console.error('❌ 初期化エラー:', error);
                updateStatus('初期化に失敗しました', 'error', error.message);
                updateStep('step-init', 'error');
            }
        }
        
        // ページ読み込み完了時
        document.addEventListener('DOMContentLoaded', function() {
            console.log('📄 直接認証ログインページ読み込み完了');
            
            // ログインボタンイベント設定
            document.getElementById('loginBtn').addEventListener('click', performGoogleAuth);
            
            // システム初期化（1秒後に実行）
            setTimeout(initializeSystem, 1000);
        });
    </script>
</body>
</html>
