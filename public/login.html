<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç›´æ¥èªè¨¼ãƒ­ã‚°ã‚¤ãƒ³ - RentPipe</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 2rem;
            background: #f5f5f5;
        }
        .login-container {
            background: white;
            border-radius: 10px;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .status-box {
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            text-align: center;
        }
        .status-loading { background: #dbeafe; border: 2px solid #3b82f6; color: #1e40af; }
        .status-success { background: #d1fae5; border: 2px solid #10b981; color: #065f46; }
        .status-error { background: #fee2e2; border: 2px solid #f87171; color: #991b1b; }
        .status-warning { background: #fff3cd; border: 2px solid #ffc107; color: #856404; }
        
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            margin: 10px 0;
            transition: background 0.3s;
        }
        button:hover { background: #2563eb; }
        button:disabled { background: #9ca3af; cursor: not-allowed; }
        
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
        }
        .step {
            flex: 1;
            text-align: center;
            padding: 10px;
            margin: 0 5px;
            border-radius: 6px;
            background: #f3f4f6;
            font-size: 14px;
        }
        .step.active { background: #3b82f6; color: white; }
        .step.completed { background: #10b981; color: white; }
        .step.error { background: #f87171; color: white; }
        
        .debug-section {
            margin-top: 2rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 6px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="login-container">
        <div style="text-align: center; margin-bottom: 2rem;">
            <h1>ğŸ  RentPipe</h1>
            <p>Google Sheetsçµ±åˆå¯¾å¿œç‰ˆãƒ­ã‚°ã‚¤ãƒ³</p>
        </div>

        <!-- ã‚¹ãƒ†ãƒƒãƒ—è¡¨ç¤º -->
        <div class="step-indicator">
            <div class="step" id="step-init">ğŸ”§ åˆæœŸåŒ–</div>
            <div class="step" id="step-auth">ğŸ” èªè¨¼</div>
            <div class="step" id="step-save">ğŸ’¾ ä¿å­˜</div>
            <div class="step" id="step-redirect">ğŸš€ å®Œäº†</div>
        </div>

        <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º -->
        <div id="status" class="status-box status-warning">
            <strong>æº–å‚™ä¸­...</strong><br>
            Google Identity Services ã‚’èª­ã¿è¾¼ã¿ä¸­ã§ã™
        </div>

        <!-- æ“ä½œãƒœã‚¿ãƒ³ -->
        <div style="text-align: center;">
            <button id="loginBtn" disabled>
                ğŸ” Googleèªè¨¼ã‚’é–‹å§‹
            </button>
            <button onclick="mockLogin()" style="background: #f59e0b;">
                ğŸ§ª ãƒ†ã‚¹ãƒˆç”¨ãƒ¢ãƒƒã‚¯ãƒ­ã‚°ã‚¤ãƒ³
            </button>
        </div>

        <!-- ãƒ‡ãƒãƒƒã‚°æƒ…å ± -->
        <div id="debugInfo" class="debug-section" style="display: none;">
            <strong>ğŸ” ãƒ‡ãƒãƒƒã‚°æƒ…å ±:</strong>
            <pre id="debugContent"></pre>
        </div>

        <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
        <div style="margin-top: 2rem; text-align: center; font-size: 14px; color: #6b7280;">
            <p>
                <a href="customer-no-auth.html">èªè¨¼ãªã—ç‰ˆã§ãƒ†ã‚¹ãƒˆ</a> |
                <a href="google-drive-integration-test.html">çµ±åˆãƒ†ã‚¹ãƒˆ</a> |
                <button onclick="toggleDebug()" style="background: none; border: none; color: #3b82f6; cursor: pointer; padding: 0; font-size: inherit;">ãƒ‡ãƒãƒƒã‚°è¡¨ç¤º</button>
            </p>
        </div>
    </div>

    <!-- Google Drive API v2 ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
    <script src="js/google-drive-api-v2.js"></script>
    <!-- çµ±åˆèªè¨¼ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã‚‚èª­ã¿è¾¼ã¿ -->
    <script src="js/integrated-auth-manager-v2.js"></script>

    <script>
        // ğŸš€ Google Sheetså¯¾å¿œ ç›´æ¥èªè¨¼ã‚·ã‚¹ãƒ†ãƒ  
        console.log('ğŸš€ Google Sheetså¯¾å¿œ ç›´æ¥èªè¨¼ãƒ­ã‚°ã‚¤ãƒ³ã‚·ã‚¹ãƒ†ãƒ é–‹å§‹');
        
        let authState = {
            initialized: false,
            authenticated: false,
            userInfo: null,
            accessToken: null
        };
        
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        function updateStatus(message, type, details = '') {
            const status = document.getElementById('status');
            status.innerHTML = '<strong>' + message + '</strong>' + (details ? '<br>' + details : '');
            status.className = 'status-box status-' + type;
        }
        
        // ã‚¹ãƒ†ãƒƒãƒ—æ›´æ–°
        function updateStep(stepId, status) {
            const step = document.getElementById(stepId);
            if (step) {
                step.className = 'step ' + status;
            }
        }
        
        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±è¡¨ç¤º
        function updateDebugInfo(info) {
            const debugContent = document.getElementById('debugContent');
            if (debugContent) {
                debugContent.textContent = JSON.stringify(info, null, 2);
            }
        }
        
        // ãƒ‡ãƒãƒƒã‚°è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
        function toggleDebug() {
            const debugInfo = document.getElementById('debugInfo');
            debugInfo.style.display = debugInfo.style.display === 'none' ? 'block' : 'none';
            
            if (debugInfo.style.display === 'block') {
                updateDebugInfo({
                    authState: authState,
                    localStorage: {
                        rentpipe_auth_simple: localStorage.getItem('rentpipe_auth_simple'),
                        rentpipe_user_simple: !!localStorage.getItem('rentpipe_user_simple'),
                        google_auth_data: !!localStorage.getItem('google_auth_data')
                    },
                    googleAPIv2: window.GoogleDriveAPIv2?.getDebugInfo() || 'æœªèª­ã¿è¾¼ã¿'
                });
            }
        }
        
        // çµ±åˆèªè¨¼ãƒ‡ãƒ¼ã‚¿ä¿å­˜ï¼ˆGoogle Sheetså¯¾å¿œï¼‰
        function saveIntegratedAuthData(userInfo, accessToken) {
            try {
                const userData = {
                    uid: userInfo.id,
                    email: userInfo.email,
                    name: userInfo.name,
                    picture: userInfo.picture
                };
                
                // æ—¢å­˜å½¢å¼ã§ä¿å­˜ï¼ˆäº’æ›æ€§ï¼‰
                localStorage.setItem('rentpipe_auth_simple', 'logged_in');
                localStorage.setItem('rentpipe_user_simple', JSON.stringify(userData));
                localStorage.setItem('rentpipe_temp_auth', 'google_authenticated');
                localStorage.setItem('rentpipe_user_info', JSON.stringify(userData));
                
                // çµ±åˆèªè¨¼ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼å½¢å¼ã§ä¿å­˜ï¼ˆGoogle Sheetså¯¾å¿œï¼‰
                const googleAuthData = {
                    isSignedIn: true,
                    user: userInfo,
                    accessToken: accessToken,
                    tokenExpiry: Date.now() + (3600 * 1000) // 1æ™‚é–“å¾Œ
                };
                
                localStorage.setItem('google_auth_data', JSON.stringify(googleAuthData));
                localStorage.setItem('google_access_token', accessToken);
                localStorage.setItem('google_token_expiry', googleAuthData.tokenExpiry.toString());
                
                // çµ±åˆèªè¨¼ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã§æ›´æ–°
                if (window.IntegratedAuthManagerV2) {
                    window.IntegratedAuthManagerV2.updateGoogleAuth(googleAuthData);
                }
                
                console.log('âœ… çµ±åˆèªè¨¼ãƒ‡ãƒ¼ã‚¿ä¿å­˜å®Œäº†:', userInfo.email);
                console.log('ğŸ”‘ ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ä¿å­˜å®Œäº†');
                return true;
                
            } catch (error) {
                console.error('âŒ çµ±åˆèªè¨¼ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                return false;
            }
        }
        
        // Googleèªè¨¼å®Ÿè¡Œ
        async function performGoogleAuth() {
            const loginBtn = document.getElementById('loginBtn');
            loginBtn.disabled = true;
            loginBtn.textContent = 'èªè¨¼ä¸­...';
            
            try {
                updateStep('step-init', 'active');
                updateStatus('ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ä¸­...', 'loading');
                
                // Google Drive API v2 åˆæœŸåŒ–
                if (!window.GoogleDriveAPIv2) {
                    throw new Error('Google Drive API v2 ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                }
                
                const initialized = await window.GoogleDriveAPIv2.initialize();
                if (!initialized) {
                    throw new Error('Google Drive API åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
                
                updateStep('step-init', 'completed');
                updateStep('step-auth', 'active');
                updateStatus('Googleèªè¨¼å®Ÿè¡Œä¸­...', 'loading', 'ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’ç¢ºèªã—ã¦ãã ã•ã„');
                
                // Googleèªè¨¼å®Ÿè¡Œ
                const userInfo = await window.GoogleDriveAPIv2.authenticate();
                const accessToken = window.GoogleDriveAPIv2.accessToken;
                
                if (!userInfo || !accessToken) {
                    throw new Error('èªè¨¼æƒ…å ±ã¾ãŸã¯ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
                
                authState.userInfo = userInfo;
                authState.accessToken = accessToken;
                authState.authenticated = true;
                
                updateStep('step-auth', 'completed');
                updateStep('step-save', 'active');
                updateStatus('èªè¨¼æˆåŠŸ - ãƒ‡ãƒ¼ã‚¿ä¿å­˜ä¸­...', 'success', 'èªè¨¼ãƒ‡ãƒ¼ã‚¿ã¨ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä¿å­˜ã—ã¦ã„ã¾ã™');
                
                // çµ±åˆèªè¨¼ãƒ‡ãƒ¼ã‚¿ä¿å­˜
                const saved = saveIntegratedAuthData(userInfo, accessToken);
                if (!saved) {
                    throw new Error('èªè¨¼ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
                
                updateStep('step-save', 'completed');
                updateStep('step-redirect', 'active');
                updateStatus('ãƒ­ã‚°ã‚¤ãƒ³å®Œäº†ï¼', 'success', 
                    userInfo.email + ' ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸã€‚Google Sheetsé€£æºã‚‚æœ‰åŠ¹ã§ã™ã€‚ã¾ã‚‚ãªããƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ã¾ã™...');
                
                // 3ç§’å¾Œã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
                setTimeout(function() {
                    window.location.href = 'customer.html';
                }, 3000);
                
            } catch (error) {
                console.error('âŒ èªè¨¼ã‚¨ãƒ©ãƒ¼:', error);
                
                let errorMessage = 'èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ';
                if (error.message.includes('popup')) {
                    errorMessage = 'ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã«å•é¡ŒãŒã‚ã‚Šã¾ã™';
                } else if (error.message.includes('client_id')) {
                    errorMessage = 'Google OAuthè¨­å®šã«å•é¡ŒãŒã‚ã‚Šã¾ã™';
                }
                
                updateStatus(errorMessage, 'error', error.message);
                
                // ã‚¨ãƒ©ãƒ¼ã‚¹ãƒ†ãƒƒãƒ—ã®æ›´æ–°
                if (authState.initialized) {
                    updateStep('step-auth', 'error');
                } else {
                    updateStep('step-init', 'error');
                }
                
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'ğŸ” Googleèªè¨¼ã‚’é–‹å§‹';
            }
        }
        
        // ãƒ¢ãƒƒã‚¯ãƒ­ã‚°ã‚¤ãƒ³ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
        function mockLogin() {
            updateStep('step-init', 'completed');
            updateStep('step-auth', 'completed');
            updateStep('step-save', 'active');
            
            const mockUser = {
                id: 'mock_user_' + Date.now(),
                email: 'test@example.com',
                name: 'ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼',
                picture: null
            };
            
            const mockToken = 'mock_access_token_' + Date.now();
            
            const saved = saveIntegratedAuthData(mockUser, mockToken);
            
            if (saved) {
                updateStep('step-save', 'completed');
                updateStep('step-redirect', 'active');
                updateStatus('ãƒ¢ãƒƒã‚¯ãƒ­ã‚°ã‚¤ãƒ³å®Œäº†ï¼', 'success', 'ãƒ†ã‚¹ãƒˆã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸ');
                
                setTimeout(function() {
                    window.location.href = 'customer.html';
                }, 2000);
            } else {
                updateStatus('ãƒ¢ãƒƒã‚¯ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }
        
        // åˆæœŸåŒ–
        async function initializeSystem() {
            try {
                console.log('ğŸ”§ ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–é–‹å§‹...');
                updateStep('step-init', 'active');
                
                // æ—¢å­˜ãƒ­ã‚°ã‚¤ãƒ³ãƒã‚§ãƒƒã‚¯
                const authStatus = localStorage.getItem('rentpipe_auth_simple');
                if (authStatus === 'logged_in') {
                    const accessToken = localStorage.getItem('google_access_token');
                    if (accessToken) {
                        updateStatus('æ—¢ã«ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã§ã™', 'success', 'Google Sheetsé€£æºã‚‚æœ‰åŠ¹ã§ã™ã€‚ã¾ã‚‚ãªããƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ã¾ã™...');
                        updateStep('step-init', 'completed');
                        updateStep('step-auth', 'completed');
                        updateStep('step-save', 'completed');
                        updateStep('step-redirect', 'active');
                        
                        setTimeout(function() {
                            window.location.href = 'customer.html';
                        }, 2000);
                        return;
                    } else {
                        console.log('âš ï¸ ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚å†èªè¨¼ãŒå¿…è¦ã§ã™ã€‚');
                        localStorage.removeItem('rentpipe_auth_simple');
                    }
                }
                
                // Google Drive API v2 æº–å‚™ç¢ºèª
                if (window.GoogleDriveAPIv2) {
                    updateStatus('ã‚·ã‚¹ãƒ†ãƒ æº–å‚™å®Œäº†', 'success', 'Googleèªè¨¼ã‚’é–‹å§‹ã§ãã¾ã™ï¼ˆGoogle Sheetsé€£æºå¯¾å¿œï¼‰');
                    document.getElementById('loginBtn').disabled = false;
                    authState.initialized = true;
                } else {
                    throw new Error('Google Drive API v2 ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                }
                
            } catch (error) {
                console.error('âŒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                updateStatus('åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error', error.message);
                updateStep('step-init', 'error');
            }
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†æ™‚
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ“„ Google Sheetså¯¾å¿œ ç›´æ¥èªè¨¼ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†');
            
            // ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
            document.getElementById('loginBtn').addEventListener('click', performGoogleAuth);
            
            // ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ï¼ˆ1ç§’å¾Œã«å®Ÿè¡Œï¼‰
            setTimeout(initializeSystem, 1000);
        });
    </script>
</body>
</html>
