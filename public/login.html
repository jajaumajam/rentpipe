<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RentPipe - „É≠„Ç∞„Ç§„É≥</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        .auth-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #1e3a8a 0%, #3730a3 100%);
            padding: 20px;
        }
        
        .auth-card {
            background: white;
            border-radius: 16px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        
        .auth-logo {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .auth-logo .logo-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }
        
        .auth-logo h1 {
            font-size: 28px;
            color: #1e3a8a;
            margin: 0;
        }
        
        .auth-logo p {
            color: #6b7280;
            margin-top: 5px;
        }
        
        .auth-tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 2px solid #e5e7eb;
        }
        
        .auth-tab {
            flex: 1;
            padding: 12px;
            background: none;
            border: none;
            color: #6b7280;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .auth-tab.active {
            color: #1e3a8a;
        }
        
        .auth-tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: #1e3a8a;
        }
        
        .auth-form {
            display: none;
        }
        
        .auth-form.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            color: #374151;
            font-weight: 500;
        }
        
        .form-input {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #1e3a8a;
            box-shadow: 0 0 0 3px rgba(30, 58, 138, 0.1);
        }
        
        .password-strength {
            margin-top: 8px;
            height: 4px;
            background: #e5e7eb;
            border-radius: 2px;
            overflow: hidden;
        }
        
        .password-strength-bar {
            height: 100%;
            transition: all 0.3s;
            border-radius: 2px;
        }
        
        .password-strength-text {
            font-size: 12px;
            margin-top: 4px;
        }
        
        .form-footer {
            margin-top: 10px;
            text-align: right;
        }
        
        .form-footer a {
            color: #1e3a8a;
            text-decoration: none;
            font-size: 14px;
        }
        
        .form-footer a:hover {
            text-decoration: underline;
        }
        
        .btn-auth {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #1e3a8a, #3730a3);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-auth:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(30, 58, 138, 0.3);
        }
        
        .demo-info {
            margin-top: 30px;
            padding: 15px;
            background: #f0f9ff;
            border-radius: 8px;
            border: 1px solid #bfdbfe;
        }
        
        .demo-info h4 {
            margin: 0 0 10px 0;
            color: #1e3a8a;
            font-size: 14px;
        }
        
        .demo-info p {
            margin: 5px 0;
            font-size: 13px;
            color: #475569;
        }
        
        .error-message {
            background: #fee;
            border: 1px solid #fcc;
            color: #dc3545;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 14px;
        }
        
        .success-message {
            background: #efe;
            border: 1px solid #cfc;
            color: #28a745;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="auth-container">
        <div class="auth-card">
            <!-- „É≠„Ç¥ -->
            <div class="auth-logo">
                <div class="logo-icon">üè†</div>
                <h1>RentPipe</h1>
                <p>Ë≥ÉË≤∏Âñ∂Ê•≠„Çí„ÄÅÊµÅ„Çå„Çã„Çà„ÅÜ„Å´</p>
            </div>
            
            <!-- „Çø„Éñ -->
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="switchTab('login')">„É≠„Ç∞„Ç§„É≥</button>
                <button class="auth-tab" onclick="switchTab('register')">Êñ∞Ë¶èÁôªÈå≤</button>
            </div>
            
            <!-- „É°„ÉÉ„Çª„Éº„Ç∏„Ç®„É™„Ç¢ -->
            <div id="messageArea"></div>
            
            <!-- „É≠„Ç∞„Ç§„É≥„Éï„Ç©„Éº„É† -->
            <form id="loginForm" class="auth-form active">
                <div class="form-group">
                    <label for="loginEmail" class="form-label">„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ</label>
                    <input type="email" id="loginEmail" class="form-input" required>
                </div>
                
                <div class="form-group">
                    <label for="loginPassword" class="form-label">„Éë„Çπ„ÉØ„Éº„Éâ</label>
                    <input type="password" id="loginPassword" class="form-input" required>
                </div>
                
                <div class="form-footer">
                    <a href="#" onclick="showResetPassword()">„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂøò„Çå„ÅüÊñπ</a>
                </div>
                
                <button type="submit" class="btn-auth">„É≠„Ç∞„Ç§„É≥</button>
            </form>
            
            <!-- Êñ∞Ë¶èÁôªÈå≤„Éï„Ç©„Éº„É† -->
            <form id="registerForm" class="auth-form">
                <div class="form-group">
                    <label for="registerName" class="form-label">„ÅäÂêçÂâç</label>
                    <input type="text" id="registerName" class="form-input" required>
                </div>
                
                <div class="form-group">
                    <label for="registerEmail" class="form-label">„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ</label>
                    <input type="email" id="registerEmail" class="form-input" required>
                </div>
                
                <div class="form-group">
                    <label for="registerPassword" class="form-label">„Éë„Çπ„ÉØ„Éº„Éâ</label>
                    <input type="password" id="registerPassword" class="form-input" required>
                    <div class="password-strength">
                        <div id="passwordStrengthBar" class="password-strength-bar"></div>
                    </div>
                    <div id="passwordStrengthText" class="password-strength-text"></div>
                </div>
                
                <button type="submit" class="btn-auth">„Ç¢„Ç´„Ç¶„É≥„Éà‰ΩúÊàê</button>
            </form>
            
            <!-- „Éá„É¢ÊÉÖÂ†± -->
            <div class="demo-info">
                <h4>üîê „Éá„É¢„Ç¢„Ç´„Ç¶„É≥„Éà</h4>
                <p>„É°„Éº„É´: demo@rentpipe.jp</p>
                <p>„Éë„Çπ„ÉØ„Éº„Éâ: demo123</p>
                <p style="margin-top: 10px; font-size: 12px;">
                    ‚Äª „Åæ„Åü„ÅØ‰ªªÊÑè„ÅÆ„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÅßÊñ∞Ë¶èÁôªÈå≤„Åß„Åç„Åæ„Åô
                </p>
            </div>
        </div>
    </div>
    
    <!-- JavaScript -->
    <script src="js/auth-manager.js"></script>
    <script src="js/security.js"></script>
    <script src="js/error-handler.js"></script>
    <script src="js/tenant-manager.js"></script>
    <script src="js/firebase-config.js"></script>
    <script>
        // „Çø„ÉñÂàá„ÇäÊõø„Åà
        function switchTab(tab) {
            // „Çø„Éñ„Éú„Çø„É≥„ÅÆÂàá„ÇäÊõø„Åà
            document.querySelectorAll('.auth-tab').forEach(t => {
                t.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // „Éï„Ç©„Éº„É†„ÅÆÂàá„ÇäÊõø„Åà
            document.querySelectorAll('.auth-form').forEach(f => {
                f.classList.remove('active');
            });
            
            if (tab === 'login') {
                document.getElementById('loginForm').classList.add('active');
            } else {
                document.getElementById('registerForm').classList.add('active');
            }
            
            // „É°„ÉÉ„Çª„Éº„Ç∏„ÇØ„É™„Ç¢
            clearMessage();
        }
        
        // „É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫
        function showMessage(message, type = 'error') {
            const messageArea = document.getElementById('messageArea');
            messageArea.innerHTML = `
                <div class="${type}-message">
                    ${SecurityManager.escapeHtml(message)}
                </div>
            `;
        }
        
        // „É°„ÉÉ„Çª„Éº„Ç∏„ÇØ„É™„Ç¢
        function clearMessage() {
            document.getElementById('messageArea').innerHTML = '';
        }
        
        // „Éë„Çπ„ÉØ„Éº„ÉâÂº∑Â∫¶„ÉÅ„Çß„ÉÉ„ÇØ
        document.getElementById('registerPassword').addEventListener('input', function(e) {
            const strength = SecurityManager.checkPasswordStrength(e.target.value);
            const bar = document.getElementById('passwordStrengthBar');
            const text = document.getElementById('passwordStrengthText');
            
            bar.style.width = strength.percentage + '%';
            bar.style.backgroundColor = strength.color;
            text.textContent = `Âº∑Â∫¶: ${strength.level} - ${strength.suggestions}`;
            text.style.color = strength.color;
        });
        
        // „É≠„Ç∞„Ç§„É≥„Éï„Ç©„Éº„É†ÈÄÅ‰ø°
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            clearMessage();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            // „Éê„É™„Éá„Éº„Ç∑„Éß„É≥
            if (!SecurityManager.validateEmail(email)) {
                showMessage('ÊúâÂäπ„Å™„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            // „É≠„Ç∞„Ç§„É≥Ë©¶Ë°å„ÉÅ„Çß„ÉÉ„ÇØ
            const attemptCheck = SecurityManager.recordLoginAttempt(email, false);
            if (!attemptCheck.allowed) {
                showMessage(attemptCheck.message);
                return;
            }
            
            // „É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫
            ErrorHandler.showLoading('„É≠„Ç∞„Ç§„É≥‰∏≠...');
            
            try {
                const result = await AuthManager.login(email, password);
                
                if (result.success) {
                    // ÊàêÂäü„ÇíË®òÈå≤
                    SecurityManager.recordLoginAttempt(email, true);
                    SecurityManager.auditLog('login_success', { email: email });
                    
                    // „Çª„ÉÉ„Ç∑„Éß„É≥ÈñãÂßã
                    SecurityManager.sessionManager.startSession(result.user);
                    
                    ErrorHandler.hideLoading();
                    showMessage('„É≠„Ç∞„Ç§„É≥„Å´ÊàêÂäü„Åó„Åæ„Åó„ÅüÔºÅ', 'success');
                    
                    // „É™„ÉÄ„Ç§„É¨„ÇØ„Éà
                    setTimeout(() => {
                        const redirect = sessionStorage.getItem('rentpipe_redirect_after_login');
                        window.location.href = redirect || 'index.html';
                    }, 1000);
                } else {
                    ErrorHandler.hideLoading();
                    showMessage(result.error || '„É≠„Ç∞„Ç§„É≥„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                    
                    if (attemptCheck.remaining) {
                        showMessage(`${result.error} (ÊÆã„ÇäË©¶Ë°åÂõûÊï∞: ${attemptCheck.remaining}Âõû)`);
                    }
                    
                    SecurityManager.auditLog('login_failed', { email: email });
                }
            } catch (error) {
                ErrorHandler.hideLoading();
                showMessage('„É≠„Ç∞„Ç§„É≥Âá¶ÁêÜ‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
                console.error('„É≠„Ç∞„Ç§„É≥„Ç®„É©„Éº:', error);
            }
        });
        
        // Êñ∞Ë¶èÁôªÈå≤„Éï„Ç©„Éº„É†ÈÄÅ‰ø°
        document.getElementById('registerForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            clearMessage();
            
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            
            // „Éê„É™„Éá„Éº„Ç∑„Éß„É≥
            if (!name || name.length < 2) {
                showMessage('ÂêçÂâç„ÅØ2ÊñáÂ≠ó‰ª•‰∏ä„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            if (!SecurityManager.validateEmail(email)) {
                showMessage('ÊúâÂäπ„Å™„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            const passwordStrength = SecurityManager.checkPasswordStrength(password);
            if (passwordStrength.strength < 2) {
                showMessage('„Çà„ÇäÂº∑Âäõ„Å™„Éë„Çπ„ÉØ„Éº„Éâ„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            // „É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫
            ErrorHandler.showLoading('„Ç¢„Ç´„Ç¶„É≥„Éà‰ΩúÊàê‰∏≠...');
            
            try {
                const result = await AuthManager.register(email, password, name);
                
                if (result.success) {
                    SecurityManager.auditLog('register_success', { email: email });
                    
                    ErrorHandler.hideLoading();
                    showMessage('„Ç¢„Ç´„Ç¶„É≥„Éà„Çí‰ΩúÊàê„Åó„Åæ„Åó„ÅüÔºÅ', 'success');
                    
                    // Ëá™Âãï„É≠„Ç∞„Ç§„É≥„Åó„Å¶„É™„ÉÄ„Ç§„É¨„ÇØ„Éà
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 1500);
                } else {
                    ErrorHandler.hideLoading();
                    showMessage(result.error || '„Ç¢„Ç´„Ç¶„É≥„Éà‰ΩúÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                    SecurityManager.auditLog('register_failed', { email: email });
                }
            } catch (error) {
                ErrorHandler.hideLoading();
                showMessage('„Ç¢„Ç´„Ç¶„É≥„Éà‰ΩúÊàê‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
                console.error('ÁôªÈå≤„Ç®„É©„Éº:', error);
            }
        });
        
        // „Éë„Çπ„ÉØ„Éº„Éâ„É™„Çª„ÉÉ„Éà
        function showResetPassword() {
            const email = prompt('„Éë„Çπ„ÉØ„Éº„Éâ„É™„Çª„ÉÉ„ÉàÁî®„ÅÆ„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
            
            if (email) {
                if (!SecurityManager.validateEmail(email)) {
                    showMessage('ÊúâÂäπ„Å™„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                    return;
                }
                
                AuthManager.resetPassword(email).then(result => {
                    if (result.success) {
                        showMessage(result.message, 'success');
                    } else {
                        showMessage(result.error);
                    }
                });
            }
        }
        
        // Êó¢„Å´„É≠„Ç∞„Ç§„É≥Ê∏à„Åø„ÅÆÂ†¥Âêà„ÅØ„É™„ÉÄ„Ç§„É¨„ÇØ„Éà
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                if (AuthManager.isAuthenticated) {
                    window.location.href = 'index.html';
                }
            }, 500);
        });
    </script>
</body>
</html>
