<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>関数デバッグ - RentPipe</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 20px auto; padding: 20px; }
        .section { background: #f9f9f9; padding: 20px; margin: 20px 0; border-radius: 8px; }
        .btn { background: #4285f4; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        .result { background: white; padding: 15px; margin: 10px 0; border-radius: 4px; font-family: monospace; font-size: 12px; white-space: pre-wrap; max-height: 300px; overflow-y: auto; }
        .error { background: #fee2e2; color: #991b1b; }
        .success { background: #d1fae5; color: #065f46; }
    </style>
</head>
<body>
    <h1>🔍 関数デバッグツール</h1>
    
    <div class="section">
        <h3>📊 現在の関数状況確認</h3>
        <button class="btn" onclick="checkCurrentFunctions()">関数状況確認</button>
        <div id="function-status" class="result">関数の状況が表示されます</div>
    </div>
    
    <div class="section">
        <h3>🔧 createGoogleForm関数の中身確認</h3>
        <button class="btn" onclick="checkFunctionContent()">関数内容確認</button>
        <div id="function-content" class="result">関数の中身が表示されます</div>
    </div>
    
    <div class="section">
        <h3>📜 読み込まれているスクリプト確認</h3>
        <button class="btn" onclick="checkLoadedScripts()">スクリプト確認</button>
        <div id="loaded-scripts" class="result">読み込まれているスクリプトが表示されます</div>
    </div>
    
    <div class="section">
        <h3>🚀 Google Apps Script専用関数テスト</h3>
        <input type="text" id="gas-url-debug" placeholder="Google Apps Script URL" style="width: 100%; padding: 8px; margin: 10px 0;">
        <button class="btn" onclick="testGASFunction()">GAS専用テスト</button>
        <div id="gas-test" class="result">テスト結果が表示されます</div>
    </div>

    <!-- 最小限のスクリプト読み込み -->
    <script src="js/create-test-customers.js"></script>
    <script src="js/google-apps-script-forms.js"></script>
    
    <!-- 現在のcustomer.htmlと同じスクリプトを読み込んで問題を再現 -->
    
    <script>
        // 関数状況確認
        function checkCurrentFunctions() {
            const functions = {
                'createGoogleForm': typeof window.createGoogleForm,
                'createGoogleFormGAS': typeof window.createGoogleFormGAS,
                'GoogleAppsScriptForms': typeof window.GoogleAppsScriptForms,
                'SimpleGoogleForms': typeof window.SimpleGoogleForms,
                'MinimalGoogleForms': typeof window.MinimalGoogleForms,
                'GoogleFormsAPIv2': typeof window.GoogleFormsAPIv2
            };
            
            let result = '📊 現在の関数状況:\n\n';
            for (const [name, type] of Object.entries(functions)) {
                result += `${name}: ${type}\n`;
            }
            
            // createGoogleForm関数がどこで定義されているかを確認
            if (window.createGoogleForm) {
                result += '\n🔍 createGoogleForm関数の出典:\n';
                result += window.createGoogleForm.toString().substring(0, 200) + '...\n';
            }
            
            document.getElementById('function-status').textContent = result;
        }
        
        // 関数内容確認
        function checkFunctionContent() {
            let result = '';
            
            if (window.createGoogleForm) {
                result += '📝 createGoogleForm 関数の完全な内容:\n\n';
                result += window.createGoogleForm.toString();
                
                // Google Apps Script関連のキーワードがあるかチェック
                const gasKeywords = ['GoogleAppsScriptForms', 'script.google.com', 'gas'];
                const apiKeywords = ['gapi', 'forms.googleapis.com', 'SimpleGoogleForms'];
                
                result += '\n\n🔍 キーワード分析:\n';
                gasKeywords.forEach(keyword => {
                    if (window.createGoogleForm.toString().includes(keyword)) {
                        result += `✅ Google Apps Script関連: ${keyword} 発見\n`;
                    }
                });
                
                apiKeywords.forEach(keyword => {
                    if (window.createGoogleForm.toString().includes(keyword)) {
                        result += `❌ 古いAPI関連: ${keyword} 発見\n`;
                    }
                });
            } else {
                result = '❌ createGoogleForm関数が見つかりません';
            }
            
            document.getElementById('function-content').textContent = result;
        }
        
        // 読み込まれているスクリプト確認
        function checkLoadedScripts() {
            const scripts = Array.from(document.querySelectorAll('script'));
            let result = '📜 読み込まれているスクリプト一覧:\n\n';
            
            scripts.forEach((script, index) => {
                if (script.src) {
                    result += `${index + 1}. ${script.src}\n`;
                    
                    // 問題のあるスクリプトをハイライト
                    if (script.src.includes('simple-google-forms') || 
                        script.src.includes('google-forms-api') ||
                        script.src.includes('minimal-google-forms')) {
                        result += '   ❌ 古いAPIスクリプト（問題の原因）\n';
                    }
                    
                    if (script.src.includes('google-apps-script-forms')) {
                        result += '   ✅ Google Apps Scriptスクリプト\n';
                    }
                } else if (script.textContent.length > 0) {
                    result += `${index + 1}. インラインスクリプト (${script.textContent.length}文字)\n`;
                }
            });
            
            document.getElementById('loaded-scripts').textContent = result;
        }
        
        // Google Apps Script専用テスト
        async function testGASFunction() {
            const gasUrl = document.getElementById('gas-url-debug').value.trim();
            const resultDiv = document.getElementById('gas-test');
            
            if (!gasUrl) {
                resultDiv.textContent = '❌ Google Apps Script URLを入力してください';
                return;
            }
            
            try {
                resultDiv.textContent = '🔄 Google Apps Script専用テスト実行中...';
                
                // Google Apps Script設定
                if (window.GoogleAppsScriptForms) {
                    window.GoogleAppsScriptForms.setScriptUrl(gasUrl);
                }
                
                const testCustomer = {
                    id: 'debug-test-' + Date.now(),
                    name: 'デバッグテスト太郎',
                    email: 'debug@example.com',
                    phone: '03-0000-0000'
                };
                
                // 直接Google Apps Script経由でテスト
                if (window.GoogleAppsScriptForms && window.GoogleAppsScriptForms.createCustomerForm) {
                    const result = await window.GoogleAppsScriptForms.createCustomerForm(testCustomer);
                    
                    if (result.success) {
                        resultDiv.className = 'result success';
                        resultDiv.textContent = `✅ Google Apps Script専用テスト成功！

フォーム作成完了:
- ID: ${result.form.id}
- タイトル: ${result.form.title}
- URL: ${result.form.url}

🎉 Google Apps Scriptは正常に動作しています！
問題は createGoogleForm 関数が古いAPIを呼んでいることです。`;
                        
                        if (confirm('作成されたフォームを確認しますか？')) {
                            window.open(result.form.url, '_blank');
                        }
                    } else {
                        throw new Error(result.error);
                    }
                } else {
                    throw new Error('GoogleAppsScriptFormsが見つかりません');
                }
                
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `❌ Google Apps Scriptテスト失敗: ${error.message}`;
            }
        }
        
        console.log('🔍 関数デバッグツール準備完了');
    </script>
</body>
</html>
