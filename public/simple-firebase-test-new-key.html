<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Test - æ–°APIã‚­ãƒ¼ç‰ˆ</title>
    <style>
        body { 
            font-family: 'Noto Sans JP', sans-serif; 
            padding: 20px; 
            max-width: 600px; 
            margin: 0 auto; 
            line-height: 1.6;
        }
        .status { 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 8px; 
            border: 1px solid #ddd;
        }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .info { background: #d1ecf1; border-color: #b8daff; }
        button {
            background: #1e3a8a; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 6px; 
            margin: 5px; 
            cursor: pointer;
        }
        pre { 
            background: #f5f5f5; 
            padding: 10px; 
            border-radius: 4px; 
            font-size: 12px; 
            overflow-x: auto;
            max-height: 300px;
        }
    </style>
</head>
<body>
    <h1>ğŸ”¥ Firebase Test - æ–°APIã‚­ãƒ¼ç‰ˆï¼ˆåˆ¶é™ãªã—ï¼‰</h1>
    
    <div id="firebase-status" class="status info">
        <strong>ğŸ”§ FirebaseåˆæœŸåŒ–ä¸­...</strong>
    </div>
    
    <div>
        <button onclick="testFirebaseInit()">Step 1: FirebaseåˆæœŸåŒ–</button>
        <button onclick="testAuthentication()">Step 2: åŒ¿åèªè¨¼ãƒ†ã‚¹ãƒˆ</button>
        <button onclick="testFirestoreBasic()">Step 3: FirestoreåŸºæœ¬æ“ä½œ</button>
        <button onclick="testMultiTenant()">Step 4: ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆãƒ†ã‚¹ãƒˆ</button>
    </div>
    
    <div id="results"></div>
    
    <pre id="logs"></pre>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <script>
        // ãƒ­ã‚°è¡¨ç¤º
        function log(message, isError = false) {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('logs');
            const logEntry = `[${timestamp}] ${isError ? 'ERROR' : 'INFO'}: ${message}\n`;
            logElement.textContent += logEntry;
            logElement.scrollTop = logElement.scrollHeight;
            
            if (isError) {
                console.error(message);
            } else {
                console.log(message);
            }
        }
        
        // çµæœè¡¨ç¤º
        function showResult(title, success, message) {
            const resultsDiv = document.getElementById('results');
            const resultClass = success ? 'success' : 'error';
            const icon = success ? 'âœ…' : 'âŒ';
            
            resultsDiv.innerHTML += `
                <div class="status ${resultClass}">
                    <strong>${icon} ${title}</strong><br>
                    ${message}
                </div>
            `;
        }
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let app, db, auth;
        
        // Step 1: FirebaseåˆæœŸåŒ–ãƒ†ã‚¹ãƒˆ
        function testFirebaseInit() {
            log('ğŸ”¥ FirebaseåˆæœŸåŒ–ãƒ†ã‚¹ãƒˆé–‹å§‹...');
            
            try {
                const firebaseConfig = {
                    apiKey: "AIzaSyBvJGdan0lvVSkaAbbSXQkoh6YyPoGyTgM",
                    authDomain: "rentpipe-ab04e.firebaseapp.com",
                    projectId: "rentpipe-ab04e",
                    storageBucket: "rentpipe-ab04e.firebasestorage.app",
                    messagingSenderId: "586040985916",
                    appId: "1:586040985916:web:3cdb5db072f1a6569fb639"
                };
                
                app = firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                auth = firebase.auth();
                
                log(`âœ… Firebase AppåˆæœŸåŒ–æˆåŠŸ: ${app.name}`);
                log(`âœ… Project ID: ${app.options.projectId}`);
                log(`âœ… APIã‚­ãƒ¼: ${firebaseConfig.apiKey.substring(0, 25)}...`);
                
                showResult('FirebaseåˆæœŸåŒ–', true, `ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: ${firebaseConfig.projectId}`);
                
            } catch (error) {
                log(`âŒ FirebaseåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`, true);
                showResult('FirebaseåˆæœŸåŒ–', false, error.message);
            }
        }
        
        // Step 2: åŒ¿åèªè¨¼ãƒ†ã‚¹ãƒˆ
        async function testAuthentication() {
            log('ğŸ” åŒ¿åèªè¨¼ãƒ†ã‚¹ãƒˆé–‹å§‹...');
            
            try {
                if (!auth) {
                    throw new Error('å…ˆã«FirebaseåˆæœŸåŒ–ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„');
                }
                
                log('åŒ¿åèªè¨¼ã‚’å®Ÿè¡Œä¸­...');
                const result = await auth.signInAnonymously();
                const user = result.user;
                
                log(`âœ… åŒ¿åèªè¨¼æˆåŠŸ: ${user.uid}`);
                log(`èªè¨¼ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼: ${user.isAnonymous ? 'anonymous' : 'other'}`);
                
                showResult('åŒ¿åèªè¨¼', true, `èªè¨¼æˆåŠŸ (UID: ${user.uid.substring(0, 8)}...)`);
                
            } catch (error) {
                log(`âŒ åŒ¿åèªè¨¼ã‚¨ãƒ©ãƒ¼: ${error.message}`, true);
                log(`ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰: ${error.code}`);
                showResult('åŒ¿åèªè¨¼', false, `${error.code}: ${error.message}`);
            }
        }
        
        // Step 3: FirestoreåŸºæœ¬æ“ä½œãƒ†ã‚¹ãƒˆ
        async function testFirestoreBasic() {
            log('ğŸ“Š FirestoreåŸºæœ¬æ“ä½œãƒ†ã‚¹ãƒˆé–‹å§‹...');
            
            try {
                if (!db) {
                    throw new Error('å…ˆã«FirebaseåˆæœŸåŒ–ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„');
                }
                
                const currentUser = auth.currentUser;
                if (!currentUser) {
                    throw new Error('å…ˆã«èªè¨¼ã‚’å®Œäº†ã—ã¦ãã ã•ã„');
                }
                
                const testData = {
                    message: 'Phase2 åŸºæœ¬ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿',
                    userId: currentUser.uid,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    testId: Math.random().toString(36).substr(2, 9)
                };
                
                // æ›¸ãè¾¼ã¿ãƒ†ã‚¹ãƒˆ
                log('Firestoreæ›¸ãè¾¼ã¿å®Ÿè¡Œä¸­...');
                const docRef = await db.collection('system').doc('basic-test').set(testData);
                log('âœ… Firestoreæ›¸ãè¾¼ã¿æˆåŠŸ');
                
                // èª­ã¿å–ã‚Šãƒ†ã‚¹ãƒˆ
                log('Firestoreèª­ã¿å–ã‚Šå®Ÿè¡Œä¸­...');
                const doc = await db.collection('system').doc('basic-test').get();
                if (doc.exists) {
                    const data = doc.data();
                    log(`âœ… Firestoreèª­ã¿å–ã‚ŠæˆåŠŸ: ${data.testId}`);
                    showResult('FirestoreåŸºæœ¬æ“ä½œ', true, `æ›¸ãè¾¼ã¿ãƒ»èª­ã¿å–ã‚ŠæˆåŠŸ (TestID: ${data.testId})`);
                } else {
                    throw new Error('æ›¸ãè¾¼ã‚“ã ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
                
            } catch (error) {
                log(`âŒ FirestoreåŸºæœ¬æ“ä½œã‚¨ãƒ©ãƒ¼: ${error.message}`, true);
                log(`ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰: ${error.code || 'N/A'}`);
                showResult('FirestoreåŸºæœ¬æ“ä½œ', false, error.message);
            }
        }
        
        // Step 4: ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆãƒ†ã‚¹ãƒˆ
        async function testMultiTenant() {
            log('ğŸ¢ ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆãƒ†ã‚¹ãƒˆé–‹å§‹...');
            
            try {
                const currentUser = auth.currentUser;
                if (!currentUser) {
                    throw new Error('å…ˆã«èªè¨¼ã‚’å®Œäº†ã—ã¦ãã ã•ã„');
                }
                
                const tenantId = currentUser.uid;
                
                // ãƒ†ãƒŠãƒ³ãƒˆåˆ¥é¡§å®¢ãƒ‡ãƒ¼ã‚¿ä½œæˆ
                const customerData = {
                    name: 'ãƒ†ã‚¹ãƒˆé¡§å®¢',
                    email: 'test@example.com',
                    phone: '090-1234-5678',
                    status: 'initial_contact',
                    tenantId: tenantId,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                // ãƒ†ãƒŠãƒ³ãƒˆåˆ¥ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«ä¿å­˜
                log(`ãƒ†ãƒŠãƒ³ãƒˆ ${tenantId} ã«é¡§å®¢ãƒ‡ãƒ¼ã‚¿ä½œæˆä¸­...`);
                const docRef = await db.collection(`tenants/${tenantId}/customers`).add(customerData);
                log(`âœ… é¡§å®¢ãƒ‡ãƒ¼ã‚¿ä½œæˆæˆåŠŸ: ${docRef.id}`);
                
                // ãƒ†ãƒŠãƒ³ãƒˆåˆ¥ãƒ‡ãƒ¼ã‚¿èª­ã¿å–ã‚Š
                const snapshot = await db.collection(`tenants/${tenantId}/customers`).get();
                log(`âœ… ãƒ†ãƒŠãƒ³ãƒˆé¡§å®¢ãƒ‡ãƒ¼ã‚¿å–å¾—: ${snapshot.size}ä»¶`);
                
                showResult('ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆ', true, `ãƒ†ãƒŠãƒ³ãƒˆåˆ†é›¢ãƒ†ã‚¹ãƒˆæˆåŠŸ (TenantID: ${tenantId.substring(0, 8)}..., é¡§å®¢æ•°: ${snapshot.size})`);
                
            } catch (error) {
                log(`âŒ ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, true);
                showResult('ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆ', false, error.message);
            }
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
        window.addEventListener('load', function() {
            log('ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº† - æ–°APIã‚­ãƒ¼ç‰ˆ');
            document.getElementById('firebase-status').innerHTML = '<strong>âœ… æº–å‚™å®Œäº†</strong><br>Step 1ã‹ã‚‰é †ç•ªã«ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚';
            document.getElementById('firebase-status').className = 'status success';
        });
        
        // ã‚¨ãƒ©ãƒ¼ã‚­ãƒ£ãƒƒãƒ
        window.addEventListener('error', function(event) {
            log(`JavaScript Error: ${event.error ? event.error.message : event.message}`, true);
        });
        
        window.addEventListener('unhandledrejection', function(event) {
            log(`Unhandled Promise Rejection: ${event.reason}`, true);
        });
    </script>
</body>
</html>
