<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¡§å®¢ç®¡ç† | RentPipe</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- æ—¢å­˜ã®å……å®Ÿã—ãŸã‚¹ã‚¿ã‚¤ãƒ«ã‚·ãƒ¼ãƒˆ -->
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/pipeline-responsive.css">
    
    <style>
        /* customer.htmlå°‚ç”¨ã®è¿½åŠ ã‚¹ã‚¿ã‚¤ãƒ« */
        .welcome-banner {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            text-align: center;
        }
        
        .welcome-banner h2 {
            margin: 0 0 10px 0;
            font-size: 24px;
            font-weight: 600;
        }
        
        .welcome-banner p {
            margin: 0;
            opacity: 0.9;
            font-size: 16px;
        }
        
        /* main.cssã¨ã®äº’æ›æ€§ç¢ºä¿ */
        .main-content {
            margin-top: 0;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* æ”¹è‰¯ã•ã‚ŒãŸã‚«ãƒ¼ãƒ‰ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .customer-card {
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }
        
        .customer-card:hover {
            border-left-color: #3b82f6;
            transform: translateX(4px);
        }
        
        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒƒã‚¸ã®æ”¹å–„ */
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-initial { background: #fee2e2; color: #991b1b; }
        .status-presentation { background: #fed7aa; color: #9a3412; }
        .status-viewing { background: #fde68a; color: #92400e; }
        .status-application { background: #dcfce7; color: #166534; }
        .status-screening { background: #dbeafe; color: #1e40af; }
        .status-contract { background: #e0e7ff; color: #3730a3; }
        .status-complete { background: #f3e8ff; color: #581c87; }
    </style>
</head>
<body>
    <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆnavigation.jsãŒç”Ÿæˆï¼‰ -->
    <nav id="main-nav" class="main-nav"></nav>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <main class="main-content">
        <div class="container">
            <!-- ã‚¦ã‚§ãƒ«ã‚«ãƒ ãƒãƒŠãƒ¼ -->
            <div class="welcome-banner">
                <h2>ğŸ‘‹ é¡§å®¢ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã¸ã‚ˆã†ã“ã</h2>
                <p>åŠ¹ç‡çš„ãªé¡§å®¢ç®¡ç†ã§ãƒ“ã‚¸ãƒã‚¹ã‚’åŠ é€Ÿã•ã›ã¾ã—ã‚‡ã†</p>
            </div>

            <!-- ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿çŠ¶æ³ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰ -->
            <div id="script-loading-status" class="script-loading-status" style="display: none;">
                <strong>ğŸ“‹ ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿çŠ¶æ³:</strong>
                <div id="script-status-details"></div>
            </div>

            <!-- èªè¨¼ãƒ»åŒæœŸçŠ¶æ…‹è¡¨ç¤º -->
            <div id="auth-sync-status" class="auth-status warning">
                ğŸ”„ ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ä¸­...
            </div>

            <!-- ãƒšãƒ¼ã‚¸ãƒ˜ãƒƒãƒ€ãƒ¼ -->
            <div class="dashboard-header">
                <div class="header-content">
                    <h1>ğŸ‘¥ é¡§å®¢ç®¡ç†</h1>
                    <p>é¡§å®¢æƒ…å ±ã®ä¸€å…ƒç®¡ç†ã¨ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³è¿½è·¡</p>
                </div>
                <div class="header-actions">
                    <a href="customer-form.html" class="btn btn-primary">
                        ğŸ“ æ–°è¦é¡§å®¢è¿½åŠ 
                    </a>
                    <button id="manual-sync-btn" class="btn btn-secondary" style="display: none;">
                        ğŸ”„ æ‰‹å‹•åŒæœŸ
                    </button>
                    <button onclick="showScriptStatus()" class="btn btn-outline" style="font-size: 12px;">
                        ğŸ” ãƒ‡ãƒãƒƒã‚°
                    </button>
                </div>
            </div>

            <!-- æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
            <div class="search-controls" style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 25px;">
                <h3 style="margin-bottom: 15px; color: #374151;">ğŸ” æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</h3>
                <div style="display: grid; grid-template-columns: 1fr 200px; gap: 15px;">
                    <input type="text" id="search-input" class="form-control" placeholder="é¡§å®¢åãƒ»ãƒ¡ãƒ¼ãƒ«ãƒ»é›»è©±ç•ªå·ã§æ¤œç´¢...">
                    <select id="status-filter" class="form-control">
                        <option value="">ã™ã¹ã¦ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</option>
                        <option value="åˆå›ç›¸è«‡">åˆå›ç›¸è«‡</option>
                        <option value="ç‰©ä»¶ç´¹ä»‹">ç‰©ä»¶ç´¹ä»‹</option>
                        <option value="å†…è¦‹">å†…è¦‹</option>
                        <option value="ç”³è¾¼">ç”³è¾¼</option>
                        <option value="å¯©æŸ»">å¯©æŸ»</option>
                        <option value="å¥‘ç´„">å¥‘ç´„</option>
                        <option value="å®Œäº†">å®Œäº†</option>
                    </select>
                </div>
            </div>

            <!-- çµ±è¨ˆ -->
            <div class="dashboard-stats">
                <div class="stats-grid" id="customer-stats">
                    <div class="stat-card">
                        <div class="stat-icon">ğŸ“Š</div>
                        <div class="stat-value">0</div>
                        <div class="stat-label">ç·é¡§å®¢æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">ğŸ†•</div>
                        <div class="stat-value">0</div>
                        <div class="stat-label">ä»Šæœˆæ–°è¦</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">âœ…</div>
                        <div class="stat-value">0</div>
                        <div class="stat-label">æˆç´„æ¸ˆ</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">ğŸ”„</div>
                        <div class="stat-value">0</div>
                        <div class="stat-label">é€²è¡Œä¸­</div>
                    </div>
                </div>
            </div>

            <!-- é¡§å®¢ä¸€è¦§ -->
            <div class="activity-section">
                <div class="activity-header">
                    <h2>ğŸ‘¥ é¡§å®¢ä¸€è¦§</h2>
                </div>
                <div id="customer-list" class="activity-list">
                    <div style="text-align: center; padding: 40px;">
                        <div class="loading-spinner"></div>
                        <p>é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- JavaScript - ç¢ºå®Ÿãªèª­ã¿è¾¼ã¿é †åº -->
    <script>
        console.log('ğŸš€ customer.html ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿é–‹å§‹');
        
        // ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å‹•çš„èª­ã¿è¾¼ã¿é–¢æ•°
        function loadScript(src, onLoad, onError) {
            const script = document.createElement('script');
            script.src = src;
            script.onload = function() {
                console.log(`âœ… ${src} èª­ã¿è¾¼ã¿å®Œäº†`);
                if (onLoad) onLoad();
            };
            script.onerror = function() {
                console.error(`âŒ ${src} èª­ã¿è¾¼ã¿å¤±æ•—`);
                if (onError) onError();
            };
            document.head.appendChild(script);
        }
        
        // é †æ¬¡ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿
        // é †æ¬¡ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿ï¼ˆGoogle Driveçµ±åˆå¯¾å¿œï¼‰
        async function loadScriptsSequentially() {
            return new Promise((resolve, reject) => {
                loadScript('js/navigation.js', function() {
                    loadScript('js/unified-data-manager.js', function() {
                        loadScript('js/integrated-auth-manager-v2.js', function() {
                            loadScript('js/google-drive-api-v2.js', function() {
                                loadScript('js/google-drive-data-manager.js', function() {
                                    loadScript('js/customer-google-drive-integration.js', function() {
                                        console.log('âœ… ã™ã¹ã¦ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿å®Œäº†');
                                        resolve();
                                    }, function() {
                                        console.warn('âš ï¸ customer-google-drive-integration.js èª­ã¿è¾¼ã¿å¤±æ•—ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ï¼‰');
                                        resolve();
                                    });
                                }, function() {
                                    console.warn('âš ï¸ google-drive-data-manager.js èª­ã¿è¾¼ã¿å¤±æ•—ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ï¼‰');
                                    resolve();
                                });
                            }, function() {
                                console.warn('âš ï¸ Google Drive API v2 èª­ã¿è¾¼ã¿å¤±æ•—ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ï¼‰');
                                resolve();
                            });
                        }, function() {
                            reject(new Error('integrated-auth-manager-v2.js èª­ã¿è¾¼ã¿å¤±æ•—'));
                        });
                    }, function() {
                        console.warn('âš ï¸ unified-data-manager.js èª­ã¿è¾¼ã¿å¤±æ•—ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ï¼‰');
                        loadScript('js/integrated-auth-manager-v2.js', function() {
                            resolve();
                        }, function() {
                            reject(new Error('integrated-auth-manager-v2.js èª­ã¿è¾¼ã¿å¤±æ•—'));
                        });
                    });
                }, function() {
                    reject(new Error('navigation.js èª­ã¿è¾¼ã¿å¤±æ•—'));
                });
            });
        }    </script>
    
    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let currentAuthState = null;
        let currentCustomers = [];
        let isAutoSyncEnabled = true;
        let systemInitialized = false;

        // ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿çŠ¶æ³è¡¨ç¤º
        function showScriptStatus() {
            const statusDiv = document.getElementById('script-loading-status');
            const detailsDiv = document.getElementById('script-status-details');
            
            statusDiv.style.display = statusDiv.style.display === 'none' ? 'block' : 'none';
            
            if (statusDiv.style.display === 'block') {
                const checks = [
                    { name: 'navigation.js', obj: 'window.generateNavigation || window.createNavigation' },
                    { name: 'unified-data-manager.js', obj: 'window.UnifiedDataManager' },
                    { name: 'integrated-auth-manager-v2.js', obj: 'window.IntegratedAuthManagerV2' },
                    { name: 'google-drive-api-v2.js', obj: 'window.GoogleDriveAPIv2' }
                ];
                
                let html = '<ul>';
                
                checks.forEach(check => {
                    try {
                        const exists = eval(check.obj);
                        const status = exists ? 'âœ…' : 'âŒ';
                        html += `<li>${status} ${check.name} - ${exists ? 'OK' : 'ãªã—'}</li>`;
                    } catch (error) {
                        html += `<li>âŒ ${check.name} - ã‚¨ãƒ©ãƒ¼: ${error.message}</li>`;
                    }
                });
                
                html += '</ul>';
                detailsDiv.innerHTML = html;
            }
        }

        // ãƒšãƒ¼ã‚¸åˆæœŸåŒ–ï¼ˆãƒ¡ã‚¤ãƒ³é–¢æ•°ï¼‰
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('ğŸš€ é¡§å®¢ç®¡ç†ãƒšãƒ¼ã‚¸åˆæœŸåŒ–é–‹å§‹');
            
            try {
                await loadScriptsSequentially();
                await new Promise(resolve => setTimeout(resolve, 300));
                await checkScriptLoading();
                await initializeAuthenticationSystem();
                await initializeGoogleDriveIntegration();
                await loadCustomerData();
                setupEventListeners();
                
                systemInitialized = true;
                console.log('âœ… é¡§å®¢ç®¡ç†ãƒšãƒ¼ã‚¸åˆæœŸåŒ–å®Œäº†');
                
            } catch (error) {
                console.error('âŒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                showAuthStatus(`åˆæœŸåŒ–å¤±æ•—: ${error.message}`, 'error');
                showScriptStatus();
            }
        });

        // ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿ç¢ºèª
        async function checkScriptLoading() {
            console.log('ğŸ” ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿çŠ¶æ³ç¢ºèª...');
            
            const checks = [
                { name: 'ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³', obj: 'window.generateNavigation || window.createNavigation', critical: true },
                { name: 'çµ±åˆèªè¨¼ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ v2', obj: 'window.IntegratedAuthManagerV2', critical: true },
                { name: 'Google Drive API v2', obj: 'window.GoogleDriveAPIv2', critical: false },
                { name: 'Unified Data Manager', obj: 'window.UnifiedDataManager', critical: false }
            ];
            
            const missing = [];
            const warnings = [];
            
            for (const check of checks) {
                try {
                    const exists = eval(check.obj);
                    if (exists) {
                        console.log(`âœ… ${check.name} OK`);
                    } else {
                        const message = `${check.name} ãªã—`;
                        if (check.critical) {
                            missing.push(message);
                        } else {
                            warnings.push(message);
                        }
                        console.warn(`âš ï¸ ${message}`);
                    }
                } catch (error) {
                    const message = `${check.name} ã‚¨ãƒ©ãƒ¼: ${error.message}`;
                    if (check.critical) {
                        missing.push(message);
                    } else {
                        warnings.push(message);
                    }
                    console.error(`âŒ ${message}`);
                }
            }
            
            if (missing.length > 0) {
                throw new Error(`é‡è¦ãªã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“: ${missing.join(', ')}`);
            }
            
            if (warnings.length > 0) {
                console.warn(`âš ï¸ ä¸€éƒ¨æ©Ÿèƒ½ãŒåˆ¶é™ã•ã‚Œã¾ã™: ${warnings.join(', ')}`);
            }
            
            console.log('âœ… å¿…é ˆã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿ç¢ºèªå®Œäº†');
        }

        // çµ±åˆèªè¨¼ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–
        async function initializeAuthenticationSystem() {
            showAuthStatus('ğŸ”§ èªè¨¼ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ä¸­...', 'warning');
            
            try {
                if (!window.IntegratedAuthManagerV2.isInitialized) {
                    const initialized = await window.IntegratedAuthManagerV2.initialize();
                    if (!initialized) {
                        throw new Error('çµ±åˆèªè¨¼ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    }
                }
                
                currentAuthState = window.IntegratedAuthManagerV2.getAuthState();
                console.log('ğŸ” ç¾åœ¨ã®èªè¨¼çŠ¶æ…‹:', currentAuthState);
                
                if (!currentAuthState.isAuthenticated) {
                    console.warn('âš ï¸ RentPipeã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã¾ã›ã‚“ - ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ');
                    showAuthStatus('ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚3ç§’å¾Œã«ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ç§»å‹•ã—ã¾ã™...', 'warning');
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 3000);
                    return false;
                }
                
                const userEmail = currentAuthState.rentpipeAuth.user?.email || 'ãƒ¦ãƒ¼ã‚¶ãƒ¼';
                showAuthStatus(`âœ… ${userEmail} ã§ãƒ­ã‚°ã‚¤ãƒ³ä¸­`, 'success');
                return true;
                
            } catch (error) {
                console.error('âŒ èªè¨¼ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                showAuthStatus(`âŒ èªè¨¼ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                return false;
            }
        }

        // Google Driveçµ±åˆåˆæœŸåŒ–
        // Google Driveçµ±åˆåˆæœŸåŒ–ï¼ˆè‡ªå‹•åŒæœŸæ©Ÿèƒ½ä»˜ã - ä¿®æ­£ç‰ˆï¼‰
        // Google Driveçµ±åˆåˆæœŸåŒ–ï¼ˆè‡ªå‹•åŒæœŸæ©Ÿèƒ½ä»˜ã - æŸ”è»Ÿèªè¨¼ç‰ˆï¼‰
        async function initializeGoogleDriveIntegration() {
            try {
                console.log('ğŸ”§ Google Driveçµ±åˆåˆæœŸåŒ–ï¼ˆè‡ªå‹•åŒæœŸæ©Ÿèƒ½ï¼‰é–‹å§‹...');
                
                if (!window.GoogleDriveAPIv2) {
                    console.warn('âš ï¸ Google Drive API v2 ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ - åŸºæœ¬æ©Ÿèƒ½ã®ã¿ä½¿ç”¨');
                    showAuthStatus('âš ï¸ Google Driveæ©Ÿèƒ½ãªã—', 'warning');
                    return false;
                }
                
                showAuthStatus('â˜ï¸ Google Drive APIåˆæœŸåŒ–ä¸­...', 'warning');
                
                // Step 0: GoogleDriveAPIv2ã®å®Œå…¨åˆæœŸåŒ–
                const apiInitialized = await window.GoogleDriveAPIv2.initialize();
                if (!apiInitialized) {
                    throw new Error('Google Drive API v2 åˆæœŸåŒ–ã«å¤±æ•—');
                }
                console.log('âœ… Google Drive API v2 åˆæœŸåŒ–å®Œäº†');
                
                // Step 1: åŸºæœ¬èªè¨¼çŠ¶æ…‹ç¢ºèªï¼ˆæŸ”è»Ÿãªãƒã‚§ãƒƒã‚¯ï¼‰
                const isFullyAuthenticated = window.IntegratedAuthManagerV2.isFullyAuthenticated();
                const hasBasicAuth = window.IntegratedAuthManagerV2.getAuthState()?.isAuthenticated;
                console.log('ğŸ” èªè¨¼çŠ¶æ…‹è©³ç´°:', { isFullyAuthenticated, hasBasicAuth });
                
                if (!hasBasicAuth) {
                    console.warn('âš ï¸ åŸºæœ¬èªè¨¼ãŒä¸è¶³ã—ã¦ã„ã¾ã™');
                    showAuthStatus('âš ï¸ åŸºæœ¬èªè¨¼ãŒå¿…è¦ã§ã™', 'warning');
                    return false;
                }
                
                // Step 2: Google Drive APIèªè¨¼ï¼ˆå®Œå…¨èªè¨¼ã§ãªã„å ´åˆã‚‚è©¦è¡Œï¼‰
                showAuthStatus('â˜ï¸ Google Driveæ¨©é™å–å¾—ä¸­...', 'warning');
                
                if (!isFullyAuthenticated) {
                    console.log('âš ï¸ å®Œå…¨èªè¨¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€Google Driveèªè¨¼ã‚’è©¦è¡Œã—ã¾ã™');
                }
                
                const driveAuthenticated = await window.GoogleDriveAPIv2.authenticate();
                if (!driveAuthenticated || !window.GoogleDriveAPIv2.accessToken) {
                    throw new Error('Google Drive APIèªè¨¼ã«å¤±æ•—');
                }
                console.log('âœ… Google Drive APIèªè¨¼æˆåŠŸ');
                
                // Step 3: GoogleDriveDataManageråˆæœŸåŒ–
                showAuthStatus('â˜ï¸ ãƒ‡ãƒ¼ã‚¿ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ä¸­...', 'warning');
                const dataManagerReady = await window.GoogleDriveDataManager.initialize();
                if (!dataManagerReady) {
                    throw new Error('GoogleDriveDataManageråˆæœŸåŒ–ã«å¤±æ•—');
                }
                console.log('âœ… GoogleDriveDataManageråˆæœŸåŒ–æˆåŠŸ');
                
                // Step 4: CustomerGoogleDriveIntegrationåˆæœŸåŒ–
                if (window.CustomerGoogleDriveIntegration) {
                    await window.CustomerGoogleDriveIntegration.initialize();
                }
                
                // Step 5: åˆå›ãƒ‡ãƒ¼ã‚¿åŒæœŸ
                showAuthStatus('â˜ï¸ åˆå›ãƒ‡ãƒ¼ã‚¿åŒæœŸä¸­...', 'warning');
                const customers = await window.GoogleDriveDataManager.syncFromGoogleDrive();
                console.log(`âœ… åˆå›ãƒ‡ãƒ¼ã‚¿åŒæœŸå®Œäº†: ${customers.length}ä»¶`);
                
                showAuthStatus(`â˜ï¸ Google Driveè‡ªå‹•åŒæœŸæœ‰åŠ¹ (${customers.length}ä»¶åŒæœŸæ¸ˆã¿)`, 'success');
                return true;
                
            } catch (error) {
                console.error('âŒ Google Driveçµ±åˆåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                showAuthStatus(`âŒ Google Driveçµ±åˆåˆæœŸåŒ–å¤±æ•—: ${error.message}`, 'error');
                return false;
            }
        }

        async function attemptAutoGoogleAuth() {
            try {
                console.log('ğŸ”„ Googleè‡ªå‹•èªè¨¼ã‚’è©¦è¡Œä¸­...');
                
                const initialized = await window.GoogleDriveAPIv2.initialize();
                if (!initialized) {
                    throw new Error('Google Drive APIåˆæœŸåŒ–ã«å¤±æ•—');
                }
                
                const userInfo = await window.GoogleDriveAPIv2.authenticateSilent();
                
                if (userInfo) {
                    console.log('âœ… Googleè‡ªå‹•èªè¨¼æˆåŠŸ:', userInfo.email);
                    
                    await window.IntegratedAuthManagerV2.updateGoogleAuth({
                        isSignedIn: true,
                        user: userInfo,
                        accessToken: window.GoogleDriveAPIv2.accessToken,
                        tokenExpiry: Date.now() + (3600 * 1000)
                    });
                    
                    return true;
                } else {
                    console.log('â„¹ï¸ Googleè‡ªå‹•èªè¨¼ã¯åˆ©ç”¨ã§ãã¾ã›ã‚“ï¼ˆåˆå›èªè¨¼ãŒå¿…è¦ï¼‰');
                    return false;
                }
                
            } catch (error) {
                console.log('â„¹ï¸ Googleè‡ªå‹•èªè¨¼ã«å¤±æ•—:', error.message);
                return false;
            }
        }

        // æ‰‹å‹•èªè¨¼ãƒœã‚¿ãƒ³è¡¨ç¤º
        function showManualAuthButton() {
            const statusDiv = document.getElementById('auth-sync-status');
            statusDiv.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px;">
                    <span>âš ï¸ Google Driveæœªæ¥ç¶š - æ‰‹å‹•èªè¨¼ãŒå¿…è¦ã§ã™</span>
                    <button id="manual-google-auth-btn" class="btn btn-primary" onclick="performManualGoogleAuth()">
                        ğŸ” Google Driveæ¥ç¶š
                    </button>
                </div>
            `;
            statusDiv.className = 'auth-status warning';
        }

        // æ‰‹å‹•Googleèªè¨¼å®Ÿè¡Œ
        async function performManualGoogleAuth() {
            const btn = document.getElementById('manual-google-auth-btn');
            const originalText = btn.textContent;
            
            try {
                btn.textContent = 'èªè¨¼ä¸­...';
                btn.disabled = true;
                
                showAuthStatus('ğŸ” Googleèªè¨¼ä¸­...', 'warning');
                
                const initialized = await window.GoogleDriveAPIv2.initialize();
                if (!initialized) {
                    throw new Error('Google Drive APIåˆæœŸåŒ–ã«å¤±æ•—');
                }
                
                const userInfo = await window.GoogleDriveAPIv2.authenticate();
                
                console.log('âœ… Googleæ‰‹å‹•èªè¨¼æˆåŠŸ:', userInfo.email);
                
                await window.IntegratedAuthManagerV2.updateGoogleAuth({
                    isSignedIn: true,
                    user: userInfo,
                    accessToken: window.GoogleDriveAPIv2.accessToken,
                    tokenExpiry: Date.now() + (3600 * 1000)
                });
                
                currentAuthState = window.IntegratedAuthManagerV2.getAuthState();
                showAuthStatus('â˜ï¸ Google Driveè‡ªå‹•åŒæœŸæœ‰åŠ¹', 'success');
                
            } catch (error) {
                console.error('âŒ æ‰‹å‹•Googleèªè¨¼ã‚¨ãƒ©ãƒ¼:', error);
                showAuthStatus(`Googleèªè¨¼ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        // é¡§å®¢ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        async function loadCustomerData() {
            try {
                console.log('ğŸ“Š é¡§å®¢ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–‹å§‹');
                
                const localCustomers = JSON.parse(localStorage.getItem('rentpipe_customers') || '[]');
                
                if (localCustomers.length > 0) {
                    currentCustomers = localCustomers;
                    updateCustomerList();
                    updateStats();
                    console.log(`ğŸ“Š LocalStorageã‹ã‚‰ ${localCustomers.length}ä»¶ã®é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿`);
                } else {
                    await createDemoData();
                }
                
            } catch (error) {
                console.error('âŒ é¡§å®¢ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                showEmptyState();
            }
        }

        // ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ä½œæˆ
        async function createDemoData() {
            const demoCustomers = [
                {
                    id: 'demo-1',
                    name: 'ç”°ä¸­å¤ªéƒ',
                    email: 'tanaka@example.com',
                    phone: '090-1234-5678',
                    pipelineStatus: 'ç‰©ä»¶ç´¹ä»‹',
                    preferences: {
                        budgetMin: 80000,
                        budgetMax: 120000,
                        areas: ['æ¸‹è°·', 'æ–°å®¿'],
                        roomType: '1LDK'
                    },
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                },
                {
                    id: 'demo-2',
                    name: 'ä½è—¤èŠ±å­',
                    email: 'sato@example.com',
                    phone: '090-2345-6789',
                    pipelineStatus: 'åˆå›ç›¸è«‡',
                    preferences: {
                        budgetMin: 60000,
                        budgetMax: 90000,
                        areas: ['æ± è¢‹', 'ç§‹è‘‰åŸ'],
                        roomType: '1K'
                    },
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                },
                {
                    id: 'demo-3',
                    name: 'å±±ç”°æ¬¡éƒ',
                    email: 'yamada@example.com',
                    phone: '090-3456-7890',
                    pipelineStatus: 'å¥‘ç´„',
                    preferences: {
                        budgetMin: 100000,
                        budgetMax: 150000,
                        areas: ['æµæ¯”å¯¿', 'ä¸­ç›®é»’'],
                        roomType: '2LDK'
                    },
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                }
            ];
            
            localStorage.setItem('rentpipe_customers', JSON.stringify(demoCustomers));
            currentCustomers = demoCustomers;
            updateCustomerList();
            updateStats();
            
            console.log('âœ… ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆã—ã¾ã—ãŸ');
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«å¿œã˜ãŸã‚¯ãƒ©ã‚¹åã‚’å–å¾—
        function getStatusClass(status) {
            const statusMap = {
                'åˆå›ç›¸è«‡': 'status-initial',
                'ç‰©ä»¶ç´¹ä»‹': 'status-presentation',
                'å†…è¦‹': 'status-viewing',
                'ç”³è¾¼': 'status-application',
                'å¯©æŸ»': 'status-screening',
                'å¥‘ç´„': 'status-contract',
                'å®Œäº†': 'status-complete'
            };
            return statusMap[status] || 'status-initial';
        }

        // é¡§å®¢ä¸€è¦§æ›´æ–°
        function updateCustomerList() {
            const customerList = document.getElementById('customer-list');
            
            if (currentCustomers.length === 0) {
                showEmptyState();
                return;
            }
            
            customerList.innerHTML = currentCustomers.map(customer => `
                <div class="activity-item customer-card" data-customer-id="${customer.id}">
                    <div class="customer-header" style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                        <div class="customer-info">
                            <h3 style="margin: 0 0 5px 0; font-size: 18px;">ğŸ‘¤ ${customer.name}</h3>
                            <div class="customer-meta" style="color: #64748b; font-size: 14px; margin-bottom: 8px;">
                                ğŸ“§ ${customer.email} â€¢ ğŸ“± ${customer.phone}
                            </div>
                            <div class="customer-status">
                                <span class="status-badge ${getStatusClass(customer.pipelineStatus)}">
                                    ${customer.pipelineStatus}
                                </span>
                            </div>
                            ${customer.preferences ? `
                                <div style="font-size: 12px; color: #6b7280; margin-top: 8px;">
                                    ğŸ’° Â¥${customer.preferences.budgetMin?.toLocaleString()} - Â¥${customer.preferences.budgetMax?.toLocaleString()} â€¢ 
                                    ğŸ  ${customer.preferences.roomType} â€¢ 
                                    ğŸ“ ${customer.preferences.areas?.join(', ') || 'ã‚¨ãƒªã‚¢æœªè¨­å®š'}
                                </div>
                            ` : ''}
                        </div>
                        <div class="customer-actions">
                            <a href="customer-detail.html?id=${customer.id}" class="btn btn-primary btn-sm">
                                ğŸ“‹ è©³ç´°
                            </a>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // çµ±è¨ˆæ›´æ–°
        function updateStats() {
            const statCards = document.querySelectorAll('.stat-card .stat-value');
            const totalCustomers = currentCustomers.length;
            const thisMonthNew = currentCustomers.filter(c => {
                const created = new Date(c.createdAt);
                const thisMonth = new Date();
                return created.getFullYear() === thisMonth.getFullYear() && 
                       created.getMonth() === thisMonth.getMonth();
            }).length;
            const completed = currentCustomers.filter(c => c.pipelineStatus === 'å®Œäº†').length;
            const inProgress = currentCustomers.filter(c => 
                c.pipelineStatus !== 'å®Œäº†' && c.pipelineStatus !== 'åˆå›ç›¸è«‡'
            ).length;
            
            if (statCards.length >= 4) {
                statCards[0].textContent = totalCustomers;
                statCards[1].textContent = thisMonthNew;
                statCards[2].textContent = completed;
                statCards[3].textContent = inProgress;
            }
        }

        // ç©ºçŠ¶æ…‹è¡¨ç¤º
        function showEmptyState() {
            const customerList = document.getElementById('customer-list');
            customerList.innerHTML = `
                <div style="text-align: center; padding: 60px 20px; color: #64748b;">
                    <div style="font-size: 64px; margin-bottom: 20px; opacity: 0.5;">ğŸ‘¥</div>
                    <h3 style="font-size: 24px; margin-bottom: 10px; color: #374151;">ã¾ã é¡§å®¢ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</h3>
                    <p style="font-size: 16px; margin-bottom: 25px;">æ–°ã—ã„é¡§å®¢ã‚’ç™»éŒ²ã—ã¦ã€åŠ¹ç‡çš„ãªé¡§å®¢ç®¡ç†ã‚’å§‹ã‚ã¾ã—ã‚‡ã†ã€‚</p>
                    <a href="customer-form.html" class="btn btn-primary">
                        ğŸ“ æœ€åˆã®é¡§å®¢ã‚’ç™»éŒ²
                    </a>
                </div>
            `;
        }

        // èªè¨¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
        function showAuthStatus(message, type) {
            const statusDiv = document.getElementById('auth-sync-status');
            statusDiv.textContent = message;
            statusDiv.className = `auth-status ${type}`;
        }

        // åŒæœŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¿½åŠ 
        function addSyncStatus(message, type) {
            const statusDiv = document.getElementById('auth-sync-status');
            const syncSpan = document.createElement('span');
            syncSpan.className = `sync-status ${type}`;
            syncSpan.textContent = message;
            statusDiv.appendChild(syncSpan);
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        function setupEventListeners() {
            const searchInput = document.getElementById('search-input');
            const statusFilter = document.getElementById('status-filter');
            
            if (searchInput) {
                searchInput.addEventListener('input', performSearch);
            }
            
            if (statusFilter) {
                statusFilter.addEventListener('change', performSearch);
            }
        }

        // æ¤œç´¢å®Ÿè¡Œ
        function performSearch() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const statusFilter = document.getElementById('status-filter').value;
            
            let filteredCustomers = [...currentCustomers];
            
            if (searchTerm) {
                filteredCustomers = filteredCustomers.filter(customer => 
                    customer.name.toLowerCase().includes(searchTerm) ||
                    customer.email.toLowerCase().includes(searchTerm) ||
                    customer.phone.includes(searchTerm)
                );
            }
            
            if (statusFilter) {
                filteredCustomers = filteredCustomers.filter(customer => 
                    customer.pipelineStatus === statusFilter
                );
            }
            
            const originalCustomers = currentCustomers;
            currentCustomers = filteredCustomers;
            updateCustomerList();
            currentCustomers = originalCustomers;
        }
    </script>
</body>
</html>
