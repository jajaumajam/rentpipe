<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¡§å®¢ç®¡ç† - RentPipe</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <header>
        <div class="header-content">
            <h1>ğŸ  RentPipe</h1>
            <nav class="nav-container">
                <a href="index.html">ãƒ›ãƒ¼ãƒ </a>
                <a href="customer.html" class="active">é¡§å®¢ç®¡ç†</a>
                <a href="customer-minimal.html">ç°¡æ˜“ç‰ˆ</a>
                <a href="pipeline.html">ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³</a>
                <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±è¡¨ç¤ºã‚¨ãƒªã‚¢ï¼ˆä¸€æ„IDï¼‰ -->
                <div id="unique-nav-user-info" class="nav-user-info"></div>
                <button onclick="handleLogout()" class="btn btn-outline nav-logout">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            </nav>
        </div>
    </header>

    <main class="main-content">
        <div class="page-header">
            <h2>ğŸ‘¥ é¡§å®¢ç®¡ç†</h2>
            <p>é¡§å®¢æƒ…å ±ã®ç®¡ç†ã¨å–¶æ¥­é€²æ—ã®è¿½è·¡ - Google DriveåŒæœŸå¯¾å¿œ</p>
        </div>

        <!-- Google DriveåŒæœŸçŠ¶æ³è¡¨ç¤º -->
        <div id="google-forms-status" style="margin: 1rem 0; padding: 1rem; border-radius: 8px; background: #f3f4f6;">
            <h3>â˜ï¸ Google Drive åŒæœŸ</h3>
            <p>ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ä¸­...</p>
        </div>

        <!-- é¡§å®¢æ“ä½œãƒœã‚¿ãƒ³ -->
        <div class="page-actions" style="margin: 1rem 0;">
            <a href="customer-form.html" class="btn btn-primary">
                ğŸ“ æ–°è¦é¡§å®¢ç™»éŒ²
            </a>
            <button onclick="refreshCustomers()" class="btn btn-outline">
                ğŸ”„ ãƒªã‚¹ãƒˆæ›´æ–°
            </button>
            <a href="google-drive-integration-test.html" target="_blank" class="btn btn-outline">
                ğŸ”§ çµ±åˆãƒ†ã‚¹ãƒˆ
            </a>
        </div>

        <!-- é¡§å®¢ãƒªã‚¹ãƒˆ -->
        <div id="customer-list" class="customer-grid">
            <div style="text-align: center; padding: 40px; color: #6b7280;">
                <div style="font-size: 24px;">ğŸ“‹</div>
                <p>é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
            </div>
        </div>
    </main>

    <!-- å¿…è¦ãªã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ã¿èª­ã¿è¾¼ã¿ -->
    <!-- åŸºæœ¬ã‚·ã‚¹ãƒ†ãƒ  -->
    <script src="js/simple-reliable-auth.js"></script>
    <script src="js/local-first-sync.js"></script>
    <script src="js/customer-unified.js"></script>
    
    <!-- Google Driveçµ±åˆï¼ˆæ–°è¦è¿½åŠ ï¼‰ -->
    <script src="js/google-drive-api-v2.js"></script>
    <script src="js/google-drive-data-manager.js"></script>
    <script src="js/customer-google-drive-integration.js"></script>
    
    <script>
        // ğŸš€ customer.html Google Driveçµ±åˆç‰ˆ åˆæœŸåŒ–
        console.log('ğŸš€ Customerç®¡ç†ç”»é¢ï¼ˆGoogle Driveçµ±åˆç‰ˆï¼‰åˆæœŸåŒ–é–‹å§‹');
        
        let isSystemReady = false;
        
        // DOMèª­ã¿è¾¼ã¿å®Œäº†æ™‚ã®å‡¦ç†
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('ğŸ“„ DOMèª­ã¿è¾¼ã¿å®Œäº†');
            
            try {
                // 1. åŸºæœ¬ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å¾…æ©Ÿ
                await waitForBasicSystems();
                
                // 2. é¡§å®¢ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
                loadCustomerData();
                
                // 3. Google Driveçµ±åˆåˆæœŸåŒ–
                await initializeGoogleDriveIntegration();
                
                isSystemReady = true;
                console.log('âœ… å…¨ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†');
                
            } catch (error) {
                console.error('âŒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
            }
        });
        
        // åŸºæœ¬ã‚·ã‚¹ãƒ†ãƒ ã®åˆæœŸåŒ–å¾…æ©Ÿ
        function waitForBasicSystems() {
            return new Promise((resolve) => {
                const checkInterval = setInterval(() => {
                    if (window.customerManager || window.CustomerUnified) {
                        clearInterval(checkInterval);
                        console.log('âœ… åŸºæœ¬ã‚·ã‚¹ãƒ†ãƒ æº–å‚™å®Œäº†');
                        resolve();
                    }
                }, 100);
                
                // 5ç§’ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
                setTimeout(() => {
                    clearInterval(checkInterval);
                    console.log('âš ï¸ åŸºæœ¬ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ - ç¶šè¡Œ');
                    resolve();
                }, 5000);
            });
        }
        
        // é¡§å®¢ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        function loadCustomerData() {
            try {
                if (window.customerManager && typeof window.customerManager.loadCustomers === 'function') {
                    console.log('ğŸ”„ é¡§å®¢ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ï¼ˆçµ±åˆã‚·ã‚¹ãƒ†ãƒ ï¼‰');
                    window.customerManager.loadCustomers();
                } else if (window.CustomerUnified && typeof window.CustomerUnified.loadCustomers === 'function') {
                    console.log('ğŸ”„ é¡§å®¢ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰');
                    window.CustomerUnified.loadCustomers();
                } else {
                    console.log('ğŸ”„ é¡§å®¢ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ï¼ˆåŸºæœ¬ï¼‰');
                    loadCustomersBasic();
                }
            } catch (error) {
                console.error('âŒ é¡§å®¢ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                loadCustomersBasic();
            }
        }
        
        // åŸºæœ¬çš„ãªé¡§å®¢ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
        function loadCustomersBasic() {
            try {
                const customers = JSON.parse(localStorage.getItem('rentpipe_customers') || '[]');
                console.log(`ğŸ“Š åŸºæœ¬é¡§å®¢ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿: ${customers.length}ä»¶`);
                
                const customerList = document.getElementById('customer-list');
                if (customers.length === 0) {
                    customerList.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #6b7280;">
                            <div style="font-size: 48px; margin-bottom: 15px;">ğŸ‘¥</div>
                            <h3>ã¾ã é¡§å®¢ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</h3>
                            <p>æ–°ã—ã„é¡§å®¢ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚</p>
                            <a href="customer-form.html" class="btn btn-primary" style="margin-top: 15px;">
                                ğŸ“ æ–°è¦é¡§å®¢ç™»éŒ²
                            </a>
                        </div>
                    `;
                } else {
                    customerList.innerHTML = customers.map(customer => `
                        <div class="customer-card" data-customer-id="${customer.id}">
                            <div class="customer-header">
                                <div class="customer-info">
                                    <h3>${customer.name || 'åå‰æœªè¨­å®š'}</h3>
                                    <div class="customer-meta">
                                        ${customer.email || 'ãƒ¡ãƒ¼ãƒ«æœªè¨­å®š'} â€¢ ${customer.phone || 'é›»è©±æœªè¨­å®š'}
                                    </div>
                                    <div class="customer-status">
                                        ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${customer.pipelineStatus || customer.status || 'æœªè¨­å®š'}
                                    </div>
                                </div>
                                <div class="customer-actions">
                                    <a href="customer-detail.html?id=${customer.id}" class="btn btn-outline">è©³ç´°</a>
                                    <button onclick="editCustomer('${customer.id}')" class="btn btn-primary">ç·¨é›†</button>
                                    <button onclick="deleteCustomer('${customer.id}')" class="btn btn-danger">å‰Šé™¤</button>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
                
            } catch (error) {
                console.error('âŒ åŸºæœ¬é¡§å®¢ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('customer-list').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #dc2626;">
                        <h3>ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</h3>
                        <p>é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>
                        <button onclick="location.reload()" class="btn btn-primary">
                            ğŸ”„ ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿
                        </button>
                    </div>
                `;
            }
        }
        
        // Google Driveçµ±åˆåˆæœŸåŒ–
        async function initializeGoogleDriveIntegration() {
            try {
                console.log('â˜ï¸ Google Driveçµ±åˆåˆæœŸåŒ–é–‹å§‹...');
                
                if (window.CustomerGoogleDriveIntegration) {
                    const success = await window.CustomerGoogleDriveIntegration.initialize();
                    if (success) {
                        console.log('âœ… Google Driveçµ±åˆåˆæœŸåŒ–æˆåŠŸ');
                    } else {
                        console.log('âš ï¸ Google Driveçµ±åˆåˆæœŸåŒ–å¤±æ•—ï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ï¼‰');
                    }
                } else {
                    console.log('âš ï¸ Google Driveçµ±åˆã‚¹ã‚¯ãƒªãƒ—ãƒˆæœªèª­ã¿è¾¼ã¿ï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ï¼‰');
                }
                
            } catch (error) {
                console.error('âŒ Google Driveçµ±åˆåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ï¼ˆHTMLã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã‚‹ï¼‰
        function editCustomer(customerId) {
            window.location.href = `customer-form.html?edit=${customerId}`;
        }
        
        function deleteCustomer(customerId) {
            if (!confirm('ã“ã®é¡§å®¢ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã—ã§ãã¾ã›ã‚“ã€‚')) {
                return;
            }
            
            try {
                const customers = JSON.parse(localStorage.getItem('rentpipe_customers') || '[]');
                const updatedCustomers = customers.filter(c => c.id !== customerId);
                localStorage.setItem('rentpipe_customers', JSON.stringify(updatedCustomers));
                
                console.log(`ğŸ—‘ï¸ é¡§å®¢å‰Šé™¤: ${customerId}`);
                loadCustomerData(); // ãƒªã‚¹ãƒˆæ›´æ–°
                
            } catch (error) {
                console.error('âŒ é¡§å®¢å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                alert('é¡§å®¢å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }
        
        function refreshCustomers() {
            console.log('ğŸ”„ é¡§å®¢ãƒªã‚¹ãƒˆæ›´æ–°');
            loadCustomerData();
        }
        
        function handleLogout() {
            if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                console.log('ğŸ‘‹ ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ');
                // å¿…è¦ã«å¿œã˜ã¦ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
                window.location.href = 'login.html';
            }
        }
        
    </script>
</body>
</html>
