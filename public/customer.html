<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¡§å®¢ç®¡ç† - RentPipe</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .page-description {
            color: #6b7280;
            margin-top: 8px;
        }
        
        .auth-status {
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            font-weight: 500;
        }
        
        .auth-status.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }
        
        .auth-status.warning {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #f59e0b;
        }
        
        .auth-status.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }
        
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .stat-icon {
            font-size: 32px;
        }
        
        .stat-content h3 {
            margin: 0;
            font-size: 28px;
            color: #1f2937;
        }
        
        .stat-content p {
            margin: 5px 0 0 0;
            color: #6b7280;
            font-size: 14px;
        }
        
        .search-filter-container {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .search-box {
            margin-bottom: 15px;
        }
        
        .search-box input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .filter-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 8px 16px;
            border: 2px solid #e5e7eb;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .filter-btn.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        
        .customer-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .customer-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.2s;
        }
        
        .customer-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        
        .customer-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }
        
        .customer-name {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
        }
        
        .customer-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .customer-info {
            margin-bottom: 8px;
            color: #6b7280;
            font-size: 14px;
        }
        
        .customer-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e5e7eb;
        }
        
        .btn-edit, .btn-delete {
            flex: 1;
            padding: 8px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .btn-edit {
            background: #3b82f6;
            color: white;
        }
        
        .btn-edit:hover {
            background: #2563eb;
        }
        
        .btn-delete {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .btn-delete:hover {
            background: #fecaca;
        }
    </style>
</head>
<body>
    <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <div id="navigation"></div>
    
    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <div class="main-content">
        <div class="page-header">
            <div>
                <h1>ğŸ‘¥ é¡§å®¢ç®¡ç†</h1>
                <p class="page-description">ã™ã¹ã¦ã®é¡§å®¢æƒ…å ±ã‚’ä¸€å…ƒç®¡ç†ï¼ˆGoogle Sheetsè‡ªå‹•åŒæœŸï¼‰</p>
            </div>
            <a href="customer-form.html" class="btn btn-primary">â• æ–°è¦é¡§å®¢ç™»éŒ²</a>
        </div>

        <!-- èªè¨¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
        <div id="auth-sync-status" class="auth-status warning">
            ğŸ”§ ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ä¸­...
        </div>

        <!-- çµ±è¨ˆ -->
        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-icon">ğŸ‘¥</div>
                <div class="stat-content">
                    <h3 id="stat-total">0</h3>
                    <p>ç·é¡§å®¢æ•°</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ğŸ†•</div>
                <div class="stat-content">
                    <h3 id="stat-new">0</h3>
                    <p>ä»Šæœˆã®æ–°è¦</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">âœ…</div>
                <div class="stat-content">
                    <h3 id="stat-completed">0</h3>
                    <p>æˆç´„æ¸ˆã¿</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ğŸ“Š</div>
                <div class="stat-content">
                    <h3 id="stat-active">0</h3>
                    <p>å¯¾å¿œä¸­</p>
                </div>
            </div>
        </div>

        <!-- æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
        <div class="search-filter-container">
            <div class="search-box">
                <input type="text" id="search-input" placeholder="ğŸ” é¡§å®¢åã€ãƒ¡ãƒ¼ãƒ«ã€é›»è©±ç•ªå·ã§æ¤œç´¢..." onkeyup="searchCustomers()">
            </div>
            <div class="filter-buttons">
                <button class="filter-btn active" onclick="filterByStatus('all')">ã™ã¹ã¦</button>
                <button class="filter-btn" onclick="filterByStatus('åˆå›ç›¸è«‡')">åˆå›ç›¸è«‡</button>
                <button class="filter-btn" onclick="filterByStatus('ç‰©ä»¶ç´¹ä»‹')">ç‰©ä»¶ç´¹ä»‹</button>
                <button class="filter-btn" onclick="filterByStatus('å†…è¦‹')">å†…è¦‹</button>
                <button class="filter-btn" onclick="filterByStatus('ç”³è¾¼')">ç”³è¾¼</button>
                <button class="filter-btn" onclick="filterByStatus('å¯©æŸ»')">å¯©æŸ»</button>
                <button class="filter-btn" onclick="filterByStatus('å¥‘ç´„')">å¥‘ç´„</button>
                <button class="filter-btn" onclick="filterByStatus('å®Œäº†')">å®Œäº†</button>
            </div>
        </div>

        <!-- é¡§å®¢ãƒªã‚¹ãƒˆ -->
        <div id="customer-list" class="customer-grid">
            <!-- é¡§å®¢ã‚«ãƒ¼ãƒ‰ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
        </div>
    </div>

    <!-- Google API Client & Identity Services -->
    <script src="https://accounts.google.com/gsi/client"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    
    <!-- RentPipe Core Scripts -->
    <script src="js/navigation.js"></script>
    <script src="js/integrated-auth-manager-v2.js"></script>
    
    <!-- Google Integration Scripts -->
    <script src="js/google-drive-api-v2.js"></script>
    <script src="js/google-sheets-api.js"></script>
    
    <!-- Data Management -->
    <script src="js/unified-sheets-manager.js"></script>
    <script src="js/unified-data-manager.js"></script>
    
    <!-- âœ… çµ±åˆåˆæœŸåŒ–ã‚·ã‚¹ãƒ†ãƒ  -->
    <script src="js/app-initializer.js"></script>
    
    <!-- Customer Management Functions -->
    <script>
        let currentFilter = 'all';
        let allCustomers = [];
        
        // ãƒšãƒ¼ã‚¸åˆæœŸåŒ–
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                // çµ±åˆåˆæœŸåŒ–ã‚·ã‚¹ãƒ†ãƒ ã‚’ä½¿ç”¨
                const result = await window.RentPipeApp.initialize('customer');
                
                if (result.success) {
                    console.log('âœ… é¡§å®¢ç®¡ç†ãƒšãƒ¼ã‚¸åˆæœŸåŒ–æˆåŠŸ');
                    
                    // èªè¨¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºã‚’æ›´æ–°
                    window.RentPipeApp.updateAuthStatusDisplay('auth-sync-status');
                    
                    // é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
                    displayCustomers();
                    updateStats();
                    
                } else {
                    console.error('âŒ é¡§å®¢ç®¡ç†ãƒšãƒ¼ã‚¸åˆæœŸåŒ–å¤±æ•—:', result.error);
                    
                    const statusDiv = document.getElementById('auth-sync-status');
                    if (statusDiv) {
                        statusDiv.className = 'auth-status error';
                        statusDiv.textContent = 'âŒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ' + result.error;
                    }
                }
                
            } catch (error) {
                console.error('âŒ é¡§å®¢ç®¡ç†ãƒšãƒ¼ã‚¸ã‚¨ãƒ©ãƒ¼:', error);
            }
        });
        
        // é¡§å®¢è¡¨ç¤º
        function displayCustomers() {
            allCustomers = window.UnifiedDataManager.getCustomers();
            console.log('ğŸ“Š é¡§å®¢ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º:', allCustomers.length, 'ä»¶');
            
            const container = document.getElementById('customer-list');
            container.innerHTML = '';
            
            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
            let filteredCustomers = allCustomers;
            if (currentFilter !== 'all') {
                filteredCustomers = allCustomers.filter(c => c.pipelineStatus === currentFilter);
            }
            
            if (filteredCustomers.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #9ca3af; padding: 40px;">é¡§å®¢ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            
            filteredCustomers.forEach(customer => {
                const card = createCustomerCard(customer);
                container.appendChild(card);
            });
        }
        
        // é¡§å®¢ã‚«ãƒ¼ãƒ‰ä½œæˆ
        function createCustomerCard(customer) {
            const card = document.createElement('div');
            card.className = 'customer-card';
            
            const statusColors = {
                'åˆå›ç›¸è«‡': '#fef3c7',
                'ç‰©ä»¶ç´¹ä»‹': '#dbeafe',
                'å†…è¦‹': '#e0e7ff',
                'ç”³è¾¼': '#fce7f3',
                'å¯©æŸ»': '#fed7aa',
                'å¥‘ç´„': '#d1fae5',
                'å®Œäº†': '#d1fae5'
            };
            
            card.innerHTML = `
                <div class="customer-header">
                    <div class="customer-name">${customer.name || 'åå‰æœªè¨­å®š'}</div>
                    <div class="customer-status" style="background: ${statusColors[customer.pipelineStatus] || '#f3f4f6'}">
                        ${customer.pipelineStatus || 'æœªè¨­å®š'}
                    </div>
                </div>
                <div class="customer-info">ğŸ“§ ${customer.email || 'ãƒ¡ãƒ¼ãƒ«ãªã—'}</div>
                <div class="customer-info">ğŸ“± ${customer.phone || 'é›»è©±ç•ªå·ãªã—'}</div>
                ${customer.preferences?.budgetMin ? `
                    <div class="customer-info">ğŸ’° ${customer.preferences.budgetMin.toLocaleString()}å†† ã€œ ${customer.preferences.budgetMax?.toLocaleString() || ''}å††</div>
                ` : ''}
                ${customer.preferences?.areas ? `
                    <div class="customer-info">ğŸ“ ${customer.preferences.areas.join(', ')}</div>
                ` : ''}
                <div class="customer-actions">
                    <button class="btn-edit" onclick="window.location.href='customer-form.html?edit=${customer.id}'">
                        ç·¨é›†
                    </button>
                    <button class="btn-delete" onclick="deleteCustomer('${customer.id}')">
                        å‰Šé™¤
                    </button>
                </div>
            `;
            
            return card;
        }
        
        // çµ±è¨ˆæ›´æ–°
        function updateStats() {
            const customers = window.UnifiedDataManager.getCustomers();
            
            document.getElementById('stat-total').textContent = customers.length;
            
            // ä»Šæœˆã®æ–°è¦
            const thisMonth = new Date().getMonth();
            const thisYear = new Date().getFullYear();
            const newThisMonth = customers.filter(c => {
                const created = new Date(c.createdAt);
                return created.getMonth() === thisMonth && created.getFullYear() === thisYear;
            }).length;
            document.getElementById('stat-new').textContent = newThisMonth;
            
            // æˆç´„æ¸ˆã¿
            const completed = customers.filter(c => c.pipelineStatus === 'å®Œäº†').length;
            document.getElementById('stat-completed').textContent = completed;
            
            // å¯¾å¿œä¸­
            const active = customers.filter(c => c.pipelineStatus !== 'å®Œäº†').length;
            document.getElementById('stat-active').textContent = active;
        }
        
        // æ¤œç´¢
        function searchCustomers() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            
            if (!searchTerm) {
                displayCustomers();
                return;
            }
            
            const filtered = allCustomers.filter(c => {
                return (c.name && c.name.toLowerCase().includes(searchTerm)) ||
                       (c.email && c.email.toLowerCase().includes(searchTerm)) ||
                       (c.phone && c.phone.includes(searchTerm));
            });
            
            const container = document.getElementById('customer-list');
            container.innerHTML = '';
            
            if (filtered.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #9ca3af; padding: 40px;">è©²å½“ã™ã‚‹é¡§å®¢ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            
            filtered.forEach(customer => {
                const card = createCustomerCard(customer);
                container.appendChild(card);
            });
        }
        
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        function filterByStatus(status) {
            currentFilter = status;
            
            // ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹æ›´æ–°
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            displayCustomers();
        }
        
        // é¡§å®¢å‰Šé™¤
        async function deleteCustomer(customerId) {
            if (!confirm('ã“ã®é¡§å®¢ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
                return;
            }
            
            try {
                await window.UnifiedDataManager.deleteCustomer(customerId);
                displayCustomers();
                updateStats();
                alert('âœ… é¡§å®¢ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
            } catch (error) {
                console.error('âŒ å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                alert('âŒ å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }
    </script>
</body>
</html>
