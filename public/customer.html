<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/svg+xml" href="img/logo-icon.svg">
    <title>é¡§å®¢ç®¡ç† - RentPipe</title>
    <link rel="stylesheet" href="css/main.css">
    <!-- Tailwind CSS (local build) -->
    <link rel="stylesheet" href="css/tailwind-output.css">

    <style>
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .page-description {
            color: #6b7280;
            margin-top: 8px;
        }

        .stats-section {
            margin-bottom: 30px;
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
        }

        .stat-card {
            background: white;
            padding: 18px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .stat-icon {
            font-size: 28px;
        }

        .stat-content h3 {
            margin: 0;
            font-size: 24px;
            color: #1f2937;
        }

        .stat-content p {
            margin: 4px 0 0 0;
            color: #6b7280;
            font-size: 13px;
        }

        .search-filter-container {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 24px;
        }

        .filter-row {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
        }

        .search-box input {
            width: 100%;
            padding: 10px 14px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
        }

        .search-box input:focus {
            outline: none;
            border-color: #5b7fa6;
        }

        .filter-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 14px;
            border: 2px solid #e5e7eb;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .filter-btn:hover {
            border-color: #5b7fa6;
        }

        .filter-btn.active {
            background: #5b7fa6;
            color: white;
            border-color: #5b7fa6;
        }

        .status-filters {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            padding-top: 16px;
            margin-top: 16px;
            border-top: 1px solid #e5e7eb;
        }

        .status-filters.hidden {
            display: none;
        }

        .status-filter-btn {
            padding: 6px 12px;
            border: 1px solid #e2e8f0;
            background: #f8fafc;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .status-filter-btn:hover {
            background: #f1f5f9;
        }

        .status-filter-btn.active {
            background: #3d4e6b;
            color: white;
            border-color: #3d4e6b;
        }

        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆå‡¦ç†ä¸­ï¼‰ */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-content {
            background: white;
            padding: 30px 40px;
            border-radius: 12px;
            text-align: center;
        }

        .loading-spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #5b7fa6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes skeleton-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        .skeleton-row td { padding: 10px 12px; }
        .skeleton-line {
            height: 18px;
            background: #e5e7eb;
            border-radius: 4px;
            width: 100%;
            animation: skeleton-pulse 1.5s ease-in-out infinite;
        }

        /* ãƒ†ãƒ¼ãƒ–ãƒ«ä»¶æ•°è¡¨ç¤º */
        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .customer-count {
            color: #64748b;
            font-size: 14px;
        }

        .customer-count strong {
            color: #1e293b;
        }
    </style>
</head>
<body>
    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆå‡¦ç†ä¸­ã®ã¿ä½¿ç”¨ï¼‰ -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <p id="loading-message">å‡¦ç†ä¸­...</p>
        </div>
    </div>

    <!-- é¡§å®¢å¾©å…ƒãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal-overlay" id="restore-modal">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                <h3 id="restore-modal-title" style="margin: 0;">é¡§å®¢ã‚’å¾©å…ƒ</h3>
                <button onclick="closeRestoreModal()" style="background: none; border: none; font-size: 20px; cursor: pointer; color: #9ca3af; line-height: 1; padding: 0 4px;">âœ•</button>
            </div>
            <p style="color: #6b7280; margin-bottom: 16px;">å¾©å…ƒå¾Œã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
            <div class="restore-status-select">
                <label style="font-weight: 500; margin-bottom: 8px; display: block;">å¾©å…ƒå…ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
                <!-- ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯PipelineConfigã‹ã‚‰å‹•çš„ç”Ÿæˆï¼ˆinitRestoreModal()ã§æŒ¿å…¥ï¼‰ -->
                <select id="restore-status" style="width: 100%; padding: 10px 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;"></select>
            </div>
            <div class="modal-actions" style="display: flex; gap: 12px; justify-content: center; margin-top: 20px;">
                <button class="btn-modal-cancel" onclick="closeRestoreModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn-modal-ok" onclick="executeRestore()" style="background: #10b981;">å¾©å…ƒã™ã‚‹</button>
            </div>
        </div>
    </div>

    <style>
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }
        .modal-overlay.active {
            display: flex;
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 16px;
            max-width: 420px;
            width: 90%;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }
        .modal-content h3 {
            margin: 0 0 8px 0;
            font-size: 20px;
            color: #1f2937;
        }
        .modal-content > p {
            margin: 0 0 20px 0;
            color: #6b7280;
            font-size: 14px;
        }
        .modal-actions {
            text-align: center;
        }
        .btn-modal-cancel {
            padding: 10px 24px;
            border: none;
            background: #f3f4f6;
            color: #4b5563;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-modal-cancel:hover {
            background: #e5e7eb;
        }
        .btn-modal-ok {
            padding: 10px 24px;
            border: none;
            background: #ef4444;
            color: white;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-modal-ok:hover {
            background: #dc2626;
        }
    </style>

    <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <div id="navigation"></div>

    <!-- ãŠçŸ¥ã‚‰ã›ãƒãƒŠãƒ¼ -->
    <div id="notification-banners" class="max-w-7xl mx-auto px-5 pt-4"></div>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <div class="max-w-7xl mx-auto px-5 py-6" id="main-content">

        <!-- ãƒšãƒ¼ã‚¸ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="flex items-center justify-between mb-6">
            <div>
                <h1 class="text-2xl font-bold text-gray-900">ğŸ‘¥ é¡§å®¢ç®¡ç†</h1>
                <p class="text-sm text-gray-500 mt-1">ã™ã¹ã¦ã®é¡§å®¢æƒ…å ±ã‚’ä¸€å…ƒç®¡ç†</p>
            </div>
            <a href="customer-form.html" class="inline-flex items-center gap-2 px-4 py-2 bg-slate-600 text-white font-semibold rounded-lg hover:bg-slate-700 transition-colors text-sm">
                ï¼‹ æ–°è¦é¡§å®¢ç™»éŒ²
            </a>
        </div>

        <!-- çµ±è¨ˆã‚«ãƒ¼ãƒ‰ -->
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6" id="stats-section">
            <div class="bg-white rounded-2xl p-5 shadow-sm border border-gray-100 flex items-center gap-4">
                <div class="text-3xl">ğŸ“‹</div>
                <div class="flex-1 min-w-0">
                    <div id="stat-active-skeleton" class="h-8 w-12 bg-gray-200 rounded-lg mb-1" style="animation:skeleton-pulse 1.5s ease-in-out infinite;"></div>
                    <div class="text-2xl font-bold text-gray-900 hidden" id="stat-active">0</div>
                    <div class="text-xs text-gray-500 mt-0.5">é€²è¡Œä¸­</div>
                </div>
            </div>
            <div class="bg-white rounded-2xl p-5 shadow-sm border border-gray-100 flex items-center gap-4">
                <div class="text-3xl">ğŸ‰</div>
                <div class="flex-1 min-w-0">
                    <div id="stat-closed-skeleton" class="h-8 w-12 bg-gray-200 rounded-lg mb-1" style="animation:skeleton-pulse 1.5s ease-in-out infinite 0.1s;"></div>
                    <div class="text-2xl font-bold text-gray-900 hidden" id="stat-closed">0</div>
                    <div class="text-xs text-gray-500 mt-0.5">æˆç´„æ¸ˆã¿</div>
                </div>
            </div>
            <div class="bg-white rounded-2xl p-5 shadow-sm border border-gray-100 flex items-center gap-4">
                <div class="text-3xl">âŒ</div>
                <div class="flex-1 min-w-0">
                    <div id="stat-lost-skeleton" class="h-8 w-12 bg-gray-200 rounded-lg mb-1" style="animation:skeleton-pulse 1.5s ease-in-out infinite 0.2s;"></div>
                    <div class="text-2xl font-bold text-gray-900 hidden" id="stat-lost">0</div>
                    <div class="text-xs text-gray-500 mt-0.5">å¤±æ³¨</div>
                </div>
            </div>
            <div class="bg-white rounded-2xl p-5 shadow-sm border border-gray-100 flex items-center gap-4">
                <div class="text-3xl">ğŸ†•</div>
                <div class="flex-1 min-w-0">
                    <div id="stat-new-skeleton" class="h-8 w-12 bg-gray-200 rounded-lg mb-1" style="animation:skeleton-pulse 1.5s ease-in-out infinite 0.3s;"></div>
                    <div class="text-2xl font-bold text-gray-900 hidden" id="stat-new">0</div>
                    <div class="text-xs text-gray-500 mt-0.5">ä»Šæœˆã®æ–°è¦</div>
                </div>
            </div>
        </div>

        <!-- æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-4 mb-4">
            <div class="flex flex-col sm:flex-row gap-3 mb-3">
                <input type="text" id="search-input"
                    placeholder="ğŸ” é¡§å®¢åã€ãƒ¡ãƒ¼ãƒ«ã€é›»è©±ç•ªå·ã§æ¤œç´¢..."
                    onkeyup="searchCustomers()"
                    class="flex-1 px-4 py-2.5 border border-gray-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-rentpipe-primary focus:border-transparent transition-all">
                <div class="flex gap-2 flex-wrap">
                    <button class="filter-btn active px-3 py-2 text-sm rounded-lg border transition-all" data-filter="active" onclick="filterByActiveStatus('active')">ğŸ“‹ é€²è¡Œä¸­</button>
                    <button class="filter-btn px-3 py-2 text-sm rounded-lg border border-gray-200 text-gray-600 transition-all hover:border-rentpipe-primary hover:text-rentpipe-primary" data-filter="closed" onclick="filterByActiveStatus('closed')">ğŸ‰ æˆç´„æ¸ˆã¿</button>
                    <button class="filter-btn px-3 py-2 text-sm rounded-lg border border-gray-200 text-gray-600 transition-all hover:border-rentpipe-primary hover:text-rentpipe-primary" data-filter="lost" onclick="filterByActiveStatus('lost')">âŒ å¤±æ³¨</button>
                    <button class="filter-btn px-3 py-2 text-sm rounded-lg border border-gray-200 text-gray-600 transition-all hover:border-rentpipe-primary hover:text-rentpipe-primary" data-filter="all" onclick="filterByActiveStatus('all')">ğŸ—‚ï¸ ã™ã¹ã¦</button>
                </div>
            </div>
            <!-- ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
            <div class="flex gap-2 flex-wrap" id="status-filters">
                <button class="status-filter-btn active px-3 py-1.5 text-xs rounded-lg border transition-all" data-status="all" onclick="filterByStatus('all')">ã™ã¹ã¦</button>
                <button class="status-filter-btn px-3 py-1.5 text-xs rounded-lg border border-gray-200 text-gray-600 transition-all hover:bg-gray-50" data-status="åˆå›ç›¸è«‡" onclick="filterByStatus('åˆå›ç›¸è«‡')">åˆå›ç›¸è«‡</button>
                <button class="status-filter-btn px-3 py-1.5 text-xs rounded-lg border border-gray-200 text-gray-600 transition-all hover:bg-gray-50" data-status="ç‰©ä»¶ç´¹ä»‹" onclick="filterByStatus('ç‰©ä»¶ç´¹ä»‹')">ç‰©ä»¶ç´¹ä»‹</button>
                <button class="status-filter-btn px-3 py-1.5 text-xs rounded-lg border border-gray-200 text-gray-600 transition-all hover:bg-gray-50" data-status="å†…è¦‹èª¿æ•´" onclick="filterByStatus('å†…è¦‹èª¿æ•´')">å†…è¦‹èª¿æ•´</button>
                <button class="status-filter-btn px-3 py-1.5 text-xs rounded-lg border border-gray-200 text-gray-600 transition-all hover:bg-gray-50" data-status="ç”³è¾¼æº–å‚™" onclick="filterByStatus('ç”³è¾¼æº–å‚™')">ç”³è¾¼æº–å‚™</button>
                <button class="status-filter-btn px-3 py-1.5 text-xs rounded-lg border border-gray-200 text-gray-600 transition-all hover:bg-gray-50" data-status="å¯©æŸ»ä¸­" onclick="filterByStatus('å¯©æŸ»ä¸­')">å¯©æŸ»ä¸­</button>
                <button class="status-filter-btn px-3 py-1.5 text-xs rounded-lg border border-gray-200 text-gray-600 transition-all hover:bg-gray-50" data-status="å¥‘ç´„æ‰‹ç¶šã" onclick="filterByStatus('å¥‘ç´„æ‰‹ç¶šã')">å¥‘ç´„æ‰‹ç¶šã</button>
            </div>
        </div>

        <!-- ä»¶æ•°è¡¨ç¤º -->
        <div class="text-sm text-gray-500 mb-3 px-1">
            è¡¨ç¤º: <strong class="text-gray-800" id="display-count">0</strong> ä»¶ / å…¨ <strong class="text-gray-800" id="total-count">0</strong> ä»¶
        </div>

        <!-- é¡§å®¢ãƒ†ãƒ¼ãƒ–ãƒ« -->
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="overflow-x-auto">
            <table class="customer-table w-full" id="customer-table">
                <thead>
                    <tr class="bg-gray-50 border-b border-gray-100">
                        <th class="text-left px-4 py-3 text-xs font-semibold text-gray-500 uppercase tracking-wider">é¡§å®¢å</th>
                        <th class="text-left px-4 py-3 text-xs font-semibold text-gray-500 uppercase tracking-wider">é€£çµ¡å…ˆ</th>
                        <th class="text-left px-4 py-3 text-xs font-semibold text-gray-500 uppercase tracking-wider">äºˆç®—</th>
                        <th class="text-left px-4 py-3 text-xs font-semibold text-gray-500 uppercase tracking-wider">å¸Œæœ›ã‚¨ãƒªã‚¢</th>
                        <th class="text-left px-4 py-3 text-xs font-semibold text-gray-500 uppercase tracking-wider">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                        <th class="text-left px-4 py-3 text-xs font-semibold text-gray-500 uppercase tracking-wider">ç™»éŒ²æ—¥</th>
                        <th class="text-left px-4 py-3 text-xs font-semibold text-gray-500 uppercase tracking-wider">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="customer-tbody">
                    <!-- ã‚¹ã‚±ãƒ«ãƒˆãƒ³ãƒ­ãƒ¼ãƒ€ãƒ¼ -->
                    <tr class="skeleton-row"><td colspan="7" class="px-4 py-3"><div class="skeleton-line"></div></td></tr>
                    <tr class="skeleton-row"><td colspan="7" class="px-4 py-3"><div class="skeleton-line"></div></td></tr>
                    <tr class="skeleton-row"><td colspan="7" class="px-4 py-3"><div class="skeleton-line" style="width:80%"></div></td></tr>
                </tbody>
            </table>
            </div><!-- /overflow-x-auto -->
            <div class="customer-table-empty" id="empty-state" style="display: none;">
                <div class="empty-icon">ğŸ“­</div>
                <div class="empty-text">è©²å½“ã™ã‚‹é¡§å®¢ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>
                <div class="empty-hint">ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’å¤‰æ›´ã™ã‚‹ã‹ã€æ–°è¦é¡§å®¢ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„</div>
            </div>
        </div>
    </div>

    <!-- Google API Client & Identity Services -->
    <script src="https://accounts.google.com/gsi/client"></script>
    <script src="https://apis.google.com/js/api.js"></script>

    <!-- RentPipe Core Scripts -->
    <script src="js/config.js"></script>
    <script src="js/session-manager.js"></script>
    <script src="js/notification-manager.js"></script>
    <script src="js/navigation.js"></script>
    <script src="js/integrated-auth-manager-v2.js"></script>
    <script src="js/google-drive-api-v2.js"></script>
    <script src="js/google-sheets-api.js"></script>
    <script src="js/data-migration.js"></script>
    <script src="js/unified-sheets-manager.js"></script>
    <script src="js/unified-data-manager.js"></script>
    <script src="js/archive-manager.js"></script>
    <script src="js/pipeline-config.js"></script>
    <script src="js/app-initializer.js"></script>
    <script src="js/page-initializer.js"></script>

    <!-- Customer Management -->
    <script>
        let currentStatusFilter = 'all';
        let currentActiveFilter = 'active';
        let allCustomers = [];

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è‰²ãƒãƒƒãƒ—ï¼ˆPipelineConfig ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚Œã°å‚ç…§ã€ãªã‘ã‚Œã°ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
        const statusColors = window.PipelineConfig?.STATUS_BADGE_COLORS || {
            'åˆå›ç›¸è«‡': { bg: '#fef3c7', color: '#92400e' },
            'ç‰©ä»¶ç´¹ä»‹': { bg: '#dbeafe', color: '#3d4e6b' },
            'å†…è¦‹èª¿æ•´': { bg: '#e0e7ff', color: '#4338ca' },
            'ç”³è¾¼æº–å‚™': { bg: '#fce7f3', color: '#9d174d' },
            'å¯©æŸ»ä¸­': { bg: '#fed7aa', color: '#c2410c' },
            'å¥‘ç´„æ‰‹ç¶šã': { bg: '#d1fae5', color: '#065f46' },
            'å®Œäº†': { bg: '#d1fae5', color: '#065f46' }
        };

        // çµ±è¨ˆè¡¨ç¤ºã®è¨­å®šã‚’èª­ã¿è¾¼ã‚€
        function loadStatsVisibility() {
            const settings = JSON.parse(localStorage.getItem('rentpipe_ui_settings') || '{}');
            const statsSection = document.getElementById('stats-section');
            if (statsSection && settings.showStats === false) {
                statsSection.classList.add('hidden');
            }
        }

        // ãƒšãƒ¼ã‚¸åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³è¡¨ç¤º
                loadNavigation();

                // ãŠçŸ¥ã‚‰ã›é€šçŸ¥ã‚’è¡¨ç¤º
                if (window.NotificationManager) {
                    window.NotificationManager.init();
                }

                // çµ±è¨ˆè¡¨ç¤ºè¨­å®šã‚’é©ç”¨
                loadStatsVisibility();

                // PageInitializerã§å…±é€šåˆæœŸåŒ–ï¼ˆèªè¨¼ãƒ»ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ï¼‰
                await PageInitializer.initialize({
                    onDataUpdated: () => {
                        console.log('ğŸ”” ãƒ‡ãƒ¼ã‚¿æ›´æ–°é€šçŸ¥å—ä¿¡ - å†è¡¨ç¤º');
                        displayCustomers();
                        updateStats();
                    }
                });

                // å¾©å…ƒãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é¸æŠè‚¢ã‚’å‹•çš„ç”Ÿæˆ
                initRestoreModal();

                // ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœã‚¿ãƒ³ã‚’ PipelineConfig ã‹ã‚‰å‹•çš„ç”Ÿæˆ
                const statusFilters = document.getElementById('status-filters');
                if (statusFilters && window.PipelineConfig?.STATUSES) {
                    const btnClass = 'status-filter-btn px-3 py-1.5 text-xs rounded-lg border border-gray-200 text-gray-600 transition-all hover:bg-gray-50';
                    const dynamicBtns = window.PipelineConfig.STATUSES.map(s =>
                        `<button class="${btnClass}" data-status="${s}" onclick="filterByStatus('${s}')">${s}</button>`
                    ).join('');
                    // ã€Œã™ã¹ã¦ã€ãƒœã‚¿ãƒ³ã‚’æ¸©å­˜ã—ã€å€‹åˆ¥ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒœã‚¿ãƒ³ã‚’å‹•çš„ç”Ÿæˆã§ç½®ãæ›ãˆã‚‹
                    const allBtn = statusFilters.querySelector('[data-status="all"]');
                    statusFilters.innerHTML = '';
                    if (allBtn) statusFilters.appendChild(allBtn);
                    statusFilters.insertAdjacentHTML('beforeend', dynamicBtns);
                }

                // åˆæœŸåŒ–å®Œäº†å¾Œã«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¡¨ç¤º
                showContent();
                displayCustomers();
                updateStats();

            } catch (error) {
                console.error('customer.html åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                showContent();
            }
        });

        // ã‚¹ã‚±ãƒ«ãƒˆãƒ³ã‚’é™¤å»ï¼ˆãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†æ™‚ï¼‰
        function showContent() {
            document.querySelectorAll('.skeleton-row').forEach(r => r.remove());
        }

        // æœ€å¤§5ç§’ã§ã‚¹ã‚±ãƒ«ãƒˆãƒ³ã‚’å¼·åˆ¶é™¤å»ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
        setTimeout(() => {
            showContent();
            // çµ±è¨ˆã‚¹ã‚±ãƒ«ãƒˆãƒ³ã‚‚å¼·åˆ¶é™¤å»ã—ã¦ã‚¼ãƒ­è¡¨ç¤ºã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
            ['stat-active', 'stat-closed', 'stat-lost', 'stat-new'].forEach(id => {
                const skeleton = document.getElementById(id + '-skeleton');
                if (skeleton) skeleton.remove();
                const el = document.getElementById(id);
                if (el) el.classList.remove('hidden');
            });
        }, 5000);

        // é¡§å®¢è¡¨ç¤ºï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«å½¢å¼ï¼‰
        function displayCustomers() {
            allCustomers = window.UnifiedDataManager ? window.UnifiedDataManager.getCustomers() : [];
            console.log('ğŸ“Š é¡§å®¢ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º:', allCustomers.length, 'ä»¶');

            const tbody = document.getElementById('customer-tbody');
            const emptyState = document.getElementById('empty-state');
            const table = document.getElementById('customer-table');
            tbody.innerHTML = '';

            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
            let filteredCustomers = [...allCustomers];

            if (currentActiveFilter === 'active') {
                filteredCustomers = filteredCustomers.filter(c => c.isActive !== false);
            } else if (currentActiveFilter === 'closed') {
                filteredCustomers = filteredCustomers.filter(c => c.isActive === false && c.archiveReason === 'æˆç´„');
            } else if (currentActiveFilter === 'lost') {
                filteredCustomers = filteredCustomers.filter(c => c.isActive === false && c.archiveReason !== 'æˆç´„');
            }

            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã¯é€²è¡Œä¸­ã®å ´åˆã®ã¿é©ç”¨
            if (currentActiveFilter === 'active' && currentStatusFilter !== 'all') {
                filteredCustomers = filteredCustomers.filter(c => c.pipelineStatus === currentStatusFilter);
            }

            // æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            if (searchTerm) {
                filteredCustomers = filteredCustomers.filter(c => {
                    const name = c.basicInfo?.name || c.name || '';
                    const email = c.basicInfo?.email || c.email || '';
                    const phone = c.basicInfo?.phone || c.phone || '';
                    return name.toLowerCase().includes(searchTerm) ||
                           email.toLowerCase().includes(searchTerm) ||
                           phone.includes(searchTerm);
                });
            }

            // ä»¶æ•°è¡¨ç¤ºã‚’æ›´æ–°
            document.getElementById('display-count').textContent = filteredCustomers.length;
            document.getElementById('total-count').textContent = allCustomers.length;

            if (filteredCustomers.length === 0) {
                table.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            table.style.display = 'table';
            emptyState.style.display = 'none';

            // æœ€æ–°é †ã«ã‚½ãƒ¼ãƒˆ
            filteredCustomers.sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0));

            filteredCustomers.forEach(customer => {
                const row = createCustomerRow(customer);
                tbody.appendChild(row);
            });
        }

        // é¡§å®¢è¡Œã‚’ä½œæˆ
        function createCustomerRow(customer) {
            const row = document.createElement('tr');
            const isInactive = customer.isActive === false;

            // åŸºæœ¬æƒ…å ±
            const name = customer.basicInfo?.name || customer.name || 'åå‰æœªè¨­å®š';
            const email = customer.basicInfo?.email || customer.email || '';
            const phone = customer.basicInfo?.phone || customer.phone || '';
            const budgetMin = customer.preferences?.budget?.min || 0;
            const budgetMax = customer.preferences?.budget?.max || 0;
            const areas = customer.preferences?.areas || '-';
            const status = customer.pipelineStatus || 'æœªè¨­å®š';
            const createdAt = customer.createdAt ? new Date(customer.createdAt).toLocaleDateString('ja-JP') : '-';

            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®è‰²
            const statusStyle = statusColors[status] || { bg: '#f3f4f6', color: '#6b7280' };

            // ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒãƒƒã‚¸
            let archiveBadge = '';
            if (isInactive) {
                if (customer.archiveReason === 'æˆç´„') {
                    archiveBadge = '<span class="archive-badge closed">ğŸ‰ æˆç´„</span>';
                } else if (customer.archiveReason === 'å¤±æ³¨') {
                    archiveBadge = '<span class="archive-badge lost">âŒ å¤±æ³¨</span>';
                } else {
                    archiveBadge = '<span class="archive-badge inactive">â¸ï¸</span>';
                }
            }

            // äºˆç®—è¡¨ç¤º
            const budgetText = budgetMin ?
                `${(budgetMin/10000).toFixed(1)}ä¸‡ã€œ${budgetMax ? (budgetMax/10000).toFixed(1) + 'ä¸‡' : ''}` :
                '-';

            // é€£çµ¡å…ˆ
            const contactInfo = [phone, email].filter(Boolean).join('<br>') || '-';

            row.innerHTML = `
                <td class="customer-name-cell">
                    <a href="customer-form.html?edit=${customer.id}">${name}</a>
                    ${archiveBadge}
                </td>
                <td style="font-size: 13px;">${contactInfo}</td>
                <td style="white-space: nowrap;">${budgetText}</td>
                <td style="max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${areas}">${areas}</td>
                <td>
                    <span class="status-badge" style="background: ${statusStyle.bg}; color: ${statusStyle.color};">
                        ${status}
                    </span>
                </td>
                <td style="white-space: nowrap; font-size: 13px;">${createdAt}</td>
                <td>
                    <div class="action-buttons">
                        <button class="btn-table-action btn-edit" onclick="window.location.href='customer-form.html?edit=${customer.id}'">
                            ç·¨é›†
                        </button>
                        ${isInactive
                            ? `<button class="btn-table-action btn-restore" onclick="activateCustomer('${customer.id}')">å¾©å…ƒ</button>`
                            : `<button class="btn-table-action btn-archive" onclick="deactivateCustomer('${customer.id}')">æ¡ˆå†…ä¸­æ­¢</button>`
                        }
                    </div>
                </td>
            `;

            if (isInactive) {
                row.style.opacity = '0.7';
            }

            return row;
        }

        // ã‚¹ã‚±ãƒ«ãƒˆãƒ³ã‚’éè¡¨ç¤ºã«ã—ã¦å®Ÿæ•°å€¤ã‚’è¡¨ç¤ºã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼
        function showStat(id, value) {
            const skeleton = document.getElementById(id + '-skeleton');
            const el = document.getElementById(id);
            if (skeleton) skeleton.remove();
            if (el) {
                el.textContent = value;
                el.classList.remove('hidden');
            }
        }

        // çµ±è¨ˆæ›´æ–°
        function updateStats() {
            const customers = window.UnifiedDataManager ? window.UnifiedDataManager.getCustomers() : [];

            const active = customers.filter(c => c.isActive !== false).length;
            const closed = customers.filter(c => c.isActive === false && c.archiveReason === 'æˆç´„').length;
            const lost = customers.filter(c => c.isActive === false && c.archiveReason !== 'æˆç´„').length;

            // ä»Šæœˆã®æ–°è¦
            const now = new Date();
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            const newThisMonth = customers.filter(c => {
                const created = new Date(c.createdAt);
                return created >= startOfMonth;
            }).length;

            showStat('stat-active', active);
            showStat('stat-closed', closed);
            showStat('stat-lost', lost);
            showStat('stat-new', newThisMonth);
        }

        // æ¤œç´¢ï¼ˆdebounceä»˜ã: 300mså¾…ã£ã¦ã‹ã‚‰å®Ÿè¡Œï¼‰
        let _searchDebounceTimer = null;
        function searchCustomers() {
            clearTimeout(_searchDebounceTimer);
            _searchDebounceTimer = setTimeout(() => displayCustomers(), 300);
        }

        // å¾©å…ƒãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é¸æŠè‚¢ã‚’ PipelineConfig ã‹ã‚‰å‹•çš„ç”Ÿæˆ
        function initRestoreModal() {
            const select = document.getElementById('restore-status');
            if (!select) return;
            const statuses = window.PipelineConfig?.STATUSES || ['åˆå›ç›¸è«‡', 'ç‰©ä»¶ç´¹ä»‹', 'å†…è¦‹èª¿æ•´', 'ç”³è¾¼æº–å‚™', 'å¯©æŸ»ä¸­', 'å¥‘ç´„æ‰‹ç¶šã'];
            select.innerHTML = statuses.map(s => `<option value="${s}">${s}</option>`).join('');
        }

        // è¡¨ç¤ºå¯¾è±¡ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        function filterByActiveStatus(filter) {
            currentActiveFilter = filter;

            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === filter);
            });

            // ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã¯é€²è¡Œä¸­ã®ã¿è¡¨ç¤º
            const statusFilters = document.getElementById('status-filters');
            if (statusFilters) {
                statusFilters.classList.toggle('hidden', filter !== 'active');
            }

            displayCustomers();
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        function filterByStatus(status) {
            currentStatusFilter = status;

            document.querySelectorAll('.status-filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.status === status);
            });

            displayCustomers();
        }

        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
        function showLoading(message = 'å‡¦ç†ä¸­...') {
            document.getElementById('loading-message').textContent = message;
            document.getElementById('loading-overlay').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loading-overlay').classList.remove('active');
        }

        // é¡§å®¢ã‚’éã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–ï¼ˆå¤±æ³¨ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ï¼‰- ArchiveManagerã‚’ä½¿ç”¨
        function deactivateCustomer(customerId) {
            window.ArchiveManager.openModal(customerId);
        }

        // å¾©å…ƒãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨ã®å¤‰æ•°
        let restoreTargetCustomerId = null;

        // é¡§å®¢ã‚’å†ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºï¼‰
        function activateCustomer(customerId) {
            const customer = window.UnifiedDataManager.getCustomerById(customerId);
            if (!customer) {
                alert('é¡§å®¢ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }

            restoreTargetCustomerId = customerId;
            const name = customer.basicInfo?.name || customer.name || 'é¡§å®¢';

            // å…ƒã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã«ã‚»ãƒƒãƒˆï¼ˆå®Œäº†ä»¥å¤–ï¼‰
            const originalStatus = customer.pipelineStatus;
            const restoreStatusSelect = document.getElementById('restore-status');
            if (originalStatus && originalStatus !== 'å®Œäº†') {
                restoreStatusSelect.value = originalStatus;
            } else {
                restoreStatusSelect.value = 'åˆå›ç›¸è«‡';
            }

            document.getElementById('restore-modal-title').textContent = `${name}ã•ã‚“ã‚’å¾©å…ƒ`;
            document.getElementById('restore-modal').classList.add('active');
        }

        // å¾©å…ƒãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeRestoreModal() {
            document.getElementById('restore-modal').classList.remove('active');
            restoreTargetCustomerId = null;
        }

        // å¾©å…ƒã‚’å®Ÿè¡Œ
        async function executeRestore() {
            if (!restoreTargetCustomerId) return;

            const newStatus = document.getElementById('restore-status').value;
            const customer = window.UnifiedDataManager.getCustomerById(restoreTargetCustomerId);
            const name = customer?.basicInfo?.name || customer?.name || 'é¡§å®¢';

            try {
                closeRestoreModal();
                showLoading('å¾©å…ƒä¸­...');

                // é¡§å®¢ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«æˆ»ã—ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’è¨­å®š
                customer.isActive = true;
                customer.pipelineStatus = newStatus;
                delete customer.archivedAt;
                delete customer.archiveReason;

                await window.UnifiedDataManager.updateCustomer(customer);
                displayCustomers();
                updateStats();
                hideLoading();
                PageInitializer.showNotification(`${name}ã•ã‚“ã‚’ã€Œ${newStatus}ã€ã«å¾©å…ƒã—ã¾ã—ãŸ`, 'success');
            } catch (error) {
                console.error('âŒ å¾©å…ƒã‚¨ãƒ©ãƒ¼:', error);
                hideLoading();
                PageInitializer.showNotification('å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
            }
        }
    </script>
</body>
</html>
