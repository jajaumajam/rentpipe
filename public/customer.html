<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¡§å®¢ç®¡ç† - RentPipe</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <header>
        <div class="header-content">
            <h1>ğŸ  RentPipe</h1>
            <nav class="nav-container">
                <a href="index.html">ãƒ›ãƒ¼ãƒ </a>
                <a href="customer.html" class="active">é¡§å®¢ç®¡ç†</a>
                <a href="customer-minimal.html">ç°¡æ˜“ç‰ˆ</a>
                <a href="pipeline.html">ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³</a>
                <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±è¡¨ç¤ºã‚¨ãƒªã‚¢ï¼ˆä¸€æ„IDï¼‰ -->
                <div id="unique-nav-user-info" class="nav-user-info"></div>
                <button onclick="handleLogout()" class="btn btn-outline nav-logout">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            </nav>
        </div>
    </header>

    <main class="main-content">
        <div class="page-header">
            <h2>ğŸ‘¥ é¡§å®¢ç®¡ç†</h2>
            <p>é¡§å®¢æƒ…å ±ã®ç®¡ç†ã¨å–¶æ¥­é€²æ—ã®è¿½è·¡</p>
        </div>

        <!-- Google Formsé€£æºçŠ¶æ³è¡¨ç¤º -->
        <div id="google-forms-status" style="margin: 1rem 0; padding: 1rem; border-radius: 8px; background: #f3f4f6;">
            <h3>ğŸ“ Google Formsé€£æºçŠ¶æ³</h3>
            <p id="forms-status-text">é€£æºçŠ¶æ³ã‚’ç¢ºèªä¸­...</p>
        </div>

        <!-- é¡§å®¢ãƒªã‚¹ãƒˆ -->
        <div id="customer-list" class="customer-grid">
            <!-- é¡§å®¢ã‚«ãƒ¼ãƒ‰ãŒã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã¾ã™ -->
        </div>
    </main>

    <!-- å¿…è¦æœ€å°é™ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ã¿ï¼ˆé‡è¤‡æ’é™¤ï¼‰ -->
    <script src="js/simple-reliable-auth.js"></script>
    <script src="js/local-first-sync.js"></script>
    <script src="js/customer-limit-checker.js"></script>
    <script src="js/customer-unified.js"></script>
    
    <!-- Google Identityï¼ˆå¿…è¦ãªå ´åˆã®ã¿ï¼‰ -->
    <script src="js/google-identity-config.js"></script>
    <script src="js/integrated-auth-manager-v2.js"></script>
    <script src="js/google-forms-api-v2.js"></script>
    <script src="js/complete-google-forms-solution.js"></script>
    
    <script>
        // ğŸ”§ customer.html å°‚ç”¨ã®çµ±åˆã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆé‡è¤‡æ’é™¤ç‰ˆï¼‰
        console.log('ğŸš€ Customer ç®¡ç†ç”»é¢åˆæœŸåŒ–é–‹å§‹');
        
        let isNavUpdated = false; // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³æ›´æ–°ã®é‡è¤‡é˜²æ­¢ãƒ•ãƒ©ã‚°
        
        // DOMèª­ã¿è¾¼ã¿å®Œäº†æ™‚ã®å‡¦ç†
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ“„ DOMèª­ã¿è¾¼ã¿å®Œäº†');
            
            // 1. èªè¨¼ãƒã‚§ãƒƒã‚¯
            performAuthCheck();
            
            // 2. ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³æ›´æ–°ï¼ˆ1å›ã®ã¿ï¼‰
            setTimeout(updateNavigationOnce, 500);
            
            // 3. Google Formsé€£æºçŠ¶æ³ç¢ºèª
            setTimeout(checkGoogleFormsStatus, 1000);
            
            // 4. é¡§å®¢ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
            setTimeout(loadCustomerDataSafely, 1500);
        });
        
        // èªè¨¼ãƒã‚§ãƒƒã‚¯
        function performAuthCheck() {
            console.log('ğŸ” èªè¨¼ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ');
            checkPageAccess();
        }
        
        // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³æ›´æ–°ï¼ˆ1å›ã®ã¿å®Ÿè¡Œï¼‰
        function updateNavigationOnce() {
            if (isNavUpdated) {
                console.log('âš ï¸ ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³æ›´æ–°ã‚¹ã‚­ãƒƒãƒ—ï¼ˆæ—¢ã«æ›´æ–°æ¸ˆã¿ï¼‰');
                return;
            }
            
            console.log('ğŸ¨ ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³æ›´æ–°é–‹å§‹');
            
            const user = getUser();
            if (!user) {
                console.log('âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãªã—');
                return;
            }
            
            const navUserInfo = document.getElementById('unique-nav-user-info');
            if (!navUserInfo) {
                console.log('âŒ ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            // æ—¢å­˜ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ã‚¯ãƒªã‚¢
            navUserInfo.innerHTML = '';
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å®‰å…¨ã«è¡¨ç¤ºï¼ˆæ–‡å­—åŒ–ã‘å¯¾ç­–ï¼‰
            try {
                const displayName = user.displayName || user.email.split('@')[0];
                const safeDisplayName = displayName.replace(/[^\w\s@.-]/g, ''); // å®‰å…¨ãªæ–‡å­—ã®ã¿
                
                navUserInfo.innerHTML = `
                    <div style="color: white; font-size: 14px; display: flex; align-items: center; gap: 8px;">
                        ${user.photoURL ? `<img src="${user.photoURL}" style="width: 24px; height: 24px; border-radius: 50%;" alt="User">` : 'ğŸ‘¤'}
                        <span>${safeDisplayName}</span>
                    </div>
                `;
                
                console.log('âœ… ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³æ›´æ–°å®Œäº†:', safeDisplayName);
                isNavUpdated = true;
                
            } catch (error) {
                console.error('âŒ ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                navUserInfo.innerHTML = '<div style="color: white; font-size: 14px;">ãƒ­ã‚°ã‚¤ãƒ³ä¸­</div>';
                isNavUpdated = true;
            }
        }
        
        // Google Formsé€£æºçŠ¶æ³ç¢ºèª
        function checkGoogleFormsStatus() {
            console.log('ğŸ“ Google Formsé€£æºçŠ¶æ³ç¢ºèª');
            
            const statusText = document.getElementById('forms-status-text');
            const statusContainer = document.getElementById('google-forms-status');
            
            try {
                // çµ±åˆèªè¨¼ãƒãƒãƒ¼ã‚¸ãƒ£ã®çŠ¶æ…‹ç¢ºèª
                if (window.IntegratedAuthManagerV2) {
                    const authState = window.IntegratedAuthManagerV2.getAuthState();
                    
                    if (authState.isAuthenticated && authState.googleAuth.isSignedIn) {
                        statusText.innerHTML = `
                            âœ… Googleèªè¨¼æ¸ˆã¿: ${authState.googleAuth.user.email}<br>
                            <small>é¡§å®¢ã‚«ãƒ¼ãƒ‰ã‹ã‚‰Google Formsæ©Ÿèƒ½ã‚’åˆ©ç”¨ã§ãã¾ã™</small>
                        `;
                        statusContainer.style.background = '#d1fae5';
                    } else {
                        statusText.innerHTML = `
                            âŒ Googleèªè¨¼ãŒå¿…è¦ã§ã™<br>
                            <button onclick="window.location.href='login-google-simple.html'" class="btn btn-primary" style="margin-top: 8px;">Googleèªè¨¼</button>
                        `;
                        statusContainer.style.background = '#fef3c7';
                    }
                } else {
                    statusText.innerHTML = 'âš ï¸ Google Formsæ©Ÿèƒ½ã‚’åˆæœŸåŒ–ä¸­...';
                    statusContainer.style.background = '#f3f4f6';
                }
                
            } catch (error) {
                console.error('âŒ Google FormsçŠ¶æ³ç¢ºèªã‚¨ãƒ©ãƒ¼:', error);
                statusText.innerHTML = 'âŒ Google Formsæ©Ÿèƒ½ã®ç¢ºèªã«å¤±æ•—ã—ã¾ã—ãŸ';
                statusContainer.style.background = '#fee2e2';
            }
        }
        
        // é¡§å®¢ãƒ‡ãƒ¼ã‚¿å®‰å…¨èª­ã¿è¾¼ã¿
        function loadCustomerDataSafely() {
            console.log('ğŸ“Š é¡§å®¢ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–‹å§‹');
            
            try {
                // customer-unified.jsãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
                if (typeof displayCustomers === 'function') {
                    console.log('âœ… customer-unified.jsä½¿ç”¨');
                    // æ—¢å­˜ã®é–¢æ•°ã‚’ä½¿ç”¨
                } else {
                    console.log('âš ï¸ customer-unified.jsæœªèª­ã¿è¾¼ã¿ - ç‹¬è‡ªå®Ÿè£…');
                    loadCustomersDirectly();
                }
                
            } catch (error) {
                console.error('âŒ é¡§å®¢ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                loadCustomersDirectly();
            }
        }
        
        // ç›´æ¥çš„ãªé¡§å®¢ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        function loadCustomersDirectly() {
            const possibleKeys = [
                'rentpipe_demo_customers',
                'rentpipe_customers',
                'customers',
                'rentpipe_unified_customers'
            ];
            
            let customers = [];
            
            for (const key of possibleKeys) {
                const data = localStorage.getItem(key);
                if (data) {
                    try {
                        const parsed = JSON.parse(data);
                        if (Array.isArray(parsed) && parsed.length > 0) {
                            customers = parsed;
                            break;
                        }
                    } catch (e) {
                        console.warn(`ãƒ‡ãƒ¼ã‚¿ãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼: ${key}`, e);
                    }
                }
            }
            
            const customerList = document.getElementById('customer-list');
            
            if (customers.length > 0) {
                console.log(`âœ… é¡§å®¢ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿æˆåŠŸ: ${customers.length}ä»¶`);
                displayCustomersSimple(customers);
            } else {
                console.log('âŒ é¡§å®¢ãƒ‡ãƒ¼ã‚¿ãªã— - ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼è¡¨ç¤º');
                customerList.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 2rem;">
                        <h3>ğŸ‘¥ é¡§å®¢ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</h3>
                        <p>æ–°ã—ã„é¡§å®¢ã‚’è¿½åŠ ã™ã‚‹ã‹ã€ä»–ã®ãƒšãƒ¼ã‚¸ã§é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèªã—ã¦ãã ã•ã„</p>
                        <button onclick="window.location.href='customer-minimal.html'" class="btn btn-outline">ç°¡æ˜“ç‰ˆã§ç¢ºèª</button>
                    </div>
                `;
            }
        }
        
        // ã‚·ãƒ³ãƒ—ãƒ«ãªé¡§å®¢è¡¨ç¤º
        function displayCustomersSimple(customers) {
            const container = document.getElementById('customer-list');
            container.innerHTML = '';
            
            customers.forEach((customer, index) => {
                const customerCard = document.createElement('div');
                customerCard.className = 'customer-card';
                customerCard.innerHTML = `
                    <div class="customer-header">
                        <h3>${customer.name || 'åå‰ãªã—'}</h3>
                        <span class="status-badge">${customer.pipelineStatus || customer.status || 'æœªè¨­å®š'}</span>
                    </div>
                    <div class="customer-info">
                        <p>ğŸ“ ${customer.phone || 'é›»è©±ç•ªå·ãªã—'}</p>
                        <p>ğŸ“§ ${customer.email || 'ãƒ¡ãƒ¼ãƒ«ãªã—'}</p>
                        <p>ğŸ’° äºˆç®—: ${customer.preferences?.budget || customer.budget || 'æœªè¨­å®š'}</p>
                    </div>
                    <div class="customer-actions">
                        <button onclick="showCustomerDetail('${customer.id}')" class="btn btn-outline">è©³ç´°</button>
                        ${window.IntegratedAuthManagerV2?.getAuthState().isAuthenticated ? 
                            '<button onclick="createGoogleForm(\'' + customer.id + '\')" class="btn btn-primary">ğŸ“ ãƒ•ã‚©ãƒ¼ãƒ ä½œæˆ</button>' : 
                            ''
                        }
                    </div>
                `;
                container.appendChild(customerCard);
            });
        }
        
        // é¡§å®¢è©³ç´°è¡¨ç¤º
        function showCustomerDetail(customerId) {
            if (customerId) {
                window.location.href = `customer-detail.html?id=${customerId}`;
            } else {
                alert('é¡§å®¢IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }
        }
        
        // Google Formä½œæˆ
        function createGoogleForm(customerId) {
            if (window.CustomerGoogleFormsIntegrationV2) {
                window.CustomerGoogleFormsIntegrationV2.createForm(customerId);
            } else {
                alert('Google Formsæ©Ÿèƒ½ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
            }
        }
        
        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
        function handleLogout() {
            if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                logout();
                window.location.href = 'login.html';
            }
        }

        console.log('âœ… Customer ç®¡ç†ç”»é¢ã‚¹ã‚¯ãƒªãƒ—ãƒˆæº–å‚™å®Œäº†ï¼ˆé‡è¤‡æ’é™¤ç‰ˆï¼‰');
    </script>
</body>
</html>
