<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>顧客管理 - RentPipe</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <header>
        <div class="header-content">
            <h1>🏠 RentPipe</h1>
            <nav class="nav-container">
                <a href="index.html">ホーム</a>
                <a href="customer.html" class="active">顧客管理</a>
                <a href="customer-minimal.html">簡易版</a>
                <a href="pipeline.html">パイプライン</a>
                <!-- ユーザー情報表示エリア（一意ID） -->
                <div id="unique-nav-user-info" class="nav-user-info"></div>
                <button onclick="handleLogout()" class="btn btn-outline nav-logout">ログアウト</button>
            </nav>
        </div>
    </header>

    <main class="main-content">
        <div class="page-header">
            <h2>👥 顧客管理</h2>
            <p>顧客情報の管理と営業進捗の追跡 - Google Drive同期対応</p>
        </div>

        <!-- Google Drive同期状況表示 -->
        <div id="google-forms-status" style="margin: 1rem 0; padding: 1rem; border-radius: 8px; background: #f3f4f6;">
            <h3>☁️ Google Drive 同期</h3>
            <p>システム初期化中...</p>
        </div>

        <!-- 顧客操作ボタン -->
        <div class="page-actions" style="margin: 1rem 0;">
            <a href="customer-form.html" class="btn btn-primary">
                📝 新規顧客登録
            </a>
            <button onclick="refreshCustomers()" class="btn btn-outline">
                🔄 リスト更新
            </button>
            <a href="google-drive-integration-test.html" target="_blank" class="btn btn-outline">
                🔧 統合テスト
            </a>
        </div>

        <!-- 顧客リスト -->
        <div id="customer-list" class="customer-grid">
            <div style="text-align: center; padding: 40px; color: #6b7280;">
                <div style="font-size: 24px;">📋</div>
                <p>顧客データを読み込み中...</p>
            </div>
        </div>
    </main>

    <!-- 必要なスクリプトのみ読み込み -->
    <!-- 基本システム -->
    <script src="js/simple-reliable-auth.js"></script>
    <script src="js/local-first-sync.js"></script>
    <script src="js/customer-unified.js"></script>
    
    <!-- Google Drive統合（新規追加） -->
    <script src="js/google-drive-api-v2.js"></script>
    <script src="js/google-drive-data-manager.js"></script>
    <script src="js/customer-google-drive-integration.js"></script>
    
    <script>
        // 🚀 customer.html Google Drive統合版 初期化
        console.log('🚀 Customer管理画面（Google Drive統合版）初期化開始');
        
        let isSystemReady = false;
        
        // DOM読み込み完了時の処理
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('📄 DOM読み込み完了');
            
            try {
                // 1. 基本システム初期化待機
                await waitForBasicSystems();
                
                // 2. 顧客データ読み込み
                loadCustomerData();
                
                // 3. Google Drive統合初期化
                await initializeGoogleDriveIntegration();
                
                isSystemReady = true;
                console.log('✅ 全システム初期化完了');
                
            } catch (error) {
                console.error('❌ 初期化エラー:', error);
            }
        });
        
        // 基本システムの初期化待機
        function waitForBasicSystems() {
            return new Promise((resolve) => {
                const checkInterval = setInterval(() => {
                    if (window.customerManager || window.CustomerUnified) {
                        clearInterval(checkInterval);
                        console.log('✅ 基本システム準備完了');
                        resolve();
                    }
                }, 100);
                
                // 5秒でタイムアウト
                setTimeout(() => {
                    clearInterval(checkInterval);
                    console.log('⚠️ 基本システム初期化タイムアウト - 続行');
                    resolve();
                }, 5000);
            });
        }
        
        // 顧客データ読み込み
        function loadCustomerData() {
            try {
                if (window.customerManager && typeof window.customerManager.loadCustomers === 'function') {
                    console.log('🔄 顧客データ読み込み（統合システム）');
                    window.customerManager.loadCustomers();
                } else if (window.CustomerUnified && typeof window.CustomerUnified.loadCustomers === 'function') {
                    console.log('🔄 顧客データ読み込み（フォールバック）');
                    window.CustomerUnified.loadCustomers();
                } else {
                    console.log('🔄 顧客データ読み込み（基本）');
                    loadCustomersBasic();
                }
            } catch (error) {
                console.error('❌ 顧客データ読み込みエラー:', error);
                loadCustomersBasic();
            }
        }
        
        // 基本的な顧客データ読み込み（フォールバック）
        function loadCustomersBasic() {
            try {
                const customers = JSON.parse(localStorage.getItem('rentpipe_customers') || '[]');
                console.log(`📊 基本顧客データ読み込み: ${customers.length}件`);
                
                const customerList = document.getElementById('customer-list');
                if (customers.length === 0) {
                    customerList.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #6b7280;">
                            <div style="font-size: 48px; margin-bottom: 15px;">👥</div>
                            <h3>まだ顧客が登録されていません</h3>
                            <p>新しい顧客を登録してください。</p>
                            <a href="customer-form.html" class="btn btn-primary" style="margin-top: 15px;">
                                📝 新規顧客登録
                            </a>
                        </div>
                    `;
                } else {
                    customerList.innerHTML = customers.map(customer => `
                        <div class="customer-card" data-customer-id="${customer.id}">
                            <div class="customer-header">
                                <div class="customer-info">
                                    <h3>${customer.name || '名前未設定'}</h3>
                                    <div class="customer-meta">
                                        ${customer.email || 'メール未設定'} • ${customer.phone || '電話未設定'}
                                    </div>
                                    <div class="customer-status">
                                        ステータス: ${customer.pipelineStatus || customer.status || '未設定'}
                                    </div>
                                </div>
                                <div class="customer-actions">
                                    <a href="customer-detail.html?id=${customer.id}" class="btn btn-outline">詳細</a>
                                    <button onclick="editCustomer('${customer.id}')" class="btn btn-primary">編集</button>
                                    <button onclick="deleteCustomer('${customer.id}')" class="btn btn-danger">削除</button>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
                
            } catch (error) {
                console.error('❌ 基本顧客データ読み込みエラー:', error);
                document.getElementById('customer-list').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #dc2626;">
                        <h3>データ読み込みエラー</h3>
                        <p>顧客データの読み込みに失敗しました。</p>
                        <button onclick="location.reload()" class="btn btn-primary">
                            🔄 ページを再読み込み
                        </button>
                    </div>
                `;
            }
        }
        
        // Google Drive統合初期化
        async function initializeGoogleDriveIntegration() {
            try {
                console.log('☁️ Google Drive統合初期化開始...');
                
                if (window.CustomerGoogleDriveIntegration) {
                    const success = await window.CustomerGoogleDriveIntegration.initialize();
                    if (success) {
                        console.log('✅ Google Drive統合初期化成功');
                    } else {
                        console.log('⚠️ Google Drive統合初期化失敗（オフラインモード）');
                    }
                } else {
                    console.log('⚠️ Google Drive統合スクリプト未読み込み（オフラインモード）');
                }
                
            } catch (error) {
                console.error('❌ Google Drive統合初期化エラー:', error);
            }
        }
        
        // グローバル関数（HTMLから呼び出される）
        function editCustomer(customerId) {
            window.location.href = `customer-form.html?edit=${customerId}`;
        }
        
        function deleteCustomer(customerId) {
            if (!confirm('この顧客を削除しますか？この操作は取り消しできません。')) {
                return;
            }
            
            try {
                const customers = JSON.parse(localStorage.getItem('rentpipe_customers') || '[]');
                const updatedCustomers = customers.filter(c => c.id !== customerId);
                localStorage.setItem('rentpipe_customers', JSON.stringify(updatedCustomers));
                
                console.log(`🗑️ 顧客削除: ${customerId}`);
                loadCustomerData(); // リスト更新
                
            } catch (error) {
                console.error('❌ 顧客削除エラー:', error);
                alert('顧客削除中にエラーが発生しました');
            }
        }
        
        function refreshCustomers() {
            console.log('🔄 顧客リスト更新');
            loadCustomerData();
        }
        
        function handleLogout() {
            if (confirm('ログアウトしますか？')) {
                console.log('👋 ログアウト');
                // 必要に応じてログアウト処理
                window.location.href = 'login.html';
            }
        }
        
    </script>
</body>
</html>
