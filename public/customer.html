<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¡§å®¢ç®¡ç†ï¼ˆèªè¨¼ãƒã‚§ãƒƒã‚¯ç„¡åŠ¹ï¼‰ - RentPipe</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <header>
        <div class="header-content">
            <h1>ğŸ  RentPipe</h1>
            <nav class="nav-container">
                <a href="index.html">ãƒ›ãƒ¼ãƒ </a>
                <a href="customer-bypass-auth.html" class="active">é¡§å®¢ç®¡ç†ï¼ˆãƒ†ã‚¹ãƒˆç‰ˆï¼‰</a>
                <a href="customer-no-auth.html">èªè¨¼ãªã—ç‰ˆ</a>
                <a href="pipeline.html">ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³</a>
                <div class="nav-user-info">
                    <span id="current-user">ğŸ§ª ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰</span>
                </div>
            </nav>
        </div>
    </header>

    <main class="main-content">
        <div class="page-header">
            <h2>ğŸ‘¥ é¡§å®¢ç®¡ç†ï¼ˆèªè¨¼ãƒã‚§ãƒƒã‚¯ç„¡åŠ¹ç‰ˆï¼‰</h2>
            <p>Google Driveçµ±åˆæ©Ÿèƒ½ä»˜ã - èªè¨¼å•é¡Œã‚’å›é¿ã—ãŸãƒãƒ¼ã‚¸ãƒ§ãƒ³</p>
        </div>

        <!-- Google DriveåŒæœŸçŠ¶æ³è¡¨ç¤º -->
        <div id="google-drive-sync-panel" style="margin: 1rem 0; padding: 1rem; border-radius: 8px; background: #f3f4f6;">
            <h3>â˜ï¸ Google Drive åŒæœŸ</h3>
            <div id="sync-status" class="sync-status-disconnected">
                <span id="sync-status-text">æœªæ¥ç¶š - ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸã‚’é–‹å§‹ã—ã¦ãã ã•ã„</span>
                <div id="sync-controls">
                    <button id="btn-connect-drive" onclick="CustomerGoogleDriveIntegration.connectToDrive()" class="btn btn-primary">
                        ğŸ”— Google Driveæ¥ç¶š
                    </button>
                    <button id="btn-sync-now" onclick="CustomerGoogleDriveIntegration.syncNow()" disabled class="btn btn-success">
                        ğŸ”„ ä»Šã™ãåŒæœŸ
                    </button>
                    <button onclick="downloadBackup()" class="btn btn-outline">
                        ğŸ’¾ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—DL
                    </button>
                </div>
                <div id="sync-info" style="margin-top: 10px; font-size: 14px; color: #666;">
                    <span id="last-sync-time">æœªåŒæœŸ</span> â€¢ 
                    <span id="sync-mode">ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰</span>
                </div>
            </div>
            
            <!-- åŒæœŸè¨­å®š -->
            <div id="sync-settings" style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 6px; display: none;">
                <label style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" id="auto-sync-checkbox" onchange="CustomerGoogleDriveIntegration.toggleAutoSync(this.checked)" checked>
                    è‡ªå‹•åŒæœŸã‚’æœ‰åŠ¹ã«ã™ã‚‹ï¼ˆãƒ‡ãƒ¼ã‚¿å¤‰æ›´æ™‚ã«è‡ªå‹•ã§Google Driveã«ä¿å­˜ï¼‰
                </label>
            </div>
        </div>

        <!-- é¡§å®¢æ“ä½œãƒœã‚¿ãƒ³ -->
        <div class="page-actions" style="margin: 1rem 0;">
            <a href="customer-form.html" class="btn btn-primary">
                ğŸ“ æ–°è¦é¡§å®¢ç™»éŒ²
            </a>
            <button onclick="refreshCustomers()" class="btn btn-outline">
                ğŸ”„ ãƒªã‚¹ãƒˆæ›´æ–°
            </button>
            <button onclick="addTestCustomer()" class="btn btn-warning">
                â• ãƒ†ã‚¹ãƒˆé¡§å®¢è¿½åŠ 
            </button>
            <a href="login-direct.html" class="btn btn-outline">
                ğŸ” èªè¨¼ãƒ†ã‚¹ãƒˆ
            </a>
        </div>

        <!-- é¡§å®¢ãƒªã‚¹ãƒˆ -->
        <div id="customer-list" class="customer-grid">
            <div style="text-align: center; padding: 40px; color: #6b7280;">
                <div style="font-size: 24px;">ğŸ“‹</div>
                <p>é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
            </div>
        </div>
        
        <!-- ãƒ­ã‚°è¡¨ç¤º -->
        <div style="margin: 2rem 0; padding: 1rem; border-radius: 8px; background: #f8f9fa;">
            <h3>ğŸ“ å®Ÿè¡Œãƒ­ã‚°</h3>
            <pre id="log-output" style="max-height: 200px; overflow-y: auto; font-size: 12px;">ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ä¸­...</pre>
        </div>
    </main>

    <!-- å¿…è¦ãªã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ã¿èª­ã¿è¾¼ã¿ï¼ˆèªè¨¼ãƒã‚§ãƒƒã‚¯ç„¡åŠ¹ï¼‰ -->
    <script src="js/google-drive-api-v2.js"></script>
    <script src="js/google-drive-data-manager.js"></script>
    <script src="js/customer-google-drive-integration.js"></script>
    
    <script>
        // ğŸš€ èªè¨¼ãƒã‚§ãƒƒã‚¯ç„¡åŠ¹ç‰ˆã®é¡§å®¢ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 
        console.log('ğŸš€ èªè¨¼ãƒã‚§ãƒƒã‚¯ç„¡åŠ¹ç‰ˆ é¡§å®¢ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–');
        
        let logs = [];
        
        // ãƒ­ã‚°è¿½åŠ 
        function addLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            logs.push(logMessage);
            
            const logElement = document.getElementById('log-output');
            if (logElement) {
                logElement.textContent = logs.join('\n');
                logElement.scrollTop = logElement.scrollHeight;
            }
            
            console.log(logMessage);
        }
        
        // é¡§å®¢ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º
        function displayCustomers(customers) {
            const customerList = document.getElementById('customer-list');
            
            if (customers.length === 0) {
                customerList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6b7280;">
                        <div style="font-size: 48px; margin-bottom: 15px;">ğŸ‘¥</div>
                        <h3>é¡§å®¢ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</h3>
                        <p>æ–°ã—ã„é¡§å®¢ã‚’ç™»éŒ²ã™ã‚‹ã‹ã€ãƒ†ã‚¹ãƒˆé¡§å®¢ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</p>
                        <div style="margin-top: 20px;">
                            <a href="customer-form.html" class="btn btn-primary" style="margin-right: 10px;">ğŸ“ æ–°è¦é¡§å®¢ç™»éŒ²</a>
                            <button onclick="addTestCustomer()" class="btn btn-warning">â• ãƒ†ã‚¹ãƒˆé¡§å®¢è¿½åŠ </button>
                        </div>
                    </div>
                `;
                return;
            }
            
            customerList.innerHTML = customers.map(customer => `
                <div class="customer-card" data-customer-id="${customer.id}">
                    <div class="customer-header">
                        <div class="customer-info">
                            <h3>${customer.name || 'åå‰æœªè¨­å®š'}</h3>
                            <div class="customer-meta">
                                ${customer.email || 'ãƒ¡ãƒ¼ãƒ«æœªè¨­å®š'} â€¢ ${customer.phone || 'é›»è©±æœªè¨­å®š'}
                            </div>
                            <div class="customer-status">
                                ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${customer.pipelineStatus || customer.status || 'æœªè¨­å®š'}
                            </div>
                            <div style="font-size: 12px; color: #6b7280; margin-top: 5px;">
                                ä½œæˆ: ${customer.createdAt ? new Date(customer.createdAt).toLocaleDateString() : 'ä¸æ˜'}
                            </div>
                        </div>
                        <div class="customer-actions">
                            <a href="customer-detail.html?id=${customer.id}" class="btn btn-outline">è©³ç´°</a>
                            <button onclick="editCustomer('${customer.id}')" class="btn btn-primary">ç·¨é›†</button>
                            <button onclick="deleteCustomer('${customer.id}')" class="btn btn-danger">å‰Šé™¤</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // é¡§å®¢ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        function loadCustomers() {
            try {
                addLog('ğŸ“Š é¡§å®¢ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...');
                const customers = JSON.parse(localStorage.getItem('rentpipe_customers') || '[]');
                displayCustomers(customers);
                addLog(`âœ… é¡§å®¢ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º: ${customers.length}ä»¶`);
                
            } catch (error) {
                addLog(`âŒ é¡§å®¢ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                console.error('é¡§å®¢ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        // ãƒ†ã‚¹ãƒˆé¡§å®¢è¿½åŠ 
        function addTestCustomer() {
            const testCustomer = {
                id: 'test_' + Date.now(),
                name: 'ãƒ†ã‚¹ãƒˆé¡§å®¢_' + Math.floor(Math.random() * 1000),
                email: `test${Math.floor(Math.random() * 1000)}@example.com`,
                phone: '090-' + Math.floor(Math.random() * 10000) + '-' + Math.floor(Math.random() * 10000),
                pipelineStatus: ['åˆå›ç›¸è«‡', 'ç‰©ä»¶ç´¹ä»‹', 'å†…è¦‹', 'ç”³è¾¼'][Math.floor(Math.random() * 4)],
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                notes: 'Google Driveçµ±åˆãƒ†ã‚¹ãƒˆç”¨ã®ãƒ‡ãƒ¼ã‚¿ã§ã™'
            };
            
            try {
                const customers = JSON.parse(localStorage.getItem('rentpipe_customers') || '[]');
                customers.push(testCustomer);
                localStorage.setItem('rentpipe_customers', JSON.stringify(customers));
                
                addLog(`â• ãƒ†ã‚¹ãƒˆé¡§å®¢è¿½åŠ : ${testCustomer.name}`);
                loadCustomers();
                
            } catch (error) {
                addLog(`âŒ ãƒ†ã‚¹ãƒˆé¡§å®¢è¿½åŠ ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }
        
        // é¡§å®¢å‰Šé™¤
        function deleteCustomer(customerId) {
            if (!confirm('ã“ã®é¡§å®¢ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            
            try {
                const customers = JSON.parse(localStorage.getItem('rentpipe_customers') || '[]');
                const updatedCustomers = customers.filter(c => c.id !== customerId);
                localStorage.setItem('rentpipe_customers', JSON.stringify(updatedCustomers));
                
                addLog(`ğŸ—‘ï¸ é¡§å®¢å‰Šé™¤: ${customerId}`);
                loadCustomers();
                
            } catch (error) {
                addLog(`âŒ é¡§å®¢å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }
        
        // é¡§å®¢ç·¨é›†ï¼ˆç°¡æ˜“ç‰ˆï¼‰
        function editCustomer(customerId) {
            const customers = JSON.parse(localStorage.getItem('rentpipe_customers') || '[]');
            const customer = customers.find(c => c.id === customerId);
            
            if (!customer) return;
            
            const newName = prompt('æ–°ã—ã„åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:', customer.name);
            if (!newName || newName === customer.name) return;
            
            try {
                customer.name = newName;
                customer.updatedAt = new Date().toISOString();
                localStorage.setItem('rentpipe_customers', JSON.stringify(customers));
                
                addLog(`âœï¸ é¡§å®¢ç·¨é›†: ${customer.name}`);
                loadCustomers();
                
            } catch (error) {
                addLog(`âŒ é¡§å®¢ç·¨é›†ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }
        
        // ãƒªã‚¹ãƒˆæ›´æ–°
        function refreshCustomers() {
            addLog('ğŸ”„ é¡§å®¢ãƒªã‚¹ãƒˆæ›´æ–°');
            loadCustomers();
        }
        
        // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        function downloadBackup() {
            try {
                const customers = JSON.parse(localStorage.getItem('rentpipe_customers') || '[]');
                if (customers.length === 0) {
                    alert('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                    return;
                }
                
                const csvContent = convertToCSV(customers);
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `rentpipe_backup_${new Date().toISOString().split('T')[0]}.csv`;
                link.click();
                
                addLog('ğŸ’¾ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†');
                
            } catch (error) {
                addLog(`âŒ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }
        
        // CSVå¤‰æ›
        function convertToCSV(customers) {
            const headers = ['ID', 'åå‰', 'ãƒ¡ãƒ¼ãƒ«', 'é›»è©±', 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹', 'ä½œæˆæ—¥', 'æ›´æ–°æ—¥'];
            const csvRows = [headers.join(',')];
            
            customers.forEach(customer => {
                const row = [
                    customer.id || '',
                    `"${(customer.name || '').replace(/"/g, '""')}"`,
                    customer.email || '',
                    customer.phone || '',
                    customer.pipelineStatus || customer.status || '',
                    customer.createdAt || '',
                    customer.updatedAt || ''
                ];
                csvRows.push(row.join(','));
            });
            
            return '\ufeff' + csvRows.join('\n'); // BOMä»˜ãUTF-8
        }
        
        // CSSè¿½åŠ 
        const style = document.createElement('style');
        style.textContent = `
            .customer-card { border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem; margin: 1rem 0; background: white; }
            .customer-header { display: flex; justify-content: space-between; align-items: center; }
            .customer-info h3 { margin: 0 0 0.5rem 0; }
            .customer-meta { color: #6b7280; font-size: 14px; margin-bottom: 0.5rem; }
            .customer-status { color: #059669; font-weight: 500; font-size: 14px; }
            .customer-actions button { margin-left: 0.5rem; }
            
            .sync-status-disconnected { padding: 15px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 6px; }
            .sync-status-connected { padding: 15px; background: #d1fae5; border: 1px solid #10b981; border-radius: 6px; }
            .sync-status-syncing { padding: 15px; background: #e0e7ff; border: 1px solid #8b5cf6; border-radius: 6px; }
            .sync-status-error { padding: 15px; background: #fee2e2; border: 1px solid #f87171; border-radius: 6px; }
            
            @media (max-width: 768px) {
                .customer-header { flex-direction: column; align-items: flex-start; }
                .customer-actions { margin-top: 1rem; width: 100%; }
                .customer-actions button { margin: 0.25rem; }
            }
        `;
        document.head.appendChild(style);
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†æ™‚
        document.addEventListener('DOMContentLoaded', async function() {
            addLog('ğŸ“„ èªè¨¼ãƒã‚§ãƒƒã‚¯ç„¡åŠ¹ç‰ˆ é¡§å®¢ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ èª­ã¿è¾¼ã¿å®Œäº†');
            
            // é¡§å®¢ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
            loadCustomers();
            
            // Google Driveçµ±åˆåˆæœŸåŒ–
            if (window.CustomerGoogleDriveIntegration) {
                try {
                    await window.CustomerGoogleDriveIntegration.initialize();
                    addLog('âœ… Google Driveçµ±åˆåˆæœŸåŒ–å®Œäº†');
                } catch (error) {
                    addLog(`âš ï¸ Google Driveçµ±åˆåˆæœŸåŒ–å¤±æ•—: ${error.message}`);
                }
            }
            
            addLog('ğŸ¯ åˆ©ç”¨å¯èƒ½æ©Ÿèƒ½: é¡§å®¢ç®¡ç†ã€Google DriveåŒæœŸã€ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—');
        });
        
    </script>
</body>
</html>
