<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebaseæ¥ç¶šãƒ†ã‚¹ãƒˆ - RentPipe Phase2ï¼ˆä¿®æ­£ç‰ˆï¼‰</title>
    <style>
        body { font-family: 'Noto Sans JP', sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        .test-result { padding: 15px; margin: 10px 0; border-radius: 8px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .info { background: #d1ecf1; border: 1px solid #b8daff; color: #0c5460; }
        .test-button { background: #1e3a8a; color: white; border: none; padding: 12px 24px; border-radius: 8px; margin: 5px; cursor: pointer; }
        .test-button:hover { background: #1e40af; }
        pre { background: #f8f9fa; padding: 15px; border-radius: 8px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>ğŸ”¥ RentPipe Phase2 - Firebaseæ¥ç¶šãƒ†ã‚¹ãƒˆï¼ˆä¿®æ­£ç‰ˆï¼‰</h1>
    
    <div id="status" class="test-result info">
        <strong>ğŸ”§ åˆæœŸåŒ–ä¸­...</strong><br>
        Firebaseè¨­å®šã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...
    </div>
    
    <div class="test-controls">
        <button class="test-button" onclick="testFirebaseConnection()">ğŸ”Œ Firebaseæ¥ç¶šãƒ†ã‚¹ãƒˆ</button>
        <button class="test-button" onclick="testFirestore()">ğŸ“Š Firestoreèª­ã¿æ›¸ããƒ†ã‚¹ãƒˆ</button>
        <button class="test-button" onclick="testAuthenticationBasic()">ğŸ” èªè¨¼ã‚·ã‚¹ãƒ†ãƒ åŸºæœ¬ãƒ†ã‚¹ãƒˆ</button>
        <button class="test-button" onclick="testDataManager()">ğŸ“‹ ãƒ‡ãƒ¼ã‚¿ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ãƒ†ã‚¹ãƒˆ</button>
        <button class="test-button" onclick="runAllTests()">ğŸš€ å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
    </div>
    
    <div id="test-results"></div>
    
    <div id="console-output">
        <h3>ğŸ“Ÿ ã‚³ãƒ³ã‚½ãƒ¼ãƒ«å‡ºåŠ›</h3>
        <pre id="console-log"></pre>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="js/firebase-config.js"></script>
    
    <script>
        // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«å‡ºåŠ›ã‚’HTMLã«è¡¨ç¤º
        const originalLog = console.log;
        const originalError = console.error;
        const consoleOutput = document.getElementById('console-log');
        
        function addToConsole(message, type = 'log') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            consoleOutput.textContent += logEntry;
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            addToConsole(args.join(' '), 'log');
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            addToConsole(args.join(' '), 'error');
        };
        
        // ãƒ†ã‚¹ãƒˆçµæœè¡¨ç¤º
        function showResult(title, success, message, details = null) {
            const resultsDiv = document.getElementById('test-results');
            const resultClass = success ? 'success' : 'error';
            const icon = success ? 'âœ…' : 'âŒ';
            
            const resultHtml = `
                <div class="test-result ${resultClass}">
                    <strong>${icon} ${title}</strong><br>
                    ${message}
                    ${details ? `<pre>${details}</pre>` : ''}
                </div>
            `;
            
            resultsDiv.innerHTML += resultHtml;
        }
        
        // Firebaseæ¥ç¶šãƒ†ã‚¹ãƒˆ
        async function testFirebaseConnection() {
            console.log('ğŸ”Œ Firebaseæ¥ç¶šãƒ†ã‚¹ãƒˆé–‹å§‹...');
            
            try {
                if (!window.firebase) {
                    throw new Error('Firebase SDKãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                }
                
                if (!window.db) {
                    throw new Error('FirestoreãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                }
                
                // åŸºæœ¬çš„ãªæ¥ç¶šãƒ†ã‚¹ãƒˆ
                await window.db.collection('system').doc('test').get();
                
                showResult(
                    'Firebaseæ¥ç¶šãƒ†ã‚¹ãƒˆ', 
                    true, 
                    'Firebase/Firestoreã¸ã®æ¥ç¶šãŒæˆåŠŸã—ã¾ã—ãŸ',
                    `Project ID: ${window.db.app.options.projectId}\nApp Name: ${window.db.app.name}`
                );
                
            } catch (error) {
                showResult(
                    'Firebaseæ¥ç¶šãƒ†ã‚¹ãƒˆ', 
                    false, 
                    'Firebaseæ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ',
                    error.message
                );
            }
        }
        
        // Firestoreèª­ã¿æ›¸ããƒ†ã‚¹ãƒˆ
        async function testFirestore() {
            console.log('ğŸ“Š Firestoreèª­ã¿æ›¸ããƒ†ã‚¹ãƒˆé–‹å§‹...');
            
            try {
                const testData = {
                    message: 'Phase2ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿',
                    timestamp: new Date().toISOString(),
                    testId: Math.random().toString(36).substr(2, 9),
                    version: 'Phase2-Test'
                };
                
                // æ›¸ãè¾¼ã¿ãƒ†ã‚¹ãƒˆ
                const docRef = await window.db.collection('system').doc('phase2-test').set(testData);
                console.log(`âœ… ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æ›¸ãè¾¼ã¿å®Œäº†`);
                
                // èª­ã¿è¾¼ã¿ãƒ†ã‚¹ãƒˆ
                const doc = await window.db.collection('system').doc('phase2-test').get();
                const readData = doc.data();
                
                if (!doc.exists) {
                    throw new Error('æ›¸ãè¾¼ã‚“ã ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿å–ã‚Œã¾ã›ã‚“ã§ã—ãŸ');
                }
                
                showResult(
                    'Firestoreèª­ã¿æ›¸ããƒ†ã‚¹ãƒˆ', 
                    true, 
                    'Firestoreã®èª­ã¿æ›¸ããŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™',
                    JSON.stringify(readData, null, 2)
                );
                
            } catch (error) {
                showResult(
                    'Firestoreèª­ã¿æ›¸ããƒ†ã‚¹ãƒˆ', 
                    false, 
                    'Firestoreæ“ä½œã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ',
                    error.message
                );
            }
        }
        
        // èªè¨¼ã‚·ã‚¹ãƒ†ãƒ åŸºæœ¬ãƒ†ã‚¹ãƒˆï¼ˆåŒ¿åèªè¨¼ãªã—ç‰ˆï¼‰
        async function testAuthenticationBasic() {
            console.log('ğŸ” èªè¨¼ã‚·ã‚¹ãƒ†ãƒ åŸºæœ¬ãƒ†ã‚¹ãƒˆé–‹å§‹...');
            
            try {
                if (!window.auth) {
                    throw new Error('Firebase AuthenticationãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                }
                
                // èªè¨¼çŠ¶æ…‹ç›£è¦–ãƒ†ã‚¹ãƒˆ
                const authStatePromise = new Promise((resolve, reject) => {
                    const timeout = setTimeout(() => {
                        reject(new Error('èªè¨¼çŠ¶æ…‹ç¢ºèªãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ'));
                    }, 5000);
                    
                    window.auth.onAuthStateChanged(function(user) {
                        clearTimeout(timeout);
                        resolve(user);
                    });
                });
                
                const user = await authStatePromise;
                
                showResult(
                    'èªè¨¼ã‚·ã‚¹ãƒ†ãƒ åŸºæœ¬ãƒ†ã‚¹ãƒˆ', 
                    true, 
                    'èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ãŒæ­£å¸¸ã«åˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã™',
                    `èªè¨¼çŠ¶æ…‹: ${user ? 'ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿' : 'æœªãƒ­ã‚°ã‚¤ãƒ³'}\n${user ? `User ID: ${user.uid}` : 'åŒ¿åèªè¨¼æœªå®Ÿè¡Œ'}`
                );
                
            } catch (error) {
                showResult(
                    'èªè¨¼ã‚·ã‚¹ãƒ†ãƒ åŸºæœ¬ãƒ†ã‚¹ãƒˆ', 
                    false, 
                    'èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ',
                    error.message
                );
            }
        }
        
        // ãƒ‡ãƒ¼ã‚¿ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ãƒ†ã‚¹ãƒˆ
        async function testDataManager() {
            console.log('ğŸ“‹ ãƒ‡ãƒ¼ã‚¿ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ãƒ†ã‚¹ãƒˆé–‹å§‹...');
            
            try {
                if (!window.FirebaseDataManager) {
                    throw new Error('FirebaseDataManagerãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                }
                
                // æ¥ç¶šãƒ†ã‚¹ãƒˆ
                const connectionResult = await window.FirebaseDataManager.testConnection();
                
                if (!connectionResult) {
                    throw new Error('FirebaseDataManageræ¥ç¶šãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸ');
                }
                
                // é¡§å®¢ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ†ã‚¹ãƒˆ
                const customers = await window.FirebaseDataManager.getCustomers();
                
                showResult(
                    'ãƒ‡ãƒ¼ã‚¿ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ãƒ†ã‚¹ãƒˆ', 
                    true, 
                    'FirebaseDataManagerãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™',
                    `é¡§å®¢ãƒ‡ãƒ¼ã‚¿ä»¶æ•°: ${customers.length}ä»¶\nãƒ†ãƒŠãƒ³ãƒˆID: ${window.FirebaseDataManager.getCurrentTenantId()}\nãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹: ${customers.length > 0 ? 'ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸' : 'Firestore'}`
                );
                
            } catch (error) {
                showResult(
                    'ãƒ‡ãƒ¼ã‚¿ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ãƒ†ã‚¹ãƒˆ', 
                    false, 
                    'ãƒ‡ãƒ¼ã‚¿ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ',
                    error.message
                );
            }
        }
        
        // å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        async function runAllTests() {
            document.getElementById('test-results').innerHTML = '';
            console.log('ğŸš€ å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œé–‹å§‹...');
            
            await testFirebaseConnection();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testFirestore();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testAuthenticationBasic();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testDataManager();
            
            console.log('ğŸ‰ å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå®Œäº†');
        }
        
        // åˆæœŸåŒ–å®Œäº†é€šçŸ¥
        window.addEventListener('load', function() {
            setTimeout(() => {
                document.getElementById('status').innerHTML = `
                    <strong>âœ… åˆæœŸåŒ–å®Œäº†</strong><br>
                    Firebase Phase2è¨­å®šãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸã€‚ã€ŒğŸš€ å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã€ãƒœã‚¿ãƒ³ã§ä¸€æ‹¬ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
                `;
                document.getElementById('status').className = 'test-result success';
            }, 2000);
        });
    </script>
</body>
</html>
