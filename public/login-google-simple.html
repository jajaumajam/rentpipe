<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Googleログイン - RentPipe</title>
    <link href="css/main.css" rel="stylesheet">
</head>

<body>
    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="nav-brand">🏠 RentPipe</a>
        </div>
    </nav>

    <main class="container">
        <div style="max-width: 400px; margin: 50px auto; text-align: center;">
            <div style="background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                <h1 style="color: #1e3a8a; margin-bottom: 20px;">🔑 Googleログイン</h1>
                <p style="color: #6b7280; margin-bottom: 30px;">
                    Google Forms機能を使用するために<br>
                    Googleアカウントでログインしてください
                </p>

                <!-- Googleサインインボタン -->
                <div id="google-signin-button" style="margin: 20px 0;"></div>

                <!-- 手動ログインボタン -->
                <button onclick="handleManualGoogleLogin()" 
                        style="background: #4285f4; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; width: 100%; font-size: 16px; margin-top: 10px;">
                    🔑 Googleアカウントでログイン
                </button>

                <!-- 戻るリンク -->
                <div style="margin-top: 20px;">
                    <a href="index.html" style="color: #6b7280; text-decoration: none;">← ホームに戻る</a>
                </div>

                <!-- 状態表示 -->
                <div id="login-status" style="margin-top: 20px; padding: 10px; border-radius: 6px; display: none;"></div>

                <!-- デバッグ情報 -->
                <details style="margin-top: 20px; text-align: left;">
                    <summary style="cursor: pointer; color: #6b7280;">デバッグ情報を表示</summary>
                    <div id="debug-info" style="background: #f9fafb; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 12px; margin-top: 10px;"></div>
                </details>
            </div>
        </div>
    </main>

    <!-- Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <script>
        // グローバル変数
        let googleInitialized = false;

        // デバッグログ
        function debugLog(message) {
            console.log(message);
            const debugDiv = document.getElementById('debug-info');
            debugDiv.innerHTML += new Date().toLocaleTimeString() + ': ' + message + '<br>';
        }

        // Base64URLデコード（JWTトークン用）
        function base64UrlDecode(str) {
            try {
                // Base64URL → Base64 変換
                str = str.replace(/-/g, '+').replace(/_/g, '/');
                
                // パディング調整
                const pad = str.length % 4;
                if (pad) {
                    if (pad === 1) {
                        throw new Error('InvalidLengthError: Input base64url string is the wrong length to determine padding');
                    }
                    str += new Array(5 - pad).join('=');
                }
                
                return atob(str);
            } catch (error) {
                debugLog('❌ Base64デコードエラー: ' + error.message);
                throw error;
            }
        }

        // JWTトークンをデコード
        function decodeJWT(token) {
            try {
                debugLog('🔍 JWTデコード開始: ' + token.substring(0, 20) + '...');
                
                const parts = token.split('.');
                if (parts.length !== 3) {
                    throw new Error('無効なJWT形式');
                }

                // ヘッダー部分をデコード（デバッグ用）
                const header = JSON.parse(base64UrlDecode(parts[0]));
                debugLog('📋 JWTヘッダー: ' + JSON.stringify(header));

                // ペイロード部分をデコード
                const payload = JSON.parse(base64UrlDecode(parts[1]));
                debugLog('📋 JWTペイロード取得成功');

                return {
                    header: header,
                    payload: payload,
                    signature: parts[2]
                };
            } catch (error) {
                debugLog('❌ JWTデコードエラー: ' + error.message);
                throw error;
            }
        }

        // 既存システム用に認証データを保存
        function saveAuthForLegacySystems(userData) {
            debugLog('💾 既存システム用認証データ保存開始...');
            
            try {
                // 1. unified-auth.js用の認証データ
                localStorage.setItem('rentpipe_authenticated', 'true');
                localStorage.setItem('rentpipe_user', JSON.stringify({
                    uid: userData.id,
                    email: userData.email,
                    displayName: userData.name,
                    photoURL: userData.picture
                }));
                
                // 2. simple-reliable-auth.js用の認証データ
                localStorage.setItem('rentpipe_auth_simple', 'logged_in');
                localStorage.setItem('rentpipe_user_simple', JSON.stringify({
                    id: userData.id,
                    email: userData.email,
                    name: userData.name,
                    picture: userData.picture
                }));
                
                // 3. セッションストレージにも保存
                sessionStorage.setItem('rentpipe_authenticated', 'true');
                sessionStorage.setItem('rentpipe_user', JSON.stringify({
                    uid: userData.id,
                    email: userData.email,
                    displayName: userData.name,
                    photoURL: userData.picture
                }));
                
                // 4. 統合認証マネージャー用データ
                const authData = {
                    isAuthenticated: true,
                    user: {
                        id: userData.id,
                        email: userData.email,
                        displayName: userData.name,
                        photoURL: userData.picture
                    },
                    sessionId: 'session-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9),
                    loginTime: Date.now(),
                    authMethod: 'google'
                };
                localStorage.setItem('rentpipe_unified_auth', JSON.stringify(authData));
                
                debugLog('✅ 既存システム用認証データ保存完了');
                debugLog('📊 保存されたキー: rentpipe_authenticated, rentpipe_user, rentpipe_auth_simple, rentpipe_user_simple, rentpipe_unified_auth');
                
            } catch (error) {
                debugLog('❌ 既存システム用認証データ保存エラー: ' + error.message);
                throw error;
            }
        }

        // Google Identity Services初期化
        window.onload = function() {
            debugLog('🚀 Googleログインページ読み込み完了');
            
            // Google Identity Services初期化
            if (window.google && window.google.accounts) {
                initializeGoogleSignIn();
            } else {
                debugLog('⏳ Google Identity Services 読み込み待機中...');
                setTimeout(initializeGoogleSignIn, 1000);
            }
        };

        function initializeGoogleSignIn() {
            try {
                if (!window.google || !window.google.accounts) {
                    debugLog('⚠️ Google Identity Services が読み込まれていません');
                    showLoginStatus('error', 'Google認証システムが読み込まれていません');
                    return;
                }

                debugLog('🔧 Google Identity Services 設定開始...');

                // Google Identity Services 設定
                window.google.accounts.id.initialize({
                    client_id: '134830384107-bk1amp8ho2q0pdj2vu6faqf9d6giajjo.apps.googleusercontent.com',
                    callback: handleGoogleSignInCallback,
                    auto_select: false,
                    cancel_on_tap_outside: false
                });

                // サインインボタンを表示
                window.google.accounts.id.renderButton(
                    document.getElementById('google-signin-button'),
                    {
                        theme: 'outline',
                        size: 'large',
                        text: 'signin_with',
                        locale: 'ja'
                    }
                );

                googleInitialized = true;
                debugLog('✅ Google Identity Services 初期化完了');
                
            } catch (error) {
                debugLog('❌ Google Identity Services 初期化エラー: ' + error.message);
                showLoginStatus('error', 'Google認証システムの初期化に失敗しました');
            }
        }

        // Google認証コールバック
        function handleGoogleSignInCallback(response) {
            try {
                debugLog('🔑 Google認証レスポンス受信');
                debugLog('📊 レスポンス詳細: ' + JSON.stringify({
                    hasCredential: !!response.credential,
                    credentialLength: response.credential ? response.credential.length : 0
                }));

                if (!response.credential) {
                    throw new Error('認証情報が取得できませんでした');
                }

                // JWTトークンをデコード（修正版）
                const decodedToken = decodeJWT(response.credential);
                const tokenPayload = decodedToken.payload;
                
                debugLog('✅ ユーザー情報取得成功: ' + tokenPayload.email);

                // 認証成功の処理
                const userData = {
                    email: tokenPayload.email,
                    name: tokenPayload.name || tokenPayload.email,
                    picture: tokenPayload.picture,
                    id: tokenPayload.sub
                };

                debugLog('🔄 認証データ保存開始...');

                // Google認証用データ保存
                const authData = {
                    ...userData,
                    credential: response.credential,
                    loginTime: Date.now(),
                    expires: tokenPayload.exp * 1000 // JWT expiry to milliseconds
                };
                localStorage.setItem('google_auth_simple', JSON.stringify(authData));
                
                // 既存システム用認証データも保存
                saveAuthForLegacySystems(userData);
                
                debugLog('💾 全認証データ保存完了');

                showLoginStatus('success', `✅ ログイン成功: ${userData.name}`);

                // 2秒後に顧客管理画面に遷移
                setTimeout(() => {
                    debugLog('🔄 顧客管理画面に遷移中...');
                    window.location.href = 'customer.html';
                }, 2000);

            } catch (error) {
                debugLog('❌ Google認証処理エラー: ' + error.message);
                console.error('❌ 詳細エラー:', error);
                showLoginStatus('error', `❌ 認証エラー: ${error.message}`);
                
                // エラー詳細をデバッグ情報に追加
                if (response && response.credential) {
                    debugLog('🔍 問題のトークン（最初の50文字）: ' + response.credential.substring(0, 50));
                }
            }
        }

        // 手動ログインボタン処理
        function handleManualGoogleLogin() {
            if (!googleInitialized) {
                showLoginStatus('warning', 'Google認証システムの初期化中です。しばらくお待ちください。');
                setTimeout(handleManualGoogleLogin, 2000);
                return;
            }

            try {
                debugLog('🔑 手動ログインボタンクリック');
                // Google Identity Services でログインプロンプト表示
                window.google.accounts.id.prompt();
            } catch (error) {
                debugLog('❌ 手動ログインエラー: ' + error.message);
                showLoginStatus('error', '認証システムの初期化に失敗しました');
            }
        }

        // ログイン状態表示
        function showLoginStatus(type, message) {
            const statusDiv = document.getElementById('login-status');
            statusDiv.style.display = 'block';
            statusDiv.textContent = message;

            switch (type) {
                case 'success':
                    statusDiv.style.background = '#dcfce7';
                    statusDiv.style.color = '#166534';
                    statusDiv.style.border = '1px solid #4ade80';
                    break;
                case 'error':
                    statusDiv.style.background = '#fee2e2';
                    statusDiv.style.color = '#991b1b';
                    statusDiv.style.border = '1px solid #ef4444';
                    break;
                case 'warning':
                    statusDiv.style.background = '#fef3c7';
                    statusDiv.style.color = '#92400e';
                    statusDiv.style.border = '1px solid #fbbf24';
                    break;
                default:
                    statusDiv.style.background = '#dbeafe';
                    statusDiv.style.color = '#1e3a8a';
                    statusDiv.style.border = '1px solid #60a5fa';
                    break;
            }
        }

        // 既存の認証状態チェック
        function checkExistingAuth() {
            try {
                // 複数の認証キーをチェック
                const authKeys = [
                    'google_auth_simple',
                    'rentpipe_authenticated',
                    'rentpipe_auth_simple'
                ];
                
                let isAuthenticated = false;
                let userName = '';
                
                for (const key of authKeys) {
                    const authData = localStorage.getItem(key);
                    if (authData) {
                        debugLog(`🔍 既存認証データ発見: ${key}`);
                        
                        if (key === 'rentpipe_authenticated' && authData === 'true') {
                            isAuthenticated = true;
                            const userData = localStorage.getItem('rentpipe_user');
                            if (userData) {
                                const user = JSON.parse(userData);
                                userName = user.displayName || user.email;
                            }
                            break;
                        } else if (key === 'rentpipe_auth_simple' && authData === 'logged_in') {
                            isAuthenticated = true;
                            const userData = localStorage.getItem('rentpipe_user_simple');
                            if (userData) {
                                const user = JSON.parse(userData);
                                userName = user.name || user.email;
                            }
                            break;
                        } else if (key === 'google_auth_simple') {
                            try {
                                const parsed = JSON.parse(authData);
                                // トークンの有効性チェック
                                const now = Date.now();
                                if (parsed.expires && now < parsed.expires) {
                                    isAuthenticated = true;
                                    userName = parsed.name;
                                    break;
                                }
                            } catch (e) {
                                debugLog('❌ Google認証データ解析エラー: ' + e.message);
                            }
                        }
                    }
                }
                
                if (isAuthenticated) {
                    debugLog('✅ 有効な既存認証を発見 - 自動リダイレクト');
                    showLoginStatus('success', `既にログイン済み: ${userName}`);
                    setTimeout(() => {
                        window.location.href = 'customer.html';
                    }, 1000);
                } else {
                    debugLog('📝 既存認証なし - ログイン待機');
                }
                
            } catch (error) {
                debugLog('❌ 既存認証確認エラー: ' + error.message);
                // 破損したデータを削除
                ['google_auth_simple', 'rentpipe_authenticated', 'rentpipe_user', 'rentpipe_auth_simple', 'rentpipe_user_simple'].forEach(key => {
                    localStorage.removeItem(key);
                });
            }
        }

        // ページ読み込み時に既存認証をチェック
        setTimeout(() => {
            debugLog('🔍 既存認証状態確認開始');
            checkExistingAuth();
        }, 500);

        // デバッグ用グローバル関数
        window.clearAllAuth = function() {
            const keys = ['google_auth_simple', 'rentpipe_authenticated', 'rentpipe_user', 'rentpipe_auth_simple', 'rentpipe_user_simple', 'rentpipe_unified_auth'];
            keys.forEach(key => {
                localStorage.removeItem(key);
                sessionStorage.removeItem(key);
            });
            debugLog('🗑️ 全認証データクリア完了');
            location.reload();
        };

        window.showAllAuthData = function() {
            const keys = ['google_auth_simple', 'rentpipe_authenticated', 'rentpipe_user', 'rentpipe_auth_simple', 'rentpipe_user_simple', 'rentpipe_unified_auth'];
            keys.forEach(key => {
                const data = localStorage.getItem(key);
                console.log(`${key}:`, data ? JSON.parse(data) : null);
            });
        };
    </script>
</body>
</html>
