<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Googleãƒ­ã‚°ã‚¤ãƒ³ - RentPipe</title>
    <link href="css/main.css" rel="stylesheet">
</head>

<body>
    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="nav-brand">ğŸ  RentPipe</a>
        </div>
    </nav>

    <main class="container">
        <div style="max-width: 400px; margin: 50px auto; text-align: center;">
            <div style="background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                <h1 style="color: #1e3a8a; margin-bottom: 20px;">ğŸ”‘ Googleãƒ­ã‚°ã‚¤ãƒ³</h1>
                <p style="color: #6b7280; margin-bottom: 30px;">
                    Google Formsæ©Ÿèƒ½ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã«<br>
                    Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„
                </p>

                <!-- Googleã‚µã‚¤ãƒ³ã‚¤ãƒ³ãƒœã‚¿ãƒ³ -->
                <div id="google-signin-button" style="margin: 20px 0;"></div>

                <!-- æ‰‹å‹•ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ -->
                <button onclick="handleManualGoogleLogin()" 
                        style="background: #4285f4; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; width: 100%; font-size: 16px; margin-top: 10px;">
                    ğŸ”‘ Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³
                </button>

                <!-- ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–ãƒœã‚¿ãƒ³ -->
                <button onclick="initializeDemoData()" 
                        style="background: #16a34a; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; width: 100%; font-size: 16px; margin-top: 10px;">
                    ğŸ“Š ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–
                </button>

                <!-- æˆ»ã‚‹ãƒªãƒ³ã‚¯ -->
                <div style="margin-top: 20px;">
                    <a href="index.html" style="color: #6b7280; text-decoration: none;">â† ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</a>
                </div>

                <!-- çŠ¶æ…‹è¡¨ç¤º -->
                <div id="login-status" style="margin-top: 20px; padding: 10px; border-radius: 6px; display: none;"></div>

                <!-- ãƒ‡ãƒãƒƒã‚°æƒ…å ± -->
                <details style="margin-top: 20px; text-align: left;">
                    <summary style="cursor: pointer; color: #6b7280;">ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’è¡¨ç¤º</summary>
                    <div id="debug-info" style="background: #f9fafb; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 12px; margin-top: 10px;"></div>
                </details>
            </div>
        </div>
    </main>

    <!-- Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let googleInitialized = false;

        // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
        function debugLog(message) {
            console.log(message);
            const debugDiv = document.getElementById('debug-info');
            debugDiv.innerHTML += new Date().toLocaleTimeString() + ': ' + message + '<br>';
        }

        // Base64URLãƒ‡ã‚³ãƒ¼ãƒ‰ï¼ˆJWTãƒˆãƒ¼ã‚¯ãƒ³ç”¨ï¼‰
        function base64UrlDecode(str) {
            try {
                // Base64URL â†’ Base64 å¤‰æ›
                str = str.replace(/-/g, '+').replace(/_/g, '/');
                
                // ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°èª¿æ•´
                const pad = str.length % 4;
                if (pad) {
                    if (pad === 1) {
                        throw new Error('InvalidLengthError: Input base64url string is the wrong length to determine padding');
                    }
                    str += new Array(5 - pad).join('=');
                }
                
                return atob(str);
            } catch (error) {
                debugLog('âŒ Base64ãƒ‡ã‚³ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼: ' + error.message);
                throw error;
            }
        }

        // JWTãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰
        function decodeJWT(token) {
            try {
                debugLog('ğŸ” JWTãƒ‡ã‚³ãƒ¼ãƒ‰é–‹å§‹: ' + token.substring(0, 20) + '...');
                
                const parts = token.split('.');
                if (parts.length !== 3) {
                    throw new Error('ç„¡åŠ¹ãªJWTå½¢å¼');
                }

                // ãƒ˜ãƒƒãƒ€ãƒ¼éƒ¨åˆ†ã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
                const header = JSON.parse(base64UrlDecode(parts[0]));
                debugLog('ğŸ“‹ JWTãƒ˜ãƒƒãƒ€ãƒ¼: ' + JSON.stringify(header));

                // ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰éƒ¨åˆ†ã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰
                const payload = JSON.parse(base64UrlDecode(parts[1]));
                debugLog('ğŸ“‹ JWTãƒšã‚¤ãƒ­ãƒ¼ãƒ‰å–å¾—æˆåŠŸ');

                return {
                    header: header,
                    payload: payload,
                    signature: parts[2]
                };
            } catch (error) {
                debugLog('âŒ JWTãƒ‡ã‚³ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼: ' + error.message);
                throw error;
            }
        }

        // ãƒ‡ãƒ¢é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–
        function initializeDemoData() {
            debugLog('ğŸ“Š ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–é–‹å§‹...');
            
            const demoCustomers = [
                {
                    id: 'cust_' + Date.now() + '_1',
                    name: 'ç”°ä¸­å¤ªéƒ',
                    email: 'tanaka@example.com',
                    phone: '090-1234-5678',
                    age: 28,
                    occupation: 'ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢',
                    annualIncome: 5000000,
                    pipelineStatus: 'åˆå›ç›¸è«‡',
                    preferences: {
                        budgetMin: 8,
                        budgetMax: 12,
                        areas: ['æ¸‹è°·åŒº', 'æ–°å®¿åŒº'],
                        roomType: '1K',
                        requirements: ['é§…å¾’æ­©10åˆ†ä»¥å†…', 'ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆå®Œå‚™']
                    },
                    notes: 'å¹³æ—¥å¤œã®é€£çµ¡å¸Œæœ›',
                    urgency: 'æ™®é€š',
                    contactTime: 'å¹³æ—¥19:00-21:00',
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    source: 'ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆ'
                },
                {
                    id: 'cust_' + Date.now() + '_2',
                    name: 'ä½è—¤èŠ±å­',
                    email: 'sato@example.com',
                    phone: '090-8765-4321',
                    age: 25,
                    occupation: 'ä¼šç¤¾å“¡',
                    annualIncome: 4000000,
                    pipelineStatus: 'ç‰©ä»¶ç´¹ä»‹',
                    preferences: {
                        budgetMin: 6,
                        budgetMax: 9,
                        areas: ['ä¸–ç”°è°·åŒº'],
                        roomType: '1DK',
                        requirements: ['ãƒšãƒƒãƒˆå¯', 'å—å‘ã']
                    },
                    notes: 'çŒ«ã‚’é£¼ã£ã¦ã„ã¾ã™',
                    urgency: 'æ€¥ã',
                    contactTime: 'å¹³æ—¥12:00-13:00',
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    source: 'ç´¹ä»‹'
                },
                {
                    id: 'cust_' + Date.now() + '_3',
                    name: 'é«˜æ©‹ä¸€éƒ',
                    email: 'takahashi@example.com',
                    phone: '090-1111-2222',
                    age: 32,
                    occupation: 'ãƒ‡ã‚¶ã‚¤ãƒŠãƒ¼',
                    annualIncome: 4500000,
                    pipelineStatus: 'å†…è¦‹',
                    preferences: {
                        budgetMin: 10,
                        budgetMax: 15,
                        areas: ['æ¸¯åŒº', 'å“å·åŒº'],
                        roomType: '1LDK',
                        requirements: ['ãƒ‡ã‚¶ã‚¤ãƒŠãƒ¼ã‚º', 'ç¯‰æµ…']
                    },
                    notes: 'ã‚¯ãƒªã‚¨ã‚¤ãƒ†ã‚£ãƒ–ãªç©ºé–“å¸Œæœ›',
                    urgency: 'æ™®é€š',
                    contactTime: 'ã„ã¤ã§ã‚‚',
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    source: 'Instagram'
                }
            ];
            
            localStorage.setItem('rentpipe_demo_customers', JSON.stringify(demoCustomers));
            debugLog('âœ… ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–å®Œäº†: ' + demoCustomers.length + 'ä»¶');
            showLoginStatus('success', `âœ… ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–å®Œäº†: ${demoCustomers.length}ä»¶ã®é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆã—ã¾ã—ãŸ`);
        }

        // æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ ç”¨ã«èªè¨¼ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ï¼ˆå®Œå…¨ç‰ˆï¼‰
        function saveAuthForLegacySystems(userData) {
            debugLog('ğŸ’¾ æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ ç”¨èªè¨¼ãƒ‡ãƒ¼ã‚¿ä¿å­˜é–‹å§‹...');
            
            try {
                const now = Date.now();
                const sessionId = 'session-' + now + '-' + Math.random().toString(36).substr(2, 9);
                
                // 1. rentpipe_authenticated + rentpipe_userï¼ˆæœ€é‡è¦ï¼‰
                localStorage.setItem('rentpipe_authenticated', 'true');
                localStorage.setItem('rentpipe_user', JSON.stringify({
                    uid: userData.id,
                    email: userData.email,
                    displayName: userData.name,
                    photoURL: userData.picture
                }));
                
                // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ã‚‚ä¿å­˜
                sessionStorage.setItem('rentpipe_authenticated', 'true');
                sessionStorage.setItem('rentpipe_user', JSON.stringify({
                    uid: userData.id,
                    email: userData.email,
                    displayName: userData.name,
                    photoURL: userData.picture
                }));
                
                // 2. rentpipe_auth_simple + rentpipe_user_simple
                localStorage.setItem('rentpipe_auth_simple', 'logged_in');
                localStorage.setItem('rentpipe_user_simple', JSON.stringify({
                    id: userData.id,
                    email: userData.email,
                    name: userData.name,
                    picture: userData.picture
                }));
                
                // 3. rentpipe_unified_auth
                const unifiedAuthData = {
                    isAuthenticated: true,
                    user: {
                        id: userData.id,
                        email: userData.email,
                        displayName: userData.name,
                        photoURL: userData.picture
                    },
                    sessionId: sessionId,
                    loginTime: now,
                    authMethod: 'google'
                };
                localStorage.setItem('rentpipe_unified_auth', JSON.stringify(unifiedAuthData));
                localStorage.setItem('rentpipe_session', sessionId);
                
                debugLog('âœ… æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ ç”¨èªè¨¼ãƒ‡ãƒ¼ã‚¿ä¿å­˜å®Œäº†');
                debugLog('ğŸ“Š ä¿å­˜ã•ã‚ŒãŸã‚­ãƒ¼:');
                debugLog('  - rentpipe_authenticated: true');
                debugLog('  - rentpipe_user: ' + userData.email);
                debugLog('  - rentpipe_auth_simple: logged_in');
                debugLog('  - rentpipe_user_simple: ' + userData.name);
                debugLog('  - rentpipe_unified_auth: ' + userData.email);
                
                return true;
                
            } catch (error) {
                debugLog('âŒ æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ ç”¨èªè¨¼ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã‚¨ãƒ©ãƒ¼: ' + error.message);
                throw error;
            }
        }

        // Google Identity ServicesåˆæœŸåŒ–
        window.onload = function() {
            debugLog('ğŸš€ Googleãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†');
            
            // Google Identity ServicesåˆæœŸåŒ–
            if (window.google && window.google.accounts) {
                initializeGoogleSignIn();
            } else {
                debugLog('â³ Google Identity Services èª­ã¿è¾¼ã¿å¾…æ©Ÿä¸­...');
                setTimeout(initializeGoogleSignIn, 1000);
            }
        };

        function initializeGoogleSignIn() {
            try {
                if (!window.google || !window.google.accounts) {
                    debugLog('âš ï¸ Google Identity Services ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                    showLoginStatus('error', 'Googleèªè¨¼ã‚·ã‚¹ãƒ†ãƒ ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                    return;
                }

                debugLog('ğŸ”§ Google Identity Services è¨­å®šé–‹å§‹...');

                // Google Identity Services è¨­å®š
                window.google.accounts.id.initialize({
                    client_id: '134830384107-bk1amp8ho2q0pdj2vu6faqf9d6giajjo.apps.googleusercontent.com',
                    callback: handleGoogleSignInCallback,
                    auto_select: false,
                    cancel_on_tap_outside: false
                });

                // ã‚µã‚¤ãƒ³ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                window.google.accounts.id.renderButton(
                    document.getElementById('google-signin-button'),
                    {
                        theme: 'outline',
                        size: 'large',
                        text: 'signin_with',
                        locale: 'ja'
                    }
                );

                googleInitialized = true;
                debugLog('âœ… Google Identity Services åˆæœŸåŒ–å®Œäº†');
                
            } catch (error) {
                debugLog('âŒ Google Identity Services åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ' + error.message);
                showLoginStatus('error', 'Googleèªè¨¼ã‚·ã‚¹ãƒ†ãƒ ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // Googleèªè¨¼ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
        function handleGoogleSignInCallback(response) {
            try {
                debugLog('ğŸ”‘ Googleèªè¨¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹å—ä¿¡');
                debugLog('ğŸ“Š ãƒ¬ã‚¹ãƒãƒ³ã‚¹è©³ç´°: ' + JSON.stringify({
                    hasCredential: !!response.credential,
                    credentialLength: response.credential ? response.credential.length : 0
                }));

                if (!response.credential) {
                    throw new Error('èªè¨¼æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
                }

                // JWTãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰ï¼ˆä¿®æ­£ç‰ˆï¼‰
                const decodedToken = decodeJWT(response.credential);
                const tokenPayload = decodedToken.payload;
                
                debugLog('âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—æˆåŠŸ: ' + tokenPayload.email);

                // èªè¨¼æˆåŠŸã®å‡¦ç†
                const userData = {
                    email: tokenPayload.email,
                    name: tokenPayload.name || tokenPayload.email,
                    picture: tokenPayload.picture,
                    id: tokenPayload.sub
                };

                debugLog('ğŸ”„ èªè¨¼ãƒ‡ãƒ¼ã‚¿ä¿å­˜é–‹å§‹...');

                // Googleèªè¨¼ç”¨ãƒ‡ãƒ¼ã‚¿ä¿å­˜
                const authData = {
                    ...userData,
                    credential: response.credential,
                    loginTime: Date.now(),
                    expires: tokenPayload.exp * 1000 // JWT expiry to milliseconds
                };
                localStorage.setItem('google_auth_simple', JSON.stringify(authData));
                debugLog('ğŸ“± Googleèªè¨¼ãƒ‡ãƒ¼ã‚¿ä¿å­˜å®Œäº†');
                
                // æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ ç”¨èªè¨¼ãƒ‡ãƒ¼ã‚¿ã‚‚ä¿å­˜
                const saveResult = saveAuthForLegacySystems(userData);
                if (saveResult) {
                    debugLog('ğŸ“‹ ãƒ¬ã‚¬ã‚·ãƒ¼èªè¨¼ãƒ‡ãƒ¼ã‚¿ä¿å­˜å®Œäº†');
                } else {
                    throw new Error('ãƒ¬ã‚¬ã‚·ãƒ¼èªè¨¼ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã«å¤±æ•—');
                }
                
                // ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯è‡ªå‹•ä½œæˆ
                const existingCustomers = localStorage.getItem('rentpipe_demo_customers');
                if (!existingCustomers) {
                    debugLog('ğŸ“Š é¡§å®¢ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ãªã„ãŸã‚è‡ªå‹•ä½œæˆ');
                    initializeDemoData();
                }
                
                debugLog('ğŸ’¾ å…¨èªè¨¼ãƒ‡ãƒ¼ã‚¿ä¿å­˜å®Œäº†');

                showLoginStatus('success', `âœ… ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ: ${userData.name}`);

                // 2ç§’å¾Œã«é¡§å®¢ç®¡ç†ç”»é¢ã«é·ç§»
                setTimeout(() => {
                    debugLog('ğŸ”„ é¡§å®¢ç®¡ç†ç”»é¢ã«é·ç§»ä¸­...');
                    window.location.href = 'customer.html';
                }, 2000);

            } catch (error) {
                debugLog('âŒ Googleèªè¨¼å‡¦ç†ã‚¨ãƒ©ãƒ¼: ' + error.message);
                console.error('âŒ è©³ç´°ã‚¨ãƒ©ãƒ¼:', error);
                showLoginStatus('error', `âŒ èªè¨¼ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                
                // ã‚¨ãƒ©ãƒ¼è©³ç´°ã‚’ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã«è¿½åŠ 
                if (response && response.credential) {
                    debugLog('ğŸ” å•é¡Œã®ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆæœ€åˆã®50æ–‡å­—ï¼‰: ' + response.credential.substring(0, 50));
                }
            }
        }

        // æ‰‹å‹•ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³å‡¦ç†
        function handleManualGoogleLogin() {
            if (!googleInitialized) {
                showLoginStatus('warning', 'Googleèªè¨¼ã‚·ã‚¹ãƒ†ãƒ ã®åˆæœŸåŒ–ä¸­ã§ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚');
                setTimeout(handleManualGoogleLogin, 2000);
                return;
            }

            try {
                debugLog('ğŸ”‘ æ‰‹å‹•ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯');
                // Google Identity Services ã§ãƒ­ã‚°ã‚¤ãƒ³ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¡¨ç¤º
                window.google.accounts.id.prompt();
            } catch (error) {
                debugLog('âŒ æ‰‹å‹•ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼: ' + error.message);
                showLoginStatus('error', 'èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹è¡¨ç¤º
        function showLoginStatus(type, message) {
            const statusDiv = document.getElementById('login-status');
            statusDiv.style.display = 'block';
            statusDiv.textContent = message;

            switch (type) {
                case 'success':
                    statusDiv.style.background = '#dcfce7';
                    statusDiv.style.color = '#166534';
                    statusDiv.style.border = '1px solid #4ade80';
                    break;
                case 'error':
                    statusDiv.style.background = '#fee2e2';
                    statusDiv.style.color = '#991b1b';
                    statusDiv.style.border = '1px solid #ef4444';
                    break;
                case 'warning':
                    statusDiv.style.background = '#fef3c7';
                    statusDiv.style.color = '#92400e';
                    statusDiv.style.border = '1px solid #fbbf24';
                    break;
                default:
                    statusDiv.style.background = '#dbeafe';
                    statusDiv.style.color = '#1e3a8a';
                    statusDiv.style.border = '1px solid #60a5fa';
                    break;
            }
        }

        // æ—¢å­˜ã®èªè¨¼çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯
        function checkExistingAuth() {
            try {
                // è¤‡æ•°ã®èªè¨¼ã‚­ãƒ¼ã‚’ãƒã‚§ãƒƒã‚¯
                const authKeys = [
                    { key: 'google_auth_simple', type: 'json' },
                    { key: 'rentpipe_authenticated', type: 'string', pair: 'rentpipe_user' },
                    { key: 'rentpipe_auth_simple', type: 'string', pair: 'rentpipe_user_simple' }
                ];
                
                let isAuthenticated = false;
                let userName = '';
                
                for (const auth of authKeys) {
                    const authData = localStorage.getItem(auth.key);
                    if (authData) {
                        debugLog(`ğŸ” æ—¢å­˜èªè¨¼ãƒ‡ãƒ¼ã‚¿ç™ºè¦‹: ${auth.key}`);
                        
                        if (auth.type === 'string') {
                            if ((auth.key === 'rentpipe_authenticated' && authData === 'true') ||
                                (auth.key === 'rentpipe_auth_simple' && authData === 'logged_in')) {
                                
                                const userData = localStorage.getItem(auth.pair);
                                if (userData) {
                                    try {
                                        const user = JSON.parse(userData);
                                        isAuthenticated = true;
                                        userName = user.displayName || user.name || user.email;
                                        break;
                                    } catch (e) {
                                        debugLog('âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿è§£æã‚¨ãƒ©ãƒ¼: ' + e.message);
                                    }
                                }
                            }
                        } else if (auth.type === 'json') {
                            try {
                                const parsed = JSON.parse(authData);
                                const now = Date.now();
                                if (!parsed.expires || now < parsed.expires) {
                                    isAuthenticated = true;
                                    userName = parsed.name;
                                    break;
                                }
                            } catch (e) {
                                debugLog('âŒ JSONèªè¨¼ãƒ‡ãƒ¼ã‚¿è§£æã‚¨ãƒ©ãƒ¼: ' + e.message);
                            }
                        }
                    }
                }
                
                if (isAuthenticated) {
                    debugLog('âœ… æœ‰åŠ¹ãªæ—¢å­˜èªè¨¼ã‚’ç™ºè¦‹ - è‡ªå‹•ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ');
                    showLoginStatus('success', `æ—¢ã«ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿: ${userName}`);
                    setTimeout(() => {
                        window.location.href = 'customer.html';
                    }, 1000);
                } else {
                    debugLog('ğŸ“ æ—¢å­˜èªè¨¼ãªã— - ãƒ­ã‚°ã‚¤ãƒ³å¾…æ©Ÿ');
                }
                
            } catch (error) {
                debugLog('âŒ æ—¢å­˜èªè¨¼ç¢ºèªã‚¨ãƒ©ãƒ¼: ' + error.message);
                // ç ´æã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
                ['google_auth_simple', 'rentpipe_authenticated', 'rentpipe_user', 'rentpipe_auth_simple', 'rentpipe_user_simple'].forEach(key => {
                    localStorage.removeItem(key);
                });
            }
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«æ—¢å­˜èªè¨¼ã‚’ãƒã‚§ãƒƒã‚¯
        setTimeout(() => {
            debugLog('ğŸ” æ—¢å­˜èªè¨¼çŠ¶æ…‹ç¢ºèªé–‹å§‹');
            checkExistingAuth();
        }, 500);

        // ãƒ‡ãƒãƒƒã‚°ç”¨ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°
        window.clearAllAuth = function() {
            const keys = ['google_auth_simple', 'rentpipe_authenticated', 'rentpipe_user', 'rentpipe_auth_simple', 'rentpipe_user_simple', 'rentpipe_unified_auth', 'rentpipe_session'];
            keys.forEach(key => {
                localStorage.removeItem(key);
                sessionStorage.removeItem(key);
            });
            debugLog('ğŸ—‘ï¸ å…¨èªè¨¼ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢å®Œäº†');
            location.reload();
        };

        window.showAllAuthData = function() {
            const keys = ['google_auth_simple', 'rentpipe_authenticated', 'rentpipe_user', 'rentpipe_auth_simple', 'rentpipe_user_simple', 'rentpipe_unified_auth', 'rentpipe_demo_customers'];
            keys.forEach(key => {
                const data = localStorage.getItem(key);
                console.log(`${key}:`, data);
                if (data && key !== 'rentpipe_demo_customers') {
                    try {
                        console.log(`  parsed:`, JSON.parse(data));
                    } catch (e) {
                        // æ–‡å­—åˆ—ãƒ‡ãƒ¼ã‚¿ã®å ´åˆã¯ãã®ã¾ã¾
                    }
                }
            });
        };

        window.testAuthStatus = function() {
            debugLog('ğŸ§ª èªè¨¼çŠ¶æ…‹ãƒ†ã‚¹ãƒˆé–‹å§‹');
            checkExistingAuth();
        };
    </script>
</body>
</html>
