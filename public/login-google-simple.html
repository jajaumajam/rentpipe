<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Googleãƒ­ã‚°ã‚¤ãƒ³ - RentPipe</title>
    <link href="css/main.css" rel="stylesheet">
</head>

<body>
    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="nav-brand">ğŸ  RentPipe</a>
        </div>
    </nav>

    <main class="container">
        <div style="max-width: 400px; margin: 50px auto; text-align: center;">
            <div style="background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                <h1 style="color: #1e3a8a; margin-bottom: 20px;">ğŸ”‘ Googleãƒ­ã‚°ã‚¤ãƒ³</h1>
                <p style="color: #6b7280; margin-bottom: 30px;">
                    Google Formsæ©Ÿèƒ½ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã«<br>
                    Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„
                </p>

                <!-- Googleã‚µã‚¤ãƒ³ã‚¤ãƒ³ãƒœã‚¿ãƒ³ -->
                <div id="google-signin-button" style="margin: 20px 0;"></div>

                <!-- æ‰‹å‹•ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ -->
                <button onclick="handleManualGoogleLogin()" 
                        style="background: #4285f4; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; width: 100%; font-size: 16px; margin-top: 10px;">
                    ğŸ”‘ Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³
                </button>

                <!-- æˆ»ã‚‹ãƒªãƒ³ã‚¯ -->
                <div style="margin-top: 20px;">
                    <a href="customer.html" style="color: #6b7280; text-decoration: none;">â† é¡§å®¢ç®¡ç†ã«æˆ»ã‚‹</a>
                </div>

                <!-- çŠ¶æ…‹è¡¨ç¤º -->
                <div id="login-status" style="margin-top: 20px; padding: 10px; border-radius: 6px; display: none;"></div>
            </div>
        </div>
    </main>

    <!-- Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let googleInitialized = false;

        // Google Identity ServicesåˆæœŸåŒ–
        window.onload = function() {
            console.log('ğŸš€ Googleãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†');
            
            // Google Identity ServicesåˆæœŸåŒ–
            if (window.google && window.google.accounts) {
                initializeGoogleSignIn();
            } else {
                setTimeout(initializeGoogleSignIn, 1000);
            }
        };

        function initializeGoogleSignIn() {
            try {
                if (!window.google || !window.google.accounts) {
                    console.warn('âš ï¸ Google Identity Services ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                    return;
                }

                // Google Identity Services è¨­å®š
                window.google.accounts.id.initialize({
                    client_id: '134830384107-bk1amp8ho2q0pdj2vu6faqf9d6giajjo.apps.googleusercontent.com',
                    callback: handleGoogleSignInCallback,
                    auto_select: false,
                    cancel_on_tap_outside: false
                });

                // ã‚µã‚¤ãƒ³ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                window.google.accounts.id.renderButton(
                    document.getElementById('google-signin-button'),
                    {
                        theme: 'outline',
                        size: 'large',
                        text: 'signin_with',
                        locale: 'ja'
                    }
                );

                googleInitialized = true;
                console.log('âœ… Google Identity Services åˆæœŸåŒ–å®Œäº†');
                
            } catch (error) {
                console.error('âŒ Google Identity Services åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // Googleèªè¨¼ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
        function handleGoogleSignInCallback(response) {
            try {
                console.log('ğŸ”‘ Googleèªè¨¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹å—ä¿¡');
                
                if (!response.credential) {
                    throw new Error('èªè¨¼æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
                }

                // JWTãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰ï¼ˆç°¡æ˜“ç‰ˆï¼‰
                const tokenPayload = JSON.parse(atob(response.credential.split('.')[1]));
                console.log('ğŸ“‹ ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±:', tokenPayload);

                // èªè¨¼æˆåŠŸã®å‡¦ç†
                const userData = {
                    email: tokenPayload.email,
                    name: tokenPayload.name,
                    picture: tokenPayload.picture,
                    id: tokenPayload.sub
                };

                // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
                localStorage.setItem('google_auth_simple', JSON.stringify({
                    ...userData,
                    credential: response.credential,
                    loginTime: Date.now()
                }));

                showLoginStatus('success', `âœ… ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ: ${userData.name}`);

                // 2ç§’å¾Œã«é¡§å®¢ç®¡ç†ç”»é¢ã«é·ç§»
                setTimeout(() => {
                    window.location.href = 'customer.html';
                }, 2000);

            } catch (error) {
                console.error('âŒ Googleèªè¨¼å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
                showLoginStatus('error', `âŒ èªè¨¼ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }

        // æ‰‹å‹•ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³å‡¦ç†
        function handleManualGoogleLogin() {
            if (!googleInitialized) {
                alert('Googleèªè¨¼ã‚·ã‚¹ãƒ†ãƒ ã®åˆæœŸåŒ–ä¸­ã§ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚');
                return;
            }

            try {
                // Google Identity Services ã§ãƒ­ã‚°ã‚¤ãƒ³ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¡¨ç¤º
                window.google.accounts.id.prompt();
            } catch (error) {
                console.error('âŒ æ‰‹å‹•ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼:', error);
                showLoginStatus('error', 'èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹è¡¨ç¤º
        function showLoginStatus(type, message) {
            const statusDiv = document.getElementById('login-status');
            statusDiv.style.display = 'block';
            statusDiv.textContent = message;

            switch (type) {
                case 'success':
                    statusDiv.style.background = '#dcfce7';
                    statusDiv.style.color = '#166534';
                    statusDiv.style.border = '1px solid #4ade80';
                    break;
                case 'error':
                    statusDiv.style.background = '#fee2e2';
                    statusDiv.style.color = '#991b1b';
                    statusDiv.style.border = '1px solid #ef4444';
                    break;
                default:
                    statusDiv.style.background = '#dbeafe';
                    statusDiv.style.color = '#1e3a8a';
                    statusDiv.style.border = '1px solid #60a5fa';
                    break;
            }
        }

        // æ—¢å­˜ã®èªè¨¼çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯
        function checkExistingAuth() {
            const authData = localStorage.getItem('google_auth_simple');
            if (authData) {
                try {
                    const parsed = JSON.parse(authData);
                    const hoursSinceLogin = (Date.now() - parsed.loginTime) / (1000 * 60 * 60);
                    
                    if (hoursSinceLogin < 24) { // 24æ™‚é–“ä»¥å†…ãªã‚‰æœ‰åŠ¹
                        showLoginStatus('success', `æ—¢ã«ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿: ${parsed.name}`);
                        setTimeout(() => {
                            window.location.href = 'customer.html';
                        }, 1000);
                    }
                } catch (error) {
                    console.warn('âš ï¸ æ—¢å­˜èªè¨¼ãƒ‡ãƒ¼ã‚¿ã®ç¢ºèªã«å¤±æ•—:', error);
                }
            }
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«æ—¢å­˜èªè¨¼ã‚’ãƒã‚§ãƒƒã‚¯
        setTimeout(checkExistingAuth, 500);
    </script>
</body>
</html>
