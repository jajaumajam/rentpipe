<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¡§å®¢è©³ç´° - RentPipe</title>
    <link rel="stylesheet" href="css/main.css">
    <style>
        .customer-detail-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            margin-top: 20px;
        }
        
        .detail-header {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .customer-info h1 {
            color: #1e3a8a;
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        .customer-meta {
            color: #64748b;
            font-size: 14px;
            margin-bottom: 15px;
        }
        
        .status-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            color: white;
            margin-bottom: 15px;
        }
        
        .status-åˆå›ç›¸è«‡ { background: #6366f1; }
        .status-ç‰©ä»¶ç´¹ä»‹ { background: #8b5cf6; }
        .status-å†…è¦‹ { background: #06b6d4; }
        .status-ç”³è¾¼ { background: #10b981; }
        .status-å¯©æŸ» { background: #f59e0b; }
        .status-å¥‘ç´„ { background: #ef4444; }
        .status-å®Œäº† { background: #22c55e; }
        
        .detail-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .detail-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .detail-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .detail-card h3 {
            color: #1e3a8a;
            margin-bottom: 15px;
            font-size: 18px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 8px;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            padding: 8px 0;
            border-bottom: 1px solid #f8fafc;
        }
        
        .info-label {
            font-weight: 600;
            color: #374151;
            min-width: 120px;
        }
        
        .info-value {
            color: #6b7280;
            flex: 1;
            text-align: right;
        }
        
        .preferences-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        
        .preference-tag {
            background: #f1f5f9;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            color: #1e3a8a;
        }
        
        .notes-section {
            grid-column: 1 / -1;
        }
        
        .notes-content {
            background: #f8fafc;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #3b82f6;
            margin-top: 10px;
            line-height: 1.6;
            white-space: pre-wrap;
        }
        
        .status-change-section {
            background: #fef3c7;
            border: 1px solid #fbbf24;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }
        
        .status-select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            margin: 10px 0;
        }
        
        .history-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px 0;
            border-bottom: 1px solid #f1f5f9;
        }
        
        .history-date {
            font-size: 12px;
            color: #6b7280;
            min-width: 140px;
        }
        
        .history-action {
            flex: 1;
            color: #374151;
        }
        
        .error-state {
            background: #fee2e2;
            border: 1px solid #ef4444;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            color: #991b1b;
        }
        
        .loading-state {
            background: #f0f9ff;
            border: 1px solid #3b82f6;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            color: #1e40af;
        }
        
        .debug-info {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            font-family: monospace;
            font-size: 12px;
        }
        
        @media (max-width: 768px) {
            .detail-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .detail-grid {
                grid-template-columns: 1fr;
            }
            
            .detail-actions {
                justify-content: stretch;
            }
            
            .detail-actions .btn {
                flex: 1;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã¯ createNavigation() ã§è‡ªå‹•ç”Ÿæˆã•ã‚Œã‚‹ -->

    <main class="customer-detail-container">
        <!-- æˆ»ã‚‹ãƒœã‚¿ãƒ³ -->
        <div style="margin-bottom: 20px;">
            <button onclick="goBack()" class="btn btn-outline">
                â† æˆ»ã‚‹
            </button>
        </div>

        <!-- ãƒ‡ãƒãƒƒã‚°æƒ…å ± -->
        <div id="debugInfo" class="debug-info" style="display: none;">
            ãƒ‡ãƒãƒƒã‚°æƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã¾ã™
        </div>

        <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ -->
        <div id="loadingState" class="loading-state">
            <div style="font-size: 48px; margin-bottom: 15px;">â³</div>
            <h2>é¡§å®¢æƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­...</h2>
            <p>ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„</p>
        </div>

        <!-- ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹ -->
        <div id="errorState" class="error-state" style="display: none;">
            <div style="font-size: 48px; margin-bottom: 15px;">âŒ</div>
            <h2>é¡§å®¢æƒ…å ±ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</h2>
            <p id="errorMessage">ã‚¨ãƒ©ãƒ¼ã®è©³ç´°</p>
            <button onclick="showDebugInfo()" class="btn btn-warning" style="margin: 15px 10px 0 0;">
                ãƒ‡ãƒãƒƒã‚°æƒ…å ±è¡¨ç¤º
            </button>
            <button onclick="retryLoad()" class="btn btn-primary" style="margin: 15px 10px 0 0;">
                å†è©¦è¡Œ
            </button>
            <button onclick="goBack()" class="btn btn-outline" style="margin: 15px 0 0 10px;">
                æˆ»ã‚‹
            </button>
        </div>

        <!-- è©³ç´°ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <div id="detailContent" style="display: none;">
            <!-- é¡§å®¢è©³ç´°ãƒ˜ãƒƒãƒ€ãƒ¼ -->
            <div class="detail-header">
                <div class="customer-info">
                    <h1 id="customerName">é¡§å®¢å</h1>
                    <div class="customer-meta">
                        <span id="customerEmail">ãƒ¡ãƒ¼ãƒ«</span> â€¢ 
                        <span id="customerPhone">é›»è©±ç•ªå·</span>
                    </div>
                    <div id="statusBadge" class="status-badge">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</div>
                    <div class="customer-meta">
                        ç™»éŒ²æ—¥: <span id="createdAt">-</span> â€¢ 
                        æœ€çµ‚æ›´æ–°: <span id="updatedAt">-</span>
                    </div>
                </div>
                
                <div class="detail-actions">
                    <button onclick="editCustomer()" class="btn btn-primary">
                        âœï¸ ç·¨é›†
                    </button>
                    <button onclick="exportCustomer()" class="btn btn-outline">
                        ğŸ“¥ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                    </button>
                    <button onclick="deleteCustomer()" class="btn btn-danger">
                        ğŸ—‘ï¸ å‰Šé™¤
                    </button>
                </div>
            </div>

            <!-- è©³ç´°æƒ…å ±ã‚°ãƒªãƒƒãƒ‰ -->
            <div class="detail-grid">
                <!-- åŸºæœ¬æƒ…å ± -->
                <div class="detail-card">
                    <h3>ğŸ“‹ åŸºæœ¬æƒ…å ±</h3>
                    <div class="info-row">
                        <span class="info-label">å¹´é½¢</span>
                        <span class="info-value" id="customerAge">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">è·æ¥­</span>
                        <span class="info-value" id="customerOccupation">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">å¹´å</span>
                        <span class="info-value" id="customerIncome">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">ç·Šæ€¥åº¦</span>
                        <span class="info-value" id="customerUrgency">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">é€£çµ¡å¸Œæœ›æ™‚é–“</span>
                        <span class="info-value" id="customerContactTime">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">æµå…¥å…ƒ</span>
                        <span class="info-value" id="customerSource">-</span>
                    </div>
                </div>

                <!-- å¸Œæœ›æ¡ä»¶ -->
                <div class="detail-card">
                    <h3>ğŸ¡ å¸Œæœ›æ¡ä»¶</h3>
                    <div class="info-row">
                        <span class="info-label">äºˆç®—</span>
                        <span class="info-value" id="customerBudget">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">é–“å–ã‚Š</span>
                        <span class="info-value" id="customerRoomType">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">å¸Œæœ›ã‚¨ãƒªã‚¢</span>
                        <span class="info-value" id="customerAreas">-</span>
                    </div>
                    <div style="margin-top: 15px;">
                        <div class="info-label" style="margin-bottom: 8px;">ç‰¹åˆ¥ãªè¦æœ›</div>
                        <div id="customerRequirements" class="preferences-list">
                            <!-- å‹•çš„ã«ç”Ÿæˆ -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- ãƒ¡ãƒ¢ãƒ»å±¥æ­´ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="detail-grid">
                <!-- ãƒ¡ãƒ¢ -->
                <div class="detail-card notes-section">
                    <h3>ğŸ“ ãƒ¡ãƒ¢ãƒ»ç‰¹è¨˜äº‹é …</h3>
                    <div id="customerNotes" class="notes-content">
                        ãƒ¡ãƒ¢ã¯ã‚ã‚Šã¾ã›ã‚“
                    </div>
                </div>

                <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´å±¥æ­´ -->
                <div class="detail-card">
                    <h3>ğŸ“ˆ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´å±¥æ­´</h3>
                    <div id="statusHistory">
                        <!-- å‹•çš„ã«ç”Ÿæˆ -->
                    </div>
                </div>
            </div>

            <!-- â­ ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆå¾©æ´»ï¼ï¼‰-->
            <div class="detail-card">
                <h3>âš¡ ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h3>
                <div class="status-change-section">
                    <label for="newStatus"><strong>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å¤‰æ›´ã™ã‚‹:</strong></label>
                    <select id="newStatus" class="status-select">
                        <option value="">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’é¸æŠ</option>
                        <option value="åˆå›ç›¸è«‡">åˆå›ç›¸è«‡</option>
                        <option value="ç‰©ä»¶ç´¹ä»‹">ç‰©ä»¶ç´¹ä»‹</option>
                        <option value="å†…è¦‹">å†…è¦‹</option>
                        <option value="ç”³è¾¼">ç”³è¾¼</option>
                        <option value="å¯©æŸ»">å¯©æŸ»</option>
                        <option value="å¥‘ç´„">å¥‘ç´„</option>
                        <option value="å®Œäº†">å®Œäº†</option>
                    </select>
                    <button onclick="changeStatus()" class="btn btn-primary" style="width: 100%; margin-top: 10px;">
                        ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- æ—¢å­˜ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿ï¼ˆçµ±ä¸€ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ä½¿ç”¨ï¼‰ -->
    <script src="js/navigation.js"></script>
    <script src="js/debug-customer-detail.js"></script>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let currentCustomer = null;
        let customerId = null;
        let debugMode = false;

        // ãƒšãƒ¼ã‚¸åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // URLã«debugãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰
            const urlParams = new URLSearchParams(window.location.search);
            debugMode = urlParams.has('debug');
            
            // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ç”Ÿæˆå®Œäº†ã‚’å¾…ã¤
            setTimeout(() => {
                initializePage();
            }, 200);
        });

        // ãƒšãƒ¼ã‚¸åˆæœŸåŒ–å‡¦ç†
        function initializePage() {
            console.log('ğŸ” é¡§å®¢è©³ç´°ãƒšãƒ¼ã‚¸åˆæœŸåŒ–é–‹å§‹...');
            
            try {
                // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰é¡§å®¢IDã‚’å–å¾—
                const urlParams = new URLSearchParams(window.location.search);
                customerId = urlParams.get('id');
                
                log(`ç¾åœ¨ã®URL: ${window.location.href}`);
                log(`å–å¾—ã—ãŸé¡§å®¢ID: ${customerId}`);
                
                if (!customerId) {
                    throw new Error('é¡§å®¢IDãŒURLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§æŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
                }
                
                // é¡§å®¢è©³ç´°ã®èª­ã¿è¾¼ã¿
                loadCustomerDetail();
                
            } catch (error) {
                console.error('âŒ ãƒšãƒ¼ã‚¸åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                showError(`ãƒšãƒ¼ã‚¸åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }

        // ãƒ­ã‚°å‡ºåŠ›ï¼ˆãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œï¼‰
        function log(message) {
            console.log(message);
            if (debugMode) {
                const debugInfo = document.getElementById('debugInfo');
                debugInfo.style.display = 'block';
                debugInfo.innerHTML += message + '<br>';
            }
        }

        // é¡§å®¢è©³ç´°ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
        function loadCustomerDetail() {
            log(`ğŸ“‹ é¡§å®¢è©³ç´°èª­ã¿è¾¼ã¿é–‹å§‹: ID=${customerId}`);
            
            try {
                // è¤‡æ•°ã®å¯èƒ½ãªã‚­ãƒ¼ã‚’ãƒã‚§ãƒƒã‚¯
                const possibleKeys = [
                    'rentpipe_demo_customers',
                    'rentpipe_customers', 
                    'customers',
                    'demo_customers'
                ];
                
                let customersData = null;
                let usedKey = null;
                
                for (const key of possibleKeys) {
                    const data = localStorage.getItem(key);
                    if (data) {
                        try {
                            const parsed = JSON.parse(data);
                            if (Array.isArray(parsed) && parsed.length > 0) {
                                customersData = parsed;
                                usedKey = key;
                                log(`âœ… ãƒ‡ãƒ¼ã‚¿ç™ºè¦‹: ã‚­ãƒ¼=${key}, ä»¶æ•°=${parsed.length}`);
                                break;
                            }
                        } catch (e) {
                            log(`âŒ ã‚­ãƒ¼ ${key} ã®ãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼: ${e.message}`);
                        }
                    }
                }
                
                if (!customersData) {
                    // åˆ©ç”¨å¯èƒ½ãªã‚­ãƒ¼ã‚’ãƒ­ã‚°å‡ºåŠ›
                    const allKeys = [];
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key.includes('rentpipe') || key.includes('customer')) {
                            allKeys.push(key);
                        }
                    }
                    log(`åˆ©ç”¨å¯èƒ½ãªã‚­ãƒ¼: ${allKeys.join(', ')}`);
                    throw new Error('é¡§å®¢ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚data-debug.htmlã§ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚');
                }
                
                // é¡§å®¢ã‚’æ¤œç´¢
                currentCustomer = customersData.find(customer => {
                    const matches = customer.id === customerId;
                    log(`IDæ¯”è¼ƒ: "${customer.id}" === "${customerId}" â†’ ${matches}`);
                    return matches;
                });
                
                if (!currentCustomer) {
                    const availableIds = customersData.map(c => c.id);
                    log(`åˆ©ç”¨å¯èƒ½ãªé¡§å®¢ID: ${availableIds.join(', ')}`);
                    throw new Error(`ID: ${customerId} ã®é¡§å®¢ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`);
                }
                
                log('âœ… é¡§å®¢ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ');
                displayCustomerDetail();
                
            } catch (error) {
                console.error('âŒ é¡§å®¢ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                showError(`é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
            }
        }

        // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
        function showError(message) {
            log(`âŒ ã‚¨ãƒ©ãƒ¼è¡¨ç¤º: ${message}`);
            
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('detailContent').style.display = 'none';
            document.getElementById('errorState').style.display = 'block';
            document.getElementById('errorMessage').textContent = message;
        }

        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±è¡¨ç¤º
        function showDebugInfo() {
            document.getElementById('debugInfo').style.display = 'block';
            
            // ç¾åœ¨ã®ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å†…å®¹ã‚’è¡¨ç¤º
            const allData = {};
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.includes('rentpipe') || key.includes('customer')) {
                    try {
                        allData[key] = JSON.parse(localStorage.getItem(key));
                    } catch (e) {
                        allData[key] = localStorage.getItem(key);
                    }
                }
            }
            
            document.getElementById('debugInfo').innerHTML = `
                <strong>ãƒ‡ãƒãƒƒã‚°æƒ…å ±:</strong><br>
                URL: ${window.location.href}<br>
                é¡§å®¢ID: ${customerId}<br>
                ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒ‡ãƒ¼ã‚¿:<br>
                <pre style="font-size: 10px; max-height: 200px; overflow-y: auto;">${JSON.stringify(allData, null, 2)}</pre>
            `;
        }

        // å†è©¦è¡Œ
        function retryLoad() {
            log('ğŸ”„ å†è©¦è¡Œé–‹å§‹...');
            
            document.getElementById('errorState').style.display = 'none';
            document.getElementById('loadingState').style.display = 'block';
            
            setTimeout(() => {
                loadCustomerDetail();
            }, 500);
        }

        // é¡§å®¢è©³ç´°è¡¨ç¤ºï¼ˆå®Œå…¨ç‰ˆï¼‰
        function displayCustomerDetail() {
            log('ğŸ–¼ï¸ é¡§å®¢è©³ç´°è¡¨ç¤ºé–‹å§‹...');
            
            if (!currentCustomer) {
                showError('è¡¨ç¤ºã™ã‚‹é¡§å®¢ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            try {
                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã‚’éš ã™
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('detailContent').style.display = 'block';
                
                // åŸºæœ¬æƒ…å ±è¡¨ç¤º
                document.getElementById('customerName').textContent = currentCustomer.name || 'åå‰æœªè¨­å®š';
                document.getElementById('customerEmail').textContent = currentCustomer.email || 'æœªè¨­å®š';
                document.getElementById('customerPhone').textContent = currentCustomer.phone || 'æœªè¨­å®š';
                
                // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒƒã‚¸
                const status = currentCustomer.pipelineStatus || currentCustomer.status || 'æœªè¨­å®š';
                const statusBadge = document.getElementById('statusBadge');
                statusBadge.textContent = status;
                statusBadge.className = `status-badge status-${status}`;
                
                // æ—¥ä»˜è¡¨ç¤º
                const createdAt = currentCustomer.createdAt ? 
                    formatDate(currentCustomer.createdAt) : 'æœªè¨­å®š';
                const updatedAt = currentCustomer.updatedAt ? 
                    formatDate(currentCustomer.updatedAt) : 'æœªè¨­å®š';
                document.getElementById('createdAt').textContent = createdAt;
                document.getElementById('updatedAt').textContent = updatedAt;
                
                // è©³ç´°æƒ…å ±
                document.getElementById('customerAge').textContent = 
                    currentCustomer.age ? `${currentCustomer.age}æ­³` : 'æœªè¨­å®š';
                document.getElementById('customerOccupation').textContent = 
                    currentCustomer.occupation || 'æœªè¨­å®š';
                document.getElementById('customerIncome').textContent = 
                    currentCustomer.annualIncome ? `${currentCustomer.annualIncome.toLocaleString()}ä¸‡å††` : 'æœªè¨­å®š';
                document.getElementById('customerUrgency').textContent = 
                    currentCustomer.urgency || 'æœªè¨­å®š';
                document.getElementById('customerContactTime').textContent = 
                    currentCustomer.contactTime || 'æœªè¨­å®š';
                document.getElementById('customerSource').textContent = 
                    currentCustomer.source || 'æœªè¨­å®š';
                
                // å¸Œæœ›æ¡ä»¶
                const preferences = currentCustomer.preferences || {};
                const budgetText = preferences.budgetMin && preferences.budgetMax 
                    ? `${preferences.budgetMin}ã€œ${preferences.budgetMax}ä¸‡å††` 
                    : 'æœªè¨­å®š';
                document.getElementById('customerBudget').textContent = budgetText;
                document.getElementById('customerRoomType').textContent = preferences.roomType || 'æœªè¨­å®š';
                document.getElementById('customerAreas').textContent = 
                    preferences.areas ? preferences.areas.join(', ') : 'æœªè¨­å®š';
                
                // ç‰¹åˆ¥ãªè¦æœ›ã‚¿ã‚°
                const requirementsContainer = document.getElementById('customerRequirements');
                requirementsContainer.innerHTML = '';
                if (preferences.requirements && preferences.requirements.length > 0) {
                    preferences.requirements.forEach(req => {
                        const tag = document.createElement('span');
                        tag.className = 'preference-tag';
                        tag.textContent = req;
                        requirementsContainer.appendChild(tag);
                    });
                } else {
                    requirementsContainer.innerHTML = '<span style="color: #6b7280;">ç‰¹åˆ¥ãªè¦æœ›ã¯ã‚ã‚Šã¾ã›ã‚“</span>';
                }
                
                // ãƒ¡ãƒ¢è¡¨ç¤º
                document.getElementById('customerNotes').textContent = 
                    currentCustomer.notes || 'ãƒ¡ãƒ¢ã¯ã‚ã‚Šã¾ã›ã‚“';
                
                // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å±¥æ­´è¡¨ç¤º
                displayStatusHistory();
                
                log('âœ… é¡§å®¢è©³ç´°è¡¨ç¤ºå®Œäº†');
                
            } catch (error) {
                console.error('âŒ è¡¨ç¤ºå‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
                showError(`è¡¨ç¤ºå‡¦ç†ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´å±¥æ­´ã®è¡¨ç¤º
        function displayStatusHistory() {
            const historyContainer = document.getElementById('statusHistory');
            historyContainer.innerHTML = '';
            
            // å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã®ç”Ÿæˆ
            const history = [
                {
                    date: currentCustomer.createdAt || new Date(),
                    action: `é¡§å®¢ç™»éŒ² (${currentCustomer.source || 'ä¸æ˜'}ã‹ã‚‰)`
                }
            ];
            
            // ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚‚å±¥æ­´ã«è¿½åŠ 
            const currentStatus = currentCustomer.pipelineStatus || currentCustomer.status;
            if (currentStatus) {
                history.push({
                    date: currentCustomer.updatedAt || new Date(),
                    action: `ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${currentStatus}`
                });
            }
            
            // å±¥æ­´ã‚’æ–°ã—ã„é †ã«ã‚½ãƒ¼ãƒˆ
            history.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // å±¥æ­´è¡¨ç¤º
            history.forEach(item => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                
                const date = formatDate(item.date, true);
                historyItem.innerHTML = `
                    <div class="history-date">${date}</div>
                    <div class="history-action">${item.action}</div>
                `;
                
                historyContainer.appendChild(historyItem);
            });
        }

        // â­ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´å‡¦ç†ï¼ˆå¾©æ´»ï¼ï¼‰
        function changeStatus() {
            const newStatus = document.getElementById('newStatus').value;
            if (!newStatus) {
                alert('å¤‰æ›´ã™ã‚‹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            if (!confirm(`ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ã€Œ${newStatus}ã€ã«å¤‰æ›´ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) {
                return;
            }
            
            try {
                // é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°
                currentCustomer.pipelineStatus = newStatus;
                currentCustomer.status = newStatus;
                currentCustomer.updatedAt = new Date().toISOString();
                
                // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®æ›´æ–°
                const possibleKeys = ['rentpipe_demo_customers', 'rentpipe_customers', 'customers'];
                
                for (const key of possibleKeys) {
                    const data = localStorage.getItem(key);
                    if (data) {
                        const customers = JSON.parse(data);
                        const customerIndex = customers.findIndex(c => c.id === customerId);
                        
                        if (customerIndex !== -1) {
                            customers[customerIndex] = currentCustomer;
                            localStorage.setItem(key, JSON.stringify(customers));
                            log(`âœ… ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°å®Œäº†: ${key}`);
                            break;
                        }
                    }
                }
                
                // ç”»é¢ã®å†è¡¨ç¤º
                displayCustomerDetail();
                
                // ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ
                document.getElementById('newStatus').value = '';
                
                alert(`âœ… ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ã€Œ${newStatus}ã€ã«æ›´æ–°ã—ã¾ã—ãŸï¼`);
                
            } catch (error) {
                console.error('âŒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                alert('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatDate(dateString, includeTime = false) {
            try {
                const date = new Date(dateString);
                if (includeTime) {
                    return date.toLocaleString('ja-JP');
                } else {
                    return date.toLocaleDateString('ja-JP');
                }
            } catch (e) {
                return 'æ—¥ä»˜å½¢å¼ã‚¨ãƒ©ãƒ¼';
            }
        }

        // é¡§å®¢ç·¨é›†
        function editCustomer() {
            window.location.href = `customer-form.html?edit=${customerId}`;
        }

        // é¡§å®¢ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        function exportCustomer() {
            if (!currentCustomer) return;
            
            const customerData = JSON.stringify(currentCustomer, null, 2);
            const blob = new Blob([customerData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `é¡§å®¢_${currentCustomer.name}_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert(`${currentCustomer.name}ã•ã‚“ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ`);
        }

        // é¡§å®¢å‰Šé™¤
        function deleteCustomer() {
            if (!currentCustomer) return;
            
            const confirmMessage = `${currentCustomer.name}ã•ã‚“ã®ãƒ‡ãƒ¼ã‚¿ã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`;
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            try {
                // ãƒ‡ãƒ¼ã‚¿ã‚­ãƒ¼ã®ç‰¹å®š
                const possibleKeys = ['rentpipe_demo_customers', 'rentpipe_customers', 'customers'];
                
                for (const key of possibleKeys) {
                    const data = localStorage.getItem(key);
                    if (data) {
                        const customers = JSON.parse(data);
                        const updatedCustomers = customers.filter(c => c.id !== customerId);
                        localStorage.setItem(key, JSON.stringify(updatedCustomers));
                        break;
                    }
                }
                
                alert(`${currentCustomer.name}ã•ã‚“ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
                window.location.href = 'customer.html';
                
            } catch (error) {
                console.error('âŒ é¡§å®¢å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                alert('é¡§å®¢ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // æˆ»ã‚‹å‡¦ç†
        function goBack() {
            if (document.referrer && (document.referrer.includes('pipeline.html') || document.referrer.includes('customer.html'))) {
                history.back();
            } else {
                window.location.href = 'customer.html';
            }
        }
    </script>
    <!-- ç·©ã„èªè¨¼ãƒã‚§ãƒƒã‚¯ -->
    <!-- ç·©ã„èªè¨¼ãƒã‚§ãƒƒã‚¯ -->
    <!-- çµ±ä¸€èªè¨¼ãƒã‚§ãƒƒã‚¯ -->
    <!-- èªè¨¼ç„¡åŠ¹åŒ–ãƒ†ã‚¹ãƒˆ -->
</html>

    <script>
        // é¡§å®¢è©³ç´°ãƒšãƒ¼ã‚¸å°‚ç”¨ï¼šãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³å¼·åˆ¶èª¿æ•´
        function forceCustomerNavActive() {
            console.log('ğŸ¯ é¡§å®¢è©³ç´°ãƒšãƒ¼ã‚¸ï¼šãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³å¼·åˆ¶èª¿æ•´é–‹å§‹');
            
            const navLinks = document.querySelectorAll('.nav-link');
            let foundCustomerLink = false;
            
            navLinks.forEach(link => {
                const href = link.getAttribute('href') || '';
                const text = link.textContent.trim();
                
                // å…¨ã¦ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚’ã‚¯ãƒªã‚¢
                link.classList.remove('active');
                
                // é¡§å®¢ç®¡ç†ãƒªãƒ³ã‚¯ã‚’æ¢ã—ã¦ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹
                if (href.includes('customer.html') || text.includes('é¡§å®¢ç®¡ç†') || text.includes('ğŸ‘¥')) {
                    link.classList.add('active');
                    foundCustomerLink = true;
                    console.log(`âœ… ã‚¢ã‚¯ãƒ†ã‚£ãƒ–è¨­å®šå®Œäº†: ${text}`);
                    
                    // ã‚¹ã‚¿ã‚¤ãƒ«ã‚‚å¼·åˆ¶é©ç”¨
                    link.style.backgroundColor = 'rgba(255, 255, 255, 0.2)';
                    link.style.fontWeight = 'bold';
                }
            });
            
            console.log(`çµæœ: ${foundCustomerLink ? 'æˆåŠŸ' : 'å¤±æ•—'} (${navLinks.length}å€‹ã®ãƒªãƒ³ã‚¯ã‚’ç¢ºèª)`);
            return foundCustomerLink;
        }
        
        // è¤‡æ•°ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§å®Ÿè¡Œ
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸ”„ DOMContentLoaded: ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³èª¿æ•´é–‹å§‹');
            
            // é…å»¶å®Ÿè¡Œã§è¤‡æ•°å›è©¦è¡Œ
            setTimeout(() => forceCustomerNavActive(), 300);
            setTimeout(() => forceCustomerNavActive(), 600);
            setTimeout(() => forceCustomerNavActive(), 1000);
        });
        
        window.addEventListener('load', () => {
            console.log('ğŸ”„ Window Load: ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³èª¿æ•´å®Ÿè¡Œ');
            setTimeout(() => forceCustomerNavActive(), 100);
        });
        
        // ãƒšãƒ¼ã‚¸è¡¨ç¤ºæ™‚ã«ã‚‚å®Ÿè¡Œ
        setTimeout(() => {
            console.log('ğŸ”„ å³åº§å®Ÿè¡Œ: ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³èª¿æ•´');
            forceCustomerNavActive();
        }, 100);
    </script>
