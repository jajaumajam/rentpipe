<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¡§å®¢è©³ç´° - RentPipe</title>
    <link rel="stylesheet" href="css/main.css">
    <style>
        .customer-detail-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            margin-top: 20px;
        }

        .detail-header {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-wrap: wrap;
            gap: 20px;
        }

        .customer-info h1 {
            color: #1e3a8a;
            margin-bottom: 5px;
            font-size: 28px;
        }

        .customer-info .name-kana {
            color: #6b7280;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .customer-meta {
            color: #64748b;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .customer-meta a {
            color: #3b82f6;
            text-decoration: none;
        }

        .customer-meta a:hover {
            text-decoration: underline;
        }

        .status-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            color: white;
            margin-bottom: 15px;
        }

        .status-åˆå›ç›¸è«‡ { background: #6366f1; }
        .status-ç‰©ä»¶ç´¹ä»‹ { background: #8b5cf6; }
        .status-å†…è¦‹èª¿æ•´ { background: #06b6d4; }
        .status-ç”³è¾¼æº–å‚™ { background: #10b981; }
        .status-å¯©æŸ»ä¸­ { background: #f59e0b; }
        .status-å¥‘ç´„æ‰‹ç¶šã { background: #ef4444; }
        .status-å®Œäº† { background: #22c55e; }

        .detail-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .detail-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .detail-card.full-width {
            grid-column: 1 / -1;
        }

        .detail-card h3 {
            color: #1e3a8a;
            margin-bottom: 15px;
            font-size: 18px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 8px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            padding: 8px 0;
            border-bottom: 1px solid #f8fafc;
        }

        .info-label {
            font-weight: 600;
            color: #374151;
            min-width: 120px;
        }

        .info-value {
            color: #6b7280;
            flex: 1;
            text-align: right;
        }

        /* è¨­å‚™ã‚¿ã‚° */
        .equipment-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .equipment-tag {
            background: #dbeafe;
            color: #1e40af;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 13px;
            font-weight: 500;
        }

        .equipment-tag.inactive {
            background: #f3f4f6;
            color: #9ca3af;
        }

        /* é–“å–ã‚Šã‚¿ã‚° */
        .layout-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .layout-tag {
            background: #fef3c7;
            color: #92400e;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 500;
        }

        /* ãƒ¡ãƒ¢ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .notes-content {
            background: #f8fafc;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #3b82f6;
            margin-top: 10px;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        .agent-memo-content {
            background: #fef3c7;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #f59e0b;
            margin-top: 10px;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ */
        .status-change-section {
            background: #f0f9ff;
            border: 1px solid #3b82f6;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .status-select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 14px;
        }

        /* ã‚¨ãƒ©ãƒ¼ãƒ»ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ */
        .error-state {
            background: #fee2e2;
            border: 1px solid #ef4444;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            color: #991b1b;
        }

        .loading-state {
            background: #f0f9ff;
            border: 1px solid #3b82f6;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            color: #1e40af;
        }

        /* éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒãƒƒã‚¸ */
        .inactive-badge {
            display: inline-block;
            background: #ef4444;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }

        @media (max-width: 768px) {
            .detail-header {
                flex-direction: column;
                align-items: stretch;
            }

            .detail-grid {
                grid-template-columns: 1fr;
            }

            .detail-actions {
                justify-content: stretch;
            }

            .detail-actions .btn {
                flex: 1;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <div id="navigation"></div>

    <main class="customer-detail-container">
        <!-- æˆ»ã‚‹ãƒœã‚¿ãƒ³ -->
        <div style="margin-bottom: 20px;">
            <button onclick="goBack()" class="btn btn-outline">
                â† æˆ»ã‚‹
            </button>
        </div>

        <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ -->
        <div id="loadingState" class="loading-state">
            <div style="font-size: 48px; margin-bottom: 15px;">â³</div>
            <h2>é¡§å®¢æƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­...</h2>
            <p>ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„</p>
        </div>

        <!-- ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹ -->
        <div id="errorState" class="error-state" style="display: none;">
            <div style="font-size: 48px; margin-bottom: 15px;">âŒ</div>
            <h2>é¡§å®¢æƒ…å ±ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</h2>
            <p id="errorMessage">ã‚¨ãƒ©ãƒ¼ã®è©³ç´°</p>
            <button onclick="retryLoad()" class="btn btn-primary" style="margin: 15px 10px 0 0;">
                å†è©¦è¡Œ
            </button>
            <button onclick="goBack()" class="btn btn-outline" style="margin: 15px 0 0 10px;">
                æˆ»ã‚‹
            </button>
        </div>

        <!-- è©³ç´°ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <div id="detailContent" style="display: none;">
            <!-- é¡§å®¢è©³ç´°ãƒ˜ãƒƒãƒ€ãƒ¼ -->
            <div class="detail-header">
                <div class="customer-info">
                    <h1 id="customerName">é¡§å®¢å<span id="inactiveBadge" class="inactive-badge" style="display: none;">éã‚¢ã‚¯ãƒ†ã‚£ãƒ–</span></h1>
                    <div class="name-kana" id="customerNameKana"></div>
                    <div class="customer-meta">
                        ğŸ“§ <a id="customerEmailLink" href="mailto:"><span id="customerEmail">ãƒ¡ãƒ¼ãƒ«</span></a> â€¢
                        ğŸ“ <a id="customerPhoneLink" href="tel:"><span id="customerPhone">é›»è©±ç•ªå·</span></a>
                    </div>
                    <div id="statusBadge" class="status-badge">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</div>
                    <div class="customer-meta">
                        ç™»éŒ²æ—¥: <span id="createdAt">-</span> â€¢
                        æœ€çµ‚æ›´æ–°: <span id="updatedAt">-</span>
                    </div>
                </div>

                <div class="detail-actions">
                    <button onclick="editCustomer()" class="btn btn-primary">
                        âœï¸ ç·¨é›†
                    </button>
                    <button onclick="exportCustomer()" class="btn btn-outline">
                        ğŸ“¥ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                    </button>
                    <button onclick="deleteCustomer()" class="btn btn-danger">
                        ğŸ—‘ï¸ å‰Šé™¤
                    </button>
                </div>
            </div>

            <!-- è©³ç´°æƒ…å ±ã‚°ãƒªãƒƒãƒ‰ -->
            <div class="detail-grid">
                <!-- åŸºæœ¬æƒ…å ± -->
                <div class="detail-card">
                    <h3>ğŸ‘¤ åŸºæœ¬æƒ…å ±</h3>
                    <div class="info-row">
                        <span class="info-label">å¹´é½¢</span>
                        <span class="info-value" id="customerAge">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">æ€§åˆ¥</span>
                        <span class="info-value" id="customerGender">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">ç¾ä½æ‰€</span>
                        <span class="info-value" id="customerAddress">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">ç¾ä½å±…å½¢æ…‹</span>
                        <span class="info-value" id="customerHousing">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">å…¥å±…äººæ•°</span>
                        <span class="info-value" id="customerOccupants">-</span>
                    </div>
                </div>

                <!-- è·æ¥­ãƒ»åå…¥æƒ…å ± -->
                <div class="detail-card">
                    <h3>ğŸ’¼ è·æ¥­ãƒ»åå…¥</h3>
                    <div class="info-row">
                        <span class="info-label">è·æ¥­</span>
                        <span class="info-value" id="customerOccupation">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">ä¼šç¤¾å</span>
                        <span class="info-value" id="customerCompany">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">å‹¤ç¶šå¹´æ•°</span>
                        <span class="info-value" id="customerYearsEmployed">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">å¹´å</span>
                        <span class="info-value" id="customerIncome">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">å¼•è¶Šã—ç†ç”±</span>
                        <span class="info-value" id="customerMovingReason">-</span>
                    </div>
                </div>

                <!-- å¸Œæœ›æ¡ä»¶ -->
                <div class="detail-card">
                    <h3>ğŸ  å¸Œæœ›æ¡ä»¶</h3>
                    <div class="info-row">
                        <span class="info-label">äºˆç®—</span>
                        <span class="info-value" id="customerBudget">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">å…¥å±…å¸Œæœ›æ™‚æœŸ</span>
                        <span class="info-value" id="customerMoveIn">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">å¸Œæœ›ã‚¨ãƒªã‚¢</span>
                        <span class="info-value" id="customerAreas">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">å¸Œæœ›é–“å–ã‚Š</span>
                        <span class="info-value" id="customerLayout">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">éƒ¨å±‹ã®åºƒã•</span>
                        <span class="info-value" id="customerRoomSize">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">é§…å¾’æ­©</span>
                        <span class="info-value" id="customerStationWalk">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">ç¯‰å¹´æ•°</span>
                        <span class="info-value" id="customerBuildingAge">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">å¸Œæœ›éšæ•°</span>
                        <span class="info-value" id="customerFloor">-</span>
                    </div>
                </div>

                <!-- è¨­å‚™ãƒ»æ¡ä»¶ -->
                <div class="detail-card">
                    <h3>âš™ï¸ å¸Œæœ›è¨­å‚™</h3>
                    <div id="equipmentTags" class="equipment-tags">
                        <!-- å‹•çš„ã«ç”Ÿæˆ -->
                    </div>
                </div>

                <!-- é¡§å®¢ãƒ¡ãƒ¢ -->
                <div class="detail-card full-width">
                    <h3>ğŸ“ ãŠå®¢æ§˜ã®ã”è¦æœ›</h3>
                    <div id="customerNotes" class="notes-content">
                        ãƒ¡ãƒ¢ã¯ã‚ã‚Šã¾ã›ã‚“
                    </div>
                </div>

                <!-- ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ¡ãƒ¢ -->
                <div class="detail-card full-width" id="agentMemoSection">
                    <h3>ğŸ—’ï¸ ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ¡ãƒ¢</h3>
                    <div id="agentMemo" class="agent-memo-content">
                        ãƒ¡ãƒ¢ã¯ã‚ã‚Šã¾ã›ã‚“
                    </div>
                </div>
            </div>

            <!-- ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="detail-card">
                <h3>âš¡ ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h3>
                <div class="status-change-section">
                    <label for="newStatus"><strong>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å¤‰æ›´ã™ã‚‹:</strong></label>
                    <select id="newStatus" class="status-select">
                        <option value="">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’é¸æŠ</option>
                        <option value="åˆå›ç›¸è«‡">åˆå›ç›¸è«‡</option>
                        <option value="ç‰©ä»¶ç´¹ä»‹">ç‰©ä»¶ç´¹ä»‹</option>
                        <option value="å†…è¦‹èª¿æ•´">å†…è¦‹èª¿æ•´</option>
                        <option value="ç”³è¾¼æº–å‚™">ç”³è¾¼æº–å‚™</option>
                        <option value="å¯©æŸ»ä¸­">å¯©æŸ»ä¸­</option>
                        <option value="å¥‘ç´„æ‰‹ç¶šã">å¥‘ç´„æ‰‹ç¶šã</option>
                        <option value="å®Œäº†">å®Œäº†</option>
                    </select>
                    <button onclick="changeStatus()" class="btn btn-primary" style="width: 100%; margin-top: 10px;">
                        ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="js/navigation.js"></script>
    <script src="js/integrated-auth-manager-v2.js"></script>
    <script src="js/google-drive-api-v2.js"></script>
    <script src="js/google-sheets-api.js"></script>
    <script src="js/data-migration.js"></script>
    <script src="js/unified-sheets-manager.js"></script>
    <script src="js/unified-data-manager.js"></script>
    <script src="js/app-initializer.js"></script>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let currentCustomer = null;
        let customerId = null;

        // è¨­å‚™é …ç›®ã®å®šç¾©
        const equipmentLabels = {
            autoLock: 'ã‚ªãƒ¼ãƒˆãƒ­ãƒƒã‚¯',
            separateBath: 'ãƒã‚¹ãƒˆã‚¤ãƒ¬åˆ¥',
            separateWashroom: 'æ´—é¢æ‰€ç‹¬ç«‹',
            indoorWashing: 'å®¤å†…æ´—æ¿¯æ©Ÿç½®å ´',
            twoGasStove: '2å£ä»¥ä¸Šã‚³ãƒ³ãƒ­',
            flooring: 'ãƒ•ãƒ­ãƒ¼ãƒªãƒ³ã‚°',
            noTatami: 'ç•³NG',
            elevator: 'ã‚¨ãƒ¬ãƒ™ãƒ¼ã‚¿ãƒ¼',
            deliveryBox: 'å®…é…ãƒœãƒƒã‚¯ã‚¹',
            internet: 'ãƒãƒƒãƒˆç„¡æ–™',
            parking: 'é§è»Šå ´',
            bike: 'ãƒã‚¤ã‚¯ç½®å ´',
            bicycle: 'é§è¼ªå ´',
            petAllowed: 'ãƒšãƒƒãƒˆå¯',
            instrumentAllowed: 'æ¥½å™¨å¯',
            sohoAllowed: 'SOHOå¯'
        };

        // æ€§åˆ¥ã®è¡¨ç¤ºå
        const genderLabels = {
            male: 'ç”·æ€§',
            female: 'å¥³æ€§',
            other: 'ãã®ä»–',
            no_answer: 'å›ç­”ãªã—'
        };

        // ãƒšãƒ¼ã‚¸åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            if (window.AppInitializer && window.AppInitializer.initializationPromise) {
                try {
                    await window.AppInitializer.initializationPromise;
                } catch (e) {
                    console.warn('AppInitializeråˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', e);
                }
            }

            setTimeout(() => {
                initializePage();
                forceCustomerNavActive();
            }, 200);
        });

        // ãƒšãƒ¼ã‚¸åˆæœŸåŒ–å‡¦ç†
        function initializePage() {
            console.log('ğŸ” é¡§å®¢è©³ç´°ãƒšãƒ¼ã‚¸åˆæœŸåŒ–é–‹å§‹...');

            try {
                const urlParams = new URLSearchParams(window.location.search);
                customerId = urlParams.get('id');

                if (!customerId) {
                    throw new Error('é¡§å®¢IDãŒURLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§æŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
                }

                loadCustomerDetail();

            } catch (error) {
                console.error('âŒ ãƒšãƒ¼ã‚¸åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                showError(`ãƒšãƒ¼ã‚¸åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }

        // é¡§å®¢è©³ç´°ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
        function loadCustomerDetail() {
            console.log(`ğŸ“‹ é¡§å®¢è©³ç´°èª­ã¿è¾¼ã¿é–‹å§‹: ID=${customerId}`);

            try {
                if (!window.UnifiedDataManager) {
                    throw new Error('ãƒ‡ãƒ¼ã‚¿ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
                }

                currentCustomer = window.UnifiedDataManager.getCustomerById(customerId);

                if (!currentCustomer) {
                    throw new Error(`ID: ${customerId} ã®é¡§å®¢ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`);
                }

                console.log('âœ… é¡§å®¢ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ');
                displayCustomerDetail();

            } catch (error) {
                console.error('âŒ é¡§å®¢ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                showError(`é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
            }
        }

        // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
        function showError(message) {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('detailContent').style.display = 'none';
            document.getElementById('errorState').style.display = 'block';
            document.getElementById('errorMessage').textContent = message;
        }

        // å†è©¦è¡Œ
        function retryLoad() {
            document.getElementById('errorState').style.display = 'none';
            document.getElementById('loadingState').style.display = 'block';

            setTimeout(() => {
                loadCustomerDetail();
            }, 500);
        }

        // é¡§å®¢è©³ç´°è¡¨ç¤º
        function displayCustomerDetail() {
            if (!currentCustomer) {
                showError('è¡¨ç¤ºã™ã‚‹é¡§å®¢ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }

            try {
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('detailContent').style.display = 'block';

                const basicInfo = currentCustomer.basicInfo || {};
                const preferences = currentCustomer.preferences || {};
                const equipment = currentCustomer.equipment || {};

                // ãƒ˜ãƒƒãƒ€ãƒ¼æƒ…å ±
                const name = basicInfo.name || currentCustomer.name || 'åå‰æœªè¨­å®š';
                document.getElementById('customerName').innerHTML = name +
                    (currentCustomer.isActive === false ? '<span class="inactive-badge">éã‚¢ã‚¯ãƒ†ã‚£ãƒ–</span>' : '');
                document.getElementById('customerNameKana').textContent = basicInfo.nameKana || '';

                const email = basicInfo.email || currentCustomer.email || 'æœªè¨­å®š';
                const phone = basicInfo.phone || currentCustomer.phone || 'æœªè¨­å®š';
                document.getElementById('customerEmail').textContent = email;
                document.getElementById('customerPhone').textContent = phone;
                document.getElementById('customerEmailLink').href = `mailto:${email}`;
                document.getElementById('customerPhoneLink').href = `tel:${phone}`;

                // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
                const status = currentCustomer.pipelineStatus || 'æœªè¨­å®š';
                const statusBadge = document.getElementById('statusBadge');
                statusBadge.textContent = status;
                statusBadge.className = `status-badge status-${status}`;

                // æ—¥ä»˜
                document.getElementById('createdAt').textContent = currentCustomer.createdAt ? formatDate(currentCustomer.createdAt) : 'æœªè¨­å®š';
                document.getElementById('updatedAt').textContent = currentCustomer.updatedAt ? formatDate(currentCustomer.updatedAt) : 'æœªè¨­å®š';

                // åŸºæœ¬æƒ…å ±
                document.getElementById('customerAge').textContent = basicInfo.birthday ? calculateAge(basicInfo.birthday) + 'æ­³' : 'æœªè¨­å®š';
                document.getElementById('customerGender').textContent = genderLabels[basicInfo.gender] || 'æœªè¨­å®š';
                document.getElementById('customerAddress').textContent = basicInfo.currentAddress || 'æœªè¨­å®š';
                document.getElementById('customerHousing').textContent = basicInfo.currentHousing || 'æœªè¨­å®š';
                document.getElementById('customerOccupants').textContent = basicInfo.numberOfOccupants ? basicInfo.numberOfOccupants + 'äºº' : 'æœªè¨­å®š';

                // è·æ¥­ãƒ»åå…¥
                document.getElementById('customerOccupation').textContent = basicInfo.occupation || 'æœªè¨­å®š';
                document.getElementById('customerCompany').textContent = basicInfo.companyName || 'æœªè¨­å®š';
                document.getElementById('customerYearsEmployed').textContent = basicInfo.yearsEmployed !== undefined ? basicInfo.yearsEmployed + 'å¹´' : 'æœªè¨­å®š';
                document.getElementById('customerIncome').textContent = basicInfo.annualIncome ? formatIncome(basicInfo.annualIncome) : 'æœªè¨­å®š';
                document.getElementById('customerMovingReason').textContent = basicInfo.movingReason || 'æœªè¨­å®š';

                // å¸Œæœ›æ¡ä»¶
                const budgetMin = preferences.budget?.min || 0;
                const budgetMax = preferences.budget?.max || 0;
                const budgetText = budgetMin || budgetMax
                    ? `${budgetMin ? (budgetMin / 10000).toFixed(0) : '0'}ã€œ${budgetMax ? (budgetMax / 10000).toFixed(0) : ''}ä¸‡å††`
                    : 'æœªè¨­å®š';
                document.getElementById('customerBudget').textContent = budgetText;
                document.getElementById('customerMoveIn').textContent = preferences.moveInDate || 'æœªè¨­å®š';
                document.getElementById('customerAreas').textContent = preferences.areas || 'æœªè¨­å®š';
                document.getElementById('customerLayout').textContent = preferences.layout || 'æœªè¨­å®š';
                document.getElementById('customerRoomSize').textContent = preferences.roomSize ? preferences.roomSize + 'ã¡ä»¥ä¸Š' : 'æœªè¨­å®š';
                document.getElementById('customerStationWalk').textContent = preferences.stationWalk ? preferences.stationWalk + 'åˆ†ä»¥å†…' : 'æœªè¨­å®š';

                // ç¯‰å¹´æ•°
                const buildingAge = preferences.buildingAge;
                let buildingAgeText = 'æœªè¨­å®š';
                if (buildingAge) {
                    if (buildingAge.type === 'any' || buildingAge.value === 999) {
                        buildingAgeText = 'ã“ã ã‚ã‚‰ãªã„';
                    } else if (buildingAge.value === 0) {
                        buildingAgeText = 'æ–°ç¯‰ã®ã¿';
                    } else {
                        buildingAgeText = buildingAge.value + 'å¹´ä»¥å†…';
                    }
                }
                document.getElementById('customerBuildingAge').textContent = buildingAgeText;

                // éšæ•°
                const floor = preferences.floor;
                document.getElementById('customerFloor').textContent = floor === 1 || !floor ? 'ã“ã ã‚ã‚‰ãªã„' : floor + 'éšä»¥ä¸Š';

                // è¨­å‚™ã‚¿ã‚°ç”Ÿæˆ
                const equipmentContainer = document.getElementById('equipmentTags');
                equipmentContainer.innerHTML = '';
                let hasEquipment = false;

                for (const [key, label] of Object.entries(equipmentLabels)) {
                    if (equipment[key]) {
                        const tag = document.createElement('span');
                        tag.className = 'equipment-tag';
                        tag.textContent = label;
                        equipmentContainer.appendChild(tag);
                        hasEquipment = true;
                    }
                }

                if (!hasEquipment) {
                    equipmentContainer.innerHTML = '<span style="color: #6b7280;">ç‰¹ã«å¸Œæœ›ãªã—</span>';
                }

                // ãƒ¡ãƒ¢
                const notes = currentCustomer.additionalInfo?.notes || '';
                document.getElementById('customerNotes').textContent = notes || 'ãƒ¡ãƒ¢ã¯ã‚ã‚Šã¾ã›ã‚“';

                // ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ¡ãƒ¢
                const agentMemo = currentCustomer.agentMemo || '';
                document.getElementById('agentMemo').textContent = agentMemo || 'ãƒ¡ãƒ¢ã¯ã‚ã‚Šã¾ã›ã‚“';

                console.log('âœ… é¡§å®¢è©³ç´°è¡¨ç¤ºå®Œäº†');

            } catch (error) {
                console.error('âŒ è¡¨ç¤ºå‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
                showError(`è¡¨ç¤ºå‡¦ç†ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }

        // å¹´é½¢è¨ˆç®—
        function calculateAge(birthday) {
            if (!birthday) return null;
            const birthDate = new Date(birthday);
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            const monthDiff = today.getMonth() - birthDate.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            return age;
        }

        // å¹´åãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatIncome(income) {
            if (!income) return 'æœªè¨­å®š';
            const man = income / 10000;
            return man.toLocaleString() + 'ä¸‡å††';
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´å‡¦ç†
        async function changeStatus() {
            const newStatus = document.getElementById('newStatus').value;
            if (!newStatus) {
                alert('å¤‰æ›´ã™ã‚‹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            if (!confirm(`ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ã€Œ${newStatus}ã€ã«å¤‰æ›´ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) {
                return;
            }

            try {
                currentCustomer.pipelineStatus = newStatus;
                const result = await window.UnifiedDataManager.updateCustomer(currentCustomer);

                if (result.success) {
                    displayCustomerDetail();
                    document.getElementById('newStatus').value = '';
                    alert(`âœ… ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ã€Œ${newStatus}ã€ã«æ›´æ–°ã—ã¾ã—ãŸï¼`);
                } else {
                    throw new Error(result.error || 'æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }

            } catch (error) {
                console.error('âŒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                alert('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        // æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatDate(dateString, includeTime = false) {
            try {
                const date = new Date(dateString);
                if (includeTime) {
                    return date.toLocaleString('ja-JP');
                } else {
                    return date.toLocaleDateString('ja-JP');
                }
            } catch (e) {
                return 'æ—¥ä»˜å½¢å¼ã‚¨ãƒ©ãƒ¼';
            }
        }

        // é¡§å®¢ç·¨é›†
        function editCustomer() {
            window.location.href = `customer-form.html?edit=${customerId}`;
        }

        // é¡§å®¢ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        function exportCustomer() {
            if (!currentCustomer) return;

            const customerData = JSON.stringify(currentCustomer, null, 2);
            const blob = new Blob([customerData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            const name = currentCustomer.basicInfo?.name || currentCustomer.name || 'é¡§å®¢';
            a.download = `é¡§å®¢_${name}_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            alert(`${name}ã•ã‚“ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ`);
        }

        // é¡§å®¢å‰Šé™¤
        async function deleteCustomer() {
            if (!currentCustomer) return;

            const name = currentCustomer.basicInfo?.name || currentCustomer.name || 'é¡§å®¢';
            const confirmMessage = `${name}ã•ã‚“ã®ãƒ‡ãƒ¼ã‚¿ã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`;

            if (!confirm(confirmMessage)) {
                return;
            }

            try {
                const result = await window.UnifiedDataManager.deleteCustomer(customerId);

                if (result.success) {
                    alert(`${name}ã•ã‚“ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
                    window.location.href = 'customer.html';
                } else {
                    throw new Error(result.error || 'å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }

            } catch (error) {
                console.error('âŒ é¡§å®¢å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                alert('é¡§å®¢ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        // æˆ»ã‚‹å‡¦ç†
        function goBack() {
            if (document.referrer && (document.referrer.includes('pipeline.html') || document.referrer.includes('customer.html'))) {
                history.back();
            } else {
                window.location.href = 'customer.html';
            }
        }

        // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’å¼·åˆ¶è¨­å®š
        function forceCustomerNavActive() {
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => {
                const href = link.getAttribute('href') || '';
                link.classList.remove('active');
                if (href.includes('customer.html')) {
                    link.classList.add('active');
                }
            });
        }
    </script>
</body>
</html>
