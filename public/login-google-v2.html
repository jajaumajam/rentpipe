<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google連携ログイン - RentPipe</title>
    <link href="css/main.css" rel="stylesheet">
</head>

<body>
    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="nav-brand">
                🏠 RentPipe
            </a>
        </div>
    </nav>

    <main class="container">
        <div style="max-width: 500px; margin: 50px auto; text-align: center;">
            <div class="login-card" style="background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                <h1 style="color: #1e3a8a; margin-bottom: 10px;">🔑 Google連携ログイン</h1>
                <p style="color: #6b7280; margin-bottom: 30px;">
                    Google Formsの機能を使用するために<br>
                    Googleアカウントでログインしてください
                </p>

                <!-- システム状態表示 -->
                <div id="system-status" style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; font-size: 12px; text-align: left;"></div>

                <!-- ログインボタン -->
                <button id="googleLoginBtn" onclick="handleGoogleLogin()" disabled
                        style="background: #4285f4; color: white; border: none; padding: 15px 30px; border-radius: 8px; font-size: 16px; cursor: pointer; margin-bottom: 20px; width: 100%;">
                    🔄 Google API読み込み中...
                </button>

                <!-- 認証状態表示 -->
                <div id="auth-status" style="margin-top: 20px; padding: 15px; border-radius: 8px; display: none;"></div>

                <!-- 戻るリンク -->
                <div style="margin-top: 30px;">
                    <a href="customer.html" style="color: #6b7280; text-decoration: none;">
                        ← 顧客管理に戻る
                    </a>
                </div>
            </div>
        </div>
    </main>

    <!-- Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <!-- Google API Client Library -->
    <script src="https://apis.google.com/js/api.js"></script>

    <!-- 設定・認証システム -->
    <script src="js/firebase-config.js"></script>
    <script src="js/google-identity-config.js"></script>
    <script src="js/integrated-auth-manager-v2.js"></script>

    <script>
        let systemReady = false;

        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Google連携ログインページ初期化開始...');
            
            // システム状態を定期的にチェック
            checkSystemStatus();
            setInterval(checkSystemStatus, 1000);
            
            // 初期化完了をチェック
            waitForInitialization();
        });

        function checkSystemStatus() {
            const statusDiv = document.getElementById('system-status');
            let status = '';
            let allReady = true;
            
            // Google Identity Services
            if (window.google?.accounts) {
                status += '✅ Google Identity Services\n';
            } else {
                status += '⏳ Google Identity Services 読み込み中...\n';
                allReady = false;
            }
            
            // Google API Client
            if (window.gapi) {
                status += '✅ Google API Client\n';
            } else {
                status += '⏳ Google API Client 読み込み中...\n';
                allReady = false;
            }
            
            // Google Identity Config
            if (window.GoogleIdentity) {
                status += '✅ Google Identity 設定\n';
            } else {
                status += '⏳ Google Identity 設定 読み込み中...\n';
                allReady = false;
            }
            
            // 統合認証マネージャー
            if (window.IntegratedAuthManagerV2) {
                status += '✅ 統合認証マネージャー\n';
            } else {
                status += '⏳ 統合認証マネージャー 読み込み中...\n';
                allReady = false;
            }
            
            statusDiv.textContent = status;
            systemReady = allReady;
            
            // ボタン状態更新
            const loginBtn = document.getElementById('googleLoginBtn');
            if (allReady) {
                loginBtn.disabled = false;
                loginBtn.textContent = '🔑 Googleアカウントでログイン';
                loginBtn.style.background = '#4285f4';
                loginBtn.style.cursor = 'pointer';
                
                // 既存の認証状態チェック
                checkExistingAuth();
            } else {
                loginBtn.disabled = true;
                loginBtn.textContent = '🔄 システム読み込み中...';
                loginBtn.style.background = '#9ca3af';
                loginBtn.style.cursor = 'not-allowed';
            }
        }

        function waitForInitialization() {
            setTimeout(async () => {
                if (window.IntegratedAuthManagerV2 && !window.IntegratedAuthManagerV2.isInitialized) {
                    try {
                        await window.IntegratedAuthManagerV2.initialize();
                        console.log('✅ 統合認証マネージャー 遅延初期化完了');
                        checkExistingAuth();
                    } catch (error) {
                        console.warn('⚠️ 統合認証マネージャー 遅延初期化失敗:', error);
                    }
                }
            }, 2000);
        }

        function checkExistingAuth() {
            if (window.IntegratedAuthManagerV2) {
                const authState = window.IntegratedAuthManagerV2.getAuthState();
                if (authState.googleAuth.isSignedIn) {
                    showAuthStatus('success', `✅ ログイン済み: ${authState.googleAuth.user.email}`);
                    
                    // 5秒後に顧客管理画面に戻る
                    setTimeout(() => {
                        window.location.href = 'customer.html';
                    }, 2000);
                }
            }
        }

        async function handleGoogleLogin() {
            if (!systemReady) {
                alert('システムの読み込みが完了していません。しばらくお待ちください。');
                return;
            }

            const loginBtn = document.getElementById('googleLoginBtn');
            const originalText = loginBtn.textContent;
            
            try {
                loginBtn.disabled = true;
                loginBtn.textContent = '🔄 ログイン処理中...';
                
                showAuthStatus('info', '🔄 Googleアカウント認証中...');
                
                // Google認証実行
                if (window.IntegratedAuthManagerV2) {
                    const result = await window.IntegratedAuthManagerV2.signIn();
                    
                    if (result) {
                        showAuthStatus('success', `✅ ログイン成功: ${result.email}`);
                        
                        // 成功メッセージを表示して画面遷移
                        setTimeout(() => {
                            alert('ログインが完了しました！顧客管理画面に戻ります。');
                            window.location.href = 'customer.html';
                        }, 1000);
                        
                    } else {
                        throw new Error('認証に失敗しました');
                    }
                } else {
                    throw new Error('認証システムが利用できません');
                }
                
            } catch (error) {
                console.error('❌ ログインエラー:', error);
                showAuthStatus('error', `❌ ログインエラー: ${error.message}`);
                
                loginBtn.disabled = false;
                loginBtn.textContent = originalText;
            }
        }

        function showAuthStatus(type, message) {
            const statusDiv = document.getElementById('auth-status');
            statusDiv.style.display = 'block';
            statusDiv.textContent = message;
            
            switch (type) {
                case 'success':
                    statusDiv.style.background = '#dcfce7';
                    statusDiv.style.color = '#166534';
                    statusDiv.style.border = '1px solid #4ade80';
                    break;
                case 'error':
                    statusDiv.style.background = '#fee2e2';
                    statusDiv.style.color = '#991b1b';
                    statusDiv.style.border = '1px solid #ef4444';
                    break;
                case 'info':
                default:
                    statusDiv.style.background = '#dbeafe';
                    statusDiv.style.color = '#1e3a8a';
                    statusDiv.style.border = '1px solid #60a5fa';
                    break;
            }
        }
    </script>

    <style>
        .login-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .login-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        #googleLoginBtn:hover:not(:disabled) {
            background: #3367d6 !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        #system-status {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            white-space: pre-line;
            line-height: 1.4;
        }
    </style>
</body>
</html>
