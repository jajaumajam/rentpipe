<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Googleé€£æºãƒ­ã‚°ã‚¤ãƒ³ - RentPipe</title>
    <link href="css/main.css" rel="stylesheet">
</head>

<body>
    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="nav-brand">
                ğŸ  RentPipe
            </a>
        </div>
    </nav>

    <main class="container">
        <div style="max-width: 500px; margin: 50px auto; text-align: center;">
            <div class="login-card" style="background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                <h1 style="color: #1e3a8a; margin-bottom: 10px;">ğŸ”‘ Googleé€£æºãƒ­ã‚°ã‚¤ãƒ³</h1>
                <p style="color: #6b7280; margin-bottom: 30px;">
                    Google Formsã®æ©Ÿèƒ½ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã«<br>
                    Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„
                </p>

                <!-- ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹è¡¨ç¤º -->
                <div id="system-status" style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; font-size: 12px; text-align: left;"></div>

                <!-- ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ -->
                <button id="googleLoginBtn" onclick="handleGoogleLogin()" disabled
                        style="background: #4285f4; color: white; border: none; padding: 15px 30px; border-radius: 8px; font-size: 16px; cursor: pointer; margin-bottom: 20px; width: 100%;">
                    ğŸ”„ Google APIèª­ã¿è¾¼ã¿ä¸­...
                </button>

                <!-- èªè¨¼çŠ¶æ…‹è¡¨ç¤º -->
                <div id="auth-status" style="margin-top: 20px; padding: 15px; border-radius: 8px; display: none;"></div>

                <!-- æˆ»ã‚‹ãƒªãƒ³ã‚¯ -->
                <div style="margin-top: 30px;">
                    <a href="customer.html" style="color: #6b7280; text-decoration: none;">
                        â† é¡§å®¢ç®¡ç†ã«æˆ»ã‚‹
                    </a>
                </div>
            </div>
        </div>
    </main>

    <!-- Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <!-- Google API Client Library -->
    <script src="https://apis.google.com/js/api.js"></script>

    <!-- è¨­å®šãƒ»èªè¨¼ã‚·ã‚¹ãƒ†ãƒ  -->
    <script src="js/firebase-config.js"></script>
    <script src="js/google-identity-config.js"></script>
    <script src="js/integrated-auth-manager-v2.js"></script>

    <script>
        let systemReady = false;

        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ Googleé€£æºãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸åˆæœŸåŒ–é–‹å§‹...');
            
            // ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ã‚’å®šæœŸçš„ã«ãƒã‚§ãƒƒã‚¯
            checkSystemStatus();
            setInterval(checkSystemStatus, 1000);
            
            // åˆæœŸåŒ–å®Œäº†ã‚’ãƒã‚§ãƒƒã‚¯
            waitForInitialization();
        });

        function checkSystemStatus() {
            const statusDiv = document.getElementById('system-status');
            let status = '';
            let allReady = true;
            
            // Google Identity Services
            if (window.google?.accounts) {
                status += 'âœ… Google Identity Services\n';
            } else {
                status += 'â³ Google Identity Services èª­ã¿è¾¼ã¿ä¸­...\n';
                allReady = false;
            }
            
            // Google API Client
            if (window.gapi) {
                status += 'âœ… Google API Client\n';
            } else {
                status += 'â³ Google API Client èª­ã¿è¾¼ã¿ä¸­...\n';
                allReady = false;
            }
            
            // Google Identity Config
            if (window.GoogleIdentity) {
                status += 'âœ… Google Identity è¨­å®š\n';
            } else {
                status += 'â³ Google Identity è¨­å®š èª­ã¿è¾¼ã¿ä¸­...\n';
                allReady = false;
            }
            
            // çµ±åˆèªè¨¼ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼
            if (window.IntegratedAuthManagerV2) {
                status += 'âœ… çµ±åˆèªè¨¼ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼\n';
            } else {
                status += 'â³ çµ±åˆèªè¨¼ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ èª­ã¿è¾¼ã¿ä¸­...\n';
                allReady = false;
            }
            
            statusDiv.textContent = status;
            systemReady = allReady;
            
            // ãƒœã‚¿ãƒ³çŠ¶æ…‹æ›´æ–°
            const loginBtn = document.getElementById('googleLoginBtn');
            if (allReady) {
                loginBtn.disabled = false;
                loginBtn.textContent = 'ğŸ”‘ Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³';
                loginBtn.style.background = '#4285f4';
                loginBtn.style.cursor = 'pointer';
                
                // æ—¢å­˜ã®èªè¨¼çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯
                checkExistingAuth();
            } else {
                loginBtn.disabled = true;
                loginBtn.textContent = 'ğŸ”„ ã‚·ã‚¹ãƒ†ãƒ èª­ã¿è¾¼ã¿ä¸­...';
                loginBtn.style.background = '#9ca3af';
                loginBtn.style.cursor = 'not-allowed';
            }
        }

        function waitForInitialization() {
            setTimeout(async () => {
                if (window.IntegratedAuthManagerV2 && !window.IntegratedAuthManagerV2.isInitialized) {
                    try {
                        await window.IntegratedAuthManagerV2.initialize();
                        console.log('âœ… çµ±åˆèªè¨¼ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ é…å»¶åˆæœŸåŒ–å®Œäº†');
                        checkExistingAuth();
                    } catch (error) {
                        console.warn('âš ï¸ çµ±åˆèªè¨¼ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ é…å»¶åˆæœŸåŒ–å¤±æ•—:', error);
                    }
                }
            }, 2000);
        }

        function checkExistingAuth() {
            if (window.IntegratedAuthManagerV2) {
                const authState = window.IntegratedAuthManagerV2.getAuthState();
                if (authState.googleAuth.isSignedIn) {
                    showAuthStatus('success', `âœ… ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿: ${authState.googleAuth.user.email}`);
                    
                    // 5ç§’å¾Œã«é¡§å®¢ç®¡ç†ç”»é¢ã«æˆ»ã‚‹
                    setTimeout(() => {
                        window.location.href = 'customer.html';
                    }, 2000);
                }
            }
        }

        async function handleGoogleLogin() {
            if (!systemReady) {
                alert('ã‚·ã‚¹ãƒ†ãƒ ã®èª­ã¿è¾¼ã¿ãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚');
                return;
            }

            const loginBtn = document.getElementById('googleLoginBtn');
            const originalText = loginBtn.textContent;
            
            try {
                loginBtn.disabled = true;
                loginBtn.textContent = 'ğŸ”„ ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ä¸­...';
                
                showAuthStatus('info', 'ğŸ”„ Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆèªè¨¼ä¸­...');
                
                // Googleèªè¨¼å®Ÿè¡Œ
                if (window.IntegratedAuthManagerV2) {
                    const result = await window.IntegratedAuthManagerV2.signIn();
                    
                    if (result) {
                        showAuthStatus('success', `âœ… ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ: ${result.email}`);
                        
                        // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã—ã¦ç”»é¢é·ç§»
                        setTimeout(() => {
                            alert('ãƒ­ã‚°ã‚¤ãƒ³ãŒå®Œäº†ã—ã¾ã—ãŸï¼é¡§å®¢ç®¡ç†ç”»é¢ã«æˆ»ã‚Šã¾ã™ã€‚');
                            window.location.href = 'customer.html';
                        }, 1000);
                        
                    } else {
                        throw new Error('èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    }
                } else {
                    throw new Error('èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
                }
                
            } catch (error) {
                console.error('âŒ ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼:', error);
                showAuthStatus('error', `âŒ ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                
                loginBtn.disabled = false;
                loginBtn.textContent = originalText;
            }
        }

        function showAuthStatus(type, message) {
            const statusDiv = document.getElementById('auth-status');
            statusDiv.style.display = 'block';
            statusDiv.textContent = message;
            
            switch (type) {
                case 'success':
                    statusDiv.style.background = '#dcfce7';
                    statusDiv.style.color = '#166534';
                    statusDiv.style.border = '1px solid #4ade80';
                    break;
                case 'error':
                    statusDiv.style.background = '#fee2e2';
                    statusDiv.style.color = '#991b1b';
                    statusDiv.style.border = '1px solid #ef4444';
                    break;
                case 'info':
                default:
                    statusDiv.style.background = '#dbeafe';
                    statusDiv.style.color = '#1e3a8a';
                    statusDiv.style.border = '1px solid #60a5fa';
                    break;
            }
        }
    </script>

    <style>
        .login-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .login-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        #googleLoginBtn:hover:not(:disabled) {
            background: #3367d6 !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        #system-status {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            white-space: pre-line;
            line-height: 1.4;
        }
    </style>
</body>
</html>
