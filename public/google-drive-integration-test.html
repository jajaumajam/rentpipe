<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RentPipe Ã— Google Drive çµ±åˆãƒ†ã‚¹ãƒˆ</title>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; 
            padding: 20px; 
            background: #f5f5f5; 
        }
        .container { 
            max-width: 1000px; 
            margin: 0 auto; 
            background: white; 
            padding: 30px; 
            border-radius: 10px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
        }
        h1 { 
            color: #333; 
            text-align: center; 
            margin-bottom: 30px; 
        }
        .section { 
            margin: 20px 0; 
            padding: 20px; 
            border: 1px solid #e0e0e0; 
            border-radius: 8px; 
        }
        .section.success { background: #e8f5e8; border-color: #4caf50; }
        .section.error { background: #ffeaea; border-color: #f44336; }
        .section.warning { background: #fff8e1; border-color: #ff9800; }
        .section.info { background: #e3f2fd; border-color: #2196f3; }
        
        button { 
            padding: 12px 24px; 
            margin: 8px; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }
        .btn-primary { background: #2196f3; color: white; }
        .btn-success { background: #4caf50; color: white; }
        .btn-warning { background: #ff9800; color: white; }
        .btn-danger { background: #f44336; color: white; }
        
        button:disabled { background: #ccc; cursor: not-allowed; }
        
        pre { 
            background: #f8f8f8; 
            padding: 15px; 
            border-radius: 6px; 
            overflow-x: auto;
            white-space: pre-wrap;
            font-size: 13px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .step-flow {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        .step {
            flex: 1;
            text-align: center;
            padding: 15px 10px;
            background: #f0f0f0;
            margin: 5px;
            border-radius: 6px;
            font-size: 13px;
            min-width: 150px;
        }
        .step.active { background: #2196f3; color: white; }
        .step.completed { background: #4caf50; color: white; }
        .step.error { background: #f44336; color: white; }
        
        .data-display {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            background: #fafafa;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th { background: #f2f2f2; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ  RentPipe Ã— Google Drive çµ±åˆãƒ†ã‚¹ãƒˆ</h1>
        
        <!-- ãƒ•ãƒ­ãƒ¼è¡¨ç¤º -->
        <div class="step-flow">
            <div class="step" id="step-auth">ğŸ”‘ Googleèªè¨¼</div>
            <div class="step" id="step-drive-init">ğŸš€ Drive APIåˆæœŸåŒ–</div>
            <div class="step" id="step-data-init">ğŸ—ƒï¸ ãƒ‡ãƒ¼ã‚¿ç®¡ç†åˆæœŸåŒ–</div>
            <div class="step" id="step-sync">ğŸ”„ ãƒ‡ãƒ¼ã‚¿åŒæœŸ</div>
            <div class="step" id="step-test">âœ… æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ</div>
        </div>
        
        <!-- ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ³ -->
        <div id="system-status" class="section warning">
            <h3>ğŸ“Š ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ³</h3>
            <p id="status-text">æº–å‚™ä¸­... ã¾ãš Googleèªè¨¼ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚</p>
        </div>
        
        <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« -->
        <div class="section">
            <h3>ğŸ® ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ«</h3>
            
            <!-- åˆæœŸåŒ–ãƒœã‚¿ãƒ³ -->
            <div>
                <h4>ğŸ”§ åˆæœŸåŒ–</h4>
                <button class="btn-primary" onclick="authenticateGoogle()">
                    ğŸ”‘ Googleèªè¨¼ & åˆæœŸåŒ–
                </button>
                <button class="btn-success" onclick="initializeDataManager()" disabled id="btn-data-init">
                    ğŸ—ƒï¸ ãƒ‡ãƒ¼ã‚¿ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–
                </button>
            </div>
            
            <!-- ãƒ‡ãƒ¼ã‚¿æ“ä½œãƒœã‚¿ãƒ³ -->
            <div>
                <h4>ğŸ“Š ãƒ‡ãƒ¼ã‚¿æ“ä½œ</h4>
                <button class="btn-success" onclick="syncData()" disabled id="btn-sync">
                    ğŸ”„ LocalStorage â†” Google Drive åŒæœŸ
                </button>
                <button class="btn-warning" onclick="loadLocalData()">
                    ğŸ“± LocalStorage ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º
                </button>
                <button class="btn-warning" onclick="loadDriveData()" disabled id="btn-drive-data">
                    â˜ï¸ Google Drive ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º
                </button>
                <button class="btn-primary" onclick="testDataOperation()" disabled id="btn-test">
                    âœ… ãƒ‡ãƒ¼ã‚¿æ“ä½œãƒ†ã‚¹ãƒˆ
                </button>
            </div>
            
            <!-- ãƒ‡ãƒãƒƒã‚°ãƒ»ç®¡ç† -->
            <div>
                <h4>ğŸ” ãƒ‡ãƒãƒƒã‚°ãƒ»ç®¡ç†</h4>
                <button class="btn-warning" onclick="showDebugInfo()">
                    ğŸ” ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±è¡¨ç¤º
                </button>
                <button class="btn-danger" onclick="resetLocalData()">
                    ğŸ—‘ï¸ LocalStorage ãƒªã‚»ãƒƒãƒˆ
                </button>
            </div>
        </div>
        
        <!-- ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div id="data-display-section" class="section" style="display: none;">
            <h3>ğŸ“‹ ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º</h3>
            <div id="data-content" class="data-display"></div>
        </div>
        
        <!-- ãƒ­ã‚°è¡¨ç¤º -->
        <div class="section">
            <h3>ğŸ“ å®Ÿè¡Œãƒ­ã‚°</h3>
            <pre id="log-output">ã‚·ã‚¹ãƒ†ãƒ å¾…æ©Ÿä¸­...</pre>
        </div>
        
        <!-- ãƒ‡ãƒãƒƒã‚°æƒ…å ± -->
        <div id="debug-section" class="section" style="display: none;">
            <h3>ğŸ” ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±</h3>
            <pre id="debug-output"></pre>
        </div>
    </div>

    <!-- ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿ -->
    <script src="js/google-drive-api-v2.js"></script>
    <script src="js/google-drive-data-manager.js"></script>
    <script>
        let testState = {
            authenticated: false,
            driveInitialized: false,
            dataManagerReady: false,
            logs: []
        };
        
        // ãƒ­ã‚°è¿½åŠ 
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            testState.logs.push(logMessage);
            
            const logElement = document.getElementById('log-output');
            logElement.textContent = testState.logs.join('\n');
            logElement.scrollTop = logElement.scrollHeight;
            
            console.log(logMessage);
        }
        
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        function updateStatus(message, type = 'warning') {
            const section = document.getElementById('system-status');
            const text = document.getElementById('status-text');
            
            section.className = `section ${type}`;
            text.textContent = message;
        }
        
        // ã‚¹ãƒ†ãƒƒãƒ—æ›´æ–°
        function updateStep(stepId, status = 'active') {
            const step = document.getElementById(stepId);
            if (step) {
                step.className = `step ${status}`;
            }
        }
        
        // 1. Googleèªè¨¼ & åˆæœŸåŒ–
        async function authenticateGoogle() {
            addLog('ğŸ”‘ Googleèªè¨¼ & APIåˆæœŸåŒ–é–‹å§‹...');
            updateStatus('Googleèªè¨¼å®Ÿè¡Œä¸­...', 'warning');
            updateStep('step-auth', 'active');
            
            try {
                // Google Drive API v2 åˆæœŸåŒ–
                const success = await window.GoogleDriveAPIv2.initialize();
                if (!success) {
                    throw new Error('Google Drive APIåˆæœŸåŒ–å¤±æ•—');
                }
                
                updateStep('step-drive-init', 'active');
                addLog('âœ… Google Drive APIåˆæœŸåŒ–æˆåŠŸ');
                
                // Googleèªè¨¼å®Ÿè¡Œ
                const userInfo = await window.GoogleDriveAPIv2.authenticate();
                
                testState.authenticated = true;
                testState.driveInitialized = true;
                
                addLog(`âœ… Googleèªè¨¼æˆåŠŸ: ${userInfo.email}`);
                updateStatus(`èªè¨¼å®Œäº†: ${userInfo.email}`, 'success');
                updateStep('step-auth', 'completed');
                updateStep('step-drive-init', 'completed');
                
                // ãƒœã‚¿ãƒ³æœ‰åŠ¹åŒ–
                document.getElementById('btn-data-init').disabled = false;
                
            } catch (error) {
                addLog(`âŒ èªè¨¼ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                updateStatus(`èªè¨¼å¤±æ•—: ${error.message}`, 'error');
                updateStep('step-auth', 'error');
            }
        }
        
        // 2. ãƒ‡ãƒ¼ã‚¿ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–
        async function initializeDataManager() {
            addLog('ğŸ—ƒï¸ ãƒ‡ãƒ¼ã‚¿ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–é–‹å§‹...');
            updateStatus('ãƒ‡ãƒ¼ã‚¿ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ä¸­...', 'warning');
            updateStep('step-data-init', 'active');
            
            try {
                const success = await window.GoogleDriveDataManager.initialize();
                if (!success) {
                    throw new Error('ãƒ‡ãƒ¼ã‚¿ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å¤±æ•—');
                }
                
                testState.dataManagerReady = true;
                
                addLog('âœ… ãƒ‡ãƒ¼ã‚¿ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†');
                updateStatus('ãƒ‡ãƒ¼ã‚¿ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ æº–å‚™å®Œäº†', 'success');
                updateStep('step-data-init', 'completed');
                
                // ãƒœã‚¿ãƒ³æœ‰åŠ¹åŒ–
                document.getElementById('btn-sync').disabled = false;
                document.getElementById('btn-drive-data').disabled = false;
                document.getElementById('btn-test').disabled = false;
                
            } catch (error) {
                addLog(`âŒ ãƒ‡ãƒ¼ã‚¿ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                updateStatus(`åˆæœŸåŒ–å¤±æ•—: ${error.message}`, 'error');
                updateStep('step-data-init', 'error');
            }
        }
        
        // 3. ãƒ‡ãƒ¼ã‚¿åŒæœŸ
        async function syncData() {
            addLog('ğŸ”„ ãƒ‡ãƒ¼ã‚¿åŒæœŸé–‹å§‹...');
            updateStatus('ãƒ‡ãƒ¼ã‚¿åŒæœŸå®Ÿè¡Œä¸­...', 'warning');
            updateStep('step-sync', 'active');
            
            try {
                const customers = await window.GoogleDriveDataManager.syncWithLocalStorage();
                
                addLog(`âœ… ãƒ‡ãƒ¼ã‚¿åŒæœŸå®Œäº†: ${customers.length}ä»¶ã®é¡§å®¢ãƒ‡ãƒ¼ã‚¿`);
                updateStatus(`ãƒ‡ãƒ¼ã‚¿åŒæœŸå®Œäº†: ${customers.length}ä»¶`, 'success');
                updateStep('step-sync', 'completed');
                
            } catch (error) {
                addLog(`âŒ ãƒ‡ãƒ¼ã‚¿åŒæœŸã‚¨ãƒ©ãƒ¼: ${error.message}`);
                updateStatus(`åŒæœŸå¤±æ•—: ${error.message}`, 'error');
                updateStep('step-sync', 'error');
            }
        }
        
        // LocalStorageãƒ‡ãƒ¼ã‚¿è¡¨ç¤º
        function loadLocalData() {
            try {
                const customers = JSON.parse(localStorage.getItem('rentpipe_customers') || '[]');
                displayCustomerData('LocalStorage', customers);
                addLog(`ğŸ“± LocalStorageãƒ‡ãƒ¼ã‚¿è¡¨ç¤º: ${customers.length}ä»¶`);
            } catch (error) {
                addLog(`âŒ LocalStorageãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }
        
        // Google Driveãƒ‡ãƒ¼ã‚¿è¡¨ç¤º
        async function loadDriveData() {
            try {
                addLog('â˜ï¸ Google Driveãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...');
                const customers = await window.GoogleDriveDataManager.loadCustomersFromGoogleDrive();
                displayCustomerData('Google Drive', customers);
                addLog(`â˜ï¸ Google Driveãƒ‡ãƒ¼ã‚¿è¡¨ç¤º: ${customers.length}ä»¶`);
            } catch (error) {
                addLog(`âŒ Google Driveãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }
        
        // ãƒ‡ãƒ¼ã‚¿æ“ä½œãƒ†ã‚¹ãƒˆ
        async function testDataOperation() {
            addLog('âœ… ãƒ‡ãƒ¼ã‚¿æ“ä½œãƒ†ã‚¹ãƒˆé–‹å§‹...');
            updateStatus('ãƒ‡ãƒ¼ã‚¿æ“ä½œãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...', 'warning');
            updateStep('step-test', 'active');
            
            try {
                // ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ä½œæˆ
                const testCustomer = {
                    id: 'test_' + Date.now(),
                    name: 'ãƒ†ã‚¹ãƒˆé¡§å®¢_' + Date.now(),
                    email: 'test@example.com',
                    phone: '090-1234-5678',
                    pipelineStatus: 'åˆå›ç›¸è«‡',
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    notes: 'Google Drive APIçµ±åˆãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿'
                };
                
                // LocalStorageã«è¿½åŠ 
                const localCustomers = JSON.parse(localStorage.getItem('rentpipe_customers') || '[]');
                localCustomers.push(testCustomer);
                localStorage.setItem('rentpipe_customers', JSON.stringify(localCustomers));
                
                // Google Driveã«åŒæœŸ
                await window.GoogleDriveDataManager.saveCustomersToGoogleDrive(localCustomers);
                
                addLog('âœ… ãƒ‡ãƒ¼ã‚¿æ“ä½œãƒ†ã‚¹ãƒˆå®Œäº†: ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ãƒ»åŒæœŸ');
                updateStatus('ãƒ‡ãƒ¼ã‚¿æ“ä½œãƒ†ã‚¹ãƒˆæˆåŠŸ', 'success');
                updateStep('step-test', 'completed');
                
            } catch (error) {
                addLog(`âŒ ãƒ‡ãƒ¼ã‚¿æ“ä½œãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`);
                updateStatus(`ãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}`, 'error');
                updateStep('step-test', 'error');
            }
        }
        
        // é¡§å®¢ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º
        function displayCustomerData(source, customers) {
            const section = document.getElementById('data-display-section');
            const content = document.getElementById('data-content');
            
            if (customers.length === 0) {
                content.innerHTML = `<p><strong>${source}</strong>: ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>`;
            } else {
                let html = `<h4>${source} - ${customers.length}ä»¶ã®é¡§å®¢ãƒ‡ãƒ¼ã‚¿</h4>`;
                html += '<table>';
                html += '<tr><th>ID</th><th>åå‰</th><th>ãƒ¡ãƒ¼ãƒ«</th><th>é›»è©±</th><th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th><th>ä½œæˆæ—¥</th></tr>';
                
                customers.slice(0, 10).forEach(customer => { // æœ€åˆã®10ä»¶ã®ã¿è¡¨ç¤º
                    html += `<tr>
                        <td>${customer.id || '-'}</td>
                        <td>${customer.name || '-'}</td>
                        <td>${customer.email || '-'}</td>
                        <td>${customer.phone || '-'}</td>
                        <td>${customer.pipelineStatus || '-'}</td>
                        <td>${customer.createdAt ? new Date(customer.createdAt).toLocaleDateString() : '-'}</td>
                    </tr>`;
                });
                
                html += '</table>';
                
                if (customers.length > 10) {
                    html += `<p><em>... ä»– ${customers.length - 10}ä»¶</em></p>`;
                }
                
                content.innerHTML = html;
            }
            
            section.style.display = 'block';
        }
        
        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±è¡¨ç¤º
        function showDebugInfo() {
            const driveDebug = window.GoogleDriveAPIv2?.getDebugInfo() || {};
            const dataDebug = window.GoogleDriveDataManager?.getDebugInfo() || {};
            
            const debugInfo = {
                testState: testState,
                googleDriveAPI: driveDebug,
                dataManager: dataDebug,
                localStorage: {
                    hasCustomers: !!localStorage.getItem('rentpipe_customers'),
                    customerCount: JSON.parse(localStorage.getItem('rentpipe_customers') || '[]').length
                }
            };
            
            document.getElementById('debug-output').textContent = JSON.stringify(debugInfo, null, 2);
            document.getElementById('debug-section').style.display = 'block';
            addLog('ğŸ” ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ');
        }
        
        // LocalStorageãƒªã‚»ãƒƒãƒˆ
        function resetLocalData() {
            if (confirm('LocalStorageã®é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                localStorage.removeItem('rentpipe_customers');
                addLog('ğŸ—‘ï¸ LocalStorageãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
                updateStatus('LocalStorageãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ', 'warning');
            }
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†
        document.addEventListener('DOMContentLoaded', function() {
            addLog('ğŸ“„ RentPipe Ã— Google Drive çµ±åˆãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†');
            addLog('ğŸ¯ æ‰‹é †: Googleèªè¨¼ â†’ ãƒ‡ãƒ¼ã‚¿ç®¡ç†åˆæœŸåŒ– â†’ ãƒ‡ãƒ¼ã‚¿åŒæœŸ â†’ æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ');
            
            // ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°è¡¨ç¤º
            loadLocalData();
        });
    </script>
</body>
</html>
