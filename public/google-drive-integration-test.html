<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RentPipe × Google Drive 統合テスト</title>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; 
            padding: 20px; 
            background: #f5f5f5; 
        }
        .container { 
            max-width: 1000px; 
            margin: 0 auto; 
            background: white; 
            padding: 30px; 
            border-radius: 10px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
        }
        h1 { 
            color: #333; 
            text-align: center; 
            margin-bottom: 30px; 
        }
        .section { 
            margin: 20px 0; 
            padding: 20px; 
            border: 1px solid #e0e0e0; 
            border-radius: 8px; 
        }
        .section.success { background: #e8f5e8; border-color: #4caf50; }
        .section.error { background: #ffeaea; border-color: #f44336; }
        .section.warning { background: #fff8e1; border-color: #ff9800; }
        .section.info { background: #e3f2fd; border-color: #2196f3; }
        
        button { 
            padding: 12px 24px; 
            margin: 8px; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }
        .btn-primary { background: #2196f3; color: white; }
        .btn-success { background: #4caf50; color: white; }
        .btn-warning { background: #ff9800; color: white; }
        .btn-danger { background: #f44336; color: white; }
        
        button:disabled { background: #ccc; cursor: not-allowed; }
        
        pre { 
            background: #f8f8f8; 
            padding: 15px; 
            border-radius: 6px; 
            overflow-x: auto;
            white-space: pre-wrap;
            font-size: 13px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .step-flow {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        .step {
            flex: 1;
            text-align: center;
            padding: 15px 10px;
            background: #f0f0f0;
            margin: 5px;
            border-radius: 6px;
            font-size: 13px;
            min-width: 150px;
        }
        .step.active { background: #2196f3; color: white; }
        .step.completed { background: #4caf50; color: white; }
        .step.error { background: #f44336; color: white; }
        
        .data-display {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            background: #fafafa;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th { background: #f2f2f2; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🏠 RentPipe × Google Drive 統合テスト</h1>
        
        <!-- フロー表示 -->
        <div class="step-flow">
            <div class="step" id="step-auth">🔑 Google認証</div>
            <div class="step" id="step-drive-init">🚀 Drive API初期化</div>
            <div class="step" id="step-data-init">🗃️ データ管理初期化</div>
            <div class="step" id="step-sync">🔄 データ同期</div>
            <div class="step" id="step-test">✅ 機能テスト</div>
        </div>
        
        <!-- システム状況 -->
        <div id="system-status" class="section warning">
            <h3>📊 システム状況</h3>
            <p id="status-text">準備中... まず Google認証を実行してください。</p>
        </div>
        
        <!-- コントロールパネル -->
        <div class="section">
            <h3>🎮 コントロールパネル</h3>
            
            <!-- 初期化ボタン -->
            <div>
                <h4>🔧 初期化</h4>
                <button class="btn-primary" onclick="authenticateGoogle()">
                    🔑 Google認証 & 初期化
                </button>
                <button class="btn-success" onclick="initializeDataManager()" disabled id="btn-data-init">
                    🗃️ データ管理システム初期化
                </button>
            </div>
            
            <!-- データ操作ボタン -->
            <div>
                <h4>📊 データ操作</h4>
                <button class="btn-success" onclick="syncData()" disabled id="btn-sync">
                    🔄 LocalStorage ↔ Google Drive 同期
                </button>
                <button class="btn-warning" onclick="loadLocalData()">
                    📱 LocalStorage データ表示
                </button>
                <button class="btn-warning" onclick="loadDriveData()" disabled id="btn-drive-data">
                    ☁️ Google Drive データ表示
                </button>
                <button class="btn-primary" onclick="testDataOperation()" disabled id="btn-test">
                    ✅ データ操作テスト
                </button>
            </div>
            
            <!-- デバッグ・管理 -->
            <div>
                <h4>🔍 デバッグ・管理</h4>
                <button class="btn-warning" onclick="showDebugInfo()">
                    🔍 システム情報表示
                </button>
                <button class="btn-danger" onclick="resetLocalData()">
                    🗑️ LocalStorage リセット
                </button>
            </div>
        </div>
        
        <!-- データ表示エリア -->
        <div id="data-display-section" class="section" style="display: none;">
            <h3>📋 データ表示</h3>
            <div id="data-content" class="data-display"></div>
        </div>
        
        <!-- ログ表示 -->
        <div class="section">
            <h3>📝 実行ログ</h3>
            <pre id="log-output">システム待機中...</pre>
        </div>
        
        <!-- デバッグ情報 -->
        <div id="debug-section" class="section" style="display: none;">
            <h3>🔍 システム情報</h3>
            <pre id="debug-output"></pre>
        </div>
    </div>

    <!-- スクリプト読み込み -->
    <script src="js/google-drive-api-v2.js"></script>
    <script src="js/google-drive-data-manager.js"></script>
    <script>
        let testState = {
            authenticated: false,
            driveInitialized: false,
            dataManagerReady: false,
            logs: []
        };
        
        // ログ追加
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            testState.logs.push(logMessage);
            
            const logElement = document.getElementById('log-output');
            logElement.textContent = testState.logs.join('\n');
            logElement.scrollTop = logElement.scrollHeight;
            
            console.log(logMessage);
        }
        
        // ステータス更新
        function updateStatus(message, type = 'warning') {
            const section = document.getElementById('system-status');
            const text = document.getElementById('status-text');
            
            section.className = `section ${type}`;
            text.textContent = message;
        }
        
        // ステップ更新
        function updateStep(stepId, status = 'active') {
            const step = document.getElementById(stepId);
            if (step) {
                step.className = `step ${status}`;
            }
        }
        
        // 1. Google認証 & 初期化
        async function authenticateGoogle() {
            addLog('🔑 Google認証 & API初期化開始...');
            updateStatus('Google認証実行中...', 'warning');
            updateStep('step-auth', 'active');
            
            try {
                // Google Drive API v2 初期化
                const success = await window.GoogleDriveAPIv2.initialize();
                if (!success) {
                    throw new Error('Google Drive API初期化失敗');
                }
                
                updateStep('step-drive-init', 'active');
                addLog('✅ Google Drive API初期化成功');
                
                // Google認証実行
                const userInfo = await window.GoogleDriveAPIv2.authenticate();
                
                testState.authenticated = true;
                testState.driveInitialized = true;
                
                addLog(`✅ Google認証成功: ${userInfo.email}`);
                updateStatus(`認証完了: ${userInfo.email}`, 'success');
                updateStep('step-auth', 'completed');
                updateStep('step-drive-init', 'completed');
                
                // ボタン有効化
                document.getElementById('btn-data-init').disabled = false;
                
            } catch (error) {
                addLog(`❌ 認証エラー: ${error.message}`);
                updateStatus(`認証失敗: ${error.message}`, 'error');
                updateStep('step-auth', 'error');
            }
        }
        
        // 2. データ管理システム初期化
        async function initializeDataManager() {
            addLog('🗃️ データ管理システム初期化開始...');
            updateStatus('データ管理システム初期化中...', 'warning');
            updateStep('step-data-init', 'active');
            
            try {
                const success = await window.GoogleDriveDataManager.initialize();
                if (!success) {
                    throw new Error('データ管理システム初期化失敗');
                }
                
                testState.dataManagerReady = true;
                
                addLog('✅ データ管理システム初期化完了');
                updateStatus('データ管理システム準備完了', 'success');
                updateStep('step-data-init', 'completed');
                
                // ボタン有効化
                document.getElementById('btn-sync').disabled = false;
                document.getElementById('btn-drive-data').disabled = false;
                document.getElementById('btn-test').disabled = false;
                
            } catch (error) {
                addLog(`❌ データ管理システム初期化エラー: ${error.message}`);
                updateStatus(`初期化失敗: ${error.message}`, 'error');
                updateStep('step-data-init', 'error');
            }
        }
        
        // 3. データ同期
        async function syncData() {
            addLog('🔄 データ同期開始...');
            updateStatus('データ同期実行中...', 'warning');
            updateStep('step-sync', 'active');
            
            try {
                const customers = await window.GoogleDriveDataManager.syncWithLocalStorage();
                
                addLog(`✅ データ同期完了: ${customers.length}件の顧客データ`);
                updateStatus(`データ同期完了: ${customers.length}件`, 'success');
                updateStep('step-sync', 'completed');
                
            } catch (error) {
                addLog(`❌ データ同期エラー: ${error.message}`);
                updateStatus(`同期失敗: ${error.message}`, 'error');
                updateStep('step-sync', 'error');
            }
        }
        
        // LocalStorageデータ表示
        function loadLocalData() {
            try {
                const customers = JSON.parse(localStorage.getItem('rentpipe_customers') || '[]');
                displayCustomerData('LocalStorage', customers);
                addLog(`📱 LocalStorageデータ表示: ${customers.length}件`);
            } catch (error) {
                addLog(`❌ LocalStorageデータ読み込みエラー: ${error.message}`);
            }
        }
        
        // Google Driveデータ表示
        async function loadDriveData() {
            try {
                addLog('☁️ Google Driveデータ読み込み中...');
                const customers = await window.GoogleDriveDataManager.loadCustomersFromGoogleDrive();
                displayCustomerData('Google Drive', customers);
                addLog(`☁️ Google Driveデータ表示: ${customers.length}件`);
            } catch (error) {
                addLog(`❌ Google Driveデータ読み込みエラー: ${error.message}`);
            }
        }
        
        // データ操作テスト
        async function testDataOperation() {
            addLog('✅ データ操作テスト開始...');
            updateStatus('データ操作テスト実行中...', 'warning');
            updateStep('step-test', 'active');
            
            try {
                // テストデータ作成
                const testCustomer = {
                    id: 'test_' + Date.now(),
                    name: 'テスト顧客_' + Date.now(),
                    email: 'test@example.com',
                    phone: '090-1234-5678',
                    pipelineStatus: '初回相談',
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    notes: 'Google Drive API統合テストデータ'
                };
                
                // LocalStorageに追加
                const localCustomers = JSON.parse(localStorage.getItem('rentpipe_customers') || '[]');
                localCustomers.push(testCustomer);
                localStorage.setItem('rentpipe_customers', JSON.stringify(localCustomers));
                
                // Google Driveに同期
                await window.GoogleDriveDataManager.saveCustomersToGoogleDrive(localCustomers);
                
                addLog('✅ データ操作テスト完了: テストデータを追加・同期');
                updateStatus('データ操作テスト成功', 'success');
                updateStep('step-test', 'completed');
                
            } catch (error) {
                addLog(`❌ データ操作テストエラー: ${error.message}`);
                updateStatus(`テスト失敗: ${error.message}`, 'error');
                updateStep('step-test', 'error');
            }
        }
        
        // 顧客データ表示
        function displayCustomerData(source, customers) {
            const section = document.getElementById('data-display-section');
            const content = document.getElementById('data-content');
            
            if (customers.length === 0) {
                content.innerHTML = `<p><strong>${source}</strong>: データがありません</p>`;
            } else {
                let html = `<h4>${source} - ${customers.length}件の顧客データ</h4>`;
                html += '<table>';
                html += '<tr><th>ID</th><th>名前</th><th>メール</th><th>電話</th><th>ステータス</th><th>作成日</th></tr>';
                
                customers.slice(0, 10).forEach(customer => { // 最初の10件のみ表示
                    html += `<tr>
                        <td>${customer.id || '-'}</td>
                        <td>${customer.name || '-'}</td>
                        <td>${customer.email || '-'}</td>
                        <td>${customer.phone || '-'}</td>
                        <td>${customer.pipelineStatus || '-'}</td>
                        <td>${customer.createdAt ? new Date(customer.createdAt).toLocaleDateString() : '-'}</td>
                    </tr>`;
                });
                
                html += '</table>';
                
                if (customers.length > 10) {
                    html += `<p><em>... 他 ${customers.length - 10}件</em></p>`;
                }
                
                content.innerHTML = html;
            }
            
            section.style.display = 'block';
        }
        
        // デバッグ情報表示
        function showDebugInfo() {
            const driveDebug = window.GoogleDriveAPIv2?.getDebugInfo() || {};
            const dataDebug = window.GoogleDriveDataManager?.getDebugInfo() || {};
            
            const debugInfo = {
                testState: testState,
                googleDriveAPI: driveDebug,
                dataManager: dataDebug,
                localStorage: {
                    hasCustomers: !!localStorage.getItem('rentpipe_customers'),
                    customerCount: JSON.parse(localStorage.getItem('rentpipe_customers') || '[]').length
                }
            };
            
            document.getElementById('debug-output').textContent = JSON.stringify(debugInfo, null, 2);
            document.getElementById('debug-section').style.display = 'block';
            addLog('🔍 システム情報を表示しました');
        }
        
        // LocalStorageリセット
        function resetLocalData() {
            if (confirm('LocalStorageの顧客データをすべて削除しますか？')) {
                localStorage.removeItem('rentpipe_customers');
                addLog('🗑️ LocalStorageデータをリセットしました');
                updateStatus('LocalStorageデータをリセット', 'warning');
            }
        }
        
        // ページ読み込み完了
        document.addEventListener('DOMContentLoaded', function() {
            addLog('📄 RentPipe × Google Drive 統合テストページ読み込み完了');
            addLog('🎯 手順: Google認証 → データ管理初期化 → データ同期 → 機能テスト');
            
            // デモデータがあれば表示
            loadLocalData();
        });
    </script>
</body>
</html>
