<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>顧客登録 - RentPipe</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .form-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .form-card {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .form-header {
            margin-bottom: 30px;
        }
        
        .form-header h1 {
            font-size: 28px;
            margin: 0 0 10px 0;
        }
        
        .form-header p {
            color: #6b7280;
            margin: 0;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            color: #1f2937;
        }
        
        .form-group label .required {
            color: #ef4444;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .form-actions {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }
        
        .btn-cancel {
            background: #6b7280;
        }
        
        .btn-cancel:hover {
            background: #4b5563;
        }
    </style>
</head>
<body>
    <!-- ナビゲーション -->
    <div id="navigation"></div>
    
    <!-- メインコンテンツ -->
    <div class="main-content">
        <div class="form-container">
            <div class="form-card">
                <div class="form-header">
                    <h1 id="form-title">➕ 新規顧客登録</h1>
                    <p id="form-description">顧客情報を入力してください</p>
                </div>
                
                <form id="customer-form" onsubmit="handleSubmit(event)">
                    <!-- 基本情報 -->
                    <h3>基本情報</h3>
                    
                    <div class="form-group">
                        <label>氏名 <span class="required">*</span></label>
                        <input type="text" id="name" name="name" required>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>メールアドレス <span class="required">*</span></label>
                            <input type="email" id="email" name="email" required>
                        </div>
                        
                        <div class="form-group">
                            <label>電話番号 <span class="required">*</span></label>
                            <input type="tel" id="phone" name="phone" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>パイプラインステータス</label>
                        <select id="pipelineStatus" name="pipelineStatus">
                            <option value="初回相談">初回相談</option>
                            <option value="物件紹介">物件紹介</option>
                            <option value="内見">内見</option>
                            <option value="申込">申込</option>
                            <option value="審査">審査</option>
                            <option value="契約">契約</option>
                            <option value="完了">完了</option>
                        </select>
                    </div>
                    
                    <!-- 希望条件 -->
                    <h3 style="margin-top: 30px;">希望条件</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>予算（最低）</label>
                            <input type="number" id="budgetMin" name="budgetMin" placeholder="50000">
                        </div>
                        
                        <div class="form-group">
                            <label>予算（最高）</label>
                            <input type="number" id="budgetMax" name="budgetMax" placeholder="100000">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>希望エリア（カンマ区切り）</label>
                        <input type="text" id="areas" name="areas" placeholder="渋谷区, 新宿区, 港区">
                    </div>
                    
                    <div class="form-group">
                        <label>備考</label>
                        <textarea id="notes" name="notes" placeholder="その他の希望条件や備考"></textarea>
                    </div>
                    
                    <!-- アクションボタン -->
                    <div class="form-actions">
                        <button type="button" class="btn btn-cancel" onclick="handleCancel()">キャンセル</button>
                        <button type="submit" class="btn btn-primary" id="submit-btn">登録する</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- RentPipe Core Scripts -->
    <script src="js/navigation.js"></script>
    <script src="js/integrated-auth-manager-v2.js"></script>
    <script src="js/unified-data-manager.js"></script>
    
    <script>
        // グローバル変数
        let isEditMode = false;
        let editingCustomerId = null;
        
        console.log('📝 顧客登録フォーム初期化');
        
        // URLパラメータから編集モードを判定
        function checkEditMode() {
            const urlParams = new URLSearchParams(window.location.search);
            const customerId = urlParams.get('edit');
            
            if (customerId) {
                console.log('✏️ 編集モード:', customerId);
                isEditMode = true;
                editingCustomerId = customerId;
                
                // UI更新
                document.getElementById('form-title').textContent = '✏️ 顧客情報編集';
                document.getElementById('form-description').textContent = '顧客情報を編集してください';
                document.getElementById('submit-btn').textContent = '更新する';
                
                // 既存データ読み込み
                loadCustomerData(customerId);
            } else {
                console.log('➕ 新規登録モード');
            }
        }
        
        // 既存顧客データ読み込み
        function loadCustomerData(customerId) {
            try {
                console.log('📖 顧客データ読み込み中...', customerId);
                
                if (!window.UnifiedDataManager) {
                    throw new Error('UnifiedDataManagerが利用できません');
                }
                
                const customers = window.UnifiedDataManager.getCustomers();
                const customer = customers.find(c => c.id === customerId);
                
                if (!customer) {
                    alert('❌ 顧客データが見つかりませんでした');
                    window.location.href = 'customer.html';
                    return;
                }
                
                console.log('✅ 顧客データ読み込み完了:', customer);
                
                // フォームに値を設定
                document.getElementById('name').value = customer.name || '';
                document.getElementById('email').value = customer.email || '';
                document.getElementById('phone').value = customer.phone || '';
                document.getElementById('pipelineStatus').value = customer.pipelineStatus || '初回相談';
                document.getElementById('budgetMin').value = customer.preferences?.budgetMin || '';
                document.getElementById('budgetMax').value = customer.preferences?.budgetMax || '';
                document.getElementById('areas').value = (customer.preferences?.areas || []).join(', ');
                document.getElementById('notes').value = customer.notes || '';
                
                console.log('✅ フォームに値を設定完了');
                
            } catch (error) {
                console.error('❌ 顧客データ読み込みエラー:', error);
                alert('顧客データの読み込みに失敗しました');
                window.location.href = 'customer.html';
            }
        }
        
        // フォーム送信処理
        function handleSubmit(event) {
            event.preventDefault();
            
            try {
                console.log('📝 フォーム送信処理開始');
                
                // フォームデータ取得
                const formData = {
                    name: document.getElementById('name').value.trim(),
                    email: document.getElementById('email').value.trim(),
                    phone: document.getElementById('phone').value.trim(),
                    pipelineStatus: document.getElementById('pipelineStatus').value,
                    preferences: {
                        budgetMin: parseInt(document.getElementById('budgetMin').value) || 0,
                        budgetMax: parseInt(document.getElementById('budgetMax').value) || 0,
                        areas: document.getElementById('areas').value
                            .split(',')
                            .map(a => a.trim())
                            .filter(a => a)
                    },
                    notes: document.getElementById('notes').value.trim()
                };
                
                console.log('📋 フォームデータ:', formData);
                
                if (!window.UnifiedDataManager) {
                    throw new Error('UnifiedDataManagerが利用できません');
                }
                
                if (isEditMode) {
                    // 更新処理
                    console.log('🔄 顧客情報更新中...', editingCustomerId);
                    
                    const success = window.UnifiedDataManager.updateCustomer(editingCustomerId, formData);
                    
                    if (success) {
                        console.log('✅ 顧客情報更新成功');
                        alert('✅ 顧客情報を更新しました');
                        window.location.href = 'customer.html';
                    } else {
                        throw new Error('顧客情報の更新に失敗しました');
                    }
                    
                } else {
                    // 新規登録処理
                    console.log('➕ 新規顧客登録中...');
                    
                    const newCustomer = window.UnifiedDataManager.addCustomer(formData);
                    
                    if (newCustomer) {
                        console.log('✅ 新規顧客登録成功:', newCustomer.id);
                        alert('✅ 顧客を登録しました');
                        window.location.href = 'customer.html';
                    } else {
                        throw new Error('顧客登録に失敗しました');
                    }
                }
                
            } catch (error) {
                console.error('❌ フォーム送信エラー:', error);
                alert('❌ エラー: ' + error.message);
            }
        }
        
        // キャンセル処理
        function handleCancel() {
            if (confirm('入力内容を破棄して戻りますか？')) {
                window.location.href = 'customer.html';
            }
        }
        
        // ページ読み込み時に編集モードチェック
        window.addEventListener('DOMContentLoaded', function() {
            checkEditMode();
        });
        
        console.log('✅ 顧客登録フォーム準備完了');
    </script>
</body>
</html>
