<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¡§å®¢ç™»éŒ² - RentPipe</title>
    <link rel="stylesheet" href="css/main.css">
    <style>
        .form-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .form-card {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .form-header {
            margin-bottom: 30px;
        }
        
        .form-header h1 {
            font-size: 28px;
            margin: 0 0 10px 0;
        }
        
        .form-header p {
            color: #6b7280;
            margin: 0;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            color: #1f2937;
        }
        
        .form-group label .required {
            color: #ef4444;
        }
        
        .form-group input[type="text"],
        .form-group input[type="email"],
        .form-group input[type="tel"],
        .form-group input[type="number"],
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.2s;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 30px;
        }
        
        .btn {
            flex: 1;
            padding: 14px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #3b82f6;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2563eb;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        .btn-secondary {
            background: #f3f4f6;
            color: #4b5563;
        }
        
        .btn-secondary:hover {
            background: #e5e7eb;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        @media (max-width: 768px) {
            .form-card {
                padding: 20px;
            }
            
            .button-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå‹•çš„ç”Ÿæˆï¼‰ -->
    <div id="navigation"></div>

    <div class="form-container">
        <div class="form-card">
            <div class="form-header">
                <h1 id="formTitle">æ–°è¦é¡§å®¢ç™»éŒ²</h1>
                <p id="formDescription">ãŠå®¢æ§˜ã®åŸºæœ¬æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
            </div>

            <form id="customerForm" onsubmit="handleSubmit(event)">
                <input type="hidden" id="customerId">
                
                <div class="form-group">
                    <label>ãŠåå‰ <span class="required">*</span></label>
                    <input type="text" id="name" placeholder="å±±ç”°å¤ªéƒ" required>
                </div>

                <div class="form-group">
                    <label>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ <span class="required">*</span></label>
                    <input type="email" id="email" placeholder="yamada@example.com" required>
                </div>

                <div class="form-group">
                    <label>é›»è©±ç•ªå· <span class="required">*</span></label>
                    <input type="tel" id="phone" placeholder="090-1234-5678" required>
                </div>

                <div class="form-group">
                    <label>ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ <span class="required">*</span></label>
                    <select id="pipelineStatus" required>
                        <option value="åˆå›ç›¸è«‡">åˆå›ç›¸è«‡</option>
                        <option value="ç‰©ä»¶ç´¹ä»‹">ç‰©ä»¶ç´¹ä»‹</option>
                        <option value="å†…è¦‹èª¿æ•´">å†…è¦‹èª¿æ•´</option>
                        <option value="ç”³è¾¼æº–å‚™">ç”³è¾¼æº–å‚™</option>
                        <option value="å¯©æŸ»ä¸­">å¯©æŸ»ä¸­</option>
                        <option value="å¥‘ç´„æ‰‹ç¶šã">å¥‘ç´„æ‰‹ç¶šã</option>
                        <option value="å®Œäº†">å®Œäº†</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>äºˆç®—ï¼ˆä¸‹é™ãƒ»ä¸‡å††ï¼‰</label>
                    <input type="number" id="budgetMin" placeholder="8" min="0" step="0.1">
                </div>

                <div class="form-group">
                    <label>äºˆç®—ï¼ˆä¸Šé™ãƒ»ä¸‡å††ï¼‰</label>
                    <input type="number" id="budgetMax" placeholder="12" min="0" step="0.1">
                </div>

                <div class="form-group">
                    <label>å¸Œæœ›ã‚¨ãƒªã‚¢</label>
                    <input type="text" id="areas" placeholder="ä¾‹: æ¸‹è°·é§…ã¾ã§30åˆ†ä»¥å†…">
                </div>

                <div class="form-group">
                    <label>å‚™è€ƒãƒ»ç‰¹è¨˜äº‹é …</label>
                    <textarea id="notes" placeholder="ãã®ä»–ã€ã”è¦æœ›ã‚„ã”è³ªå•ãªã©ãŒã‚ã‚Œã°ã”è¨˜å…¥ãã ã•ã„"></textarea>
                </div>

                <div class="button-group">
                    <button type="button" class="btn btn-secondary" onclick="handleCancel()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="submit" class="btn btn-primary" id="submitBtn">ç™»éŒ²ã™ã‚‹</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="js/navigation.js"></script>
    <script src="js/integrated-auth-manager-v2.js"></script>
    <script src="js/google-drive-api-v2.js"></script>
    <script src="js/google-sheets-api.js"></script>
    <script src="js/data-migration.js"></script>
    <script src="js/unified-sheets-manager.js"></script>
    <script src="js/unified-data-manager.js"></script>
    <script src="js/app-initializer.js"></script>
    
    <script>
        console.log('ğŸ“ é¡§å®¢ãƒ•ã‚©ãƒ¼ãƒ ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿é–‹å§‹...');
        
        let isEditMode = false;
        let editingCustomerId = null;
        
        // ãƒšãƒ¼ã‚¸åˆæœŸåŒ–å®Œäº†å¾Œã«ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯
        document.addEventListener('DOMContentLoaded', async () => {
            // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ç·¨é›†å¯¾è±¡ã®é¡§å®¢IDã‚’å–å¾—
            const urlParams = new URLSearchParams(window.location.search);
            const customerId = urlParams.get('edit');
            
            if (customerId) {
                // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰
                isEditMode = true;
                editingCustomerId = customerId;
                
                // ã‚¿ã‚¤ãƒˆãƒ«å¤‰æ›´
                document.getElementById('formTitle').textContent = 'é¡§å®¢æƒ…å ±ç·¨é›†';
                document.getElementById('formDescription').textContent = 'é¡§å®¢æƒ…å ±ã‚’æ›´æ–°ã—ã¦ãã ã•ã„';
                document.getElementById('submitBtn').textContent = 'æ›´æ–°ã™ã‚‹';
                
                // AppInitializerã®åˆæœŸåŒ–ã‚’å¾…ã¤
                if (window.AppInitializer && window.AppInitializer.initializationPromise) {
                    await window.AppInitializer.initializationPromise;
                }
                
                // é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
                await loadCustomerData(customerId);
            }
        });
        
        // é¡§å®¢ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        async function loadCustomerData(customerId) {
            try {
                console.log('ğŸ“¥ é¡§å®¢ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­:', customerId);
                
                const customer = window.UnifiedDataManager.getCustomerById(customerId);
                
                if (!customer) {
                    throw new Error('é¡§å®¢ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
                
                console.log('âœ… é¡§å®¢ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ:', customer);
                
                // ãƒ•ã‚©ãƒ¼ãƒ ã«ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
                document.getElementById('customerId').value = customer.id;
                document.getElementById('name').value = customer.basicInfo?.name || customer.name || '';
                document.getElementById('email').value = customer.basicInfo?.email || customer.email || '';
                document.getElementById('phone').value = customer.basicInfo?.phone || customer.phone || '';
                document.getElementById('pipelineStatus').value = customer.pipelineStatus || 'åˆå›ç›¸è«‡';
                
                const budgetMin = customer.preferences?.budget?.min || customer.preferences?.budgetMin || 0;
                const budgetMax = customer.preferences?.budget?.max || customer.preferences?.budgetMax || 0;
                
                document.getElementById('budgetMin').value = budgetMin ? (budgetMin / 10000).toFixed(1) : '';
                document.getElementById('budgetMax').value = budgetMax ? (budgetMax / 10000).toFixed(1) : '';
                document.getElementById('areas').value = customer.preferences?.areas || '';
                document.getElementById('notes').value = customer.additionalInfo?.notes || customer.preferences?.notes || '';
                
            } catch (error) {
                console.error('âŒ é¡§å®¢ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                alert('é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                window.location.href = 'customer.html';
            }
        }
        
        // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‡¦ç†
        async function handleSubmit(event) {
            event.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.textContent;
            
            try {
                submitBtn.disabled = true;
                submitBtn.textContent = isEditMode ? 'æ›´æ–°ä¸­...' : 'ç™»éŒ²ä¸­...';
                
                // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’åé›†
                const customerData = {
                    basicInfo: {
                        name: document.getElementById('name').value.trim(),
                        nameKana: "",
                        email: document.getElementById('email').value.trim(),
                        phone: document.getElementById('phone').value.trim(),
                        birthday: "",
                        gender: "no_answer",
                        currentAddress: "",
                        currentHousing: "",
                        occupation: "",
                        companyName: "",
                        yearsEmployed: 0,
                        annualIncome: 0,
                        movingReason: "",
                        numberOfOccupants: 1
                    },
                    preferences: {
                        budget: {
                            min: (parseFloat(document.getElementById('budgetMin').value) || 0) * 10000,
                            max: (parseFloat(document.getElementById('budgetMax').value) || 0) * 10000,
                            note: ""
                        },
                        moveInDate: "",
                        moveInDateNote: "",
                        areas: document.getElementById('areas').value.trim(),
                        areasNote: "",
                        layout: "",
                        layoutNote: "",
                        roomSize: 0,
                        roomSizeNote: "",
                        stationWalk: 0,
                        stationWalkNote: "",
                        buildingAge: {
                            value: 999,
                            type: "any",
                            note: ""
                        },
                        floor: 1,
                        floorNote: ""
                    },
                    equipment: {
                        autoLock: false,
                        separateBath: false,
                        separateWashroom: false,
                        indoorWashing: false,
                        twoGasStove: false,
                        flooring: false,
                        noTatami: false,
                        elevator: false,
                        deliveryBox: false,
                        internet: false,
                        parking: false,
                        bike: false,
                        bicycle: false,
                        petAllowed: false,
                        instrumentAllowed: false,
                        sohoAllowed: false,
                        equipmentNote: ""
                    },
                    additionalInfo: {
                        notes: document.getElementById('notes').value.trim()
                    },
                    agentMemo: "",
                    pipelineStatus: document.getElementById('pipelineStatus').value
                };
                
                let result;
                
                if (isEditMode) {
                    // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰: æ—¢å­˜é¡§å®¢ã‚’æ›´æ–°
                    customerData.id = editingCustomerId;
                    
                    // æ—¢å­˜ã®é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ãƒãƒ¼ã‚¸
                    const existingCustomer = window.UnifiedDataManager.getCustomerById(editingCustomerId);
                    if (existingCustomer) {
                        // æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒã—ã¤ã¤ã€ãƒ•ã‚©ãƒ¼ãƒ ã®å…¥åŠ›ã§ä¸Šæ›¸ã
                        Object.assign(existingCustomer.basicInfo, customerData.basicInfo);
                        Object.assign(existingCustomer.preferences, customerData.preferences);
                        Object.assign(existingCustomer.equipment, customerData.equipment);
                        Object.assign(existingCustomer.additionalInfo, customerData.additionalInfo);
                        existingCustomer.pipelineStatus = customerData.pipelineStatus;
                        
                        result = await window.UnifiedDataManager.updateCustomer(existingCustomer);
                    } else {
                        throw new Error('æ›´æ–°å¯¾è±¡ã®é¡§å®¢ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    }
                    
                    console.log('ğŸ“¤ é¡§å®¢ãƒ‡ãƒ¼ã‚¿æ›´æ–°:', customerData);
                } else {
                    // æ–°è¦ç™»éŒ²ãƒ¢ãƒ¼ãƒ‰
                    result = await window.UnifiedDataManager.addCustomer(customerData);
                    console.log('ğŸ“¤ é¡§å®¢ãƒ‡ãƒ¼ã‚¿ç™»éŒ²:', customerData);
                }
                
                if (result.success) {
                    alert(isEditMode ? 'âœ… é¡§å®¢æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼' : 'âœ… é¡§å®¢ã‚’ç™»éŒ²ã—ã¾ã—ãŸï¼');
                    window.location.href = 'customer.html';
                } else {
                    throw new Error(result.error || (isEditMode ? 'æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ' : 'ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ'));
                }
                
            } catch (error) {
                console.error('âŒ ã‚¨ãƒ©ãƒ¼:', error);
                alert('âŒ ã‚¨ãƒ©ãƒ¼: ' + error.message);
                
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        }
        
        // ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç†
        function handleCancel() {
            if (confirm('å…¥åŠ›å†…å®¹ã‚’ç ´æ£„ã—ã¦æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ')) {
                window.location.href = 'customer.html';
            }
        }
        
        console.log('âœ… é¡§å®¢ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ æº–å‚™å®Œäº†');
    </script>
</body>
</html>
