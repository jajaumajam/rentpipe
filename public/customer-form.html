<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¡§å®¢ç™»éŒ² - RentPipe</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .form-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .form-card {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .form-header {
            margin-bottom: 30px;
        }
        
        .form-header h1 {
            font-size: 28px;
            margin: 0 0 10px 0;
        }
        
        .form-header p {
            color: #6b7280;
            margin: 0;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            color: #1f2937;
        }
        
        .form-group label .required {
            color: #ef4444;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .form-actions {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }
        
        .btn-cancel {
            background: #6b7280;
        }
        
        .btn-cancel:hover {
            background: #4b5563;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <div id="navigation"></div>
    
    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <div class="main-content">
        <div class="form-container">
            <div class="form-card">
                <div class="form-header">
                    <h1 id="form-title">â• æ–°è¦é¡§å®¢ç™»éŒ²</h1>
                    <p id="form-description">é¡§å®¢æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
                </div>
                
                <form id="customer-form" onsubmit="handleSubmit(event)">
                    <!-- åŸºæœ¬æƒ…å ± -->
                    <h3>åŸºæœ¬æƒ…å ±</h3>
                    
                    <div class="form-group">
                        <label>æ°å <span class="required">*</span></label>
                        <input type="text" id="name" name="name" required>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ <span class="required">*</span></label>
                            <input type="email" id="email" name="email" required>
                        </div>
                        
                        <div class="form-group">
                            <label>é›»è©±ç•ªå· <span class="required">*</span></label>
                            <input type="tel" id="phone" name="phone" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
                        <select id="pipelineStatus" name="pipelineStatus">
                            <option value="åˆå›ç›¸è«‡">åˆå›ç›¸è«‡</option>
                            <option value="ç‰©ä»¶ç´¹ä»‹">ç‰©ä»¶ç´¹ä»‹</option>
                            <option value="å†…è¦‹">å†…è¦‹</option>
                            <option value="ç”³è¾¼">ç”³è¾¼</option>
                            <option value="å¯©æŸ»">å¯©æŸ»</option>
                            <option value="å¥‘ç´„">å¥‘ç´„</option>
                            <option value="å®Œäº†">å®Œäº†</option>
                        </select>
                    </div>
                    
                    <!-- å¸Œæœ›æ¡ä»¶ -->
                    <h3 style="margin-top: 30px;">å¸Œæœ›æ¡ä»¶</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>äºˆç®—ï¼ˆæœ€ä½ï¼‰</label>
                            <input type="number" id="budgetMin" name="budgetMin" placeholder="50000">
                        </div>
                        
                        <div class="form-group">
                            <label>äºˆç®—ï¼ˆæœ€é«˜ï¼‰</label>
                            <input type="number" id="budgetMax" name="budgetMax" placeholder="100000">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>å¸Œæœ›ã‚¨ãƒªã‚¢</label>
                        <input type="text" id="areas" name="areas" placeholder="æ¸‹è°·åŒº, æ–°å®¿åŒº">
                    </div>
                    
                    <div class="form-group">
                        <label>å‚™è€ƒ</label>
                        <textarea id="notes" name="notes" placeholder="ãã®ä»–ã®è¦æœ›ã‚„è£œè¶³æƒ…å ±"></textarea>
                    </div>
                    
                    <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
                    <div class="form-actions">
                        <button type="button" class="btn btn-cancel" onclick="handleCancel()">
                            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                        </button>
                        <button type="submit" class="btn btn-primary" id="submit-btn">
                            ç™»éŒ²ã™ã‚‹
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Google API Client & Identity Services -->
    <script src="https://accounts.google.com/gsi/client"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    
    <!-- RentPipe Core Scriptsï¼ˆæ­£ã—ã„é †åº - customer.htmlã¨åŒã˜ï¼‰-->
    <script src="js/navigation.js"></script>
    <script src="js/integrated-auth-manager-v2.js"></script>
    
    <!-- Google Integration Scripts -->
    <script src="js/google-drive-api-v2.js"></script>
    <script src="js/google-sheets-api.js"></script>
    
    <!-- Data Management -->
    <script src="js/unified-sheets-manager.js"></script>
    <script src="js/unified-data-manager.js"></script>
    
    <!-- âœ… çµ±åˆåˆæœŸåŒ–ã‚·ã‚¹ãƒ†ãƒ  -->
    <script src="js/app-initializer.js"></script>
    
    <!-- Customer Form Functions -->
    <script>
        let isEditMode = false;
        let editingCustomerId = null;
        
        // âœ… é«˜é€Ÿã‚¹ã‚¿ãƒ¼ãƒˆï¼ˆçµ±åˆåˆæœŸåŒ–ã‚·ã‚¹ãƒ†ãƒ ä½¿ç”¨ï¼‰
        console.log('ğŸ“ é¡§å®¢ãƒ•ã‚©ãƒ¼ãƒ ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿é–‹å§‹...');
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                window.RentPipeApp.quickStart('customer-form');
            });
        } else {
            window.RentPipeApp.quickStart('customer-form');
        }
        
        // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ï¼ˆåˆæœŸåŒ–å®Œäº†å¾Œã«å®Ÿè¡Œï¼‰
        function loadCustomerForEdit(customerId) {
            console.log('âœï¸ ç·¨é›†ãƒ¢ãƒ¼ãƒ‰åˆæœŸåŒ–:', customerId);
            isEditMode = true;
            editingCustomerId = customerId;
            
            // UIæ›´æ–°
            document.getElementById('form-title').textContent = 'âœï¸ é¡§å®¢æƒ…å ±ç·¨é›†';
            document.getElementById('form-description').textContent = 'é¡§å®¢æƒ…å ±ã‚’ç·¨é›†ã—ã¦ãã ã•ã„';
            document.getElementById('submit-btn').textContent = 'æ›´æ–°ã™ã‚‹';
            
            // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
            try {
                if (!window.UnifiedDataManager) {
                    throw new Error('UnifiedDataManagerãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
                }
                
                const customer = window.UnifiedDataManager.getCustomerById(customerId);
                
                if (!customer) {
                    alert('âŒ é¡§å®¢ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
                    window.location.href = 'customer.html';
                    return;
                }
                
                console.log('âœ… é¡§å®¢ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ:', customer);
                
                // ãƒ•ã‚©ãƒ¼ãƒ ã«å€¤ã‚’è¨­å®š
                document.getElementById('name').value = customer.name || '';
                document.getElementById('email').value = customer.email || '';
                document.getElementById('phone').value = customer.phone || '';
                document.getElementById('pipelineStatus').value = customer.pipelineStatus || 'åˆå›ç›¸è«‡';
                document.getElementById('budgetMin').value = customer.preferences?.budgetMin || '';
                document.getElementById('budgetMax').value = customer.preferences?.budgetMax || '';
                document.getElementById('areas').value = (customer.preferences?.areas || []).join(', ');
                document.getElementById('notes').value = customer.notes || '';
                
                console.log('âœ… ãƒ•ã‚©ãƒ¼ãƒ ã«å€¤ã‚’è¨­å®šå®Œäº†');
                
            } catch (error) {
                console.error('âŒ é¡§å®¢ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                alert('é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
                window.location.href = 'customer.html';
            }
        }
        
        // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‡¦ç†ï¼ˆéåŒæœŸç‰ˆãƒ»awaitä½¿ç”¨ï¼‰
        async function handleSubmit(event) {
            event.preventDefault();
            
            const submitBtn = document.getElementById('submit-btn');
            const originalText = submitBtn.textContent;
            
            try {
                // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
                submitBtn.disabled = true;
                submitBtn.textContent = 'å‡¦ç†ä¸­...';
                
                console.log('ğŸ“ ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‡¦ç†é–‹å§‹');
                
                // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿å–å¾—
                const formData = {
                    name: document.getElementById('name').value.trim(),
                    email: document.getElementById('email').value.trim(),
                    phone: document.getElementById('phone').value.trim(),
                    pipelineStatus: document.getElementById('pipelineStatus').value,
                    preferences: {
                        budgetMin: parseInt(document.getElementById('budgetMin').value) || 0,
                        budgetMax: parseInt(document.getElementById('budgetMax').value) || 0,
                        areas: document.getElementById('areas').value
                            .split(',')
                            .map(a => a.trim())
                            .filter(a => a)
                    },
                    notes: document.getElementById('notes').value.trim()
                };
                
                console.log('ğŸ“‹ ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿:', formData);
                
                if (!window.UnifiedDataManager) {
                    throw new Error('UnifiedDataManagerãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
                }
                
                if (isEditMode) {
                    // âœ… æ›´æ–°å‡¦ç†ï¼ˆçµ±ä¸€ãƒ‡ãƒ¼ã‚¿ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ä½¿ç”¨ï¼‰
                    console.log('ğŸ”„ é¡§å®¢æƒ…å ±æ›´æ–°ä¸­...', editingCustomerId);
                    
                    const success = await window.UnifiedDataManager.updateCustomer(editingCustomerId, formData);
                    
                    if (success) {
                        console.log('âœ… é¡§å®¢æƒ…å ±æ›´æ–°æˆåŠŸï¼ˆGoogle SheetsåŒæœŸå®Œäº†ï¼‰');
                        alert('âœ… é¡§å®¢æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
                        window.location.href = 'customer.html';
                    } else {
                        throw new Error('é¡§å®¢æƒ…å ±ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    }
                    
                } else {
                    // âœ… æ–°è¦ç™»éŒ²å‡¦ç†ï¼ˆçµ±ä¸€ãƒ‡ãƒ¼ã‚¿ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ä½¿ç”¨ï¼‰
                    console.log('â• æ–°è¦é¡§å®¢ç™»éŒ²ä¸­...');
                    
                    const newCustomer = await window.UnifiedDataManager.addCustomer(formData);
                    
                    if (newCustomer) {
                        console.log('âœ… æ–°è¦é¡§å®¢ç™»éŒ²æˆåŠŸï¼ˆGoogle SheetsåŒæœŸå®Œäº†ï¼‰:', newCustomer.id);
                        alert('âœ… é¡§å®¢ã‚’ç™»éŒ²ã—ã¾ã—ãŸ');
                        window.location.href = 'customer.html';
                    } else {
                        throw new Error('é¡§å®¢ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    }
                }
                
            } catch (error) {
                console.error('âŒ ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
                alert('âŒ ã‚¨ãƒ©ãƒ¼: ' + error.message);
                
                // ãƒœã‚¿ãƒ³ã‚’å†åº¦æœ‰åŠ¹åŒ–
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        }
        
        // ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç†
        function handleCancel() {
            if (confirm('å…¥åŠ›å†…å®¹ã‚’ç ´æ£„ã—ã¦æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ')) {
                window.location.href = 'customer.html';
            }
        }
        
        console.log('âœ… é¡§å®¢ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ æº–å‚™å®Œäº†ï¼ˆçµ±åˆåˆæœŸåŒ–ã‚·ã‚¹ãƒ†ãƒ å¯¾å¿œï¼‰');
    </script>
</body>
</html>
