<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Drive API ãƒ†ã‚¹ãƒˆ - RentPipe</title>
    <style>
        body { 
            font-family: sans-serif; 
            max-width: 800px; 
            margin: 0 auto; 
            padding: 20px; 
            background: #f5f5f5;
        }
        .test-section { 
            margin: 20px 0; 
            padding: 20px; 
            border: 1px solid #ddd; 
            border-radius: 8px; 
            background: white;
        }
        .success { 
            background: #d4edda; 
            border-color: #c3e6cb; 
        }
        .error { 
            background: #f8d7da; 
            border-color: #f5c6cb; 
        }
        .warning {
            background: #fff3cd;
            border-color: #ffeaa7;
        }
        button { 
            padding: 10px 20px; 
            margin: 5px; 
            background: #007bff; 
            color: white; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
        }
        button:hover { 
            background: #0056b3; 
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        pre { 
            background: #f8f9fa; 
            padding: 10px; 
            border-radius: 5px; 
            overflow-x: auto; 
        }
        .auth-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .auth-success { background: #d4edda; color: #155724; }
        .auth-error { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <h1>ğŸ§ª Google Drive API ãƒ†ã‚¹ãƒˆ</h1>
    <p><strong>æ–°æ©Ÿèƒ½:</strong> çµ±åˆèªè¨¼ã‚·ã‚¹ãƒ†ãƒ  + Google Drive APIé€£æº</p>
    
    <div class="test-section">
        <h2>ğŸ“Š èªè¨¼çŠ¶æ…‹ç¢ºèª</h2>
        <div id="auth-status-display"></div>
        <button onclick="checkAuthStatus()" id="checkAuthBtn">èªè¨¼çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯</button>
        <div id="auth-result"></div>
    </div>
    
    <div class="test-section">
        <h2>ğŸ”§ Google Drive APIåˆæœŸåŒ–</h2>
        <button onclick="initializeDriveAPI()" id="driveInitBtn" disabled>Drive APIåˆæœŸåŒ–</button>
        <div id="drive-init-result"></div>
    </div>
    
    <div class="test-section">
        <h2>ğŸ“ RentPipeãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ä½œæˆ</h2>
        <button onclick="createRentPipeFolder()" id="folderBtn" disabled>ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ä½œæˆ</button>
        <div id="folder-result"></div>
    </div>
    
    <div class="test-section">
        <h2>ğŸ“Š CSVå¤‰æ›ãƒ†ã‚¹ãƒˆ</h2>
        <button onclick="testCSVConversion()" id="csvBtn">CSVå¤‰æ›ãƒ†ã‚¹ãƒˆ</button>
        <div id="csv-result"></div>
    </div>

    <div class="test-section warning">
        <h3>âš ï¸ æœªèªè¨¼ã®å ´åˆ</h3>
        <p>Google Drive APIæ©Ÿèƒ½ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯ã€Googleèªè¨¼ãŒå¿…è¦ã§ã™ã€‚</p>
        <a href="login.html" class="button" style="background: #28a745; text-decoration: none; color: white; display: inline-block; padding: 10px 20px; border-radius: 5px;">ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸</a>
    </div>

    <!-- Google Drive API SDK -->
    <script src="https://apis.google.com/js/api.js"></script>
    
    <script>
        // èªè¨¼çŠ¶æ…‹ç®¡ç†
        let isAuthenticated = false;
        let currentUser = null;
        let driveAPIReady = false;
        
        // çµæœè¡¨ç¤ºç”¨é–¢æ•°
        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : type === 'warning' ? 'warning' : '';
            element.innerHTML = `<div class="${className}"><pre>${message}</pre></div>`;
        }
        
        // èªè¨¼çŠ¶æ…‹ç¢ºèª
        function checkAuthStatus() {
            console.log('ğŸ” èªè¨¼çŠ¶æ…‹ç¢ºèªé–‹å§‹');
            
            try {
                // LocalStorageèªè¨¼ãƒ‡ãƒ¼ã‚¿ç¢ºèª
                const authSimple = localStorage.getItem('rentpipe_auth_simple');
                const userSimple = localStorage.getItem('rentpipe_user_simple');
                const tempAuth = localStorage.getItem('rentpipe_temp_auth');
                const userInfo = localStorage.getItem('rentpipe_user_info');
                
                console.log('ğŸ” èªè¨¼ãƒ‡ãƒ¼ã‚¿ç¢ºèª:', {
                    authSimple, tempAuth,
                    hasUserSimple: !!userSimple,
                    hasUserInfo: !!userInfo
                });
                
                if (authSimple === 'logged_in' && userSimple) {
                    try {
                        currentUser = JSON.parse(userSimple);
                        isAuthenticated = true;
                        
                        const statusHtml = `âœ… èªè¨¼æ¸ˆã¿
ãƒ¦ãƒ¼ã‚¶ãƒ¼: ${currentUser.email}
åå‰: ${currentUser.name || 'æœªè¨­å®š'}
èªè¨¼æ–¹å¼: simple-reliable-auth`;
                        
                        log('auth-result', statusHtml, 'success');
                        
                        // èªè¨¼çŠ¶æ…‹è¡¨ç¤ºæ›´æ–°
                        updateAuthStatusDisplay(true);
                        
                        // ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
                        document.getElementById('driveInitBtn').disabled = false;
                        
                        console.log('âœ… èªè¨¼ç¢ºèªå®Œäº†:', currentUser.email);
                        
                    } catch (parseError) {
                        console.error('âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼:', parseError);
                        log('auth-result', 'âŒ èªè¨¼ãƒ‡ãƒ¼ã‚¿ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                        updateAuthStatusDisplay(false);
                    }
                    
                } else if (tempAuth === 'google_authenticated' && userInfo) {
                    try {
                        const fullUserData = JSON.parse(userInfo);
                        currentUser = {
                            email: fullUserData.email,
                            name: fullUserData.displayName,
                            picture: fullUserData.photoURL
                        };
                        isAuthenticated = true;
                        
                        const statusHtml = `âœ… èªè¨¼æ¸ˆã¿ï¼ˆGoogleï¼‰
ãƒ¦ãƒ¼ã‚¶ãƒ¼: ${currentUser.email}
åå‰: ${currentUser.name || 'æœªè¨­å®š'}
èªè¨¼æ–¹å¼: google-integrated-auth`;
                        
                        log('auth-result', statusHtml, 'success');
                        updateAuthStatusDisplay(true);
                        document.getElementById('driveInitBtn').disabled = false;
                        
                        console.log('âœ… Googleèªè¨¼ç¢ºèªå®Œäº†:', currentUser.email);
                        
                    } catch (parseError) {
                        console.error('âŒ Googleèªè¨¼ãƒ‡ãƒ¼ã‚¿ãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼:', parseError);
                        log('auth-result', 'âŒ Googleèªè¨¼ãƒ‡ãƒ¼ã‚¿ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                        updateAuthStatusDisplay(false);
                    }
                    
                } else {
                    // æœªèªè¨¼çŠ¶æ…‹
                    isAuthenticated = false;
                    currentUser = null;
                    
                    log('auth-result', `âŒ æœªèªè¨¼çŠ¶æ…‹

Google Drive APIæ©Ÿèƒ½ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯ã€ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚
ä¸‹è¨˜ã®ãƒœã‚¿ãƒ³ã‹ã‚‰ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚`, 'error');
                    
                    updateAuthStatusDisplay(false);
                    
                    // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
                    document.getElementById('driveInitBtn').disabled = true;
                    document.getElementById('folderBtn').disabled = true;
                    
                    console.log('âŒ æœªèªè¨¼çŠ¶æ…‹');
                }
                
            } catch (error) {
                console.error('âŒ èªè¨¼çŠ¶æ…‹ç¢ºèªã‚¨ãƒ©ãƒ¼:', error);
                log('auth-result', `âŒ èªè¨¼çŠ¶æ…‹ç¢ºèªã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                updateAuthStatusDisplay(false);
            }
        }
        
        // èªè¨¼çŠ¶æ…‹è¡¨ç¤ºæ›´æ–°
        function updateAuthStatusDisplay(authenticated) {
            const statusDisplay = document.getElementById('auth-status-display');
            
            if (authenticated && currentUser) {
                statusDisplay.innerHTML = `
                    <span class="auth-status auth-success">âœ… èªè¨¼æ¸ˆã¿</span>
                    <strong>${currentUser.email}</strong>
                `;
            } else {
                statusDisplay.innerHTML = `
                    <span class="auth-status auth-error">âŒ æœªèªè¨¼</span>
                    <strong>ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™</strong>
                `;
            }
        }
        
        // Google Drive APIåˆæœŸåŒ–
        // Google Drive APIåˆæœŸåŒ–ï¼ˆä¿®æ­£ç‰ˆ - APIã‚­ãƒ¼å¯¾å¿œï¼‰
        async function initializeDriveAPI() {
            if (!isAuthenticated) {
                log("drive-init-result", "âŒ èªè¨¼ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚å…ˆã«èªè¨¼çŠ¶æ…‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚", "error");
                return;
            }
            
            console.log("ğŸ”§ Google Drive APIåˆæœŸåŒ–é–‹å§‹");
            log("drive-init-result", "ğŸ”§ Google Drive APIåˆæœŸåŒ–ä¸­...", "info");
            
            try {
                // Google API Client Library ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
                if (!window.gapi) {
                    throw new Error("Google API Client Library ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“");
                }
                
                // gapi client åˆæœŸåŒ–ï¼ˆAPIã‚­ãƒ¼ä»˜ãï¼‰
                await new Promise((resolve, reject) => {
                    window.gapi.load("client", {
                        callback: resolve,
                        onerror: reject
                    });
                });
                
                console.log("ğŸ”‘ Google API Clientè¨­å®šä¸­...");
                
                // Firebase APIã‚­ãƒ¼ã‚’ä½¿ç”¨ã—ã¦Google Drive APIã‚’åˆæœŸåŒ–
                await window.gapi.client.init({
                    apiKey: "AIzaSyBvJGdan0lvVSkaAbbSXQkoh6YyPoGyTgM", // Firebase APIã‚­ãƒ¼
                    discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"]
                });
                
                console.log("âœ… Google API ClientåˆæœŸåŒ–å®Œäº†");
                
                // Firebaseèªè¨¼ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
                let tokenSet = false;
                
                try {
                    // Firebaseã®ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰IDãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
                    if (window.firebase && firebase.auth && firebase.auth().currentUser) {
                        const user = firebase.auth().currentUser;
                        const idToken = await user.getIdToken();
                        
                        window.gapi.client.setToken({
                            access_token: idToken
                        });
                        console.log("âœ… Firebase IDãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ç”¨");
                        tokenSet = true;
                    }
                } catch (tokenError) {
                    console.warn("âš ï¸ Firebase IDãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ã‚¨ãƒ©ãƒ¼:", tokenError);
                }
                
                if (!tokenSet) {
                    throw new Error("ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã®è¨­å®šã«å¤±æ•—ã—ã¾ã—ãŸã€‚å†ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚");
                }
                
                // Drive APIæ¥ç¶šãƒ†ã‚¹ãƒˆ
                console.log("ğŸ” Google Drive APIæ¥ç¶šãƒ†ã‚¹ãƒˆä¸­...");
                const testResponse = await window.gapi.client.drive.about.get({
                    fields: "user"
                });
                
                console.log("âœ… Drive APIæ¥ç¶šãƒ†ã‚¹ãƒˆæˆåŠŸ:", testResponse.result.user.displayName);
                
                driveAPIReady = true;
                
                log("drive-init-result", `âœ… Google Drive APIåˆæœŸåŒ–å®Œäº†

APIã‚­ãƒ¼: è¨­å®šæ¸ˆã¿ (Firebase)
ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³: è¨­å®šæ¸ˆã¿
æ¥ç¶šãƒ†ã‚¹ãƒˆ: æˆåŠŸ
ãƒ¦ãƒ¼ã‚¶ãƒ¼: ${testResponse.result.user.displayName}

ä½¿ç”¨å¯èƒ½æ©Ÿèƒ½:
- ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§å–å¾—  
- ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆãƒ»æ›´æ–°  
- ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ç®¡ç†
- ãƒ•ã‚¡ã‚¤ãƒ«ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿æ“ä½œ`, "success");
                
                // ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ä½œæˆãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
                document.getElementById("folderBtn").disabled = false;
                
                console.log("âœ… Google Drive APIåˆæœŸåŒ–å®Œäº†");
                
            } catch (error) {
                console.error("âŒ Google Drive APIåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:", error);
                
                let errorMessage = `âŒ Google Drive APIåˆæœŸåŒ–å¤±æ•—

ã‚¨ãƒ©ãƒ¼: ${error.message}`;
                
                if (error.status === 403) {
                    errorMessage += `

ğŸ”§ 403ã‚¨ãƒ©ãƒ¼å¯¾å‡¦æ–¹æ³•:
1. Firebase Console ã§ Google Drive API ã‚’æœ‰åŠ¹åŒ–
2. ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¦å†ãƒ­ã‚°ã‚¤ãƒ³ï¼ˆæ–°ã—ã„æ¨©é™å–å¾—ï¼‰
3. Google Driveæ¨©é™ã‚’è¨±å¯

ğŸ“‹ è¨­å®šæ‰‹é †:
1. https://console.firebase.google.com/project/rentpipe-ab04e
2. Authentication â†’ Sign-in method â†’ Googleè¨­å®šç¢ºèª
3. https://console.cloud.google.com/apis/dashboard?project=rentpipe-ab04e
4. Google Drive API ã‚’æœ‰åŠ¹åŒ–`;
                    
                } else if (error.status === 401) {
                    errorMessage += `

ğŸ”§ 401ã‚¨ãƒ©ãƒ¼å¯¾å‡¦æ–¹æ³•:
1. ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¦å†ãƒ­ã‚°ã‚¤ãƒ³
2. ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã®å†å–å¾—`;
                    
                } else {
                    errorMessage += `

ğŸ”§ ä¸€èˆ¬çš„ãªå¯¾å‡¦æ–¹æ³•:
1. ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèª
2. ãƒ–ãƒ©ã‚¦ã‚¶ã‚’å†èª­ã¿è¾¼ã¿
3. ãƒ­ã‚°ã‚¢ã‚¦ãƒˆâ†’å†ãƒ­ã‚°ã‚¤ãƒ³`;
                }
                
                log("drive-init-result", errorMessage, "error");
                driveAPIReady = false;
            }
        }        
        // RentPipeãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ä½œæˆ
        async function createRentPipeFolder() {
            if (!driveAPIReady) {
                log('folder-result', 'âŒ Google Drive APIãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚', 'error');
                return;
            }
            
            console.log('ğŸ“ RentPipeãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ä½œæˆé–‹å§‹');
            log('folder-result', 'ğŸ“ RentPipeãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ä½œæˆä¸­...', 'info');
            
            try {
                // æ—¢å­˜ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼æ¤œç´¢
                console.log('ğŸ” æ—¢å­˜RentPipeãƒ•ã‚©ãƒ«ãƒ€ãƒ¼æ¤œç´¢ä¸­...');
                const searchResponse = await window.gapi.client.drive.files.list({
                    q: "name='RentPipe' and mimeType='application/vnd.google-apps.folder' and trashed=false",
                    spaces: 'drive'
                });
                
                let folderId;
                
                if (searchResponse.result.files.length > 0) {
                    // æ—¢å­˜ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ãŒè¦‹ã¤ã‹ã£ãŸ
                    folderId = searchResponse.result.files[0].id;
                    console.log('ğŸ“ æ—¢å­˜RentPipeãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ç™ºè¦‹:', folderId);
                    
                    log('folder-result', `âœ… æ—¢å­˜RentPipeãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã‚’ä½¿ç”¨

ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ID: ${folderId}
ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼å: RentPipe
çŠ¶æ…‹: æ—¢ã«å­˜åœ¨

ã“ã®ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã«é¡§å®¢ãƒ‡ãƒ¼ã‚¿ï¼ˆCSVï¼‰ã‚’ä¿å­˜ã—ã¾ã™ã€‚`, 'success');
                    
                } else {
                    // æ–°è¦ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ä½œæˆ
                    console.log('ğŸ“ æ–°è¦RentPipeãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ä½œæˆä¸­...');
                    const createResponse = await window.gapi.client.drive.files.create({
                        resource: {
                            name: 'RentPipe',
                            mimeType: 'application/vnd.google-apps.folder'
                        }
                    });
                    
                    folderId = createResponse.result.id;
                    console.log('âœ… æ–°è¦RentPipeãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ä½œæˆå®Œäº†:', folderId);
                    
                    log('folder-result', `âœ… æ–°è¦RentPipeãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ä½œæˆå®Œäº†

ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ID: ${folderId}
ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼å: RentPipe
ä½œæˆæ—¥æ™‚: ${new Date().toLocaleString()}

ã“ã®ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã«é¡§å®¢ãƒ‡ãƒ¼ã‚¿ï¼ˆCSVï¼‰ã‚’ä¿å­˜ã—ã¾ã™ã€‚
Google Driveã§ç¢ºèªã§ãã¾ã™ã€‚`, 'success');
                }
                
                // ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼IDã‚’localStorageã«ä¿å­˜ï¼ˆå¾Œã§ä½¿ç”¨ï¼‰
                localStorage.setItem('rentpipe_drive_folder_id', folderId);
                
            } catch (error) {
                console.error('âŒ RentPipeãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ä½œæˆã‚¨ãƒ©ãƒ¼:', error);
                
                let errorMessage = `âŒ RentPipeãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ä½œæˆå¤±æ•—

ã‚¨ãƒ©ãƒ¼: ${error.message}`;
                
                if (error.status === 403) {
                    errorMessage += `

åŸå› : Google Drive APIæ¨©é™ä¸è¶³
å¯¾å‡¦æ–¹æ³•: 
1. ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¦å†ãƒ­ã‚°ã‚¤ãƒ³
2. Google Driveæ¨©é™ã‚’è¨±å¯`;
                } else if (error.status === 401) {
                    errorMessage += `

åŸå› : ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ç„¡åŠ¹
å¯¾å‡¦æ–¹æ³•:
1. ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¦å†ãƒ­ã‚°ã‚¤ãƒ³`;
                }
                
                log('folder-result', errorMessage, 'error');
            }
        }
        
        // CSVå¤‰æ›ãƒ†ã‚¹ãƒˆ
        function testCSVConversion() {
            console.log('ğŸ“Š CSVå¤‰æ›ãƒ†ã‚¹ãƒˆé–‹å§‹');
            log('csv-result', 'ğŸ“Š CSVå¤‰æ›ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...', 'info');
            
            try {
                // ãƒ†ã‚¹ãƒˆç”¨é¡§å®¢ãƒ‡ãƒ¼ã‚¿
                const testCustomers = [
                    {
                        id: 'test-001',
                        name: 'ãƒ†ã‚¹ãƒˆå¤ªéƒ',
                        email: 'test@example.com',
                        phone: '090-1234-5678',
                        age: 30,
                        occupation: 'ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢',
                        annualIncome: 5000000,
                        pipelineStatus: 'åˆå›ç›¸è«‡',
                        preferences: {
                            budgetMin: 80000,
                            budgetMax: 120000,
                            areas: ['æ¸‹è°·', 'æ–°å®¿'],
                            roomType: '1K',
                            requirements: ['é§…è¿‘', 'ãƒšãƒƒãƒˆå¯']
                        },
                        notes: 'ãƒ†ã‚¹ãƒˆç”¨é¡§å®¢ãƒ‡ãƒ¼ã‚¿',
                        urgency: 'ä¸­',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString(),
                        source: 'drive_api_test'
                    }
                ];
                
                // CSVãƒ˜ãƒƒãƒ€ãƒ¼
                const headers = [
                    'id', 'name', 'email', 'phone', 'age', 'occupation',
                    'annualIncome', 'pipelineStatus', 'budgetMin', 'budgetMax',
                    'areas', 'roomType', 'requirements', 'notes', 'urgency',
                    'createdAt', 'updatedAt', 'source'
                ];
                
                // CSVç”Ÿæˆ
                const csvRows = [headers.join(',')]; // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ
                
                testCustomers.forEach(customer => {
                    const row = headers.map(header => {
                        let value = customer[header] || '';
                        
                        // ç‰¹åˆ¥ãªå‡¦ç†
                        if (header === 'areas' && customer.preferences?.areas) {
                            value = customer.preferences.areas.join(';');
                        } else if (header === 'requirements' && customer.preferences?.requirements) {
                            value = customer.preferences.requirements.join(';');
                        } else if (header === 'budgetMin') {
                            value = customer.preferences?.budgetMin || '';
                        } else if (header === 'budgetMax') {
                            value = customer.preferences?.budgetMax || '';
                        } else if (header === 'roomType') {
                            value = customer.preferences?.roomType || '';
                        }
                        
                        // CSVå½¢å¼ã«ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
                        return `"${String(value).replace(/"/g, '""')}"`;
                    });
                    
                    csvRows.push(row.join(','));
                });
                
                const csvContent = csvRows.join('\n');
                
                // çµæœè¡¨ç¤º
                const result = `âœ… CSVå¤‰æ›ãƒ†ã‚¹ãƒˆæˆåŠŸ

å…ƒãƒ‡ãƒ¼ã‚¿: ${testCustomers.length}ä»¶ã®é¡§å®¢ãƒ‡ãƒ¼ã‚¿

ç”Ÿæˆã•ã‚ŒãŸCSV:
${csvContent}

CSVç‰¹å¾´:
- ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°: UTF-8
- åŒºåˆ‡ã‚Šæ–‡å­—: ã‚«ãƒ³ãƒï¼ˆ,ï¼‰
- ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—: ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆ
- é…åˆ—ãƒ‡ãƒ¼ã‚¿: ã‚»ãƒŸã‚³ãƒ­ãƒ³ï¼ˆ;ï¼‰åŒºåˆ‡ã‚Š

æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—: ã“ã®CSVã‚’Google Driveã«ä¿å­˜`;
                
                log('csv-result', result, 'success');
                console.log('âœ… CSVå¤‰æ›ãƒ†ã‚¹ãƒˆå®Œäº†');
                
            } catch (error) {
                console.error('âŒ CSVå¤‰æ›ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                log('csv-result', `âŒ CSVå¤‰æ›ãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}`, 'error');
            }
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ Google Drive APIãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸åˆæœŸåŒ–');
            
            // åˆæœŸèªè¨¼çŠ¶æ…‹ç¢ºèª
            setTimeout(() => {
                checkAuthStatus();
            }, 500);
        });
    </script>
</body>
</html>
